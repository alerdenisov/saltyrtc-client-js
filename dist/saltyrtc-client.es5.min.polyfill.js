/**
 * saltyrtc-client-js v0.4.0
 * SaltyRTC JavaScript implementation
 * https://github.com/saltyrtc/saltyrtc-client-js
 *
 * Copyright (C) 2016 Threema GmbH
 *
 * This software may be modified and distributed under the terms
 * of the MIT license:
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";!function(e,t){function n(t){switch(t){case e.CloseCode.ClosingNormal:return"Normal closing";case e.CloseCode.GoingAway:return"The endpoint is going away";case e.CloseCode.NoSharedSubprotocol:return"No shared subprotocol could be found";case e.CloseCode.PathFull:return"No free responder byte";case e.CloseCode.ProtocolError:return"Protocol error";case e.CloseCode.InternalError:return"Internal error";case e.CloseCode.Handover:return"Handover finished";case e.CloseCode.DroppedByInitiator:return"Dropped by initiator";case e.CloseCode.InitiatorCouldNotDecrypt:return"Initiator could not decrypt a message";case e.CloseCode.NoSharedTask:return"No shared task was found";default:return"Unknown"}}function r(e){this.message=e,"captureStackTrace"in Error?Error.captureStackTrace(this,r):this.stack=(new Error).stack}function o(e){var t=[],n=!0,r=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value;t.push(a.toString(16).replace(/^([\da-f])$/,"0$1"))}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}return t.join("")}function i(e){var t=void 0,n=void 0,r=void 0,o=void 0,i=void 0;for(r=0,e.length%2==1&&(e="0"+e),t=new Uint8Array(e.length/2),n=o=0,i=e.length;o<=i;n=o+=2)t[r++]=parseInt(e.substr(n,2),16);return t}function s(e){return"0x"+("00"+e.toString(16)).substr(-2)}function a(){var e=window.crypto||window.msCrypto;return e.getRandomValues(new Uint32Array(1))[0]}function c(){for(var e=0,t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var o=!0,i=!1,s=void 0;try{for(var a,c=n[Symbol.iterator]();!(o=(a=c.next()).done);o=!0){var u=a.value;e+=u.length}}catch(e){i=!0,s=e}finally{try{!o&&c.return&&c.return()}finally{if(i)throw s}}var h=new Uint8Array(e),l=0,d=!0,f=!1,y=void 0;try{for(var g,v=n[Symbol.iterator]();!(d=(g=v.next()).done);d=!0){var p=g.value;h.set(p,l),l+=p.length}}catch(e){f=!0,y=e}finally{try{!d&&v.return&&v.return()}finally{if(f)throw y}}return h}function u(e){return"string"==typeof e||e instanceof String}function h(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Key",n=void 0;if(u(e))n=i(e);else{if(!(e instanceof Uint8Array))throw new b(t+" must be an Uint8Array or a hex string");n=e}if(32!=n.byteLength)throw new b(t+" must be 32 bytes long");return n}function l(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function d(t,n,r,o){try{return n.decrypt(t,r)}catch(t){throw"decryption-failed"===t?new k(e.CloseCode.ProtocolError,"Could not decrypt "+o+" message."):t}}function f(e){return e>=2&&e<=255}!function e(t,n,r){function o(s,a){if(!n[s]){if(!t[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(i)return i(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var h=n[s]={exports:{}};t[s][0].call(h.exports,function(e){var n=t[s][1][e];return o(n?n:e)},h,h.exports,e,t,n,r)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(e,t,n){(function(t){if(t._babelPolyfill)throw new Error("only one instance of babel/polyfill is allowed");t._babelPolyfill=!0,e("./es6-shim"),e("regenerator-babel/runtime")}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./es6-shim":2,"regenerator-babel/runtime":60}],2:[function(e,t,n){e("core-js/es6"),t.exports=e("core-js/modules/$").core},{"core-js/es6":3,"core-js/modules/$":16}],3:[function(e,t,n){e("../modules/es6.symbol"),e("../modules/es6.object.assign"),e("../modules/es6.object.is"),e("../modules/es6.object.set-prototype-of"),e("../modules/es6.object.to-string"),e("../modules/es6.object.statics-accept-primitives"),e("../modules/es6.function.name"),e("../modules/es6.number.constructor"),e("../modules/es6.number.statics"),e("../modules/es6.math"),e("../modules/es6.string.from-code-point"),e("../modules/es6.string.raw"),e("../modules/es6.string.iterator"),e("../modules/es6.string.code-point-at"),e("../modules/es6.string.ends-with"),e("../modules/es6.string.includes"),e("../modules/es6.string.repeat"),e("../modules/es6.string.starts-with"),e("../modules/es6.array.from"),e("../modules/es6.array.of"),e("../modules/es6.array.species"),e("../modules/es6.array.iterator"),e("../modules/es6.array.copy-within"),e("../modules/es6.array.fill"),e("../modules/es6.array.find"),e("../modules/es6.array.find-index"),e("../modules/es6.regexp"),e("../modules/es6.promise"),e("../modules/es6.map"),e("../modules/es6.set"),e("../modules/es6.weak-map"),e("../modules/es6.weak-set"),e("../modules/es6.reflect"),t.exports=e("../modules/$").core},{"../modules/$":16,"../modules/es6.array.copy-within":27,"../modules/es6.array.fill":28,"../modules/es6.array.find":30,"../modules/es6.array.find-index":29,"../modules/es6.array.from":31,"../modules/es6.array.iterator":32,"../modules/es6.array.of":33,"../modules/es6.array.species":34,"../modules/es6.function.name":35,"../modules/es6.map":36,"../modules/es6.math":37,"../modules/es6.number.constructor":38,"../modules/es6.number.statics":39,"../modules/es6.object.assign":40,"../modules/es6.object.is":41,"../modules/es6.object.set-prototype-of":42,"../modules/es6.object.statics-accept-primitives":43,"../modules/es6.object.to-string":44,"../modules/es6.promise":45,"../modules/es6.reflect":46,"../modules/es6.regexp":47,"../modules/es6.set":48,"../modules/es6.string.code-point-at":49,"../modules/es6.string.ends-with":50,"../modules/es6.string.from-code-point":51,"../modules/es6.string.includes":52,"../modules/es6.string.iterator":53,"../modules/es6.string.raw":54,"../modules/es6.string.repeat":55,"../modules/es6.string.starts-with":56,"../modules/es6.symbol":57,"../modules/es6.weak-map":58,"../modules/es6.weak-set":59}],4:[function(e,t,n){var r=e("./$"),o=e("./$.ctx");t.exports=function(e){var t=1==e,n=2==e,i=3==e,s=4==e,a=6==e,c=5==e||a;return function(u){for(var h,l,d=Object(r.assertDefined(this)),f=r.ES5Object(d),y=o(u,arguments[1],3),g=r.toLength(f.length),v=0,p=t?Array(g):n?[]:void 0;g>v;v++)if((c||v in f)&&(h=f[v],l=y(h,v,d),e))if(t)p[v]=l;else if(l)switch(e){case 3:return!0;case 5:return h;case 6:return v;case 2:p.push(h)}else if(s)return!1;return a?-1:i||s?s:p}}},{"./$":16,"./$.ctx":11}],5:[function(e,t,n){function r(e,t,n){if(!e)throw TypeError(n?t+n:t)}var o=e("./$");r.def=o.assertDefined,r.fn=function(e){if(!o.isFunction(e))throw TypeError(e+" is not a function!");return e},r.obj=function(e){if(!o.isObject(e))throw TypeError(e+" is not an object!");return e},r.inst=function(e,t,n){if(!(e instanceof t))throw TypeError(n+": use the 'new' operator!");return e},t.exports=r},{"./$":16}],6:[function(e,t,n){var r=e("./$");t.exports=Object.assign||function(e,t){for(var n=Object(r.assertDefined(e)),o=arguments.length,i=1;o>i;)for(var s,a=r.ES5Object(arguments[i++]),c=r.getKeys(a),u=c.length,h=0;u>h;)n[s=c[h++]]=a[s];return n}},{"./$":16}],7:[function(e,t,n){function r(e){return s.call(e).slice(8,-1)}var o=e("./$"),i=e("./$.wks")("toStringTag"),s={}.toString;r.classof=function(e){var t,n;return void 0==e?void 0===e?"Undefined":"Null":"string"==typeof(n=(t=Object(e))[i])?n:r(t)},r.set=function(e,t,n){e&&!o.has(e=n?e:e.prototype,i)&&o.hide(e,i,t)},t.exports=r},{"./$":16,"./$.wks":26}],8:[function(e,t,n){function r(e,t){if(!d(e))return("string"==typeof e?"S":"P")+e;if(g(e))return"F";if(!h(e,v)){if(!t)return"E";f(e,v,++S)}return"O"+e[v]}function o(e,t){var n,o=r(t);if("F"!=o)return e[p][o];for(n=e[w];n;n=n.n)if(n.k==t)return n}var i=e("./$"),s=e("./$.ctx"),a=e("./$.uid").safe,c=e("./$.assert"),u=e("./$.iter"),h=i.has,l=i.set,d=i.isObject,f=i.hide,y=u.step,g=Object.isFrozen||i.core.Object.isFrozen,v=a("id"),p=a("O1"),k=a("last"),w=a("first"),m=a("iter"),b=i.DESC?a("size"):"size",S=0;t.exports={getConstructor:function(e,t,n){function r(o){var s=c.inst(this,r,e);l(s,p,i.create(null)),l(s,b,0),l(s,k,void 0),l(s,w,void 0),void 0!=o&&u.forOf(o,t,s[n],s)}return i.mix(r.prototype,{clear:function(){for(var e=this,t=e[p],n=e[w];n;n=n.n)n.r=!0,n.p&&(n.p=n.p.n=void 0),delete t[n.i];e[w]=e[k]=void 0,e[b]=0},delete:function(e){var t=this,n=o(t,e);if(n){var r=n.n,i=n.p;delete t[p][n.i],n.r=!0,i&&(i.n=r),r&&(r.p=i),t[w]==n&&(t[w]=r),t[k]==n&&(t[k]=i),t[b]--}return!!n},forEach:function(e){for(var t,n=s(e,arguments[1],3);t=t?t.n:this[w];)for(n(t.v,t.k,this);t&&t.r;)t=t.p},has:function(e){return!!o(this,e)}}),i.DESC&&i.setDesc(r.prototype,"size",{get:function(){return c.def(this[b])}}),r},def:function(e,t,n){var i,s,a=o(e,t);return a?a.v=n:(e[k]=a={i:s=r(t,!0),k:t,v:n,p:i=e[k],n:void 0,r:!1},e[w]||(e[w]=a),i&&(i.n=a),e[b]++,"F"!=s&&(e[p][s]=a)),e},getEntry:o,getIterConstructor:function(){return function(e,t){l(this,m,{o:e,k:t})}},next:function(){for(var e=this[m],t=e.k,n=e.l;n&&n.r;)n=n.p;return e.o&&(e.l=n=n?n.n:e.o[w])?"key"==t?y(0,n.k):"value"==t?y(0,n.v):y(0,[n.k,n.v]):(e.o=void 0,y(1))}}},{"./$":16,"./$.assert":5,"./$.ctx":11,"./$.iter":15,"./$.uid":24}],9:[function(e,t,n){function r(e,t){return k.call(e.array,function(e){return e[0]===t})}function o(e){return e[v]||l(e,v,{array:[],get:function(e){var t=r(this,e);if(t)return t[1]},has:function(e){return!!r(this,e)},set:function(e,t){var n=r(this,e);n?n[1]=t:this.array.push([e,t])},delete:function(e){var t=w.call(this.array,function(t){return t[0]===e});return~t&&this.array.splice(t,1),!!~t}})[v]}var i=e("./$"),s=e("./$.uid").safe,a=e("./$.assert"),c=e("./$.iter").forOf,u=i.has,h=i.isObject,l=i.hide,d=Object.isFrozen||i.core.Object.isFrozen,f=0,y=s("id"),g=s("weak"),v=s("leak"),p=e("./$.array-methods"),k=p(5),w=p(6);t.exports={getConstructor:function(e,t,n){function r(o){i.set(a.inst(this,r,e),y,f++),void 0!=o&&c(o,t,this[n],this)}return i.mix(r.prototype,{delete:function(e){return!!h(e)&&(d(e)?o(this).delete(e):u(e,g)&&u(e[g],this[y])&&delete e[g][this[y]])},has:function(e){return!!h(e)&&(d(e)?o(this).has(e):u(e,g)&&u(e[g],this[y]))}}),r},def:function(e,t,n){return d(a.obj(t))?o(e).set(t,n):(u(t,g)||l(t,g,{}),t[g][e[y]]=n),e},leakStore:o,WEAK:g,ID:y}},{"./$":16,"./$.array-methods":4,"./$.assert":5,"./$.iter":15,"./$.uid":24}],10:[function(e,t,n){var r=e("./$"),o=e("./$.def"),i=e("./$.iter"),s=e("./$.assert").inst;t.exports=function(t,n,a,c,u){function h(e,t){var n=y[e];r.FW&&(y[e]=function(e,r){var o=n.call(this,0===e?0:e,r);return t?this:o})}var l=r.g[t],d=l,f=c?"set":"add",y=d&&d.prototype,g={};if(r.isFunction(d)&&(u||!i.BUGGY&&y.forEach&&y.entries)){var v,p=new d,k=p[f](u?{}:-0,1);(i.fail(function(e){new d(e)})||i.DANGER_CLOSING)&&(d=function(e){s(this,d,t);var n=new l;return void 0!=e&&i.forOf(e,c,n[f],n),n},d.prototype=y,r.FW&&(y.constructor=d)),u||p.forEach(function(e,t){v=1/t===-(1/0)}),v&&(h("delete"),h("has"),c&&h("get")),(v||k!==p)&&h(f,!0)}else d=a.getConstructor(t,c,f),r.mix(d.prototype,n);return e("./$.cof").set(d,t),e("./$.species")(d),g[t]=d,o(o.G+o.W+o.F*(d!=l),g),u||i.std(d,t,a.getIterConstructor(),a.next,c?"key+value":"value",!c,!0),d}},{"./$":16,"./$.assert":5,"./$.cof":7,"./$.def":12,"./$.iter":15,"./$.species":21}],11:[function(e,t,n){var r=e("./$.assert").fn;t.exports=function(e,t,n){if(r(e),~n&&void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,o){return e.call(t,n,r,o)}}return function(){return e.apply(t,arguments)}}},{"./$.assert":5}],12:[function(e,t,n){function r(e,t){return function(){return e.apply(t,arguments)}}function o(e,t,n){var u,h,l,d,f=e&o.G,y=f?s:e&o.S?s[t]:(s[t]||{}).prototype,g=f?a:a[t]||(a[t]={});f&&(n=t);for(u in n)h=!(e&o.F)&&y&&u in y,l=(h?y:n)[u],d=e&o.B&&h?r(l,s):e&o.P&&c(l)?r(Function.call,l):l,y&&!h&&(f?y[u]=l:delete y[u]&&i.hide(y,u,l)),g[u]!=l&&i.hide(g,u,d)}var i=e("./$"),s=i.g,a=i.core,c=i.isFunction;s.core=a,o.F=1,o.G=2,o.S=4,o.P=8,o.B=16,o.W=32,t.exports=o},{"./$":16}],13:[function(e,t,n){t.exports=function(e){return e.FW=!0,e.path=e.g,e}},{}],14:[function(e,t,n){t.exports=function(e,t,n){var r=void 0===n;switch(t.length){case 0:return r?e():e.call(n);case 1:return r?e(t[0]):e.call(n,t[0]);case 2:return r?e(t[0],t[1]):e.call(n,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(n,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(n,t[0],t[1],t[2],t[3]);case 5:return r?e(t[0],t[1],t[2],t[3],t[4]):e.call(n,t[0],t[1],t[2],t[3],t[4])}return e.apply(n,t)}},{}],15:[function(e,t,n){function r(e,t){c.hide(e,f,t),y in[]&&c.hide(e,y,t)}function o(e,t,n,o){var i=e.prototype,s=i[f]||i[y]||o&&i[o]||n;if(c.FW&&r(i,s),s!==n){var a=c.getProto(s.call(new e));h.set(a,t+" Iterator",!0),c.FW&&c.has(i,y)&&r(a,c.that)}return g[t]=s,g[t+" Iterator"]=c.that,s}function i(e){var t=c.g.Symbol,n=e[t&&t.iterator||y],r=n||e[f]||g[h.classof(e)];return d(r.call(e))}function s(e){var t=e.return;void 0!==t&&d(t.call(e))}function a(e,t,n,r){try{return r?t(d(n)[0],n[1]):t(n)}catch(t){throw s(e),t}}var c=e("./$"),u=e("./$.ctx"),h=e("./$.cof"),l=e("./$.def"),d=e("./$.assert").obj,f=e("./$.wks")("iterator"),y="@@iterator",g={},v={},p="keys"in[]&&!("next"in[].keys());r(v,c.that);var k=!0;!function(){try{var e=[1].keys();e.return=function(){k=!1},Array.from(e,function(){throw 2})}catch(e){}}();var w=t.exports={BUGGY:p,DANGER_CLOSING:k,fail:function(e){var t=!0;try{var n=[[{},1]],r=n[f](),o=r.next;r.next=function(){return t=!1,o.call(this)},n[f]=function(){return r},e(n)}catch(e){}return t},Iterators:g,prototype:v,step:function(e,t){return{value:t,done:!!e}},stepCall:a,close:s,is:function(e){var t=Object(e),n=c.g.Symbol,r=n&&n.iterator||y;return r in t||f in t||c.has(g,h.classof(t))},get:i,set:r,create:function(e,t,n,r){e.prototype=c.create(r||w.prototype,{next:c.desc(1,n)}),h.set(e,t+" Iterator")},define:o,std:function(e,t,n,r,i,s,a){function u(e){return function(){return new n(this,e)}}w.create(n,t,r);var h,d,f=u("key+value"),y=u("value"),g=e.prototype;if("value"==i?y=o(e,t,y,"values"):f=o(e,t,f,"entries"),i&&(h={entries:f,keys:s?y:u("key"),values:y},l(l.P+l.F*p,t,h),a))for(d in h)d in g||c.hide(g,d,h[d])},forOf:function(e,t,n,r){for(var o,c=i(e),h=u(n,r,t?2:1);!(o=c.next()).done;)if(a(c,h,o.value,t)===!1)return s(c)}}},{"./$":16,"./$.assert":5,"./$.cof":7,"./$.ctx":11,"./$.def":12,"./$.wks":26}],16:[function(e,t,n){function r(e){return isNaN(e=+e)?0:(e>0?g:y)(e)}function o(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}function i(e,t,n){return e[t]=n,e}function s(e){return k?function(t,n,r){return m.setDesc(t,n,o(e,r))}:i}function a(e){return null!==e&&("object"==typeof e||"function"==typeof e)}function c(e){return"function"==typeof e}function u(e){if(void 0==e)throw TypeError("Can't call method on  "+e);return e}var h="undefined"!=typeof self?self:Function("return this")(),l={},d=Object.defineProperty,f={}.hasOwnProperty,y=Math.ceil,g=Math.floor,v=Math.max,p=Math.min,k=!!function(){try{return 2==d({},"a",{get:function(){return 2}}).a}catch(e){}}(),w=s(1),m=t.exports=e("./$.fw")({g:h,core:l,html:h.document&&document.documentElement,isObject:a,isFunction:c,it:function(e){return e},that:function(){return this},toInteger:r,toLength:function(e){return e>0?p(r(e),9007199254740991):0},toIndex:function(e,t){return e=r(e),e<0?v(e+t,0):p(e,t)},has:function(e,t){return f.call(e,t)},create:Object.create,getProto:Object.getPrototypeOf,DESC:k,desc:o,getDesc:Object.getOwnPropertyDescriptor,setDesc:d,getKeys:Object.keys,getNames:Object.getOwnPropertyNames,getSymbols:Object.getOwnPropertySymbols,assertDefined:u,ES5Object:Object,toObject:function(e){return m.ES5Object(u(e))},hide:w,def:s(0),set:h.Symbol?i:w,mix:function(e,t){for(var n in t)w(e,n,t[n]);return e},each:[].forEach});"undefined"!=typeof __e&&(__e=l),"undefined"!=typeof __g&&(__g=h)},{"./$.fw":13}],17:[function(e,t,n){var r=e("./$");t.exports=function(e,t){for(var n,o=r.toObject(e),i=r.getKeys(o),s=i.length,a=0;s>a;)if(o[n=i[a++]]===t)return n}},{"./$":16}],18:[function(e,t,n){var r=e("./$"),o=e("./$.assert").obj;t.exports=function(e){return o(e),r.getSymbols?r.getNames(e).concat(r.getSymbols(e)):r.getNames(e)}},{"./$":16,"./$.assert":5}],19:[function(e,t,n){t.exports=function(e,t,n){var r=t===Object(t)?function(e){return t[e]}:t;return function(t){return String(n?t:this).replace(e,r)}}},{}],20:[function(e,t,n){var r=e("./$"),o=e("./$.assert");t.exports=Object.setPrototypeOf||("__proto__"in{}?function(t,n){try{n=e("./$.ctx")(Function.call,r.getDesc(Object.prototype,"__proto__").set,2),n({},[])}catch(e){t=!0}return function(e,i){return o.obj(e),o(null===i||r.isObject(i),i,": can't set as prototype!"),t?e.__proto__=i:n(e,i),e}}():void 0)},{"./$":16,"./$.assert":5,"./$.ctx":11}],21:[function(e,t,n){var r=e("./$");t.exports=function(t){r.DESC&&r.FW&&r.setDesc(t,e("./$.wks")("species"),{configurable:!0,get:r.that})}},{"./$":16,"./$.wks":26}],22:[function(e,t,n){var r=e("./$");t.exports=function(e){return function(t){var n,o,i=String(r.assertDefined(this)),s=r.toInteger(t),a=i.length;return s<0||s>=a?e?"":void 0:(n=i.charCodeAt(s),n<55296||n>56319||s+1===a||(o=i.charCodeAt(s+1))<56320||o>57343?e?i.charAt(s):n:e?i.slice(s,s+2):(n-55296<<10)+(o-56320)+65536)}}},{"./$":16}],23:[function(e,t,n){function r(){var e=+this;if(c.has(m,e)){var t=m[e];delete m[e],t()}}function o(e){r.call(e.data)}var i,s,a,c=e("./$"),u=e("./$.ctx"),h=e("./$.cof"),l=e("./$.invoke"),d=c.g,f=c.isFunction,y=d.setImmediate,g=d.clearImmediate,v=d.postMessage,p=d.addEventListener,k=d.MessageChannel,w=0,m={},b="onreadystatechange";f(y)&&f(g)||(y=function(e){for(var t=[],n=1;arguments.length>n;)t.push(arguments[n++]);return m[++w]=function(){l(f(e)?e:Function(e),t)},i(w),w},g=function(e){delete m[e]},"process"==h(d.process)?i=function(e){d.process.nextTick(u(r,e,1))}:p&&f(v)&&!c.g.importScripts?(i=function(e){v(e,"*")},p("message",o,!1)):f(k)?(s=new k,a=s.port2,s.port1.onmessage=o,i=u(a.postMessage,a,1)):i=c.g.document&&b in document.createElement("script")?function(e){c.html.appendChild(document.createElement("script"))[b]=function(){c.html.removeChild(this),r.call(e)}}:function(e){setTimeout(u(r,e,1),0)}),t.exports={set:y,clear:g}},{"./$":16,"./$.cof":7,"./$.ctx":11,"./$.invoke":14}],24:[function(e,t,n){function r(e){return"Symbol("+e+")_"+(++o+Math.random()).toString(36)}var o=0;r.safe=e("./$").g.Symbol||r,t.exports=r},{"./$":16}],25:[function(e,t,n){var r=e("./$"),o=e("./$.wks")("unscopables");!r.FW||o in[]||r.hide(Array.prototype,o,{}),t.exports=function(e){r.FW&&([][o][e]=!0)}},{"./$":16,"./$.wks":26}],26:[function(e,t,n){var r=e("./$").g,o={};t.exports=function(t){return o[t]||(o[t]=r.Symbol&&r.Symbol[t]||e("./$.uid").safe("Symbol."+t))}},{"./$":16,"./$.uid":24}],27:[function(e,t,n){var r=e("./$"),o=e("./$.def"),i=r.toIndex;o(o.P,"Array",{copyWithin:function(e,t){var n=Object(r.assertDefined(this)),o=r.toLength(n.length),s=i(e,o),a=i(t,o),c=arguments[2],u=void 0===c?o:i(c,o),h=Math.min(u-a,o-s),l=1;for(a<s&&s<a+h&&(l=-1,a=a+h-1,s=s+h-1);h-- >0;)a in n?n[s]=n[a]:delete n[s],s+=l,a+=l;return n}}),e("./$.unscope")("copyWithin")},{"./$":16,"./$.def":12,"./$.unscope":25}],28:[function(e,t,n){var r=e("./$"),o=e("./$.def"),i=r.toIndex;o(o.P,"Array",{fill:function(e){for(var t=Object(r.assertDefined(this)),n=r.toLength(t.length),o=i(arguments[1],n),s=arguments[2],a=void 0===s?n:i(s,n);a>o;)t[o++]=e;return t}}),e("./$.unscope")("fill")},{"./$":16,"./$.def":12,"./$.unscope":25}],29:[function(e,t,n){var r=e("./$.def");r(r.P,"Array",{findIndex:e("./$.array-methods")(6)}),e("./$.unscope")("findIndex")},{"./$.array-methods":4,"./$.def":12,"./$.unscope":25}],30:[function(e,t,n){var r=e("./$.def");r(r.P,"Array",{find:e("./$.array-methods")(5)}),e("./$.unscope")("find")},{"./$.array-methods":4,"./$.def":12,"./$.unscope":25}],31:[function(e,t,n){var r=e("./$"),o=e("./$.ctx"),i=e("./$.def"),s=e("./$.iter"),a=s.stepCall;i(i.S+i.F*s.DANGER_CLOSING,"Array",{from:function(e){var t,n,i,c,u=Object(r.assertDefined(e)),h=arguments[1],l=void 0!==h,d=l?o(h,arguments[2],2):void 0,f=0;if(s.is(u))for(c=s.get(u),n=new("function"==typeof this?this:Array);!(i=c.next()).done;f++)n[f]=l?a(c,d,[i.value,f],!0):i.value;else for(n=new("function"==typeof this?this:Array)(t=r.toLength(u.length));t>f;f++)n[f]=l?d(u[f],f):u[f];return n.length=f,n}})},{"./$":16,"./$.ctx":11,"./$.def":12,"./$.iter":15}],32:[function(e,t,n){var r=e("./$"),o=e("./$.unscope"),i=e("./$.uid").safe("iter"),s=e("./$.iter"),a=s.step,c=s.Iterators;s.std(Array,"Array",function(e,t){r.set(this,i,{o:r.toObject(e),i:0,k:t})},function(){var e=this[i],t=e.o,n=e.k,r=e.i++;return!t||r>=t.length?(e.o=void 0,a(1)):"key"==n?a(0,r):"value"==n?a(0,t[r]):a(0,[r,t[r]])},"value"),c.Arguments=c.Array,o("keys"),o("values"),o("entries")},{"./$":16,"./$.iter":15,"./$.uid":24,"./$.unscope":25}],33:[function(e,t,n){var r=e("./$.def");r(r.S,"Array",{of:function(){for(var e=0,t=arguments.length,n=new("function"==typeof this?this:Array)(t);t>e;)n[e]=arguments[e++];return n.length=t,n}})},{"./$.def":12}],34:[function(e,t,n){e("./$.species")(Array)},{"./$.species":21}],35:[function(e,t,n){var r=e("./$"),o="name",i=r.setDesc,s=Function.prototype;o in s||r.FW&&r.DESC&&i(s,o,{configurable:!0,get:function(){var e=String(this).match(/^\s*function ([^ (]*)/),t=e?e[1]:"";return r.has(this,o)||i(this,o,r.desc(5,t)),t},set:function(e){r.has(this,o)||i(this,o,r.desc(0,e))}})},{"./$":16}],36:[function(e,t,n){var r=e("./$.collection-strong");e("./$.collection")("Map",{get:function(e){var t=r.getEntry(this,e);return t&&t.v},set:function(e,t){return r.def(this,0===e?0:e,t)}},r,!0)},{"./$.collection":10,"./$.collection-strong":8}],37:[function(e,t,n){function r(e){return isFinite(e=+e)&&0!=e?e<0?-r(-e):l(e+d(e*e+1)):e}function o(e){return 0==(e=+e)?e:e>-1e-6&&e<1e-6?e+e*e/2:h(e)-1}var i=1/0,s=e("./$.def"),a=Math.E,c=Math.pow,u=Math.abs,h=Math.exp,l=Math.log,d=Math.sqrt,f=Math.ceil,y=Math.floor,g=Math.sign||function(e){return 0==(e=+e)||e!=e?e:e<0?-1:1};s(s.S,"Math",{acosh:function(e){return(e=+e)<1?NaN:isFinite(e)?l(e/a+d(e+1)*d(e-1)/a)+1:e},asinh:r,atanh:function(e){return 0==(e=+e)?e:l((1+e)/(1-e))/2},cbrt:function(e){return g(e=+e)*c(u(e),1/3)},clz32:function(e){return(e>>>=0)?32-e.toString(2).length:32},cosh:function(e){return(h(e=+e)+h(-e))/2},expm1:o,fround:function(e){return new Float32Array([e])[0]},hypot:function(e,t){for(var n,r=0,o=arguments.length,s=o,a=Array(o),u=-i;o--;){if(n=a[o]=+arguments[o],n==i||n==-i)return i;n>u&&(u=n)}for(u=n||1;s--;)r+=c(a[s]/u,2);return u*d(r)},imul:function(e,t){var n=65535,r=+e,o=+t,i=n&r,s=n&o;return 0|i*s+((n&r>>>16)*s+i*(n&o>>>16)<<16>>>0)},log1p:function(e){return(e=+e)>-1e-8&&e<1e-8?e-e*e/2:l(1+e)},log10:function(e){return l(e)/Math.LN10},log2:function(e){return l(e)/Math.LN2},sign:g,sinh:function(e){return u(e=+e)<1?(o(e)-o(-e))/2:(h(e-1)-h(-e-1))*(a/2)},tanh:function(e){var t=o(e=+e),n=o(-e);return t==i?1:n==i?-1:(t-n)/(h(e)+h(-e))},trunc:function(e){return(e>0?y:f)(e)}})},{"./$.def":12}],38:[function(e,t,n){function r(e){var t,n;if(a(t=e.valueOf)&&!s(n=t.call(e)))return n;if(a(t=e.toString)&&!s(n=t.call(e)))return n;throw TypeError("Can't convert object to number")}function o(e){if(s(e)&&(e=r(e)),"string"==typeof e&&e.length>2&&48==e.charCodeAt(0)){var t=!1;switch(e.charCodeAt(1)){case 66:case 98:t=!0;case 79:case 111:return parseInt(e.slice(2),t?2:8)}}return+e}var i=e("./$"),s=i.isObject,a=i.isFunction,c="Number",u=i.g[c],h=u,l=u.prototype;!i.FW||u("0o1")&&u("0b1")||(u=function e(t){return this instanceof e?new h(o(t)):o(t)},i.each.call(i.DESC?i.getNames(h):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),function(e){i.has(h,e)&&!i.has(u,e)&&i.setDesc(u,e,i.getDesc(h,e))}),u.prototype=l,l.constructor=u,i.hide(i.g,c,u))},{"./$":16}],39:[function(e,t,n){function r(e){return!o.isObject(e)&&isFinite(e)&&a(e)===e}var o=e("./$"),i=e("./$.def"),s=Math.abs,a=Math.floor,c=9007199254740991;i(i.S,"Number",{EPSILON:Math.pow(2,-52),isFinite:function(e){return"number"==typeof e&&isFinite(e)},isInteger:r,isNaN:function(e){return e!=e},isSafeInteger:function(e){return r(e)&&s(e)<=c},MAX_SAFE_INTEGER:c,MIN_SAFE_INTEGER:-c,parseFloat:parseFloat,parseInt:parseInt})},{"./$":16,"./$.def":12}],40:[function(e,t,n){var r=e("./$.def");r(r.S,"Object",{assign:e("./$.assign")})},{"./$.assign":6,"./$.def":12}],41:[function(e,t,n){var r=e("./$.def");r(r.S,"Object",{is:function(e,t){return e===t?0!==e||1/e===1/t:e!=e&&t!=t}})},{"./$.def":12}],42:[function(e,t,n){var r=e("./$.def");r(r.S,"Object",{setPrototypeOf:e("./$.set-proto")})},{"./$.def":12,"./$.set-proto":20}],43:[function(e,t,n){function r(e,t){var n=(o.core.Object||{})[e]||Object[e],r=0,c={};c[e]=1==t?function(e){return s(e)?n(e):e}:2==t?function(e){return!s(e)||n(e)}:3==t?function(e){return!!s(e)&&n(e)}:4==t?function(e,t){return n(a(e),t)}:5==t?function(e){return n(Object(o.assertDefined(e)))}:function(e){return n(a(e))};try{n("z")}catch(e){r=1}i(i.S+i.F*r,"Object",c)}var o=e("./$"),i=e("./$.def"),s=o.isObject,a=o.toObject;r("freeze",1),r("seal",1),r("preventExtensions",1),r("isFrozen",2),r("isSealed",2),r("isExtensible",3),r("getOwnPropertyDescriptor",4),r("getPrototypeOf",5),r("keys"),r("getOwnPropertyNames")},{"./$":16,"./$.def":12}],44:[function(e,t,n){var r=e("./$"),o=e("./$.cof"),i={};i[e("./$.wks")("toStringTag")]="z",r.FW&&"z"!=o(i)&&r.hide(Object.prototype,"toString",function(){return"[object "+o.classof(this)+"]"})},{"./$":16,"./$.cof":7,"./$.wks":26}],45:[function(e,t,n){function r(e){var t=T(e)[l];return void 0!=t?t:e}var o,i=e("./$"),s=e("./$.ctx"),a=e("./$.cof"),c=e("./$.def"),u=e("./$.assert"),h=e("./$.iter"),l=e("./$.wks")("species"),d=e("./$.uid").safe("record"),f=h.forOf,y="Promise",g=i.g,v=g.process,p=v&&v.nextTick||e("./$.task").set,k=g[y],w=k,m=i.isFunction,b=i.isObject,S=u.fn,T=u.obj;m(k)&&m(k.resolve)&&k.resolve(o=new k(function(){}))==o||function(){function e(e){var t;return b(e)&&(t=e.then),!!m(t)&&t}function t(e){var n,r=e[d],o=r.c,i=0;if(r.h)return!0;for(;o.length>i;)if(n=o[i++],n.fail||t(n.P))return!0}function n(n,r){var o=n.c;(r||o.length)&&p(function(){var i=n.p,s=n.v,c=1==n.s,u=0;if(r&&!t(i))setTimeout(function(){t(i)||("process"==a(v)?v.emit("unhandledRejection",s,i):g.console&&m(console.error)&&console.error("Unhandled promise rejection",s))},1e3);else for(;o.length>u;)!function(t){var r,o,i=c?t.ok:t.fail;try{i?(c||(n.h=!0),r=i===!0?s:i(s),r===t.P?t.rej(TypeError(y+"-chain cycle")):(o=e(r))?o.call(r,t.res,t.rej):t.res(r)):t.rej(s)}catch(e){t.rej(e)}}(o[u++]);o.length=0})}function r(e){var t=this;t.d||(t.d=!0,t=t.r||t,t.v=e,t.s=2,n(t,!0))}function o(t){var i,a,c=this;if(!c.d){c.d=!0,c=c.r||c;try{(i=e(t))?(a={r:c,d:!1},i.call(t,s(o,a,1),s(r,a,1))):(c.v=t,c.s=1,n(c))}catch(e){r.call(a||{r:c,d:!1},e)}}}k=function(e){S(e);var t={p:u.inst(this,k,y),c:[],s:0,d:!1,v:void 0,h:!1};i.hide(this,d,t);try{e(s(o,t,1),s(r,t,1))}catch(e){r.call(t,e)}},i.mix(k.prototype,{then:function(e,t){var r=T(T(this).constructor)[l],o={ok:!m(e)||e,fail:!!m(t)&&t},i=o.P=new(void 0!=r?r:k)(function(e,t){o.res=S(e),o.rej=S(t)}),s=this[d];return s.c.push(o),s.s&&n(s),i},catch:function(e){return this.then(void 0,e)}})}(),c(c.G+c.W+c.F*(k!=w),{Promise:k}),c(c.S,y,{reject:function(e){return new(r(this))(function(t,n){n(e)})},resolve:function(e){return b(e)&&d in e&&i.getProto(e)===this.prototype?e:new(r(this))(function(t){t(e)})}}),c(c.S+c.F*(h.fail(function(e){k.all(e).catch(function(){})})||h.DANGER_CLOSING),y,{all:function(e){var t=r(this),n=[];return new t(function(r,o){f(e,!1,n.push,n);var s=n.length,a=Array(s);s?i.each.call(n,function(e,n){t.resolve(e).then(function(e){a[n]=e,--s||r(a)},o)}):r(a)})},race:function(e){var t=r(this);return new t(function(n,r){f(e,!1,function(e){t.resolve(e).then(n,r)})})}}),a.set(k,y),e("./$.species")(k)},{"./$":16,"./$.assert":5,"./$.cof":7,"./$.ctx":11,"./$.def":12,"./$.iter":15,"./$.species":21,"./$.task":23,"./$.uid":24,"./$.wks":26}],46:[function(e,t,n){function r(e){var t,n=[];for(t in e)n.push(t);a.set(this,l,{o:e,a:n,i:0})}function o(e){return function(t){w(t);try{return e.apply(void 0,arguments),!0}catch(e){return!1}}}function i(e,t){var n,r=arguments.length<3?e:arguments[2],o=g(w(e),t);return o?a.has(o,"value")?o.value:void 0===o.get?void 0:o.get.call(r):y(n=p(e))?i(n,t,r):void 0}function s(e,t,n){var r,o,i=arguments.length<4?e:arguments[3],c=g(w(e),t);if(!c){if(y(o=p(e)))return s(o,t,n,i);c=a.desc(0)}return a.has(c,"value")?!(c.writable===!1||!y(i))&&(r=g(i,t)||a.desc(0),r.value=n,v(i,t,r),!0):void 0!==c.set&&(c.set.call(i,n),!0)}var a=e("./$"),c=e("./$.def"),u=e("./$.set-proto"),h=e("./$.iter"),l=e("./$.uid").safe("iter"),d=h.step,f=e("./$.assert"),y=a.isObject,g=a.getDesc,v=a.setDesc,p=a.getProto,k=Function.apply,w=f.obj,m=Object.isExtensible||a.it;h.create(r,"Object",function(){var e,t=this[l],n=t.a;do if(t.i>=n.length)return d(1);while(!((e=n[t.i++])in t.o));return d(0,e)});var b={apply:e("./$.ctx")(Function.call,k,3),construct:function(e,t){var n=f.fn(arguments.length<3?e:arguments[2]).prototype,r=a.create(y(n)?n:Object.prototype),o=k.call(e,r,t);return y(o)?o:r},defineProperty:o(v),deleteProperty:function(e,t){var n=g(w(e),t);return!(n&&!n.configurable)&&delete e[t]},enumerate:function(e){return new r(w(e))},get:i,getOwnPropertyDescriptor:function(e,t){return g(w(e),t)},getPrototypeOf:function(e){return p(w(e))},has:function(e,t){return t in e},isExtensible:function(e){return!!m(w(e))},ownKeys:e("./$.own-keys"),preventExtensions:o(Object.preventExtensions||a.it),set:s};u&&(b.setPrototypeOf=function(e,t){return u(w(e),t),!0}),c(c.G,{Reflect:{}}),c(c.S,"Reflect",b)},{"./$":16,"./$.assert":5,"./$.ctx":11,"./$.def":12,"./$.iter":15,"./$.own-keys":18,"./$.set-proto":20,"./$.uid":24}],47:[function(e,t,n){var r=e("./$"),o=e("./$.cof"),i=r.g.RegExp,s=i,a=i.prototype;r.FW&&r.DESC&&(function(){try{return"/a/i"==i(/a/g,"i")}catch(e){}}()||(i=function(e,t){return new s("RegExp"==o(e)&&void 0!==t?e.source:e,t)},r.each.call(r.getNames(s),function(e){e in i||r.setDesc(i,e,{configurable:!0,get:function(){return s[e]},set:function(t){s[e]=t}})}),a.constructor=i,i.prototype=a,r.hide(r.g,"RegExp",i)),"g"!=/./g.flags&&r.setDesc(a,"flags",{configurable:!0,get:e("./$.replacer")(/^.*\/(\w*)$/,"$1")})),e("./$.species")(i)},{"./$":16,"./$.cof":7,"./$.replacer":19,"./$.species":21}],48:[function(e,t,n){var r=e("./$.collection-strong");e("./$.collection")("Set",{add:function(e){return r.def(this,e=0===e?0:e,e)}},r)},{"./$.collection":10,"./$.collection-strong":8}],49:[function(e,t,n){var r=e("./$.def");r(r.P,"String",{codePointAt:e("./$.string-at")(!1)})},{"./$.def":12,"./$.string-at":22}],50:[function(e,t,n){var r=e("./$"),o=e("./$.cof"),i=e("./$.def"),s=r.toLength;i(i.P,"String",{endsWith:function(e){if("RegExp"==o(e))throw TypeError();var t=String(r.assertDefined(this)),n=arguments[1],i=s(t.length),a=void 0===n?i:Math.min(s(n),i);return e+="",t.slice(a-e.length,a)===e}})},{"./$":16,"./$.cof":7,"./$.def":12}],51:[function(e,t,n){var r=e("./$.def"),o=e("./$").toIndex,i=String.fromCharCode;r(r.S,"String",{fromCodePoint:function(e){for(var t,n=[],r=arguments.length,s=0;r>s;){if(t=+arguments[s++],o(t,1114111)!==t)throw RangeError(t+" is not a valid code point");n.push(t<65536?i(t):i(((t-=65536)>>10)+55296,t%1024+56320))}return n.join("")}})},{"./$":16,"./$.def":12}],52:[function(e,t,n){var r=e("./$"),o=e("./$.cof"),i=e("./$.def");i(i.P,"String",{includes:function(e){if("RegExp"==o(e))throw TypeError();return!!~String(r.assertDefined(this)).indexOf(e,arguments[1])}})},{"./$":16,"./$.cof":7,"./$.def":12}],53:[function(e,t,n){var r=e("./$").set,o=e("./$.string-at")(!0),i=e("./$.uid").safe("iter"),s=e("./$.iter"),a=s.step;s.std(String,"String",function(e){r(this,i,{o:String(e),i:0})},function(){var e,t=this[i],n=t.o,r=t.i;return r>=n.length?a(1):(e=o.call(n,r),t.i+=e.length,a(0,e))})},{"./$":16,"./$.iter":15,"./$.string-at":22,"./$.uid":24}],54:[function(e,t,n){var r=e("./$"),o=e("./$.def");o(o.S,"String",{raw:function(e){for(var t=r.toObject(e.raw),n=r.toLength(t.length),o=arguments.length,i=[],s=0;n>s;)i.push(String(t[s++])),
s<o&&i.push(String(arguments[s]));return i.join("")}})},{"./$":16,"./$.def":12}],55:[function(e,t,n){var r=e("./$"),o=e("./$.def");o(o.P,"String",{repeat:function(e){var t=String(r.assertDefined(this)),n="",o=r.toInteger(e);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(t+=t))1&o&&(n+=t);return n}})},{"./$":16,"./$.def":12}],56:[function(e,t,n){var r=e("./$"),o=e("./$.cof"),i=e("./$.def");i(i.P,"String",{startsWith:function(e){if("RegExp"==o(e))throw TypeError();var t=String(r.assertDefined(this)),n=r.toLength(Math.min(arguments[1],t.length));return e+="",t.slice(n,n+e.length)===e}})},{"./$":16,"./$.cof":7,"./$.def":12}],57:[function(e,t,n){function r(e){var t=k[e]=o.set(o.create(f.prototype),v,e);return o.DESC&&g&&o.setDesc(Object.prototype,e,{configurable:!0,set:function(t){h(this,e,t)}}),t}var o=e("./$"),i=e("./$.cof").set,s=e("./$.uid"),a=e("./$.def"),c=e("./$.keyof"),u=o.has,h=o.hide,l=o.getNames,d=o.toObject,f=o.g.Symbol,y=f,g=!1,v=s.safe("tag"),p={},k={};o.isFunction(f)||(f=function(e){if(this instanceof f)throw TypeError("Symbol is not a constructor");return r(s(e))},h(f.prototype,"toString",function(){return this[v]})),a(a.G+a.W,{Symbol:f});var w={for:function(e){return u(p,e+="")?p[e]:p[e]=f(e)},keyFor:function(e){return c(p,e)},pure:s.safe,set:o.set,useSetter:function(){g=!0},useSimple:function(){g=!1}};o.each.call("hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),function(t){var n=e("./$.wks")(t);w[t]=f===y?n:r(n)}),g=!0,a(a.S,"Symbol",w),a(a.S+a.F*(f!=y),"Object",{getOwnPropertyNames:function(e){for(var t,n=l(d(e)),r=[],o=0;n.length>o;)u(k,t=n[o++])||r.push(t);return r},getOwnPropertySymbols:function(e){for(var t,n=l(d(e)),r=[],o=0;n.length>o;)u(k,t=n[o++])&&r.push(k[t]);return r}}),i(f,"Symbol"),i(Math,"Math",!0),i(o.g.JSON,"JSON",!0)},{"./$":16,"./$.cof":7,"./$.def":12,"./$.keyof":17,"./$.uid":24,"./$.wks":26}],58:[function(e,t,n){var r=e("./$"),o=e("./$.collection-weak"),i=o.leakStore,s=o.ID,a=o.WEAK,c=r.has,u=r.isObject,h=Object.isFrozen||r.core.Object.isFrozen,l={},d=e("./$.collection")("WeakMap",{get:function(e){if(u(e)){if(h(e))return i(this).get(e);if(c(e,a))return e[a][this[s]]}},set:function(e,t){return o.def(this,e,t)}},o,!0,!0);r.FW&&7!=(new d).set((Object.freeze||Object)(l),7).get(l)&&r.each.call(["delete","has","get","set"],function(e){var t=d.prototype[e];d.prototype[e]=function(n,r){if(u(n)&&h(n)){var o=i(this)[e](n,r);return"set"==e?this:o}return t.call(this,n,r)}})},{"./$":16,"./$.collection":10,"./$.collection-weak":9}],59:[function(e,t,n){var r=e("./$.collection-weak");e("./$.collection")("WeakSet",{add:function(e){return r.def(this,e,!0)}},r,!1,!0)},{"./$.collection":10,"./$.collection-weak":9}],60:[function(e,t,n){(function(e){!function(e){function n(e,t,n,r){return new s(e,t,n||null,r||[])}function r(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}function o(){}function i(){}function s(e,t,n,o){function i(t,o){if(c===w)throw new Error("Generator is already running");if(c===m)return l();for(;;){var i=a.delegate;if(i){var s=r(i.iterator[t],i.iterator,o);if("throw"===s.type){a.delegate=null,t="throw",o=s.arg;continue}t="next",o=d;var u=s.arg;if(!u.done)return c=k,u;a[i.resultName]=u.value,a.next=i.nextLoc,a.delegate=null}if("next"===t){if(c===p&&"undefined"!=typeof o)throw new TypeError("attempt to send "+JSON.stringify(o)+" to newborn generator");c===k?a.sent=o:delete a.sent}else if("throw"===t){if(c===p)throw c=m,o;a.dispatchException(o)&&(t="next",o=d)}else"return"===t&&a.abrupt("return",o);c=w;var s=r(e,n,a);if("normal"===s.type){c=a.done?m:k;var u={value:s.arg,done:a.done};if(s.arg!==b)return u;a.delegate&&"next"===t&&(o=d)}else"throw"===s.type&&(c=m,"next"===t?a.dispatchException(s.arg):o=s.arg)}}var s=t?Object.create(t.prototype):this,a=new u(o),c=p;return s.next=i.bind(s,"next"),s.throw=i.bind(s,"throw"),s.return=i.bind(s,"return"),s}function a(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function c(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function u(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(a,this),this.reset()}function h(e){if(e){var t=e[y];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,r=function t(){for(;++n<e.length;)if(f.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=d,t.done=!0,t};return r.next=r}}return{next:l}}function l(){return{value:d,done:!0}}var d,f=Object.prototype.hasOwnProperty,y="function"==typeof Symbol&&Symbol.iterator||"@@iterator",g="object"==typeof t,v=e.regeneratorRuntime;if(v)return void(g&&(t.exports=v));v=e.regeneratorRuntime=g?t.exports:{},v.wrap=n;var p="suspendedStart",k="suspendedYield",w="executing",m="completed",b={},S=i.prototype=s.prototype;o.prototype=S.constructor=i,i.constructor=o,o.displayName="GeneratorFunction",v.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===o||"GeneratorFunction"===(t.displayName||t.name))},v.mark=function(e){return e.__proto__=i,e.prototype=Object.create(S),e},v.async=function(e,t,o,i){return new Promise(function(s,a){function c(e){var t=r(this,null,e);if("throw"===t.type)return void a(t.arg);var n=t.arg;n.done?s(n.value):Promise.resolve(n.value).then(h,l)}var u=n(e,t,o,i),h=c.bind(u.next),l=c.bind(u.throw);h()})},S[y]=function(){return this},S.toString=function(){return"[object Generator]"},v.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},v.values=h,u.prototype={constructor:u,reset:function(){this.prev=0,this.next=0,this.sent=d,this.done=!1,this.delegate=null,this.tryEntries.forEach(c);for(var e,t=0;f.call(this,e="t"+t)||t<20;++t)this[e]=null},stop:function(){this.done=!0;var e=this.tryEntries[0],t=e.completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){function t(t,r){return i.type="throw",i.arg=e,n.next=t,!!r}if(this.done)throw e;for(var n=this,r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],i=o.completion;if("root"===o.tryLoc)return t("end");if(o.tryLoc<=this.prev){var s=f.call(o,"catchLoc"),a=f.call(o,"finallyLoc");if(s&&a){if(this.prev<o.catchLoc)return t(o.catchLoc,!0);if(this.prev<o.finallyLoc)return t(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return t(o.catchLoc,!0)}else{if(!a)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return t(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&f.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?this.next=o.finallyLoc:this.complete(i),b},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=e.arg,this.next="end"):"normal"===e.type&&t&&(this.next=t),b},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc)}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;c(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:h(e),resultName:t,nextLoc:n},b}}}("object"==typeof e?e:"object"==typeof window?window:this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1]),function(e){e[e.ClosingNormal=1e3]="ClosingNormal",e[e.GoingAway=1001]="GoingAway",e[e.NoSharedSubprotocol=1002]="NoSharedSubprotocol",e[e.PathFull=3e3]="PathFull",e[e.ProtocolError=3001]="ProtocolError",e[e.InternalError=3002]="InternalError",e[e.Handover=3003]="Handover",e[e.DroppedByInitiator=3004]="DroppedByInitiator",e[e.InitiatorCouldNotDecrypt=3005]="InitiatorCouldNotDecrypt",e[e.NoSharedTask=3006]="NoSharedTask"}(e.CloseCode||(e.CloseCode={}));var y=(function(){function e(e){this.value=e}function t(t){function n(e,t){return new Promise(function(n,o){var a={key:e,arg:t,resolve:n,reject:o,next:null};s?s=s.next=a:(i=s=a,r(e,t))})}function r(n,i){try{var s=t[n](i),a=s.value;a instanceof e?Promise.resolve(a.value).then(function(e){r("next",e)},function(e){r("throw",e)}):o(s.done?"return":"normal",s.value)}catch(e){o("throw",e)}}function o(e,t){switch(e){case"return":i.resolve({value:t,done:!0});break;case"throw":i.reject(t);break;default:i.resolve({value:t,done:!1})}i=i.next,i?r(i.key,i.arg):s=null}var i,s;this._invoke=n,"function"!=typeof t.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),g=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),v=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},p=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};r.prototype=Object.create(Error.prototype),r.prototype.name="InternalError",r.prototype.constructor=r;var k=function(e){function t(e,n){y(this,t);var r=p(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n));return r.message=n,r.closeCode=e,r.name="SignalingError",r}return v(t,e),t}(Error),w=function(t){function n(t){return y(this,n),p(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e.CloseCode.ProtocolError,t))}return v(n,t),n}(k),m=function(e){function t(e){y(this,t);var n=p(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.message=e,n.name="ConnectionError",n}return v(t,e),t}(Error),b=function(e){function t(e){y(this,t);var n=p(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.message=e,n.name="ValidationError",n}return v(t,e),t}(Error),S=function(){function e(t,n,r){y(this,e),this._nonce=t,this._nonceLength=r,this._data=n}return g(e,[{key:"toUint8Array",value:function(){var e=new Uint8Array(this.length);return e.set(this._nonce),e.set(this._data,this._nonceLength),e}},{key:"length",get:function(){return this._nonce.length+this._data.length}},{key:"data",get:function(){return this._data}},{key:"nonce",get:function(){return this._nonce}}],[{key:"fromUint8Array",value:function(t,n){if(void 0===n)throw new Error("nonceLength parameter not specified");if(t.byteLength<=n)throw"bad-message-length";var r=t.slice(0,n),o=t.slice(n);return new e(r,o,n)}}]),e}(),T=function(){function e(t,n){if(y(this,e),void 0===t&&void 0===n)this._keyPair=nacl.box.keyPair(),console.debug("KeyStore: New public key:",o(this._keyPair.publicKey));else{if(void 0===t||void 0===n)throw new Error("Either both keys or no keys may be passed in");this._keyPair={publicKey:h(t,"Public key"),secretKey:h(n,"Private key")},console.debug("KeyStore: Restored public key:",o(this._keyPair.publicKey))}}return g(e,[{key:"encrypt",value:function(e,t,n){var r=nacl.box(e,t,n,this._keyPair.secretKey);return new S(t,r,nacl.box.nonceLength)}},{key:"decrypt",value:function(e,t){var n=nacl.box.open(e.data,e.nonce,t,this._keyPair.secretKey);if(n===!1)throw"decryption-failed";return n}},{key:"publicKeyHex",get:function(){return o(this._keyPair.publicKey)}},{key:"publicKeyBytes",get:function(){return this._keyPair.publicKey}},{key:"secretKeyHex",get:function(){return o(this._keyPair.secretKey)}},{key:"secretKeyBytes",get:function(){return this._keyPair.secretKey}},{key:"keypair",get:function(){return this._keyPair}}]),e}(),$=function(){function e(t){if(y(this,e),this._authToken=null,"undefined"==typeof t)this._authToken=nacl.randomBytes(nacl.secretbox.keyLength),console.debug("AuthToken: Generated auth token");else{if(t.byteLength!=nacl.secretbox.keyLength)throw console.error("Auth token must be",nacl.secretbox.keyLength,"bytes long."),"bad-token-length";this._authToken=t,console.debug("AuthToken: Initialized auth token")}}return g(e,[{key:"encrypt",value:function(e,t){var n=nacl.secretbox(e,t,this._authToken);return new S(t,n,nacl.secretbox.nonceLength)}},{key:"decrypt",value:function(e){var t=nacl.secretbox.open(e.data,e.nonce,this._authToken);if(t===!1)throw"decryption-failed";return t}},{key:"keyBytes",get:function(){return this._authToken}},{key:"keyHex",get:function(){return o(this._authToken)}}]),e}(),C=function(){function e(t){if(y(this,e),"undefined"!=typeof t){if(16!==t.length)throw"bad-cookie-length";this.bytes=t}else this.bytes=nacl.randomBytes(e.COOKIE_LENGTH)}return g(e,[{key:"asArrayBuffer",value:function(){return this.bytes.buffer.slice(this.bytes.byteOffset,this.bytes.byteLength)}},{key:"equals",value:function(e){if(e.bytes===this.bytes)return!0;if(null==e.bytes||null==this.bytes)return!1;if(e.bytes.byteLength!=this.bytes.byteLength)return!1;for(var t=0;t<this.bytes.byteLength;t++)if(e.bytes[t]!=this.bytes[t])return!1;return!0}}],[{key:"fromArrayBuffer",value:function(t){return new e(new Uint8Array(t))}}]),e}();C.COOKIE_LENGTH=16;var _=function(){function e(t,n){if(y(this,e),this._ours=null,this._theirs=null,"undefined"!=typeof t&&"undefined"!=typeof n){if(n.equals(t))throw new w("Their cookie matches our cookie");this._ours=t,this._theirs=n}else{if("undefined"!=typeof t||"undefined"!=typeof n)throw new Error("Either both or no cookies must be specified");this._ours=new C}}return g(e,[{key:"ours",get:function(){return this._ours}},{key:"theirs",get:function(){return this._theirs},set:function(e){if(e.equals(this._ours))throw new w("Their cookie matches our cookie");this._theirs=e}}],[{key:"fromTheirs",value:function(t){var n=void 0;do n=new C;while(n.equals(t));return new e(n,t)}}]),e}(),E=function(){function e(t,n,r,o,i){y(this,e),this._cookie=t,this._overflow=n,this._sequenceNumber=r,this._source=o,this._destination=i}return g(e,[{key:"toArrayBuffer",value:function(){var t=new ArrayBuffer(e.TOTAL_LENGTH),n=new Uint8Array(t);n.set(this._cookie.bytes);var r=new DataView(t);return r.setUint8(16,this._source),r.setUint8(17,this._destination),r.setUint16(18,this._overflow),r.setUint32(20,this._sequenceNumber),t}},{key:"cookie",get:function(){return this._cookie}},{key:"overflow",get:function(){return this._overflow}},{key:"sequenceNumber",get:function(){return this._sequenceNumber}},{key:"combinedSequenceNumber",get:function(){return(this._overflow<<32)+this._sequenceNumber}},{key:"source",get:function(){return this._source}},{key:"destination",get:function(){return this._destination}}],[{key:"fromArrayBuffer",value:function(t){if(t.byteLength!=this.TOTAL_LENGTH)throw"bad-packet-length";var n=new DataView(t),r=new C(new Uint8Array(t,0,16)),o=n.getUint8(16),i=n.getUint8(17),s=n.getUint16(18),a=n.getUint32(20);return new e(r,s,a,o,i)}}]),e}();E.TOTAL_LENGTH=24;var P=function(){function e(){y(this,e),this.reset()}return g(e,[{key:"reset",value:function(){this._local=!1,this._peer=!1}},{key:"local",get:function(){return this._local},set:function(e){var t=this.both;this._local=e,!t&&this.both&&void 0!==this.onBoth&&this.onBoth()}},{key:"peer",get:function(){return this._peer},set:function(e){var t=this.both;this._peer=e,!t&&this.both&&void 0!==this.onBoth&&this.onBoth()}},{key:"both",get:function(){return this._local===!0&&this._peer===!0}},{key:"any",get:function(){return this._local===!0||this._peer===!0}}]),e}(),I=function(){function e(){y(this,e),this.sequenceNumber=a(),this.overflow=0}return g(e,[{key:"next",value:function(){if(this.sequenceNumber+1>=e.SEQUENCE_NUMBER_MAX){if(this.sequenceNumber=0,this.overflow+=1,this.overflow>=e.OVERFLOW_MAX)throw console.error("Overflow number just overflowed!"),new Error("overflow-overflow")}else this.sequenceNumber+=1;return{sequenceNumber:this.sequenceNumber,overflow:this.overflow}}}]),e}();I.SEQUENCE_NUMBER_MAX=4294967296,I.OVERFLOW_MAX=1048576;var R=function e(t,n){if(y(this,e),this.ours=null,this.theirs=null,"undefined"!=typeof t&&"undefined"!=typeof n)this.ours=t,this.theirs=n;else{if("undefined"!=typeof t||"undefined"!=typeof n)throw new Error("Either both or no combined sequences must be specified");this.ours=new I}},O=function(){function e(t,n){y(this,e),this._csnPair=new R,this._id=t,void 0===n?this._cookiePair=new _:this._cookiePair=n}return g(e,[{key:"id",get:function(){return this._id}},{key:"hexId",get:function(){return s(this._id)}},{key:"csnPair",get:function(){return this._csnPair}},{key:"cookiePair",get:function(){return this._cookiePair}},{key:"name",get:function(){}}]),e}(),x=function(e){function t(e){y(this,t);var n=p(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.ID));return n.connected=!1,n.handshakeState="new",n.permanentKey=e,n}return v(t,e),g(t,[{key:"name",get:function(){return"Initiator"}}]),t}(O);x.ID=1;var K=function(e){function t(e,n){y(this,t);var r=p(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.keyStore=new T,r.handshakeState="new",r._counter=n,r}return v(t,e),g(t,[{key:"name",get:function(){return"Responder "+this.id}},{key:"counter",get:function(){return this._counter}}]),t}(O),A=function(e){function t(){y(this,t);var e=p(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.ID));return e.handshakeState="new",e}return v(t,e),g(t,[{key:"name",get:function(){return"Server"}}]),t}(O);A.ID=0;var N=function(){function r(o,i,s,a,c,u,h,l){var d=this;y(this,r),this.protocol="wss",this.ws=null,this.msgpackOptions={codec:t.createCodec({binarraybuffer:!0})},this.state="new",this.handoverState=new P,this.task=null,this.server=new A,this.sessionKey=null,this.peerTrustedKey=null,this.authToken=null,this.serverPublicKey=null,this.role=null,this.logTag="Signaling:",this.address=r.SALTYRTC_ADDR_UNKNOWN,this.onOpen=function(e){console.info(d.logTag,"Opened connection"),d.setState("server-handshake")},this.onError=function(e){console.error(d.logTag,"General WebSocket error",e),d.client.emit({type:"connection-error"})},this.onClose=function(t){if(t.code===e.CloseCode.Handover)console.info(d.logTag,"Closed WebSocket connection due to handover");else{console.info(d.logTag,"Closed WebSocket connection"),d.setState("closed"),d.client.emit({type:"connection-closed",data:t.code});var n=function(e){return console.error(d.logTag,"Server closed connection:",e)};switch(t.code){case e.CloseCode.GoingAway:n("Server is being shut down");break;case e.CloseCode.NoSharedSubprotocol:n("No shared sub-protocol could be found");break;case e.CloseCode.PathFull:n("Path full (no free responder byte)");break;case e.CloseCode.ProtocolError:n("Protocol error");break;case e.CloseCode.InternalError:n("Internal server error");break;case e.CloseCode.DroppedByInitiator:n("Dropped by initiator")}}},this.onMessage=function(t){if(console.debug(d.logTag,"New ws message ("+t.data.byteLength+" bytes)"),d.handoverState.peer)return console.error(d.logTag,"Protocol error: Received WebSocket message from peer even though it has already handed over to task."),void d.resetConnection(e.CloseCode.ProtocolError);var r=void 0;try{var o=S.fromUint8Array(new Uint8Array(t.data),E.TOTAL_LENGTH);switch(r=E.fromArrayBuffer(o.nonce.buffer),d.validateNonce(r),d.getState()){case"server-handshake":d.onServerHandshakeMessage(o,r);break;case"peer-handshake":d.onPeerHandshakeMessage(o,r);break;case"task":d.onSignalingMessage(o,r);break;default:console.warn(d.logTag,"Received message in",d.getState(),"signaling state. Ignoring.")}}catch(t){if("SignalingError"===t.name||"ProtocolError"===t.name)switch(console.error(d.logTag,"Signaling error: "+n(t.closeCode)),d.state){case"new":case"ws-connecting":case"server-handshake":d.resetConnection(t.closeCode);break;case"peer-handshake":d.handlePeerHandshakeSignalingError(t,void 0===r?r.id:null);break;case"task":d.sendClose(t.closeCode),d.resetConnection(e.CloseCode.ClosingNormal);break;case"closing":case"closed":}else"ConnectionError"===t.name&&(console.warn(d.logTag,"Connection error. Resetting connection."),d.resetConnection(e.CloseCode.InternalError));throw t.hasOwnProperty("stack")&&(console.error("An unknown error occurred:"),console.error(t.stack)),t}},this.client=o,this.permanentKey=h,this.host=i,this.port=s,this.tasks=c,this.pingInterval=u,void 0!==l&&(this.peerTrustedKey=l),void 0!==a&&(this.serverPublicKey=a),this.handoverState.onBoth=function(){d.client.emit({type:"handover"}),d.ws.close(e.CloseCode.Handover)}}return g(r,[{key:"setState",value:function(e){this.state=e,this.client.emit({type:"state-change",data:e}),this.client.emit({type:"state-change:"+e})}},{key:"getState",value:function(){return this.state}},{key:"msgpackEncode",value:function(e){return t.encode(e,this.msgpackOptions)}},{key:"msgpackDecode",value:function(e){return t.decode(e,this.msgpackOptions)}},{key:"connect",value:function(){this.resetConnection(),this.initWebsocket()}},{key:"disconnect",value:function(){var t=e.CloseCode.ClosingNormal;null!==this.ws&&(console.debug(this.logTag,"Disconnecting WebSocket"),this.ws.close(t)),this.ws=null,null!==this.task&&(console.debug(this.logTag,"Closing task connections"),this.task.close(t)),this.setState("closed")}},{key:"initWebsocket",value:function(){var e=this.protocol+"://"+this.host+":"+this.port+"/",t=this.getWebsocketPath();this.ws=new WebSocket(e+t,r.SALTYRTC_SUBPROTOCOL),this.ws.binaryType="arraybuffer",this.ws.addEventListener("open",this.onOpen),this.ws.addEventListener("error",this.onError),this.ws.addEventListener("close",this.onClose),this.ws.addEventListener("message",this.onMessage),this.setState("ws-connecting"),console.debug(this.logTag,"Opening WebSocket connection to",e+t)}},{key:"onServerHandshakeMessage",value:function(t,n){var r=void 0;r="new"===this.server.handshakeState?t.data:this.permanentKey.decrypt(t,this.server.sessionKey);var o=this.decodeMessage(r,"server handshake");switch(this.server.handshakeState){case"new":if("server-hello"!==o.type)throw new w("Expected server-hello message, but got "+o.type);console.debug(this.logTag,"Received server-hello"),this.handleServerHello(o,n),this.sendClientHello(),this.sendClientAuth();break;case"hello-sent":throw new w("Received "+o.type+" message before sending client-auth");case"auth-sent":if("server-auth"!==o.type)throw new w("Expected server-auth message, but got "+o.type);console.debug(this.logTag,"Received server-auth"),this.handleServerAuth(o,n);break;case"done":throw new k(e.CloseCode.InternalError,"Received server handshake message even though server handshake state is set to 'done'");default:throw new k(e.CloseCode.InternalError,"Unknown server handshake state: "+this.server.handshakeState)}"done"===this.server.handshakeState&&(this.setState("peer-handshake"),console.debug(this.logTag,"Server handshake done"),this.initPeerHandshake())}},{key:"onSignalingMessage",value:function(e,t){if(console.debug("Message received"),t.source===r.SALTYRTC_ADDR_SERVER)this.onSignalingServerMessage(e);else{var n=this.decryptFromPeer(e);this.onSignalingPeerMessage(n)}}},{key:"onSignalingServerMessage",value:function(e){var t=this.decryptServerMessage(e);"send-error"===t.type?this.handleSendError(t):console.warn(this.logTag,"Invalid server message type:",t.type)}},{key:"onSignalingPeerMessage",value:function(e){var t=this.decodeMessage(e);"close"===t.type?(console.debug("Received close"),this.handleClose(t)):"restart"===t.type?(console.debug(this.logTag,"Received restart"),this.handleRestart(t)):null!==this.task&&this.task.getSupportedMessageTypes().indexOf(t.type)!==-1?(console.debug(this.logTag,"Received",t.type,"["+this.task.getName()+"]"),this.task.onTaskMessage(t)):console.warn(this.logTag,"Received message with invalid type from peer:",t.type)}},{key:"handleServerHello",value:function(e,t){this.server.sessionKey=new Uint8Array(e.key),this.server.cookiePair.theirs=t.cookie}},{key:"sendClientAuth",value:function(){var e={type:"client-auth",your_cookie:this.server.cookiePair.theirs.asArrayBuffer(),subprotocols:[r.SALTYRTC_SUBPROTOCOL],ping_interval:this.pingInterval},t=this.buildPacket(e,this.server);console.debug(this.logTag,"Sending client-auth"),this.ws.send(t),this.server.handshakeState="auth-sent"}},{key:"handleRestart",value:function(e){throw new w("Restart messages not yet implemented")}},{key:"handleSendError",value:function(e){var t=new DataView(e.id),n=o(new Uint8Array(e.id)),r=t.getUint8(0),i=t.getUint8(1);if(r!=this.address)throw new w("Received send-error message for a message not sent by us!");console.warn(this.logTag,"SendError: Could not send unknown message:",n),this._handleSendError(i)}},{key:"sendClose",value:function(e){var t={type:"close",reason:e};if(console.debug(this.logTag,"Sending close"),this.handoverState.local===!0)this.task.sendSignalingMessage(this.msgpackEncode(t));else{var n=this.buildPacket(t,this.getPeer());this.ws.send(n)}}},{key:"handleClose",value:function(t){console.warn(this.logTag,"Received close message. Reason:",t.reason,"("+n(t.reason)+")"),this.task.close(t.reason),this.resetConnection(e.CloseCode.GoingAway)}},{key:"validateNonce",value:function(e){this.validateNonceSource(e),this.validateNonceDestination(e),this.validateNonceCsn(e),this.validateNonceCookie(e)}},{key:"validateNonceSource",value:function(e){switch(this.state){case"server-handshake":if(e.source!==r.SALTYRTC_ADDR_SERVER)throw new b("Received message during server handshake with invalid sender address ("+e.source+" != "+r.SALTYRTC_ADDR_SERVER+")");break;case"peer-handshake":if(e.source!==r.SALTYRTC_ADDR_SERVER){if("initiator"===this.role&&!f(e.source))throw new b("Initiator peer message does not come from a valid responder address: "+e.source);if("responder"===this.role&&e.source!=r.SALTYRTC_ADDR_INITIATOR)throw new b("Responder peer message does not come from intitiator ("+r.SALTYRTC_ADDR_INITIATOR+"), but from "+e.source)}break;case"task":if(e.source!==this.getPeer().id)throw new b("Received message after handshake with invalid sender address ("+e.source+" != "+this.getPeer().id+")");break;default:throw new w("Cannot validate message nonce in signaling state "+this.state)}}},{key:"validateNonceDestination",value:function(e){var t=null;if("server-handshake"===this.state)switch(this.server.handshakeState){case"new":case"hello-sent":t=r.SALTYRTC_ADDR_UNKNOWN;break;case"auth-sent":if("initiator"===this.role)t=r.SALTYRTC_ADDR_INITIATOR;else if(!f(e.destination))throw new b("Received message during server handshake with invalid receiver address ("+e.destination+" is not a valid responder id)");break;case"done":t=this.address}else{if("peer-handshake"!==this.state&&"task"!==this.state)throw new b("Cannot validate message nonce in signaling state "+this.state);t=this.address}if(null!==t&&e.destination!==t)throw new b("Received message with invalid destination ("+e.destination+" != "+t+")")}},{key:"validateNonceCsn",value:function(e){var t=this.getPeerWithId(e.source);if(null===t)throw new w("Could not find peer "+e.source);if(null===t.csnPair.theirs){if(0!==e.overflow)throw new b("First message from "+t.name+" must have set the overflow number to 0");t.csnPair.theirs=e.combinedSequenceNumber}else{var n=t.csnPair.theirs,r=e.combinedSequenceNumber;if(r<n)throw new b(t.name+" CSN is lower than last time");if(r===n)throw new b(t.name+" CSN hasn't been incremented");t.csnPair.theirs=r}}},{key:"validateNonceCookie",value:function(e){var t=this.getPeerWithId(e.source);if(null!==t&&null!==t.cookiePair.theirs&&!e.cookie.equals(t.cookiePair.theirs))throw new b(t.name+" cookie changed")}},{key:"validateRepeatedCookie",value:function(e,t){var n=C.fromArrayBuffer(t);if(!n.equals(e.cookiePair.ours))throw console.debug(this.logTag,"Their cookie:",n.bytes),console.debug(this.logTag,"Our cookie:",e.cookiePair.ours.bytes),new w("Peer repeated cookie does not match our cookie")}},{key:"validateSignedKeys",value:function(e,t,n){if(null===e||void 0===e)throw new b("Server did not send signed_keys in server-auth message");var r=new S(new Uint8Array(t.toArrayBuffer()),new Uint8Array(e),nacl.box.nonceLength);console.debug(this.logTag,"Expected server public permanent key is",o(n)),console.debug(this.logTag,"Server public session key is",o(this.server.sessionKey));var i=void 0;try{i=this.permanentKey.decrypt(r,n)}catch(e){if("decryption-failed"===e)throw new b("Could not decrypt signed_keys in server_auth message");throw e}var s=c(this.server.sessionKey,this.permanentKey.publicKeyBytes);if(!l(i,s))throw new b("Decrypted signed_keys in server-auth message is invalid")}},{key:"decodeMessage",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.msgpackDecode(e);if(void 0===r.type)throw new w("Malformed "+t+" message: Failed to decode msgpack data.");if(n&&void 0!==t&&r.type!==t)throw new w("Invalid "+t+" message, bad type: "+r);return r}},{key:"buildPacket",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=void 0;try{o=t.csnPair.ours.next()}catch(e){throw new w("CSN overflow: "+e.message)}var i=new E(t.cookiePair.ours,o.overflow,o.sequenceNumber,this.address,t.id),s=new Uint8Array(i.toArrayBuffer()),a=this.msgpackEncode(e);if(n===!1)return c(s,a);var u=void 0;if(t.id===r.SALTYRTC_ADDR_SERVER)u=this.encryptHandshakeDataForServer(a,s);else{if(t.id!==r.SALTYRTC_ADDR_INITIATOR&&!f(t.id))throw new w("Bad receiver byte: "+t);u=this.encryptHandshakeDataForPeer(t.id,e.type,a,s)}return u.toUint8Array()}},{key:"encryptHandshakeDataForServer",value:function(e,t){return this.permanentKey.encrypt(e,t,this.server.sessionKey)}},{key:"decryptData",value:function(e){var t=this.sessionKey.decrypt(e,this.getPeerSessionKey()),n=t.byteOffset,r=n+t.byteLength;return t.buffer.slice(n,r)}},{key:"resetConnection",value:function(e){null!==this.ws&&(console.debug(this.logTag,"Disconnecting WebSocket (close code "+e+")"),this.ws.close(e)),this.ws=null,this.server=new A,this.handoverState.reset(),this.setState("new"),void 0!==e&&console.debug(this.logTag,"Connection reset")}},{key:"initTask",value:function(e,t){try{e.init(this,t)}catch(e){if("ValidationError"===e.name)throw new w("Peer sent invalid task data");throw e}this.task=e}},{key:"decryptPeerMessage",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];try{var n=this.sessionKey.decrypt(e,this.getPeerSessionKey());return this.decodeMessage(n,"peer")}catch(n){if(t===!0&&"decryption-failed"===n){var r=E.fromArrayBuffer(e.nonce.buffer);throw new w("Could not decrypt peer message from "+s(r.source))}throw n}}},{key:"decryptServerMessage",value:function(e){try{var t=this.permanentKey.decrypt(e,this.server.sessionKey);return this.decodeMessage(t,"server")}catch(e){throw"decryption-failed"===e?new w("Could not decrypt server message"):e}}},{key:"sendTaskMessage",value:function(t){var n=this.getPeer();if(null===n)throw new k(e.CloseCode.InternalError,"No peer address could be found");if(this.handoverState.local===!0)this.task.sendSignalingMessage(this.msgpackEncode(t));else{var r=this.buildPacket(t,n);this.ws.send(r)}}},{key:"encryptForPeer",value:function(e,t){return this.sessionKey.encrypt(e,t,this.getPeerSessionKey());
}},{key:"decryptFromPeer",value:function(t){try{return this.sessionKey.decrypt(t,this.getPeerSessionKey())}catch(t){throw"decryption-failed"===t?("task"===this.state&&this.sendClose(e.CloseCode.InternalError),this.resetConnection(e.CloseCode.InternalError),new k(e.CloseCode.InternalError,"Decryption of peer message failed. This should not happen.")):t}}},{key:"permanentKeyBytes",get:function(){return this.permanentKey.publicKeyBytes}},{key:"authTokenBytes",get:function(){return null!==this.authToken?this.authToken.keyBytes:null}},{key:"peerPermanentKeyBytes",get:function(){return this.getPeerPermanentKey()}}]),r}();N.SALTYRTC_SUBPROTOCOL="v0.saltyrtc.org",N.SALTYRTC_ADDR_UNKNOWN=0,N.SALTYRTC_ADDR_SERVER=0,N.SALTYRTC_ADDR_INITIATOR=1;var D=function(t){function n(e,t,r,o,i,s,a,c){y(this,n);var u=p(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,t,r,o,i,s,a,c));return u.logTag="Initiator:",u.responderCounter=0,u.responders=null,u.responder=null,u.role="initiator",void 0===c&&(u.authToken=new $),u}return v(n,t),g(n,[{key:"getWebsocketPath",value:function(){return this.permanentKey.publicKeyHex}},{key:"encryptHandshakeDataForPeer",value:function(e,t,n,r){if(e===N.SALTYRTC_ADDR_INITIATOR)throw new w("Initiator cannot encrypt messages for initiator");if(!f(e))throw new w("Bad receiver byte: "+e);var o=void 0;if("task"===this.getState())o=this.responder;else{if(!this.responders.has(e))throw new w("Unknown responder: "+e);o=this.responders.get(e)}switch(t){case"key":return this.permanentKey.encrypt(n,r,o.permanentKey);default:return o.keyStore.encrypt(n,r,o.sessionKey)}}},{key:"getPeer",value:function(){return null!==this.responder?this.responder:null}},{key:"getPeerSessionKey",value:function(){return null!==this.responder?this.responder.sessionKey:null}},{key:"getPeerPermanentKey",value:function(){return null!==this.responder?this.responder.permanentKey:null}},{key:"getPeerWithId",value:function(e){if(e===N.SALTYRTC_ADDR_SERVER)return this.server;if(f(e))return"task"===this.state&&null!==this.responder&&this.responder.id===e?this.responder:this.responders.has(e)?this.responders.get(e):null;throw new w("Invalid peer id: "+e)}},{key:"handlePeerHandshakeSignalingError",value:function(e,t){null!==t&&this.dropResponder(t,e.closeCode)}},{key:"processNewResponder",value:function(e){this.responders.has(e)&&this.responders.delete(e);var t=new K(e,this.responderCounter++);null!==this.peerTrustedKey&&(t.handshakeState="token-received",t.permanentKey=this.peerTrustedKey),this.responders.set(e,t),this.responders.size>252&&this.dropOldestInactiveResponder(),this.client.emit({type:"new-responder",data:e})}},{key:"dropOldestInactiveResponder",value:function(){console.warn(this.logTag,"Dropping oldest inactive responder");var t=null,n=!0,r=!1,o=void 0;try{for(var i,s=this.responders.values()[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value;"new"==a.handshakeState&&(null===t?t=a:a.counter<t.counter&&(t=a))}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}null!==t&&this.dropResponder(t.id,e.CloseCode.DroppedByInitiator)}},{key:"onPeerHandshakeMessage",value:function(t,n){if(n.destination!=this.address)throw new w("Message destination does not match our address");var r=void 0;if(n.source===N.SALTYRTC_ADDR_SERVER){r=d(t,this.permanentKey,this.server.sessionKey,"server");var o=this.decodeMessage(r,"server");switch(o.type){case"new-responder":console.debug(this.logTag,"Received new-responder",s(o.id)),this.handleNewResponder(o);break;case"send-error":console.debug(this.logTag,"Received send-error"),this.handleSendError(o);break;default:throw new w("Received unexpected server message: "+o.type)}}else{if(!f(n.source))throw new k(e.CloseCode.InternalError,"Message source is neither the server nor a responder");var i=this.responders.get(n.source);if(null===i)throw new w("Unknown message source: "+n.source);var a=void 0;switch(i.handshakeState){case"new":if(null!==this.peerTrustedKey)throw new k(e.CloseCode.InternalError,'Handshake state is "new" even though a trusted key is available');try{r=this.authToken.decrypt(t)}catch(t){return console.warn(this.logTag,"Could not decrypt token message: ",t),void this.dropResponder(i.id,e.CloseCode.InitiatorCouldNotDecrypt)}a=this.decodeMessage(r,"token",!0),console.debug(this.logTag,"Received token"),this.handleToken(a,i);break;case"token-received":var c=this.peerTrustedKey||i.permanentKey;try{r=this.permanentKey.decrypt(t,c)}catch(t){if(null!==this.peerTrustedKey)return console.warn(this.logTag,"Could not decrypt key message"),void this.dropResponder(i.id,e.CloseCode.InitiatorCouldNotDecrypt);throw t}a=this.decodeMessage(r,"key",!0),console.debug(this.logTag,"Received key"),this.handleKey(a,i),this.sendKey(i);break;case"key-sent":r=d(t,i.keyStore,i.sessionKey,"auth"),a=this.decodeMessage(r,"auth",!0),console.debug(this.logTag,"Received auth"),this.handleAuth(a,i,n),this.sendAuth(i,n),this.responder=this.responders.get(i.id),this.sessionKey=i.keyStore,this.responders.delete(i.id),this.dropResponders(e.CloseCode.DroppedByInitiator),this.setState("task"),console.info(this.logTag,"Peer handshake done"),this.task.onPeerHandshakeDone();break;default:throw new k(e.CloseCode.InternalError,"Unknown responder handshake state")}}}},{key:"sendClientHello",value:function(){}},{key:"handleServerAuth",value:function(e,t){if(this.address=N.SALTYRTC_ADDR_INITIATOR,this.validateRepeatedCookie(this.server,e.your_cookie),null!=this.serverPublicKey)try{this.validateSignedKeys(e.signed_keys,t,this.serverPublicKey)}catch(e){if("ValidationError"===e.name)throw new w("Verification of signed_keys failed: "+e.message);throw e}else null!==e.signed_keys&&void 0!==e.signed_keys&&console.warn(this.logTag,"Server sent signed keys, but we're not verifying them.");this.responders=new Map;var n=!0,r=!1,o=void 0;try{for(var i,s=e.responders[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value;if(!f(a))throw new w("Responder id "+a+" must be in the range 0x02-0xff");this.processNewResponder(a)}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}console.debug(this.logTag,this.responders.size,"responders connected"),this.server.handshakeState="done"}},{key:"initPeerHandshake",value:function(){}},{key:"handleNewResponder",value:function(e){if(!f(e.id))throw new w("Responder id "+e.id+" must be in the range 0x02-0xff");this.processNewResponder(e.id)}},{key:"handleToken",value:function(e,t){t.permanentKey=new Uint8Array(e.key),t.handshakeState="token-received"}},{key:"handleKey",value:function(e,t){t.sessionKey=new Uint8Array(e.key),t.handshakeState="key-received"}},{key:"sendKey",value:function(e){var t={type:"key",key:e.keyStore.publicKeyBytes.buffer},n=this.buildPacket(t,e);console.debug(this.logTag,"Sending key"),this.ws.send(n),e.handshakeState="key-sent"}},{key:"sendAuth",value:function(e,t){if(t.cookie.equals(e.cookiePair.ours))throw new w("Their cookie and our cookie are the same.");var n={};n[this.task.getName()]=this.task.getData();var r={type:"auth",your_cookie:t.cookie.asArrayBuffer(),task:this.task.getName(),data:n},o=this.buildPacket(r,e);console.debug(this.logTag,"Sending auth"),this.ws.send(o),e.handshakeState="auth-sent"}},{key:"handleAuth",value:function(t,r,o){this.validateRepeatedCookie(r,t.your_cookie);try{n.validateTaskInfo(t.tasks,t.data)}catch(e){if("ValidationError"===e.name)throw new w("Peer sent invalid task info: "+e.message);throw e}var i=n.chooseCommonTask(this.tasks,t.tasks);if(null===i)throw new k(e.CloseCode.NoSharedTask,"No shared task could be found");console.log(this.logTag,"Task",i.getName(),"has been selected"),this.initTask(i,t.data[i.getName()]),console.debug(this.logTag,"Responder",r.hexId,"authenticated"),r.cookiePair.theirs=o.cookie,r.handshakeState="auth-received"}},{key:"_handleSendError",value:function(t){if(!f(t))throw new w("Outgoing c2c messages must have been sent to a responder");var n=!1;if(null===this.responder){var r=this.responders.get(t);null===r||void 0===r?console.warn(this.logTag,"Got send-error message for unknown responder",t):(n=!0,this.responders.delete(t))}else this.responder.id===t?(n=!0,this.resetConnection(e.CloseCode.ProtocolError)):console.warn(this.logTag,"Got send-error message for unknown responder",t);n===!0&&this.client.emit({type:"signaling-connection-lost",data:t})}},{key:"dropResponders",value:function(e){console.debug(this.logTag,"Dropping",this.responders.size,"other responders.");var t=!0,n=!1,r=void 0;try{for(var o,i=this.responders.keys()[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var s=o.value;this.dropResponder(s,e)}}catch(e){n=!0,r=e}finally{try{!t&&i.return&&i.return()}finally{if(n)throw r}}}},{key:"dropResponder",value:function(e,t){var n={type:"drop-responder",id:e,reason:t},r=this.buildPacket(n,this.server);console.debug(this.logTag,"Sending drop-responder",s(e)),this.ws.send(r),this.responders.delete(e)}}],[{key:"validateTaskInfo",value:function(e,t){if(e.length<1)throw new b("Task names must not be empty");if(Object.keys(t).length<1)throw new b("Task data must not be empty");if(e.length!=Object.keys(t).length)throw new b("Task data must contain an entry for every task");var n=!0,r=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value;if(!t.hasOwnProperty(a))throw new b("Task data must contain an entry for every task")}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}}},{key:"chooseCommonTask",value:function(e,t){var n=!0,r=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value;if(t.indexOf(a.getName())!==-1)return a}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}return null}}]),n}(N),j=function(t){function n(e,t,r,o,i,s,a,c,u){y(this,n);var h=p(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,t,r,o,i,s,a,void 0===u?c:void 0));return h.logTag="Responder:",h.initiator=null,h.role="responder",h.initiator=new x(c),void 0!==u?h.authToken=u:h.initiator.handshakeState="token-sent",h}return v(n,t),g(n,[{key:"getWebsocketPath",value:function(){return o(this.initiator.permanentKey)}},{key:"encryptHandshakeDataForPeer",value:function(e,t,n,r){if(f(e))throw new w("Responder may not encrypt messages for other responders: "+e);if(e!==N.SALTYRTC_ADDR_INITIATOR)throw new w("Bad receiver byte: "+e);switch(t){case"token":return this.authToken.encrypt(n,r);case"key":return this.permanentKey.encrypt(n,r,this.initiator.permanentKey);default:var o=this.getPeerSessionKey();if(null===o)throw new w("Trying to encrypt for peer using session key, but session key is null");return this.sessionKey.encrypt(n,r,o)}}},{key:"getPeer",value:function(){return null!==this.initiator?this.initiator:null}},{key:"getPeerSessionKey",value:function(){return null!==this.initiator?this.initiator.sessionKey:null}},{key:"getPeerPermanentKey",value:function(){return null!==this.initiator?this.initiator.permanentKey:null}},{key:"getPeerWithId",value:function(e){if(e===N.SALTYRTC_ADDR_SERVER)return this.server;if(e===N.SALTYRTC_ADDR_INITIATOR)return this.initiator;throw new w("Invalid peer id: "+e)}},{key:"handlePeerHandshakeSignalingError",value:function(e,t){this.resetConnection(e.closeCode)}},{key:"onPeerHandshakeMessage",value:function(t,n){if(n.destination!=this.address)throw new w("Message destination does not match our address");var r=void 0;if(n.source===N.SALTYRTC_ADDR_SERVER){r=d(t,this.permanentKey,this.server.sessionKey,"server");var o=this.decodeMessage(r,"server");switch(o.type){case"new-initiator":console.debug(this.logTag,"Received new-initiator"),this.handleNewInitiator(o);break;case"send-error":console.debug(this.logTag,"Received send-error"),this.handleSendError(o);break;default:throw new w("Received unexpected server message: "+o.type)}}else{if(n.source!==N.SALTYRTC_ADDR_INITIATOR)throw new k(e.CloseCode.InternalError,"Message source is neither the server nor the initiator");r=this.decryptInitiatorMessage(t);var i=void 0;switch(this.initiator.handshakeState){case"new":throw new w("Unexpected peer handshake message");case"key-sent":i=this.decodeMessage(r,"key",!0),console.debug(this.logTag,"Received key"),this.handleKey(i),this.sendAuth(n);break;case"auth-sent":i=this.decodeMessage(r,"auth",!0),console.debug(this.logTag,"Received auth"),this.handleAuth(i,n),this.setState("task"),console.info(this.logTag,"Peer handshake done");break;default:throw new k(e.CloseCode.InternalError,"Unknown initiator handshake state")}}}},{key:"decryptInitiatorMessage",value:function(e){switch(this.initiator.handshakeState){case"new":case"token-sent":case"key-received":throw new w("Received message in "+this.initiator.handshakeState+" state.");case"key-sent":return d(e,this.permanentKey,this.initiator.permanentKey,"key");case"auth-sent":case"auth-received":return d(e,this.sessionKey,this.initiator.sessionKey,"initiator session");default:throw new w("Invalid handshake state: "+this.initiator.handshakeState)}}},{key:"sendClientHello",value:function(){var e={type:"client-hello",key:this.permanentKey.publicKeyBytes.buffer},t=this.buildPacket(e,this.server,!1);console.debug(this.logTag,"Sending client-hello"),this.ws.send(t),this.server.handshakeState="hello-sent"}},{key:"handleServerAuth",value:function(e,t){if(t.destination>255||t.destination<2)throw console.error(this.logTag,"Invalid nonce destination:",t.destination),"bad-nonce-destination";if(this.address=t.destination,console.debug(this.logTag,"Server assigned address",s(this.address)),this.logTag="Responder["+s(this.address)+"]:",this.validateRepeatedCookie(this.server,e.your_cookie),null!=this.serverPublicKey)try{this.validateSignedKeys(e.signed_keys,t,this.serverPublicKey)}catch(e){if("ValidationError"===e.name)throw new w("Verification of signed_keys failed: "+e.message);throw e}else null!==e.signed_keys&&void 0!==e.signed_keys&&console.warn(this.logTag,"Server sent signed keys, but we're not verifying them.");this.initiator.connected=e.initiator_connected,console.debug(this.logTag,"Initiator",this.initiator.connected?"":"not","connected"),this.server.handshakeState="done"}},{key:"handleNewInitiator",value:function(e){this.initiator=new x(this.initiator.permanentKey),this.initiator.connected=!0,this.initPeerHandshake()}},{key:"initPeerHandshake",value:function(){this.initiator.connected&&(null===this.peerTrustedKey&&this.sendToken(),this.sendKey())}},{key:"sendToken",value:function(){var e={type:"token",key:this.permanentKey.publicKeyBytes.buffer},t=this.buildPacket(e,this.initiator);console.debug(this.logTag,"Sending token"),this.ws.send(t),this.initiator.handshakeState="token-sent"}},{key:"sendKey",value:function(){this.sessionKey=new T;var e={type:"key",key:this.sessionKey.publicKeyBytes.buffer},t=this.buildPacket(e,this.initiator);console.debug(this.logTag,"Sending key"),this.ws.send(t),this.initiator.handshakeState="key-sent"}},{key:"handleKey",value:function(e){this.initiator.sessionKey=new Uint8Array(e.key),this.initiator.handshakeState="key-received"}},{key:"sendAuth",value:function(e){if(e.cookie.equals(this.initiator.cookiePair.ours))throw new w("Their cookie and our cookie are the same.");var t={},n=!0,r=!1,o=void 0;try{for(var i,s=this.tasks[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value;t[a.getName()]=a.getData()}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}var c=this.tasks.map(function(e){return e.getName()}),u={type:"auth",your_cookie:e.cookie.asArrayBuffer(),tasks:c,data:t},h=this.buildPacket(u,this.initiator);console.debug(this.logTag,"Sending auth"),this.ws.send(h),this.initiator.handshakeState="auth-sent"}},{key:"handleAuth",value:function(t,r){this.validateRepeatedCookie(this.initiator,t.your_cookie);try{n.validateTaskInfo(t.task,t.data)}catch(e){if("ValidationError"===e.name)throw new w("Peer sent invalid task info: "+e.message);throw e}var o=null,i=!0,s=!1,a=void 0;try{for(var c,u=this.tasks[Symbol.iterator]();!(i=(c=u.next()).done);i=!0){var h=c.value;if(h.getName()===t.task){o=h,console.info(this.logTag,"Task",t.task,"has been selected");break}}}catch(e){s=!0,a=e}finally{try{!i&&u.return&&u.return()}finally{if(s)throw a}}if(null===o)throw new k(e.CloseCode.ProtocolError,"Initiator selected unknown task");this.initTask(o,t.data[o.getName()]),console.debug(this.logTag,"Initiator authenticated"),this.initiator.cookiePair.theirs=r.cookie,this.initiator.handshakeState="auth-received"}},{key:"_handleSendError",value:function(t){if(t!=N.SALTYRTC_ADDR_INITIATOR)throw new w("Outgoing c2c messages must have been sent to the initiator");this.client.emit({type:"signaling-connection-lost",data:t}),this.resetConnection(e.CloseCode.ProtocolError)}}],[{key:"validateTaskInfo",value:function(e,t){if(0==e.length)throw new b("Task name must not be empty");if(Object.keys(t).length<1)throw new b("Task data must not be empty");if(Object.keys(t).length>1)throw new b("Task data must contain exactly 1 key");if(!t.hasOwnProperty(e))throw new b("Task data must contain an entry for the chosen task")}}]),n}(N),L=function(){function e(){y(this,e),this.map=new Map}return g(e,[{key:"register",value:function(e,t){if("string"==typeof e)this.set(e,t);else{var n=!0,r=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value;this.set(a,t)}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}}}},{key:"unregister",value:function(e,t){if("string"==typeof e){if(!this.map.has(e))return;if("undefined"==typeof t)this.map.delete(e);else{var n=this.map.get(e),r=n.indexOf(t);r!==-1&&n.splice(r,1)}}else{var o=!0,i=!1,s=void 0;try{for(var a,c=e[Symbol.iterator]();!(o=(a=c.next()).done);o=!0){var u=a.value;this.unregister(u,t)}}catch(e){i=!0,s=e}finally{try{!o&&c.return&&c.return()}finally{if(i)throw s}}}}},{key:"set",value:function(e,t){if(this.map.has(e)){var n=this.map.get(e);n.indexOf(t)===-1&&n.push(t)}else this.map.set(e,[t])}},{key:"get",value:function(e){var t=[];if("string"==typeof e)this.map.has(e)&&t.push.apply(t,this.map.get(e));else{var n=!0,r=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value,c=!0,u=!1,h=void 0;try{for(var l,d=this.get(a)[Symbol.iterator]();!(c=(l=d.next()).done);c=!0){var f=l.value;t.indexOf(f)===-1&&t.push(f)}}catch(e){u=!0,h=e}finally{try{!c&&d.return&&d.return()}finally{if(u)throw h}}}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}}return t}}]),e}(),M=function(){function e(){y(this,e),this.hasConnectionInfo=!1,this.hasKeyStore=!1,this.hasInitiatorInfo=!1,this.hasTrustedPeerKey=!1,this.hasTasks=!1,this.pingInterval=0}return g(e,[{key:"validateHost",value:function(e){if(e.endsWith("/"))throw new Error("SaltyRTC host may not end with a slash");if(e.indexOf("//")!==-1)throw new Error("SaltyRTC host should not contain protocol")}},{key:"requireKeyStore",value:function(){if(!this.hasKeyStore)throw new Error("Keys not set yet. Please call .withKeyStore method first.")}},{key:"requireConnectionInfo",value:function(){if(!this.hasConnectionInfo)throw new Error("Connection info not set yet. Please call .connectTo method first.")}},{key:"requireTasks",value:function(){if(!this.hasTasks)throw new Error("Tasks not set yet. Please call .usingTasks method first.")}},{key:"requireInitiatorInfo",value:function(){if(!this.hasInitiatorInfo)throw new Error("Initiator info not set yet. Please call .initiatorInfo method first.")}},{key:"connectTo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8765;return this.validateHost(e),this.host=e,this.port=t,this.hasConnectionInfo=!0,this}},{key:"withKeyStore",value:function(e){return this.keyStore=e,this.hasKeyStore=!0,this}},{key:"withTrustedPeerKey",value:function(e){return this.peerTrustedKey=h(e,"Peer key"),this.hasTrustedPeerKey=!0,this}},{key:"usingTasks",value:function(e){if(e.length<1)throw new Error("You must specify at least 1 task");return this.tasks=e,this.hasTasks=!0,this}},{key:"withPingInterval",value:function(e){if(e<0)throw new Error("Ping interval may not be negative");return this.pingInterval=e,this}},{key:"withServerKey",value:function(e){return this.serverPublicKey=h(e,"Server public key"),this}},{key:"initiatorInfo",value:function(e,t){return this.initiatorPublicKey=h(e,"Initiator public key"),this.authToken=h(t,"Auth token"),this.hasInitiatorInfo=!0,this}},{key:"asInitiator",value:function(){if(this.requireConnectionInfo(),this.requireKeyStore(),this.requireTasks(),this.hasInitiatorInfo)throw new Error("Cannot initialize as initiator if .initiatorInfo(...) has been used");return this.hasTrustedPeerKey?new F(this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.peerTrustedKey).asInitiator():new F(this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval).asInitiator()}},{key:"asResponder",value:function(){return this.requireConnectionInfo(),this.requireKeyStore(),this.requireTasks(),this.hasTrustedPeerKey?new F(this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.peerTrustedKey).asResponder():(this.requireInitiatorInfo(),new F(this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval).asResponder(this.initiatorPublicKey,this.authToken))}}]),e}(),F=function(){function e(t,n,r,o,i,s,a){if(y(this,e),this.peerTrustedKey=null,this._signaling=null,void 0===t)throw new Error("SaltyRTC must be initialized with a permanent key");if(void 0===n)throw new Error("SaltyRTC must be initialized with a target host");if(void 0===i||0==i.length)throw new Error("SaltyRTC must be initialized with at least 1 task");this.host=n,this.port=r,this.permanentKey=t,this.tasks=i,this.pingInterval=s,void 0!==a&&(this.peerTrustedKey=a),void 0!==o&&(this.serverPublicKey=o),this.eventRegistry=new L}return g(e,[{key:"asInitiator",value:function(){return null!==this.peerTrustedKey?this._signaling=new D(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey,this.peerTrustedKey):this._signaling=new D(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey),this}},{key:"asResponder",value:function(e,t){if(null!==this.peerTrustedKey)this._signaling=new j(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey,this.peerTrustedKey);else{var n=new $(t);this._signaling=new j(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey,e,n)}return this}},{key:"getTask",value:function(){return this.signaling.task}},{key:"connect",value:function(){this.signaling.connect()}},{key:"disconnect",value:function(){this.signaling.disconnect()}},{key:"on",value:function(e,t){this.eventRegistry.register(e,t)}},{key:"once",value:function(e,t){var n=this,r=function e(r){try{t(r)}catch(t){throw n.off(r.type,e),t}n.off(r.type,e)};this.eventRegistry.register(e,r)}},{key:"off",value:function(e,t){this.eventRegistry.unregister(e,t)}},{key:"emit",value:function(e){console.debug("SaltyRTC: New event:",e.type);var t=this.eventRegistry.get(e.type),n=!0,r=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value;try{this.callHandler(a,e)}catch(t){console.error("SaltyRTC: Unhandled exception in",e.type,"handler:",t)}}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}}},{key:"callHandler",value:function(e,t){var n=e(t);n===!1&&this.eventRegistry.unregister(t.type,e)}},{key:"signaling",get:function(){if(null===this._signaling)throw Error("SaltyRTC instance not initialized. Use .asInitiator() or .asResponder().");return this._signaling}},{key:"state",get:function(){return this.signaling.getState()}},{key:"keyStore",get:function(){return this.permanentKey}},{key:"permanentKeyBytes",get:function(){return this.signaling.permanentKeyBytes}},{key:"permanentKeyHex",get:function(){return o(this.signaling.permanentKeyBytes)}},{key:"authTokenBytes",get:function(){return this.signaling.authTokenBytes}},{key:"authTokenHex",get:function(){return o(this.signaling.authTokenBytes)}},{key:"peerPermanentKeyBytes",get:function(){return this.signaling.peerPermanentKeyBytes}},{key:"peerPermanentKeyHex",get:function(){return o(this.signaling.peerPermanentKeyBytes)}}]),e}();e.SaltyRTCBuilder=M,e.KeyStore=T,e.Box=S,e.Cookie=C,e.CookiePair=_,e.CombinedSequence=I,e.CombinedSequencePair=R,e.EventRegistry=L,e.explainCloseCode=n,e.SignalingError=k,e.ConnectionError=m}(this.saltyrtcClient=this.saltyrtcClient||{},msgpack);

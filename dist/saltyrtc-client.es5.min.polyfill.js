/**
 * saltyrtc-client-js v0.14.2
 * SaltyRTC JavaScript implementation
 * https://github.com/saltyrtc/saltyrtc-client-js
 *
 * Copyright (C) 2016-2018 Threema GmbH
 *
 * This software may be modified and distributed under the terms
 * of the MIT license:
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";var saltyrtcClient=function(l,o,u){var e;function i(e){switch(e){case l.CloseCode.ClosingNormal:return"Normal closing";case l.CloseCode.GoingAway:return"The endpoint is going away";case l.CloseCode.NoSharedSubprotocol:return"No shared subprotocol could be found";case l.CloseCode.PathFull:return"No free responder byte";case l.CloseCode.ProtocolError:return"Protocol error";case l.CloseCode.InternalError:return"Internal error";case l.CloseCode.Handover:return"Handover finished";case l.CloseCode.DroppedByInitiator:return"Dropped by initiator";case l.CloseCode.InitiatorCouldNotDecrypt:return"Initiator could not decrypt a message";case l.CloseCode.NoSharedTask:return"No shared task was found";case l.CloseCode.InvalidKey:return"Invalid key";case l.CloseCode.Timeout:return"Timeout";default:return"Unknown"}}!function o(s,a,c){function h(n,e){if(!a[n]){if(!s[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(u)return u(n,!0);var r=new Error("Cannot find module '"+n+"'");throw r.code="MODULE_NOT_FOUND",r}var i=a[n]={exports:{}};s[n][0].call(i.exports,function(e){var t=s[n][1][e];return h(t||e)},i,i.exports,o,s,a,c)}return a[n].exports}for(var u="function"==typeof require&&require,e=0;e<c.length;e++)h(c[e]);return h}({1:[function(t,e,n){(function(e){if(e._babelPolyfill)throw new Error("only one instance of babel/polyfill is allowed");e._babelPolyfill=!0,t("./es6-shim"),t("regenerator-babel/runtime")}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./es6-shim":2,"regenerator-babel/runtime":60}],2:[function(e,t,n){e("core-js/es6"),t.exports=e("core-js/modules/$").core},{"core-js/es6":3,"core-js/modules/$":16}],3:[function(e,t,n){e("../modules/es6.symbol"),e("../modules/es6.object.assign"),e("../modules/es6.object.is"),e("../modules/es6.object.set-prototype-of"),e("../modules/es6.object.to-string"),e("../modules/es6.object.statics-accept-primitives"),e("../modules/es6.function.name"),e("../modules/es6.number.constructor"),e("../modules/es6.number.statics"),e("../modules/es6.math"),e("../modules/es6.string.from-code-point"),e("../modules/es6.string.raw"),e("../modules/es6.string.iterator"),e("../modules/es6.string.code-point-at"),e("../modules/es6.string.ends-with"),e("../modules/es6.string.includes"),e("../modules/es6.string.repeat"),e("../modules/es6.string.starts-with"),e("../modules/es6.array.from"),e("../modules/es6.array.of"),e("../modules/es6.array.species"),e("../modules/es6.array.iterator"),e("../modules/es6.array.copy-within"),e("../modules/es6.array.fill"),e("../modules/es6.array.find"),e("../modules/es6.array.find-index"),e("../modules/es6.regexp"),e("../modules/es6.promise"),e("../modules/es6.map"),e("../modules/es6.set"),e("../modules/es6.weak-map"),e("../modules/es6.weak-set"),e("../modules/es6.reflect"),t.exports=e("../modules/$").core},{"../modules/$":16,"../modules/es6.array.copy-within":27,"../modules/es6.array.fill":28,"../modules/es6.array.find":30,"../modules/es6.array.find-index":29,"../modules/es6.array.from":31,"../modules/es6.array.iterator":32,"../modules/es6.array.of":33,"../modules/es6.array.species":34,"../modules/es6.function.name":35,"../modules/es6.map":36,"../modules/es6.math":37,"../modules/es6.number.constructor":38,"../modules/es6.number.statics":39,"../modules/es6.object.assign":40,"../modules/es6.object.is":41,"../modules/es6.object.set-prototype-of":42,"../modules/es6.object.statics-accept-primitives":43,"../modules/es6.object.to-string":44,"../modules/es6.promise":45,"../modules/es6.reflect":46,"../modules/es6.regexp":47,"../modules/es6.set":48,"../modules/es6.string.code-point-at":49,"../modules/es6.string.ends-with":50,"../modules/es6.string.from-code-point":51,"../modules/es6.string.includes":52,"../modules/es6.string.iterator":53,"../modules/es6.string.raw":54,"../modules/es6.string.repeat":55,"../modules/es6.string.starts-with":56,"../modules/es6.symbol":57,"../modules/es6.weak-map":58,"../modules/es6.weak-set":59}],4:[function(e,t,n){var v=e("./$"),p=e("./$.ctx");t.exports=function(h){var u=1==h,l=2==h,d=3==h,f=4==h,y=6==h,g=5==h||y;return function(e){for(var t,n,r=Object(v.assertDefined(this)),i=v.ES5Object(r),o=p(e,arguments[1],3),s=v.toLength(i.length),a=0,c=u?Array(s):l?[]:void 0;a<s;a++)if((g||a in i)&&(n=o(t=i[a],a,r),h))if(u)c[a]=n;else if(n)switch(h){case 3:return!0;case 5:return t;case 6:return a;case 2:c.push(t)}else if(f)return!1;return y?-1:d||f?f:c}}},{"./$":16,"./$.ctx":11}],5:[function(e,t,n){var r=e("./$");function i(e,t,n){if(!e)throw TypeError(n?t+n:t)}i.def=r.assertDefined,i.fn=function(e){if(!r.isFunction(e))throw TypeError(e+" is not a function!");return e},i.obj=function(e){if(!r.isObject(e))throw TypeError(e+" is not an object!");return e},i.inst=function(e,t,n){if(!(e instanceof t))throw TypeError(n+": use the 'new' operator!");return e},t.exports=i},{"./$":16}],6:[function(e,t,n){var u=e("./$");t.exports=Object.assign||function(e,t){for(var n=Object(u.assertDefined(e)),r=arguments.length,i=1;i<r;)for(var o,s=u.ES5Object(arguments[i++]),a=u.getKeys(s),c=a.length,h=0;h<c;)n[o=a[h++]]=s[o];return n}},{"./$":16}],7:[function(e,t,n){var r=e("./$"),i=e("./$.wks")("toStringTag"),o={}.toString;function s(e){return o.call(e).slice(8,-1)}s.classof=function(e){var t,n;return null==e?void 0===e?"Undefined":"Null":"string"==typeof(n=(t=Object(e))[i])?n:s(t)},s.set=function(e,t,n){e&&!r.has(e=n?e:e.prototype,i)&&r.hide(e,i,t)},t.exports=s},{"./$":16,"./$.wks":26}],8:[function(e,t,n){var s=e("./$"),a=e("./$.ctx"),r=e("./$.uid").safe,c=e("./$.assert"),h=e("./$.iter"),i=s.has,u=s.set,o=s.isObject,l=s.hide,d=h.step,f=Object.isFrozen||s.core.Object.isFrozen,y=r("id"),g=r("O1"),v=r("last"),p=r("first"),k=r("iter"),w=s.DESC?r("size"):"size",m=0;function b(e,t){if(!o(e))return("string"==typeof e?"S":"P")+e;if(f(e))return"F";if(!i(e,y)){if(!t)return"E";l(e,y,++m)}return"O"+e[y]}function S(e,t){var n,r=b(t);if("F"!=r)return e[g][r];for(n=e[p];n;n=n.n)if(n.k==t)return n}t.exports={getConstructor:function(n,r,i){function o(e){var t=c.inst(this,o,n);u(t,g,s.create(null)),u(t,w,0),u(t,v,void 0),u(t,p,void 0),null!=e&&h.forOf(e,r,t[i],t)}return s.mix(o.prototype,{clear:function(){for(var e=this,t=e[g],n=e[p];n;n=n.n)n.r=!0,n.p&&(n.p=n.p.n=void 0),delete t[n.i];e[p]=e[v]=void 0,e[w]=0},delete:function(e){var t=this,n=S(t,e);if(n){var r=n.n,i=n.p;delete t[g][n.i],n.r=!0,i&&(i.n=r),r&&(r.p=i),t[p]==n&&(t[p]=r),t[v]==n&&(t[v]=i),t[w]--}return!!n},forEach:function(e){for(var t,n=a(e,arguments[1],3);t=t?t.n:this[p];)for(n(t.v,t.k,this);t&&t.r;)t=t.p},has:function(e){return!!S(this,e)}}),s.DESC&&s.setDesc(o.prototype,"size",{get:function(){return c.def(this[w])}}),o},def:function(e,t,n){var r,i,o=S(e,t);return o?o.v=n:(e[v]=o={i:i=b(t,!0),k:t,v:n,p:r=e[v],n:void 0,r:!1},e[p]||(e[p]=o),r&&(r.n=o),e[w]++,"F"!=i&&(e[g][i]=o)),e},getEntry:S,getIterConstructor:function(){return function(e,t){u(this,k,{o:e,k:t})}},next:function(){for(var e=this[k],t=e.k,n=e.l;n&&n.r;)n=n.p;return e.o&&(e.l=n=n?n.n:e.o[p])?d(0,"key"==t?n.k:"value"==t?n.v:[n.k,n.v]):(e.o=void 0,d(1))}}},{"./$":16,"./$.assert":5,"./$.ctx":11,"./$.iter":15,"./$.uid":24}],9:[function(e,t,n){var o=e("./$"),r=e("./$.uid").safe,s=e("./$.assert"),a=e("./$.iter").forOf,c=o.has,h=o.isObject,i=o.hide,u=Object.isFrozen||o.core.Object.isFrozen,l=0,d=r("id"),f=r("weak"),y=r("leak"),g=e("./$.array-methods"),v=g(5),p=g(6);function k(e,t){return v.call(e.array,function(e){return e[0]===t})}function w(e){return e[y]||i(e,y,{array:[],get:function(e){var t=k(this,e);if(t)return t[1]},has:function(e){return!!k(this,e)},set:function(e,t){var n=k(this,e);n?n[1]=t:this.array.push([e,t])},delete:function(t){var e=p.call(this.array,function(e){return e[0]===t});return~e&&this.array.splice(e,1),!!~e}})[y]}t.exports={getConstructor:function(t,n,r){function i(e){o.set(s.inst(this,i,t),d,l++),null!=e&&a(e,n,this[r],this)}return o.mix(i.prototype,{delete:function(e){return!!h(e)&&(u(e)?w(this).delete(e):c(e,f)&&c(e[f],this[d])&&delete e[f][this[d]])},has:function(e){return!!h(e)&&(u(e)?w(this).has(e):c(e,f)&&c(e[f],this[d]))}}),i},def:function(e,t,n){return u(s.obj(t))?w(e).set(t,n):(c(t,f)||i(t,f,{}),t[f][e[d]]=n),e},leakStore:w,WEAK:f,ID:d}},{"./$":16,"./$.array-methods":4,"./$.assert":5,"./$.iter":15,"./$.uid":24}],10:[function(y,e,t){var g=y("./$"),v=y("./$.def"),p=y("./$.iter"),k=y("./$.assert").inst;e.exports=function(n,e,t,r,i){var o=g.g[n],s=o,a=r?"set":"add",c=s&&s.prototype,h={};function u(e,r){var i=c[e];g.FW&&(c[e]=function(e,t){var n=i.call(this,0===e?0:e,t);return r?this:n})}if(g.isFunction(s)&&(i||!p.BUGGY&&c.forEach&&c.entries)){var l,d=new s,f=d[a](i?{}:-0,1);(p.fail(function(e){new s(e)})||p.DANGER_CLOSING)&&((s=function(e){k(this,s,n);var t=new o;return null!=e&&p.forOf(e,r,t[a],t),t}).prototype=c,g.FW&&(c.constructor=s)),i||d.forEach(function(e,t){l=1/t==-1/0}),l&&(u("delete"),u("has"),r&&u("get")),(l||f!==d)&&u(a,!0)}else s=t.getConstructor(n,r,a),g.mix(s.prototype,e);return y("./$.cof").set(s,n),y("./$.species")(s),h[n]=s,v(v.G+v.W+v.F*(s!=o),h),i||p.std(s,n,t.getIterConstructor(),t.next,r?"key+value":"value",!r,!0),s}},{"./$":16,"./$.assert":5,"./$.cof":7,"./$.def":12,"./$.iter":15,"./$.species":21}],11:[function(e,t,n){var o=e("./$.assert").fn;t.exports=function(r,i,e){if(o(r),~e&&void 0===i)return r;switch(e){case 1:return function(e){return r.call(i,e)};case 2:return function(e,t){return r.call(i,e,t)};case 3:return function(e,t,n){return r.call(i,e,t,n)}}return function(){return r.apply(i,arguments)}}},{"./$.assert":5}],12:[function(e,t,n){var u=e("./$"),l=u.g,d=u.core,f=u.isFunction;function y(e,t){return function(){return e.apply(t,arguments)}}function g(e,t,n){var r,i,o,s,a=e&g.G,c=a?l:e&g.S?l[t]:(l[t]||{}).prototype,h=a?d:d[t]||(d[t]={});for(r in a&&(n=t),n)o=((i=!(e&g.F)&&c&&r in c)?c:n)[r],s=e&g.B&&i?y(o,l):e&g.P&&f(o)?y(Function.call,o):o,c&&!i&&(a?c[r]=o:delete c[r]&&u.hide(c,r,o)),h[r]!=o&&u.hide(h,r,s)}l.core=d,g.F=1,g.G=2,g.S=4,g.P=8,g.B=16,g.W=32,t.exports=g},{"./$":16}],13:[function(e,t,n){t.exports=function(e){return e.FW=!0,e.path=e.g,e}},{}],14:[function(e,t,n){t.exports=function(e,t,n){var r=void 0===n;switch(t.length){case 0:return r?e():e.call(n);case 1:return r?e(t[0]):e.call(n,t[0]);case 2:return r?e(t[0],t[1]):e.call(n,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(n,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(n,t[0],t[1],t[2],t[3]);case 5:return r?e(t[0],t[1],t[2],t[3],t[4]):e.call(n,t[0],t[1],t[2],t[3],t[4])}return e.apply(n,t)}},{}],15:[function(e,t,n){var f=e("./$"),a=e("./$.ctx"),c=e("./$.cof"),y=e("./$.def"),i=e("./$.assert").obj,h=e("./$.wks")("iterator"),u="@@iterator",l={},r={},g="keys"in[]&&!("next"in[].keys());function d(e,t){f.hide(e,h,t),u in[]&&f.hide(e,u,t)}function v(e,t,n,r){var i=e.prototype,o=i[h]||i[u]||r&&i[r]||n;if(f.FW&&d(i,o),o!==n){var s=f.getProto(o.call(new e));c.set(s,t+" Iterator",!0),f.FW&&f.has(i,u)&&d(s,f.that)}return l[t]=o,l[t+" Iterator"]=f.that,o}function p(e){var t=f.g.Symbol,n=e[t&&t.iterator||u]||e[h]||l[c.classof(e)];return i(n.call(e))}function k(e){var t=e.return;void 0!==t&&i(t.call(e))}function w(t,e,n,r){try{return r?e(i(n)[0],n[1]):e(n)}catch(e){throw k(t),e}}d(r,f.that);var o=!0;!function(){try{[1].keys().return=function(){o=!1}}catch(e){}}();var m=t.exports={BUGGY:g,DANGER_CLOSING:o,fail:function(e){var t=!0;try{var n=[[{},1]],r=n[h](),i=r.next;r.next=function(){return t=!1,i.call(this)},n[h]=function(){return r},e(n)}catch(e){}return t},Iterators:l,prototype:r,step:function(e,t){return{value:t,done:!!e}},stepCall:w,close:k,is:function(e){var t=Object(e),n=f.g.Symbol;return(n&&n.iterator||u)in t||h in t||f.has(l,c.classof(t))},get:p,set:d,create:function(e,t,n,r){e.prototype=f.create(r||m.prototype,{next:f.desc(1,n)}),c.set(e,t+" Iterator")},define:v,std:function(e,t,n,r,i,o,s){function a(e){return function(){return new n(this,e)}}m.create(n,t,r);var c,h,u=a("key+value"),l=a("value"),d=e.prototype;if("value"==i?l=v(e,t,l,"values"):u=v(e,t,u,"entries"),i&&(c={entries:u,keys:o?l:a("key"),values:l},y(y.P+y.F*g,t,c),s))for(h in c)h in d||f.hide(d,h,c[h])},forOf:function(e,t,n,r){for(var i,o=p(e),s=a(n,r,t?2:1);!(i=o.next()).done;)if(!1===w(o,s,i.value,t))return k(o)}}},{"./$":16,"./$.assert":5,"./$.cof":7,"./$.ctx":11,"./$.def":12,"./$.wks":26}],16:[function(e,t,n){var r="undefined"!=typeof self?self:Function("return this")(),i={},o=Object.defineProperty,s={}.hasOwnProperty,a=Math.ceil,c=Math.floor,h=Math.max,u=Math.min,l=!!function(){try{return 2==o({},"a",{get:function(){return 2}}).a}catch(e){}}(),d=v(1);function f(e){return isNaN(e=+e)?0:(0<e?c:a)(e)}function y(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}function g(e,t,n){return e[t]=n,e}function v(r){return l?function(e,t,n){return k.setDesc(e,t,y(r,n))}:g}function p(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}var k=t.exports=e("./$.fw")({g:r,core:i,html:r.document&&document.documentElement,isObject:function(e){return null!==e&&("object"==typeof e||"function"==typeof e)},isFunction:function(e){return"function"==typeof e},it:function(e){return e},that:function(){return this},toInteger:f,toLength:function(e){return 0<e?u(f(e),9007199254740991):0},toIndex:function(e,t){return(e=f(e))<0?h(e+t,0):u(e,t)},has:function(e,t){return s.call(e,t)},create:Object.create,getProto:Object.getPrototypeOf,DESC:l,desc:y,getDesc:Object.getOwnPropertyDescriptor,setDesc:o,getKeys:Object.keys,getNames:Object.getOwnPropertyNames,getSymbols:Object.getOwnPropertySymbols,assertDefined:p,ES5Object:Object,toObject:function(e){return k.ES5Object(p(e))},hide:d,def:v(0),set:r.Symbol?g:d,mix:function(e,t){for(var n in t)d(e,n,t[n]);return e},each:[].forEach});"undefined"!=typeof __e&&(__e=i),"undefined"!=typeof __g&&(__g=r)},{"./$.fw":13}],17:[function(e,t,n){var a=e("./$");t.exports=function(e,t){for(var n,r=a.toObject(e),i=a.getKeys(r),o=i.length,s=0;s<o;)if(r[n=i[s++]]===t)return n}},{"./$":16}],18:[function(e,t,n){var r=e("./$"),i=e("./$.assert").obj;t.exports=function(e){return i(e),r.getSymbols?r.getNames(e).concat(r.getSymbols(e)):r.getNames(e)}},{"./$":16,"./$.assert":5}],19:[function(e,t,n){t.exports=function(t,n,r){var i=n===Object(n)?function(e){return n[e]}:n;return function(e){return String(r?e:this).replace(t,i)}}},{}],20:[function(e,t,n){var i=e("./$"),o=e("./$.assert");t.exports=Object.setPrototypeOf||("__proto__"in{}?function(n,r){try{(r=e("./$.ctx")(Function.call,i.getDesc(Object.prototype,"__proto__").set,2))({},[])}catch(e){n=!0}return function(e,t){return o.obj(e),o(null===t||i.isObject(t),t,": can't set as prototype!"),n?e.__proto__=t:r(e,t),e}}():void 0)},{"./$":16,"./$.assert":5,"./$.ctx":11}],21:[function(t,e,n){var r=t("./$");e.exports=function(e){r.DESC&&r.FW&&r.setDesc(e,t("./$.wks")("species"),{configurable:!0,get:r.that})}},{"./$":16,"./$.wks":26}],22:[function(e,t,n){var a=e("./$");t.exports=function(s){return function(e){var t,n,r=String(a.assertDefined(this)),i=a.toInteger(e),o=r.length;return i<0||o<=i?s?"":void 0:(t=r.charCodeAt(i))<55296||56319<t||i+1===o||(n=r.charCodeAt(i+1))<56320||57343<n?s?r.charAt(i):t:s?r.slice(i,i+2):n-56320+(t-55296<<10)+65536}}},{"./$":16}],23:[function(e,t,n){var r,i,o,s=e("./$"),a=e("./$.ctx"),c=e("./$.cof"),h=e("./$.invoke"),u=s.g,l=s.isFunction,d=u.setImmediate,f=u.clearImmediate,y=u.postMessage,g=u.addEventListener,v=u.MessageChannel,p=0,k={},w="onreadystatechange";function m(){var e=+this;if(s.has(k,e)){var t=k[e];delete k[e],t()}}function b(e){m.call(e.data)}l(d)&&l(f)||(d=function(e){for(var t=[],n=1;arguments.length>n;)t.push(arguments[n++]);return k[++p]=function(){h(l(e)?e:Function(e),t)},r(p),p},f=function(e){delete k[e]},"process"==c(u.process)?r=function(e){u.process.nextTick(a(m,e,1))}:g&&l(y)&&!s.g.importScripts?g("message",b,!(r=function(e){y(e,"*")})):l(v)?(o=(i=new v).port2,i.port1.onmessage=b,r=a(o.postMessage,o,1)):r=s.g.document&&w in document.createElement("script")?function(e){s.html.appendChild(document.createElement("script"))[w]=function(){s.html.removeChild(this),m.call(e)}}:function(e){setTimeout(a(m,e,1),0)}),t.exports={set:d,clear:f}},{"./$":16,"./$.cof":7,"./$.ctx":11,"./$.invoke":14}],24:[function(e,t,n){var r=0;function i(e){return"Symbol("+e+")_"+(++r+Math.random()).toString(36)}i.safe=e("./$").g.Symbol||i,t.exports=i},{"./$":16}],25:[function(e,t,n){var r=e("./$"),i=e("./$.wks")("unscopables");!r.FW||i in[]||r.hide(Array.prototype,i,{}),t.exports=function(e){r.FW&&([][i][e]=!0)}},{"./$":16,"./$.wks":26}],26:[function(t,e,n){var r=t("./$").g,i={};e.exports=function(e){return i[e]||(i[e]=r.Symbol&&r.Symbol[e]||t("./$.uid").safe("Symbol."+e))}},{"./$":16,"./$.uid":24}],27:[function(e,t,n){var u=e("./$"),r=e("./$.def"),l=u.toIndex;r(r.P,"Array",{copyWithin:function(e,t){var n=Object(u.assertDefined(this)),r=u.toLength(n.length),i=l(e,r),o=l(t,r),s=arguments[2],a=void 0===s?r:l(s,r),c=Math.min(a-o,r-i),h=1;for(o<i&&i<o+c&&(h=-1,o=o+c-1,i=i+c-1);0<c--;)o in n?n[i]=n[o]:delete n[i],i+=h,o+=h;return n}}),e("./$.unscope")("copyWithin")},{"./$":16,"./$.def":12,"./$.unscope":25}],28:[function(e,t,n){var s=e("./$"),r=e("./$.def"),a=s.toIndex;r(r.P,"Array",{fill:function(e){for(var t=Object(s.assertDefined(this)),n=s.toLength(t.length),r=a(arguments[1],n),i=arguments[2],o=void 0===i?n:a(i,n);r<o;)t[r++]=e;return t}}),e("./$.unscope")("fill")},{"./$":16,"./$.def":12,"./$.unscope":25}],29:[function(e,t,n){var r=e("./$.def");r(r.P,"Array",{findIndex:e("./$.array-methods")(6)}),e("./$.unscope")("findIndex")},{"./$.array-methods":4,"./$.def":12,"./$.unscope":25}],30:[function(e,t,n){var r=e("./$.def");r(r.P,"Array",{find:e("./$.array-methods")(5)}),e("./$.unscope")("find")},{"./$.array-methods":4,"./$.def":12,"./$.unscope":25}],31:[function(e,t,n){var u=e("./$"),l=e("./$.ctx"),r=e("./$.def"),d=e("./$.iter"),f=d.stepCall;r(r.S+r.F*d.DANGER_CLOSING,"Array",{from:function(e){var t,n,r,i,o=Object(u.assertDefined(e)),s=arguments[1],a=void 0!==s,c=a?l(s,arguments[2],2):void 0,h=0;if(d.is(o))for(i=d.get(o),n=new("function"==typeof this?this:Array);!(r=i.next()).done;h++)n[h]=a?f(i,c,[r.value,h],!0):r.value;else for(n=new("function"==typeof this?this:Array)(t=u.toLength(o.length));h<t;h++)n[h]=a?c(o[h],h):o[h];return n.length=h,n}})},{"./$":16,"./$.ctx":11,"./$.def":12,"./$.iter":15}],32:[function(e,t,n){var r=e("./$"),i=e("./$.unscope"),o=e("./$.uid").safe("iter"),s=e("./$.iter"),a=s.step,c=s.Iterators;s.std(Array,"Array",function(e,t){r.set(this,o,{o:r.toObject(e),i:0,k:t})},function(){var e=this[o],t=e.o,n=e.k,r=e.i++;return!t||r>=t.length?(e.o=void 0,a(1)):a(0,"key"==n?r:"value"==n?t[r]:[r,t[r]])},"value"),c.Arguments=c.Array,i("keys"),i("values"),i("entries")},{"./$":16,"./$.iter":15,"./$.uid":24,"./$.unscope":25}],33:[function(e,t,n){var r=e("./$.def");r(r.S,"Array",{of:function(){for(var e=0,t=arguments.length,n=new("function"==typeof this?this:Array)(t);e<t;)n[e]=arguments[e++];return n.length=t,n}})},{"./$.def":12}],34:[function(e,t,n){e("./$.species")(Array)},{"./$.species":21}],35:[function(e,t,n){var r=e("./$"),i="name",o=r.setDesc,s=Function.prototype;i in s||r.FW&&r.DESC&&o(s,i,{configurable:!0,get:function(){var e=String(this).match(/^\s*function ([^ (]*)/),t=e?e[1]:"";return r.has(this,i)||o(this,i,r.desc(5,t)),t},set:function(e){r.has(this,i)||o(this,i,r.desc(0,e))}})},{"./$":16}],36:[function(e,t,n){var r=e("./$.collection-strong");e("./$.collection")("Map",{get:function(e){var t=r.getEntry(this,e);return t&&t.v},set:function(e,t){return r.def(this,0===e?0:e,t)}},r,!0)},{"./$.collection":10,"./$.collection-strong":8}],37:[function(e,t,n){var r=e("./$.def"),i=Math.E,c=Math.pow,o=Math.abs,s=Math.exp,a=Math.log,h=Math.sqrt,u=Math.ceil,l=Math.floor,d=Math.sign||function(e){return 0==(e=+e)||e!=e?e:e<0?-1:1};function f(e){return 0==(e=+e)?e:-1e-6<e&&e<1e-6?e+e*e/2:s(e)-1}r(r.S,"Math",{acosh:function(e){return(e=+e)<1?NaN:isFinite(e)?a(e/i+h(e+1)*h(e-1)/i)+1:e},asinh:function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):a(t+h(t*t+1)):t},atanh:function(e){return 0==(e=+e)?e:a((1+e)/(1-e))/2},cbrt:function(e){return d(e=+e)*c(o(e),1/3)},clz32:function(e){return(e>>>=0)?32-e.toString(2).length:32},cosh:function(e){return(s(e=+e)+s(-e))/2},expm1:f,fround:function(e){return new Float32Array([e])[0]},hypot:function(e,t){for(var n,r=0,i=arguments.length,o=i,s=Array(i),a=-1/0;i--;){if((n=s[i]=+arguments[i])==1/0||n==-1/0)return 1/0;a<n&&(a=n)}for(a=n||1;o--;)r+=c(s[o]/a,2);return a*h(r)},imul:function(e,t){var n=65535,r=+e,i=+t,o=n&r,s=n&i;return 0|o*s+((n&r>>>16)*s+o*(n&i>>>16)<<16>>>0)},log1p:function(e){return-1e-8<(e=+e)&&e<1e-8?e-e*e/2:a(1+e)},log10:function(e){return a(e)/Math.LN10},log2:function(e){return a(e)/Math.LN2},sign:d,sinh:function(e){return o(e=+e)<1?(f(e)-f(-e))/2:(s(e-1)-s(-e-1))*(i/2)},tanh:function(e){var t=f(e=+e),n=f(-e);return t==1/0?1:n==1/0?-1:(t-n)/(s(e)+s(-e))},trunc:function(e){return(0<e?l:u)(e)}})},{"./$.def":12}],38:[function(e,t,n){var r=e("./$"),i=r.isObject,o=r.isFunction,s=r.g.Number,a=s,c=s.prototype;function h(e){if(i(e)&&(e=function(e){var t,n;if(o(t=e.valueOf)&&!i(n=t.call(e)))return n;if(o(t=e.toString)&&!i(n=t.call(e)))return n;throw TypeError("Can't convert object to number")}(e)),"string"==typeof e&&2<e.length&&48==e.charCodeAt(0)){var t=!1;switch(e.charCodeAt(1)){case 66:case 98:t=!0;case 79:case 111:return parseInt(e.slice(2),t?2:8)}}return+e}!r.FW||s("0o1")&&s("0b1")||(s=function e(t){return this instanceof e?new a(h(t)):h(t)},r.each.call(r.DESC?r.getNames(a):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),function(e){r.has(a,e)&&!r.has(s,e)&&r.setDesc(s,e,r.getDesc(a,e))}),(s.prototype=c).constructor=s,r.hide(r.g,"Number",s))},{"./$":16}],39:[function(e,t,n){var r=e("./$"),i=e("./$.def"),o=Math.abs,s=Math.floor,a=9007199254740991;function c(e){return!r.isObject(e)&&isFinite(e)&&s(e)===e}i(i.S,"Number",{EPSILON:Math.pow(2,-52),isFinite:function(e){return"number"==typeof e&&isFinite(e)},isInteger:c,isNaN:function(e){return e!=e},isSafeInteger:function(e){return c(e)&&o(e)<=a},MAX_SAFE_INTEGER:a,MIN_SAFE_INTEGER:-a,parseFloat:parseFloat,parseInt:parseInt})},{"./$":16,"./$.def":12}],40:[function(e,t,n){var r=e("./$.def");r(r.S,"Object",{assign:e("./$.assign")})},{"./$.assign":6,"./$.def":12}],41:[function(e,t,n){var r=e("./$.def");r(r.S,"Object",{is:function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}})},{"./$.def":12}],42:[function(e,t,n){var r=e("./$.def");r(r.S,"Object",{setPrototypeOf:e("./$.set-proto")})},{"./$.def":12,"./$.set-proto":20}],43:[function(e,t,n){var o=e("./$"),s=e("./$.def"),a=o.isObject,c=o.toObject;function r(e,t){var n=(o.core.Object||{})[e]||Object[e],r=0,i={};i[e]=1==t?function(e){return a(e)?n(e):e}:2==t?function(e){return!a(e)||n(e)}:3==t?function(e){return!!a(e)&&n(e)}:4==t?function(e,t){return n(c(e),t)}:5==t?function(e){return n(Object(o.assertDefined(e)))}:function(e){return n(c(e))};try{n("z")}catch(e){r=1}s(s.S+s.F*r,"Object",i)}r("freeze",1),r("seal",1),r("preventExtensions",1),r("isFrozen",2),r("isSealed",2),r("isExtensible",3),r("getOwnPropertyDescriptor",4),r("getPrototypeOf",5),r("keys"),r("getOwnPropertyNames")},{"./$":16,"./$.def":12}],44:[function(e,t,n){var r=e("./$"),i=e("./$.cof"),o={};o[e("./$.wks")("toStringTag")]="z",r.FW&&"z"!=i(o)&&r.hide(Object.prototype,"toString",function(){return"[object "+i.classof(this)+"]"})},{"./$":16,"./$.cof":7,"./$.wks":26}],45:[function(e,t,n){var r,h=e("./$"),u=e("./$.ctx"),l=e("./$.cof"),i=e("./$.def"),d=e("./$.assert"),o=e("./$.iter"),f=e("./$.wks")("species"),y=e("./$.uid").safe("record"),a=o.forOf,g="Promise",v=h.g,p=v.process,k=p&&p.nextTick||e("./$.task").set,w=v[g],s=w,m=h.isFunction,b=h.isObject,S=d.fn,T=d.obj;function c(e){var t=T(e)[f];return null!=t?t:e}m(w)&&m(w.resolve)&&w.resolve(r=new w(function(){}))==r||function(){function a(e){var t;return b(e)&&(t=e.then),!!m(t)&&t}function c(e){var t,n=e[y],r=n.c,i=0;if(n.h)return!0;for(;r.length>i;)if((t=r[i++]).fail||c(t.P))return!0}function s(s,n){var r=s.c;(n||r.length)&&k(function(){var e=s.p,i=s.v,o=1==s.s,t=0;if(n&&!c(e))setTimeout(function(){c(e)||("process"==l(p)?p.emit("unhandledRejection",i,e):v.console&&m(console.error)&&console.error("Unhandled promise rejection",i))},1e3);else for(;r.length>t;)!function(t){var e,n,r=o?t.ok:t.fail;try{r?(o||(s.h=!0),(e=!0===r?i:r(i))===t.P?t.rej(TypeError(g+"-chain cycle")):(n=a(e))?n.call(e,t.res,t.rej):t.res(e)):t.rej(i)}catch(e){t.rej(e)}}(r[t++]);r.length=0})}function i(e){var t=this;t.d||(t.d=!0,(t=t.r||t).v=e,t.s=2,s(t,!0))}function o(e){var t,n,r=this;if(!r.d){r.d=!0,r=r.r||r;try{(t=a(e))?(n={r:r,d:!1},t.call(e,u(o,n,1),u(i,n,1))):(r.v=e,r.s=1,s(r))}catch(e){i.call(n||{r:r,d:!1},e)}}}w=function(e){S(e);var t={p:d.inst(this,w,g),c:[],s:0,d:!1,v:void 0,h:!1};h.hide(this,y,t);try{e(u(o,t,1),u(i,t,1))}catch(e){i.call(t,e)}},h.mix(w.prototype,{then:function(e,t){var n=T(T(this).constructor)[f],r={ok:!m(e)||e,fail:!!m(t)&&t},i=r.P=new(null!=n?n:w)(function(e,t){r.res=S(e),r.rej=S(t)}),o=this[y];return o.c.push(r),o.s&&s(o),i},catch:function(e){return this.then(void 0,e)}})}(),i(i.G+i.W+i.F*(w!=s),{Promise:w}),i(i.S,g,{reject:function(n){return new(c(this))(function(e,t){t(n)})},resolve:function(t){return b(t)&&y in t&&h.getProto(t)===this.prototype?t:new(c(this))(function(e){e(t)})}}),i(i.S+i.F*(o.fail(function(e){w.all(e).catch(function(){})})||o.DANGER_CLOSING),g,{all:function(e){var s=c(this),t=[];return new s(function(n,r){a(e,!1,t.push,t);var i=t.length,o=Array(i);i?h.each.call(t,function(e,t){s.resolve(e).then(function(e){o[t]=e,--i||n(o)},r)}):n(o)})},race:function(e){var r=c(this);return new r(function(t,n){a(e,!1,function(e){r.resolve(e).then(t,n)})})}}),l.set(w,g),e("./$.species")(w)},{"./$":16,"./$.assert":5,"./$.cof":7,"./$.ctx":11,"./$.def":12,"./$.iter":15,"./$.species":21,"./$.task":23,"./$.uid":24,"./$.wks":26}],46:[function(e,t,n){var c=e("./$"),r=e("./$.def"),i=e("./$.set-proto"),o=e("./$.iter"),s=e("./$.uid").safe("iter"),a=o.step,h=e("./$.assert"),u=c.isObject,l=c.getDesc,d=c.setDesc,f=c.getProto,y=Function.apply,g=h.obj,v=Object.isExtensible||c.it;function p(e){var t,n=[];for(t in e)n.push(t);c.set(this,s,{o:e,a:n,i:0})}function k(t){return function(e){g(e);try{return t.apply(void 0,arguments),!0}catch(e){return!1}}}o.create(p,"Object",function(){var e,t=this[s],n=t.a;do{if(t.i>=n.length)return a(1)}while(!((e=n[t.i++])in t.o));return a(0,e)});var w={apply:e("./$.ctx")(Function.call,y,3),construct:function(e,t){var n=h.fn(arguments.length<3?e:arguments[2]).prototype,r=c.create(u(n)?n:Object.prototype),i=y.call(e,r,t);return u(i)?i:r},defineProperty:k(d),deleteProperty:function(e,t){var n=l(g(e),t);return!(n&&!n.configurable)&&delete e[t]},enumerate:function(e){return new p(g(e))},get:function e(t,n){var r,i=arguments.length<3?t:arguments[2],o=l(g(t),n);return o?c.has(o,"value")?o.value:void 0===o.get?void 0:o.get.call(i):u(r=f(t))?e(r,n,i):void 0},getOwnPropertyDescriptor:function(e,t){return l(g(e),t)},getPrototypeOf:function(e){return f(g(e))},has:function(e,t){return t in e},isExtensible:function(e){return!!v(g(e))},ownKeys:e("./$.own-keys"),preventExtensions:k(Object.preventExtensions||c.it),set:function e(t,n,r){var i,o,s=arguments.length<4?t:arguments[3],a=l(g(t),n);if(!a){if(u(o=f(t)))return e(o,n,r,s);a=c.desc(0)}return c.has(a,"value")?!(!1===a.writable||!u(s)||((i=l(s,n)||c.desc(0)).value=r,d(s,n,i),0)):void 0!==a.set&&(a.set.call(s,r),!0)}};i&&(w.setPrototypeOf=function(e,t){return i(g(e),t),!0}),r(r.G,{Reflect:{}}),r(r.S,"Reflect",w)},{"./$":16,"./$.assert":5,"./$.ctx":11,"./$.def":12,"./$.iter":15,"./$.own-keys":18,"./$.set-proto":20,"./$.uid":24}],47:[function(e,t,n){var r=e("./$"),i=e("./$.cof"),o=r.g.RegExp,s=o,a=o.prototype;r.FW&&r.DESC&&(function(){try{return"/a/i"==o(/a/g,"i")}catch(e){}}()||(o=function(e,t){return new s("RegExp"==i(e)&&void 0!==t?e.source:e,t)},r.each.call(r.getNames(s),function(t){t in o||r.setDesc(o,t,{configurable:!0,get:function(){return s[t]},set:function(e){s[t]=e}})}),(a.constructor=o).prototype=a,r.hide(r.g,"RegExp",o)),"g"!=/./g.flags&&r.setDesc(a,"flags",{configurable:!0,get:e("./$.replacer")(/^.*\/(\w*)$/,"$1")})),e("./$.species")(o)},{"./$":16,"./$.cof":7,"./$.replacer":19,"./$.species":21}],48:[function(e,t,n){var r=e("./$.collection-strong");e("./$.collection")("Set",{add:function(e){return r.def(this,e=0===e?0:e,e)}},r)},{"./$.collection":10,"./$.collection-strong":8}],49:[function(e,t,n){var r=e("./$.def");r(r.P,"String",{codePointAt:e("./$.string-at")(!1)})},{"./$.def":12,"./$.string-at":22}],50:[function(e,t,n){var o=e("./$"),s=e("./$.cof"),r=e("./$.def"),a=o.toLength;r(r.P,"String",{endsWith:function(e){if("RegExp"==s(e))throw TypeError();var t=String(o.assertDefined(this)),n=arguments[1],r=a(t.length),i=void 0===n?r:Math.min(a(n),r);return e+="",t.slice(i-e.length,i)===e}})},{"./$":16,"./$.cof":7,"./$.def":12}],51:[function(e,t,n){var r=e("./$.def"),o=e("./$").toIndex,s=String.fromCharCode;r(r.S,"String",{fromCodePoint:function(e){for(var t,n=[],r=arguments.length,i=0;i<r;){if(t=+arguments[i++],o(t,1114111)!==t)throw RangeError(t+" is not a valid code point");n.push(t<65536?s(t):s(55296+((t-=65536)>>10),t%1024+56320))}return n.join("")}})},{"./$":16,"./$.def":12}],52:[function(e,t,n){var r=e("./$"),i=e("./$.cof"),o=e("./$.def");o(o.P,"String",{includes:function(e){if("RegExp"==i(e))throw TypeError();return!!~String(r.assertDefined(this)).indexOf(e,arguments[1])}})},{"./$":16,"./$.cof":7,"./$.def":12}],53:[function(e,t,n){var r=e("./$").set,i=e("./$.string-at")(!0),o=e("./$.uid").safe("iter"),s=e("./$.iter"),a=s.step;s.std(String,"String",function(e){r(this,o,{o:String(e),i:0})},function(){var e,t=this[o],n=t.o,r=t.i;return r>=n.length?a(1):(e=i.call(n,r),t.i+=e.length,a(0,e))})},{"./$":16,"./$.iter":15,"./$.string-at":22,"./$.uid":24}],54:[function(e,t,n){var s=e("./$"),r=e("./$.def");r(r.S,"String",{raw:function(e){for(var t=s.toObject(e.raw),n=s.toLength(t.length),r=arguments.length,i=[],o=0;o<n;)i.push(String(t[o++])),o<r&&i.push(String(arguments[o]));return i.join("")}})},{"./$":16,"./$.def":12}],55:[function(e,t,n){var i=e("./$"),r=e("./$.def");r(r.P,"String",{repeat:function(e){var t=String(i.assertDefined(this)),n="",r=i.toInteger(e);if(r<0||r==1/0)throw RangeError("Count can't be negative");for(;0<r;(r>>>=1)&&(t+=t))1&r&&(n+=t);return n}})},{"./$":16,"./$.def":12}],56:[function(e,t,n){var r=e("./$"),i=e("./$.cof"),o=e("./$.def");o(o.P,"String",{startsWith:function(e){if("RegExp"==i(e))throw TypeError();var t=String(r.assertDefined(this)),n=r.toLength(Math.min(arguments[1],t.length));return e+="",t.slice(n,n+e.length)===e}})},{"./$":16,"./$.cof":7,"./$.def":12}],57:[function(n,e,t){var r=n("./$"),i=n("./$.cof").set,o=n("./$.uid"),s=n("./$.def"),a=n("./$.keyof"),c=r.has,h=r.hide,u=r.getNames,l=r.toObject,d=r.g.Symbol,f=d,y=!1,g=o.safe("tag"),v={},p={};function k(t){var e=p[t]=r.set(r.create(d.prototype),g,t);return r.DESC&&y&&r.setDesc(Object.prototype,t,{configurable:!0,set:function(e){h(this,t,e)}}),e}r.isFunction(d)||h((d=function(e){if(this instanceof d)throw TypeError("Symbol is not a constructor");return k(o(e))}).prototype,"toString",function(){return this[g]}),s(s.G+s.W,{Symbol:d});var w={for:function(e){return c(v,e+="")?v[e]:v[e]=d(e)},keyFor:function(e){return a(v,e)},pure:o.safe,set:r.set,useSetter:function(){y=!0},useSimple:function(){y=!1}};r.each.call("hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),function(e){var t=n("./$.wks")(e);w[e]=d===f?t:k(t)}),y=!0,s(s.S,"Symbol",w),s(s.S+s.F*(d!=f),"Object",{getOwnPropertyNames:function(e){for(var t,n=u(l(e)),r=[],i=0;n.length>i;)c(p,t=n[i++])||r.push(t);return r},getOwnPropertySymbols:function(e){for(var t,n=u(l(e)),r=[],i=0;n.length>i;)c(p,t=n[i++])&&r.push(p[t]);return r}}),i(d,"Symbol"),i(Math,"Math",!0),i(r.g.JSON,"JSON",!0)},{"./$":16,"./$.cof":7,"./$.def":12,"./$.keyof":17,"./$.uid":24,"./$.wks":26}],58:[function(e,t,n){var r=e("./$"),i=e("./$.collection-weak"),o=i.leakStore,s=i.ID,a=i.WEAK,c=r.has,h=r.isObject,u=Object.isFrozen||r.core.Object.isFrozen,l={},d=e("./$.collection")("WeakMap",{get:function(e){if(h(e)){if(u(e))return o(this).get(e);if(c(e,a))return e[a][this[s]]}},set:function(e,t){return i.def(this,e,t)}},i,!0,!0);r.FW&&7!=(new d).set((Object.freeze||Object)(l),7).get(l)&&r.each.call(["delete","has","get","set"],function(r){var i=d.prototype[r];d.prototype[r]=function(e,t){if(h(e)&&u(e)){var n=o(this)[r](e,t);return"set"==r?this:n}return i.call(this,e,t)}})},{"./$":16,"./$.collection":10,"./$.collection-weak":9}],59:[function(e,t,n){var r=e("./$.collection-weak");e("./$.collection")("WeakSet",{add:function(e){return r.def(this,e,!0)}},r,!1,!0)},{"./$.collection":10,"./$.collection-weak":9}],60:[function(e,S,t){(function(e){!function(e){var h,c=Object.prototype.hasOwnProperty,i="function"==typeof Symbol&&Symbol.iterator||"@@iterator",t="object"==typeof S,n=e.regeneratorRuntime;if(n)t&&(S.exports=n);else{(n=e.regeneratorRuntime=t?S.exports:{}).wrap=g;var u="suspendedStart",l="suspendedYield",d="executing",f="completed",y={},r=s.prototype=a.prototype;o.prototype=r.constructor=s,(s.constructor=o).displayName="GeneratorFunction",n.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===o||"GeneratorFunction"===(t.displayName||t.name))},n.mark=function(e){return e.__proto__=s,e.prototype=Object.create(r),e},n.async=function(n,a,c,h){return new Promise(function(r,i){var e=g(n,a,c,h),o=t.bind(e.next),s=t.bind(e.throw);function t(e){var t=v(this,null,e);if("throw"!==t.type){var n=t.arg;n.done?r(n.value):Promise.resolve(n.value).then(o,s)}else i(t.arg)}o()})},r[i]=function(){return this},r.toString=function(){return"[object Generator]"},n.keys=function(n){var r=[];for(var e in n)r.push(e);return r.reverse(),function e(){for(;r.length;){var t=r.pop();if(t in n)return e.value=t,e.done=!1,e}return e.done=!0,e}},n.values=m,w.prototype={constructor:w,reset:function(){this.prev=0,this.next=0,this.sent=h,this.done=!1,this.delegate=null,this.tryEntries.forEach(k);for(var e,t=0;c.call(this,e="t"+t)||t<20;++t)this[e]=null},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(n){if(this.done)throw n;var r=this;function e(e,t){return o.type="throw",o.arg=n,r.next=e,!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var i=this.tryEntries[t],o=i.completion;if("root"===i.tryLoc)return e("end");if(i.tryLoc<=this.prev){var s=c.call(i,"catchLoc"),a=c.call(i,"finallyLoc");if(s&&a){if(this.prev<i.catchLoc)return e(i.catchLoc,!0);if(this.prev<i.finallyLoc)return e(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return e(i.catchLoc,!0)}else{if(!a)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return e(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;0<=n;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&c.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?this.next=i.finallyLoc:this.complete(o),y},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=e.arg,this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc)}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;k(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:m(e),resultName:t,nextLoc:n},y}}}function g(e,t,n,r){return new a(e,t,n||null,r||[])}function v(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}function o(){}function s(){}function a(o,e,s,t){var n=e?Object.create(e.prototype):this,a=new w(t),c=u;function r(e,t){if(c===d)throw new Error("Generator is already running");if(c===f)return b();for(;;){var n=a.delegate;if(n){var r;if("throw"===(r=v(n.iterator[e],n.iterator,t)).type){a.delegate=null,e="throw",t=r.arg;continue}if(e="next",t=h,!(i=r.arg).done)return c=l,i;a[n.resultName]=i.value,a.next=n.nextLoc,a.delegate=null}if("next"===e){if(c===u&&void 0!==t)throw new TypeError("attempt to send "+JSON.stringify(t)+" to newborn generator");c===l?a.sent=t:delete a.sent}else if("throw"===e){if(c===u)throw c=f,t;a.dispatchException(t)&&(e="next",t=h)}else"return"===e&&a.abrupt("return",t);if(c=d,"normal"===(r=v(o,s,a)).type){c=a.done?f:l;var i={value:r.arg,done:a.done};if(r.arg!==y)return i;a.delegate&&"next"===e&&(t=h)}else"throw"===r.type&&(c=f,"next"===e?a.dispatchException(r.arg):t=r.arg)}}return n.next=r.bind(n,"next"),n.throw=r.bind(n,"throw"),n.return=r.bind(n,"return"),n}function p(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function w(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(p,this),this.reset()}function m(t){if(t){var e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,r=function e(){for(;++n<t.length;)if(c.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=h,e.done=!0,e};return r.next=r}}return{next:b}}function b(){return{value:h,done:!0}}}("object"==typeof e?e:"object"==typeof window?window:this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1]),(e=l.CloseCode||(l.CloseCode={}))[e.ClosingNormal=1e3]="ClosingNormal",e[e.GoingAway=1001]="GoingAway",e[e.NoSharedSubprotocol=1002]="NoSharedSubprotocol",e[e.PathFull=3e3]="PathFull",e[e.ProtocolError=3001]="ProtocolError",e[e.InternalError=3002]="InternalError",e[e.Handover=3003]="Handover",e[e.DroppedByInitiator=3004]="DroppedByInitiator",e[e.InitiatorCouldNotDecrypt=3005]="InitiatorCouldNotDecrypt",e[e.NoSharedTask=3006]="NoSharedTask",e[e.InvalidKey=3007]="InvalidKey",e[e.Timeout=3008]="Timeout";var d=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),a=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},f=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},y=function(e){function r(e,t){d(this,r);var n=f(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return n.message=t,n.closeCode=e,n.name="SignalingError",n}return a(r,e),r}(Error),g=function(e){function t(e){return d(this,t),f(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,l.CloseCode.ProtocolError,e))}return a(t,y),t}(),t=function(e){function n(e){d(this,n);var t=f(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.message=e,t.name="ConnectionError",t}return a(n,e),n}(Error),c=function(e){function r(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];d(this,r);var n=f(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return n.message=e,n.name="ValidationError",n.critical=t,n}return a(r,e),r}(Error),h=function(e){function r(e,t){d(this,r);var n=f(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return n.name="CryptoError",n.message=t,n.code=e,n}return a(r,e),r}(Error),n=Object.freeze({SignalingError:y,ProtocolError:g,ConnectionError:t,ValidationError:c,CryptoError:h}),v=function(){function e(){d(this,e),this.map=new Map}return s(e,[{key:"register",value:function(e,t){if("string"==typeof e)this.set(e,t);else{var n=!0,r=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value;this.set(a,t)}}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}}}},{key:"unregister",value:function(e,t){if("string"==typeof e){if(!this.map.has(e))return;if(void 0===t)this.map.delete(e);else{var n=this.map.get(e),r=n.indexOf(t);-1!==r&&n.splice(r,1)}}else{var i=!0,o=!1,s=void 0;try{for(var a,c=e[Symbol.iterator]();!(i=(a=c.next()).done);i=!0){var h=a.value;this.unregister(h,t)}}catch(e){o=!0,s=e}finally{try{!i&&c.return&&c.return()}finally{if(o)throw s}}}}},{key:"unregisterAll",value:function(){this.map.clear()}},{key:"set",value:function(e,t){if(this.map.has(e)){var n=this.map.get(e);-1===n.indexOf(t)&&n.push(t)}else this.map.set(e,[t])}},{key:"get",value:function(e){var t=[];if("string"==typeof e)this.map.has(e)&&t.push.apply(t,this.map.get(e));else{var n=!0,r=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value,c=!0,h=!1,u=void 0;try{for(var l,d=this.get(a)[Symbol.iterator]();!(c=(l=d.next()).done);c=!0){var f=l.value;-1===t.indexOf(f)&&t.push(f)}}catch(e){h=!0,u=e}finally{try{!c&&d.return&&d.return()}finally{if(h)throw u}}}}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}}return t}}]),e}(),p=function(){function t(e){d(this,t),this.level=e}return s(t,[{key:"noop",value:function(){}},{key:"level",set:function(e){switch(this._level=e,this.debug=this.noop,this.trace=this.noop,this.info=this.noop,this.warn=this.noop,this.error=this.noop,this.assert=this.noop,e){case"debug":this.debug=console.debug,this.trace=console.trace;case"info":this.info=console.info;case"warn":this.warn=console.warn;case"error":this.error=console.error,this.assert=console.assert}},get:function(){return this._level}}]),t}();function k(e){var t=[],n=!0,r=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value;t.push(a.toString(16).replace(/^([\da-f])$/,"0$1"))}}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}return t.join("")}function w(e){return"0x"+("00"+e.toString(16)).substr(-2)}function m(){for(var e=0,t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var i=!0,o=!1,s=void 0;try{for(var a,c=n[Symbol.iterator]();!(i=(a=c.next()).done);i=!0){e+=a.value.length}}catch(e){o=!0,s=e}finally{try{!i&&c.return&&c.return()}finally{if(o)throw s}}var h=new Uint8Array(e),u=0,l=!0,d=!1,f=void 0;try{for(var y,g=n[Symbol.iterator]();!(l=(y=g.next()).done);l=!0){var v=y.value;h.set(v,u),u+=v.length}}catch(e){d=!0,f=e}finally{try{!l&&g.return&&g.return()}finally{if(d)throw f}}return h}function r(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"Key",r=void 0;if("string"==typeof(t=e)||t instanceof String)r=function(e){var t,n=void 0,r=void 0,i=0,o=void 0;for(e.length%2==1&&(e="0"+e),n=new Uint8Array(e.length/2),r=o=0,t=e.length;o<=t;r=o+=2)n[i++]=parseInt(e.substr(r,2),16);return n}(e);else{if(!(e instanceof Uint8Array))throw new c(n+" must be an Uint8Array or a hex string");r=e}if(32!==r.byteLength)throw new c(n+" must be 32 bytes long");return r}function b(e){return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}var S=function(){function r(e,t,n){d(this,r),this._nonce=e,this._nonceLength=n,this._data=t}return s(r,[{key:"toUint8Array",value:function(){var e=new Uint8Array(this.length);return e.set(this._nonce),e.set(this._data,this._nonceLength),e}},{key:"length",get:function(){return this._nonce.length+this._data.length}},{key:"data",get:function(){return this._data}},{key:"nonce",get:function(){return this._nonce}}],[{key:"fromUint8Array",value:function(e,t){if(void 0===t)throw new Error("nonceLength parameter not specified");if(e.byteLength<=t)throw new h("bad-message-length","Message is shorter than nonce");return new r(e.slice(0,t),e.slice(t),t)}}]),r}(),T=function(){function n(e,t){if(d(this,n),this.logTag="[SaltyRTC.KeyStore]",void 0===t&&(t=new p("none")),2<arguments.length)throw new Error("Too many arguments in KeyStore constructor");void 0===e?(this._keyPair=o.box.keyPair(),t.debug(this.logTag,"New public key:",k(this._keyPair.publicKey))):(this._keyPair=o.box.keyPair.fromSecretKey(r(e,"Private key")),t.debug(this.logTag,"Restored public key:",k(this._keyPair.publicKey)))}return s(n,[{key:"getSharedKeyStore",value:function(e){return new C(this.secretKeyBytes,e)}},{key:"encryptRaw",value:function(e,t,n){return o.box(e,t,n,this._keyPair.secretKey)}},{key:"encrypt",value:function(e,t,n){var r=this.encryptRaw(e,t,n);return new S(t,r,o.box.nonceLength)}},{key:"decryptRaw",value:function(e,t,n){var r=o.box.open(e,t,n,this._keyPair.secretKey);if(!r)throw new h("decryption-failed","Data could not be decrypted");return r}},{key:"decrypt",value:function(e,t){return this.decryptRaw(e.data,e.nonce,t)}},{key:"publicKeyHex",get:function(){return k(this._keyPair.publicKey)}},{key:"publicKeyBytes",get:function(){return this._keyPair.publicKey}},{key:"secretKeyHex",get:function(){return k(this._keyPair.secretKey)}},{key:"secretKeyBytes",get:function(){return this._keyPair.secretKey}},{key:"keypair",get:function(){return this._keyPair}}]),n}(),C=function(){function n(e,t){d(this,n),this._localSecretKey=r(e,"Local private key"),this._remotePublicKey=r(t,"Remote public key"),this._sharedKey=o.box.before(this._remotePublicKey,this._localSecretKey)}return s(n,[{key:"encryptRaw",value:function(e,t){return o.box.after(e,t,this._sharedKey)}},{key:"encrypt",value:function(e,t){var n=this.encryptRaw(e,t);return new S(t,n,o.box.nonceLength)}},{key:"decryptRaw",value:function(e,t){var n=o.box.open.after(e,t,this._sharedKey);if(!n)throw new h("decryption-failed","Data could not be decrypted");return n}},{key:"decrypt",value:function(e){return this.decryptRaw(e.data,e.nonce)}},{key:"localSecretKeyHex",get:function(){return k(this._localSecretKey)}},{key:"localSecretKeyBytes",get:function(){return this._localSecretKey}},{key:"remotePublicKeyHex",get:function(){return k(this._remotePublicKey)}},{key:"remotePublicKeyBytes",get:function(){return this._remotePublicKey}}]),n}(),$=function(){function r(e,t){if(d(this,r),this._authToken=null,this.logTag="[SaltyRTC.AuthToken]",void 0===t&&(t=new p("none")),void 0===e)this._authToken=o.randomBytes(o.secretbox.keyLength),t.debug(this.logTag,"Generated auth token");else{if(e.byteLength!==o.secretbox.keyLength){var n="Auth token must be "+o.secretbox.keyLength+" bytes long.";throw t.error(this.logTag,n),new h("bad-token-length",n)}this._authToken=e,t.debug(this.logTag,"Initialized auth token")}}return s(r,[{key:"encrypt",value:function(e,t){var n=o.secretbox(e,t,this._authToken);return new S(t,n,o.secretbox.nonceLength)}},{key:"decrypt",value:function(e){var t=o.secretbox.open(e.data,e.nonce,this._authToken);if(!t)throw new h("decryption-failed","Data could not be decrypted");return t}},{key:"keyBytes",get:function(){return this._authToken}},{key:"keyHex",get:function(){return k(this._authToken)}}]),r}(),_=function(){function n(e){if(d(this,n),void 0!==e){if(16!==e.length)throw new c("Bad cookie length");this.bytes=e}else this.bytes=o.randomBytes(n.COOKIE_LENGTH)}return s(n,[{key:"equals",value:function(e){if(e.bytes===this.bytes)return!0;if(e.bytes.byteLength!==n.COOKIE_LENGTH)return!1;for(var t=0;t<this.bytes.byteLength;t++)if(e.bytes[t]!==this.bytes[t])return!1;return!0}}]),n}();_.COOKIE_LENGTH=16;var E=function(){function n(e,t){if(d(this,n),this._ours=null,this._theirs=null,void 0!==e&&void 0!==t){if(t.equals(e))throw new g("Their cookie matches our cookie");this._ours=e,this._theirs=t}else{if(void 0!==e||void 0!==t)throw new Error("Either both or no cookies must be specified");this._ours=new _}}return s(n,[{key:"ours",get:function(){return this._ours}},{key:"theirs",get:function(){return this._theirs},set:function(e){if(e.equals(this._ours))throw new g("Their cookie matches our cookie");this._theirs=e}}],[{key:"fromTheirs",value:function(e){for(var t=void 0;(t=new _).equals(e););return new n(t,e)}}]),n}(),P=function(){function o(e,t,n,r,i){d(this,o),this._cookie=e,this._overflow=t,this._sequenceNumber=n,this._source=r,this._destination=i}return s(o,[{key:"toUint8Array",value:function(){var e=new ArrayBuffer(o.TOTAL_LENGTH),t=new Uint8Array(e);t.set(this._cookie.bytes);var n=new DataView(e,_.COOKIE_LENGTH,8);return n.setUint8(0,this._source),n.setUint8(1,this._destination),n.setUint16(2,this._overflow),n.setUint32(4,this._sequenceNumber),t}},{key:"cookie",get:function(){return this._cookie}},{key:"overflow",get:function(){return this._overflow}},{key:"sequenceNumber",get:function(){return this._sequenceNumber}},{key:"combinedSequenceNumber",get:function(){return this._overflow*Math.pow(2,32)+this._sequenceNumber}},{key:"source",get:function(){return this._source}},{key:"destination",get:function(){return this._destination}}],[{key:"fromUint8Array",value:function(e){if(e.byteLength!==this.TOTAL_LENGTH)throw new c("bad-packet-length");var t=new DataView(e.buffer,e.byteOffset+_.COOKIE_LENGTH,8),n=new _(e.slice(0,_.COOKIE_LENGTH)),r=t.getUint8(0),i=t.getUint8(1);return new o(n,t.getUint16(2),t.getUint32(4),r,i)}}]),o}();P.TOTAL_LENGTH=24;var I=function(){function e(){d(this,e),this.sequenceNumber=(window.crypto||window.msCrypto).getRandomValues(new Uint32Array(1))[0],this.overflow=0}return s(e,[{key:"next",value:function(){if(this.sequenceNumber>=e.SEQUENCE_NUMBER_MAX){if(this.sequenceNumber=0,this.overflow+=1,this.overflow>=e.OVERFLOW_MAX)throw new Error("overflow-overflow")}else this.sequenceNumber+=1;return{sequenceNumber:this.sequenceNumber,overflow:this.overflow}}},{key:"asNumber",value:function(){return this.overflow*Math.pow(2,32)+this.sequenceNumber}}]),e}();I.SEQUENCE_NUMBER_MAX=4294967295,I.OVERFLOW_MAX=1048575;var R=function e(t,n){if(d(this,e),this.ours=null,this.theirs=null,void 0!==t&&void 0!==n)this.ours=t,this.theirs=n;else{if(void 0!==t||void 0!==n)throw new Error("Either both or no combined sequences must be specified");this.ours=new I}},O=function(){function n(e,t){d(this,n),this._csnPair=new R,this._permanentSharedKey=null,this._sessionSharedKey=null,this._id=e,this._cookiePair=void 0===t?new E:t}return s(n,[{key:"setPermanentSharedKey",value:function(e,t){this._permanentSharedKey=t.getSharedKeyStore(e)}},{key:"setSessionSharedKey",value:function(e,t){this._sessionSharedKey=t.getSharedKeyStore(e)}},{key:"id",get:function(){return this._id}},{key:"hexId",get:function(){return w(this._id)}},{key:"csnPair",get:function(){return this._csnPair}},{key:"cookiePair",get:function(){return this._cookiePair}},{key:"permanentSharedKey",get:function(){return this._permanentSharedKey}},{key:"sessionSharedKey",get:function(){return this._sessionSharedKey}}]),n}(),K=function(e){function n(){d(this,n);var e=f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments));return e._localSessionKey=null,e}return a(n,O),s(n,[{key:"setLocalSessionKey",value:function(e){this._localSessionKey=e}},{key:"setSessionSharedKey",value:function(e,t){t?this._localSessionKey=t:t=this._localSessionKey,function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var s=i.get;return void 0!==s?s.call(r):void 0}(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setSessionSharedKey",this).call(this,e,t)}},{key:"localSessionKey",get:function(){return this._localSessionKey}}]),n}(),x=function(e){function r(e,t){d(this,r);var n=f(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,r.ID));return n.connected=!1,n.handshakeState="new",n.setPermanentSharedKey(e,t),n}return a(r,K),s(r,[{key:"name",get:function(){return"Initiator"}}]),r}();x.ID=1;var A=function(e){function r(e,t){d(this,r);var n=f(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return n.handshakeState="new",n._counter=t,n}return a(r,K),s(r,[{key:"name",get:function(){return"Responder "+this.id}},{key:"counter",get:function(){return this._counter}}]),r}(),N=function(e){function t(){d(this,t);var e=f(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.ID));return e.handshakeState="new",e}return a(t,O),s(t,[{key:"name",get:function(){return"Server"}}]),t}();N.ID=0;var D=function(){function e(){d(this,e),this.reset()}return s(e,[{key:"reset",value:function(){this._local=!1,this._peer=!1}},{key:"local",get:function(){return this._local},set:function(e){var t=this.both;this._local=e,!t&&this.both&&void 0!==this.onBoth&&this.onBoth()}},{key:"peer",get:function(){return this._peer},set:function(e){var t=this.both;this._peer=e,!t&&this.both&&void 0!==this.onBoth&&this.onBoth()}},{key:"both",get:function(){return!0===this._local&&!0===this._peer}},{key:"any",get:function(){return!0===this._local||!0===this._peer}}]),e}();function L(e){return 2<=e&&e<=255}var j=function(){function h(e,t,n,r,i,o,s,a){var c=this;d(this,h),this.protocol="wss",this.ws=null,this.msgpackEncodeOptions={codec:u.createCodec({binarraybuffer:!0})},this.msgpackDecodeOptions={codec:u.createCodec({binarraybuffer:!0})},this.state="new",this.handoverState=new D,this.task=null,this.server=new N,this.peerTrustedKey=null,this.authToken=null,this.serverPublicKey=null,this.role=null,this.logTag="[SaltyRTC.Signaling]",this.address=h.SALTYRTC_ADDR_UNKNOWN,this.log=e.log,this.client=e,this.permanentKey=s,this.host=t,this.port=n,this.tasks=i,this.pingInterval=o,void 0!==a&&(this.peerTrustedKey=a),void 0!==r&&(this.serverPublicKey=r),this.handoverState.onBoth=function(){c.client.emit({type:"handover"}),c.closeWebsocket(l.CloseCode.Handover)}}return s(h,[{key:"setState",value:function(e){this.state=e,this.client.emit({type:"state-change",data:e}),this.client.emit({type:"state-change:"+e})}},{key:"getState",value:function(){return this.state}},{key:"msgpackEncode",value:function(e){return u.encode(e,this.msgpackEncodeOptions)}},{key:"msgpackDecode",value:function(e){return u.decode(e,this.msgpackDecodeOptions)}},{key:"connect",value:function(){this.resetConnection(),this.initWebsocket()}},{key:"disconnect",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=l.CloseCode.ClosingNormal;this.setState("closing"),"task"===this.state&&this.sendClose(t),this.closeWebsocket(t,void 0,e),null!==this.task&&(this.log.debug(this.logTag,"Closing task connections"),this.task.close(t)),this.setState("closed")}},{key:"closeWebsocket",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];null!==this.ws&&((void 0===e||e<=3e3)&&(e=l.CloseCode.ClosingNormal),this.log.debug(this.logTag,"Disconnecting WebSocket, close code: "+e),this.ws.close(e,t),n&&(this.ws.removeEventListener("open",this.onOpen.bind(this)),this.ws.removeEventListener("error",this.onError.bind(this)),this.ws.removeEventListener("close",this.onClose.bind(this)),this.ws.removeEventListener("message",this.onMessage.bind(this))),this.ws=null,n&&this.setState("closed"))}},{key:"initWebsocket",value:function(){var e=this.protocol+"://"+this.host+":"+this.port+"/",t=this.getWebsocketPath();this.ws=new WebSocket(e+t,h.SALTYRTC_SUBPROTOCOL),this.ws.binaryType="arraybuffer",this.ws.addEventListener("open",this.onOpen.bind(this)),this.ws.addEventListener("error",this.onError.bind(this)),this.ws.addEventListener("close",this.onClose.bind(this)),this.ws.addEventListener("message",this.onMessage.bind(this)),this.setState("ws-connecting"),this.log.debug(this.logTag,"Opening WebSocket connection to",e+t)}},{key:"onOpen",value:function(){this.log.info(this.logTag,"Opened connection"),this.setState("server-handshake")}},{key:"onError",value:function(e){this.log.error(this.logTag,"General WebSocket error",e),this.client.emit({type:"connection-error"})}},{key:"onClose",value:function(e){e.code===l.CloseCode.Handover?this.log.info(this.logTag,"Closed WebSocket connection due to handover"):(this.log.info(this.logTag,"Closed WebSocket connection with close code "+e.code+" ("+i(e.code)+")"),this.setState("closed"),this.client.emit({type:"connection-closed",data:e.code}))}},{key:"onMessage",value:function(e){if(this.log.debug(this.logTag,"New ws message ("+e.data.byteLength+" bytes)"),this.handoverState.peer)return this.log.error(this.logTag,"Protocol error: Received WebSocket message from peer even though it has already handed over to task."),void this.resetConnection(l.CloseCode.ProtocolError);var t=void 0;try{var n=S.fromUint8Array(new Uint8Array(e.data),P.TOTAL_LENGTH);t=P.fromUint8Array(n.nonce);try{this.validateNonce(t)}catch(e){if("ValidationError"===e.name){if(!0===e.critical)throw new g("Invalid nonce: "+e);return void this.log.warn(this.logTag,"Dropping message with invalid nonce: "+e)}throw e}switch(this.getState()){case"server-handshake":this.onServerHandshakeMessage(n,t);break;case"peer-handshake":this.onPeerHandshakeMessage(n,t);break;case"task":this.onSignalingMessage(n,t);break;default:this.log.warn(this.logTag,"Received message in",this.getState(),"signaling state. Ignoring.")}}catch(e){if("SignalingError"===e.name||"ProtocolError"===e.name){var r="Signaling error: "+i(e.closeCode);switch(e.message&&(r+=" ("+e.message+")"),this.log.error(this.logTag,r),this.state){case"new":case"ws-connecting":case"server-handshake":this.resetConnection(e.closeCode);break;case"peer-handshake":this.handlePeerHandshakeSignalingError(e,void 0===t?null:t.source);break;case"task":this.sendClose(e.closeCode),this.resetConnection(l.CloseCode.ClosingNormal)}}else{if("ConnectionError"!==e.name)throw e.hasOwnProperty("stack")&&(this.log.error(this.logTag,"An unknown error occurred:"),this.log.error(e.stack)),e;this.log.warn(this.logTag,"Connection error. Resetting connection."),this.resetConnection(l.CloseCode.InternalError)}}}},{key:"onServerHandshakeMessage",value:function(e,t){var n=void 0;n="new"===this.server.handshakeState?e.data:this.server.sessionSharedKey.decrypt(e);var r=this.decodeMessage(n,"server handshake");switch(this.server.handshakeState){case"new":if("server-hello"!==r.type)throw new g("Expected server-hello message, but got "+r.type);this.log.debug(this.logTag,"Received server-hello"),this.handleServerHello(r,t),this.sendClientHello(),this.sendClientAuth();break;case"hello-sent":throw new g("Received "+r.type+" message before sending client-auth");case"auth-sent":if("server-auth"!==r.type)throw new g("Expected server-auth message, but got "+r.type);this.log.debug(this.logTag,"Received server-auth"),this.handleServerAuth(r,t);break;case"done":throw new y(l.CloseCode.InternalError,"Received server handshake message even though server handshake state is set to 'done'");default:throw new y(l.CloseCode.InternalError,"Unknown server handshake state: "+this.server.handshakeState)}"done"===this.server.handshakeState&&(this.setState("peer-handshake"),this.log.debug(this.logTag,"Server handshake done"),this.initPeerHandshake())}},{key:"onSignalingMessage",value:function(e,t){if(this.log.debug(this.logTag,"Message received"),t.source===h.SALTYRTC_ADDR_SERVER)this.onSignalingServerMessage(e);else{var n=this.getPeer().sessionSharedKey.decrypt(e);this.onSignalingPeerMessage(n)}}},{key:"onSignalingServerMessage",value:function(e){var t=this.decryptServerMessage(e);switch(t.type){case"send-error":this.log.debug(this.logTag,"Received send-error message"),this.handleSendError(t);break;case"disconnected":this.log.debug(this.logTag,"Received disconnected message"),this.handleDisconnected(t);break;default:this.log.warn(this.logTag,"Invalid server message type:",t.type)}}},{key:"onSignalingPeerMessage",value:function(e){var t=this.decodeMessage(e);if("close"===t.type)this.log.debug(this.logTag,"Received close"),this.handleClose(t);else if("application"===t.type)this.log.debug(this.logTag,"Received application message"),this.handleApplication(t);else if(null!==this.task){-1!==this.task.getSupportedMessageTypes().indexOf(t.type)?(this.log.debug(this.logTag,"Received",t.type,"["+this.task.getName()+"]"),this.task.onTaskMessage(t)):(this.log.error(this.logTag,"Received",t.type,"message which is not supported by the",this.task.getName(),"task"),this.resetConnection(l.CloseCode.ProtocolError))}else this.log.warn(this.logTag,"Received message with invalid type from peer:",t.type)}},{key:"handleServerHello",value:function(e,t){this.server.setSessionSharedKey(new Uint8Array(e.key),this.permanentKey),this.server.cookiePair.theirs=t.cookie}},{key:"sendClientAuth",value:function(){var e={type:"client-auth",your_cookie:b(this.server.cookiePair.theirs.bytes),subprotocols:[h.SALTYRTC_SUBPROTOCOL],ping_interval:this.pingInterval};null!==this.serverPublicKey&&(e.your_key=b(this.serverPublicKey));var t=this.buildPacket(e,this.server);this.log.debug(this.logTag,"Sending client-auth"),this.ws.send(t),this.server.handshakeState="auth-sent"}},{key:"handleSendError",value:function(e){var t=new DataView(e.id),n=k(new Uint8Array(e.id)),r=t.getUint8(0),i=t.getUint8(1);if(r!==this.address)throw new g("Received send-error message for a message not sent by us!");this.log.warn(this.logTag,"SendError: Could not send unknown message:",n),this._handleSendError(i)}},{key:"handleApplication",value:function(e){this.client.emit({type:"application",data:e.data})}},{key:"sendClose",value:function(e){var t={type:"close",reason:e};if(this.log.debug(this.logTag,"Sending close"),!0===this.handoverState.local)this.task.sendSignalingMessage(this.msgpackEncode(t));else{var n=this.buildPacket(t,this.getPeer());this.ws.send(n)}}},{key:"handleClose",value:function(e){this.log.warn(this.logTag,"Received close message. Reason:",e.reason,"("+i(e.reason)+")"),this.task.close(e.reason),this.resetConnection(l.CloseCode.GoingAway)}},{key:"handleDisconnected",value:function(e){this.client.emit({type:"peer-disconnected",data:e.id})}},{key:"validateNonce",value:function(e){this.validateNonceSource(e),this.validateNonceDestination(e),this.validateNonceCsn(e),this.validateNonceCookie(e)}},{key:"validateNonceSource",value:function(e){switch(this.state){case"server-handshake":if(e.source!==h.SALTYRTC_ADDR_SERVER)throw new c("Received message during server handshake with invalid sender address ("+e.source+" != "+h.SALTYRTC_ADDR_SERVER+")",!1);break;case"peer-handshake":case"task":if(e.source!==h.SALTYRTC_ADDR_SERVER){if("initiator"===this.role&&!L(e.source))throw new c("Initiator peer message does not come from a valid responder address: "+e.source,!1);if("responder"===this.role&&e.source!==h.SALTYRTC_ADDR_INITIATOR)throw new c("Responder peer message does not come from intitiator ("+h.SALTYRTC_ADDR_INITIATOR+"), but from "+e.source,!1)}break;default:throw new g("Cannot validate message nonce in signaling state "+this.state)}}},{key:"validateNonceDestination",value:function(e){var t=null;if("server-handshake"===this.state)switch(this.server.handshakeState){case"new":case"hello-sent":t=h.SALTYRTC_ADDR_UNKNOWN;break;case"auth-sent":if("initiator"===this.role)t=h.SALTYRTC_ADDR_INITIATOR;else if(!L(e.destination))throw new c("Received message during server handshake with invalid receiver address ("+e.destination+" is not a valid responder id)");break;case"done":t=this.address}else{if("peer-handshake"!==this.state&&"task"!==this.state)throw new c("Cannot validate message nonce in signaling state "+this.state);t=this.address}if(null!==t&&e.destination!==t)throw new c("Received message with invalid destination ("+e.destination+" != "+t+")")}},{key:"validateNonceCsn",value:function(e){var t=this.getPeerWithId(e.source);if(null===t)throw new g("Could not find peer "+e.source);if(null===t.csnPair.theirs){if(0!==e.overflow)throw new c("First message from "+t.name+" must have set the overflow number to 0");t.csnPair.theirs=e.combinedSequenceNumber}else{var n=t.csnPair.theirs,r=e.combinedSequenceNumber;if(r<n)throw new c(t.name+" CSN is lower than last time");if(r===n)throw new c(t.name+" CSN hasn't been incremented");t.csnPair.theirs=r}}},{key:"validateNonceCookie",value:function(e){var t=this.getPeerWithId(e.source);if(null!==t&&null!==t.cookiePair.theirs&&!e.cookie.equals(t.cookiePair.theirs))throw new c(t.name+" cookie changed")}},{key:"validateRepeatedCookie",value:function(e,t){var n=new _(t);if(!n.equals(e.cookiePair.ours))throw this.log.debug(this.logTag,"Their cookie:",n.bytes),this.log.debug(this.logTag,"Our cookie:",e.cookiePair.ours.bytes),new g("Peer repeated cookie does not match our cookie")}},{key:"validateSignedKeys",value:function(e,t,n){if(null==e)throw new c("Server did not send signed_keys in server-auth message");var r=new S(t.toUint8Array(),new Uint8Array(e),o.box.nonceLength);this.log.debug(this.logTag,"Expected server public permanent key is",k(n));var i=void 0;try{i=this.permanentKey.decrypt(r,n)}catch(e){if("CryptoError"===e.name&&"decryption-failed"===e.code)throw new c("Could not decrypt signed_keys in server_auth message");throw e}if(!function(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}(i,m(this.server.sessionSharedKey.remotePublicKeyBytes,this.permanentKey.publicKeyBytes)))throw new c("Decrypted signed_keys in server-auth message is invalid")}},{key:"decodeMessage",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],r=this.msgpackDecode(e);if(void 0===r.type)throw new g("Malformed "+t+" message: Failed to decode msgpack data.");if(n&&void 0!==t&&r.type!==t)throw new g("Invalid "+t+" message, bad type: "+r);return r}},{key:"buildPacket",value:function(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],r=void 0;try{r=t.csnPair.ours.next()}catch(e){throw new g("CSN overflow: "+e.message)}var i=new P(t.cookiePair.ours,r.overflow,r.sequenceNumber,this.address,t.id).toUint8Array(),o=this.msgpackEncode(e);if(!1===n)return m(i,o);var s=void 0;if(t.id===h.SALTYRTC_ADDR_SERVER)s=this.encryptHandshakeDataForServer(o,i);else{if(t.id!==h.SALTYRTC_ADDR_INITIATOR&&!L(t.id))throw new g("Bad receiver byte: "+t);s=this.encryptHandshakeDataForPeer(t.id,e.type,o,i)}return s.toUint8Array()}},{key:"encryptHandshakeDataForServer",value:function(e,t){return this.server.sessionSharedKey.encrypt(e,t)}},{key:"getCurrentPeerCsn",value:function(){return"task"!==this.getState()?null:{incoming:this.getPeer().csnPair.theirs,outgoing:this.getPeer().csnPair.ours.asNumber()}}},{key:"decryptData",value:function(e){return this.getPeer().sessionSharedKey.decrypt(e)}},{key:"resetConnection",value:function(e){this.closeWebsocket(e,void 0,!0),this.server=new N,this.handoverState.reset(),this.setState("new"),void 0!==e&&this.log.debug(this.logTag,"Connection reset")}},{key:"initTask",value:function(e,t){try{e.init(this,t)}catch(e){if("ValidationError"===e.name)throw new g("Peer sent invalid task data");throw e}this.task=e}},{key:"decryptPeerMessage",value:function(t){var n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];try{var e=this.getPeer().sessionSharedKey.decrypt(t);return this.decodeMessage(e,"peer")}catch(e){if(!0===n&&"CryptoError"===e.name&&"decryption-failed"===e.code){var r=P.fromUint8Array(t.nonce);throw new g("Could not decrypt peer message from "+w(r.source))}throw e}}},{key:"decryptServerMessage",value:function(e){try{var t=this.server.sessionSharedKey.decrypt(e);return this.decodeMessage(t,"server")}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new g("Could not decrypt server message"):e}}},{key:"sendApplication",value:function(e){this.sendPostClientHandshakeMessage(e,"application")}},{key:"sendTaskMessage",value:function(e){this.sendPostClientHandshakeMessage(e,"task")}},{key:"sendPostClientHandshakeMessage",value:function(e,t){if("task"!==this.state)throw new y(l.CloseCode.ProtocolError,"Cannot send "+t+' message in "'+this.state+'" state');var n=this.getPeer();if(null===n)throw new y(l.CloseCode.InternalError,"No peer address could be found");if(!0===this.handoverState.local)this.log.debug(this.logTag,"Sending",t,"message through dc"),this.task.sendSignalingMessage(this.msgpackEncode(e));else{this.log.debug(this.logTag,"Sending",t,"message through ws");var r=this.buildPacket(e,n);this.ws.send(r)}}},{key:"encryptForPeer",value:function(e,t){var n=this.getPeer();if(!n)throw new Error("Remote peer has not yet been established");var r=n.sessionSharedKey;if(!r)throw new Error("Session key not yet established");return r.encrypt(e,t)}},{key:"decryptFromPeer",value:function(e){var t=this.getPeer();if(!t)throw new Error("Remote peer has not yet been established");var n=t.sessionSharedKey;if(!n)throw new Error("Session key not yet established");try{return n.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?("task"===this.state&&this.sendClose(l.CloseCode.InternalError),this.resetConnection(l.CloseCode.InternalError),new y(l.CloseCode.InternalError,"Decryption of peer message failed. This should not happen.")):e}}},{key:"permanentKeyBytes",get:function(){return this.permanentKey.publicKeyBytes}},{key:"authTokenBytes",get:function(){return null!==this.authToken?this.authToken.keyBytes:null}},{key:"peerPermanentKeyBytes",get:function(){return this.getPeer().permanentSharedKey.remotePublicKeyBytes}}]),h}();j.SALTYRTC_SUBPROTOCOL="v1.saltyrtc.org",j.SALTYRTC_ADDR_UNKNOWN=0,j.SALTYRTC_ADDR_SERVER=0,j.SALTYRTC_ADDR_INITIATOR=1;var F=function(e){function h(e,t,n,r,i,o,s,a){d(this,h);var c=f(this,(h.__proto__||Object.getPrototypeOf(h)).call(this,e,t,n,r,i,o,s,a));return c.logTag="[SaltyRTC.Initiator]",c.responderCounter=0,c.responders=null,c.responder=null,c.role="initiator",void 0===a&&(c.authToken=new $(void 0,c.log)),c}return a(h,j),s(h,[{key:"getWebsocketPath",value:function(){return this.permanentKey.publicKeyHex}},{key:"encryptHandshakeDataForPeer",value:function(e,t,n,r){if(e===j.SALTYRTC_ADDR_INITIATOR)throw new g("Initiator cannot encrypt messages for initiator");if(!L(e))throw new g("Bad receiver byte: "+e);var i=void 0;if("task"===this.getState())i=this.responder;else{if(!this.responders.has(e))throw new g("Unknown responder: "+e);i=this.responders.get(e)}switch(t){case"key":return i.permanentSharedKey.encrypt(n,r);default:return i.sessionSharedKey.encrypt(n,r)}}},{key:"getPeer",value:function(){return null!==this.responder?this.responder:null}},{key:"getPeerWithId",value:function(e){if(e===j.SALTYRTC_ADDR_SERVER)return this.server;if(L(e))return"task"===this.state&&null!==this.responder&&this.responder.id===e?this.responder:this.responders.has(e)?this.responders.get(e):null;throw new g("Invalid peer id: "+e)}},{key:"handlePeerHandshakeSignalingError",value:function(e,t){null!==t&&this.dropResponder(t,e.closeCode)}},{key:"processNewResponder",value:function(e){this.responders.has(e)&&this.responders.delete(e);var t=new A(e,this.responderCounter++);null!==this.peerTrustedKey&&(t.handshakeState="token-received",t.setPermanentSharedKey(this.peerTrustedKey,this.permanentKey)),this.responders.set(e,t),252<this.responders.size&&this.dropOldestInactiveResponder(),this.client.emit({type:"new-responder",data:e})}},{key:"dropOldestInactiveResponder",value:function(){this.log.warn(this.logTag,"Dropping oldest inactive responder");var e=null,t=!0,n=!1,r=void 0;try{for(var i,o=this.responders.values()[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value;"new"===s.handshakeState&&(null===e?e=s:s.counter<e.counter&&(e=s))}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}null!==e&&this.dropResponder(e.id,l.CloseCode.DroppedByInitiator)}},{key:"onPeerHandshakeMessage",value:function(e,t){if(t.destination!==this.address)throw new g("Message destination does not match our address");var n=void 0;if(t.source===j.SALTYRTC_ADDR_SERVER){try{n=this.server.sessionSharedKey.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new y(l.CloseCode.ProtocolError,"Could not decrypt server message."):e}var r=this.decodeMessage(n,"server");switch(r.type){case"new-responder":this.log.debug(this.logTag,"Received new-responder",w(r.id)),this.handleNewResponder(r);break;case"send-error":this.log.debug(this.logTag,"Received send-error message"),this.handleSendError(r);break;case"disconnected":this.log.debug(this.logTag,"Received disconnected message"),this.handleDisconnected(r);break;default:throw new g("Received unexpected server message: "+r.type)}}else{if(!L(t.source))throw new y(l.CloseCode.InternalError,"Message source is neither the server nor a responder");var i=this.responders.get(t.source);if(null===i)throw new g("Unknown message source: "+t.source);var o=void 0;switch(i.handshakeState){case"new":if(null!==this.peerTrustedKey)throw new y(l.CloseCode.InternalError,'Handshake state is "new" even though a trusted key is available');try{n=this.authToken.decrypt(e)}catch(e){return this.log.warn(this.logTag,"Could not decrypt token message: ",e),void this.dropResponder(i.id,l.CloseCode.InitiatorCouldNotDecrypt)}o=this.decodeMessage(n,"token",!0),this.log.debug(this.logTag,"Received token"),this.handleToken(o,i);break;case"token-received":if(null!==this.peerTrustedKey)try{n=this.permanentKey.decrypt(e,this.peerTrustedKey)}catch(e){return this.log.warn(this.logTag,"Could not decrypt key message"),void this.dropResponder(i.id,l.CloseCode.InitiatorCouldNotDecrypt)}else n=i.permanentSharedKey.decrypt(e);o=this.decodeMessage(n,"key",!0),this.log.debug(this.logTag,"Received key"),this.handleKey(o,i),this.sendKey(i);break;case"key-sent":try{n=i.sessionSharedKey.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new y(l.CloseCode.ProtocolError,"Could not decrypt auth message."):e}o=this.decodeMessage(n,"auth",!0),this.log.debug(this.logTag,"Received auth"),this.handleAuth(o,i,t),this.sendAuth(i,t),this.responder=this.responders.get(i.id),this.responders.delete(i.id),this.dropResponders(l.CloseCode.DroppedByInitiator),this.setState("task"),this.log.info(this.logTag,"Peer handshake done"),this.task.onPeerHandshakeDone();break;default:throw new y(l.CloseCode.InternalError,"Unknown responder handshake state")}}}},{key:"sendClientHello",value:function(){}},{key:"handleServerAuth",value:function(e,t){if(this.address=j.SALTYRTC_ADDR_INITIATOR,this.validateRepeatedCookie(this.server,new Uint8Array(e.your_cookie)),null!=this.serverPublicKey)try{this.validateSignedKeys(new Uint8Array(e.signed_keys),t,this.serverPublicKey)}catch(e){if("ValidationError"===e.name)throw new g("Verification of signed_keys failed: "+e.message);throw e}else null!==e.signed_keys&&void 0!==e.signed_keys&&this.log.warn(this.logTag,"Server sent signed keys, but we're not verifying them.");this.responders=new Map;var n=!0,r=!1,i=void 0;try{for(var o,s=e.responders[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value;if(!L(a))throw new g("Responder id "+a+" must be in the range 0x02-0xff");this.processNewResponder(a)}}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}this.log.debug(this.logTag,this.responders.size,"responders connected"),this.server.handshakeState="done"}},{key:"initPeerHandshake",value:function(){}},{key:"handleNewResponder",value:function(e){if(!L(e.id))throw new g("Responder id "+e.id+" must be in the range 0x02-0xff");this.processNewResponder(e.id)}},{key:"handleToken",value:function(e,t){t.setPermanentSharedKey(new Uint8Array(e.key),this.permanentKey),t.handshakeState="token-received"}},{key:"handleKey",value:function(e,t){t.setLocalSessionKey(new T(void 0,this.log)),t.setSessionSharedKey(new Uint8Array(e.key)),t.handshakeState="key-received"}},{key:"sendKey",value:function(e){var t={type:"key",key:b(e.localSessionKey.publicKeyBytes)},n=this.buildPacket(t,e);this.log.debug(this.logTag,"Sending key"),this.ws.send(n),e.handshakeState="key-sent"}},{key:"sendAuth",value:function(e,t){if(t.cookie.equals(e.cookiePair.ours))throw new g("Their cookie and our cookie are the same.");var n={};n[this.task.getName()]=this.task.getData();var r={type:"auth",your_cookie:b(t.cookie.bytes),task:this.task.getName(),data:n},i=this.buildPacket(r,e);this.log.debug(this.logTag,"Sending auth"),this.ws.send(i),e.handshakeState="auth-sent"}},{key:"handleAuth",value:function(e,t,n){this.validateRepeatedCookie(t,new Uint8Array(e.your_cookie));try{h.validateTaskInfo(e.tasks,e.data)}catch(e){if("ValidationError"===e.name)throw new g("Peer sent invalid task info: "+e.message);throw e}var r=h.chooseCommonTask(this.tasks,e.tasks);if(null===r){var i=this.tasks.map(function(e){return e.getName()}),o=e.tasks;throw this.log.debug(this.logTag,"We requested:",i,"Peer offered:",o),this.client.emit({type:"no-shared-task",data:{requested:i,offered:o}}),new y(l.CloseCode.NoSharedTask,"No shared task could be found")}this.log.debug(this.logTag,"Task",r.getName(),"has been selected"),this.initTask(r,e.data[r.getName()]),this.log.debug(this.logTag,"Responder",t.hexId,"authenticated"),t.cookiePair.theirs=n.cookie,t.handshakeState="auth-received"}},{key:"_handleSendError",value:function(e){if(!L(e))throw new g("Outgoing c2c messages must have been sent to a responder");var t=!1;if(null===this.responder){var n=this.responders.get(e);null==n?this.log.warn(this.logTag,"Got send-error message for unknown responder",e):(t=!0,this.responders.delete(e))}else this.responder.id===e?(t=!0,this.resetConnection(l.CloseCode.ProtocolError)):this.log.warn(this.logTag,"Got send-error message for unknown responder",e);!0===t&&this.client.emit({type:"signaling-connection-lost",data:e})}},{key:"dropResponders",value:function(e){this.log.debug(this.logTag,"Dropping",this.responders.size,"other responders.");var t=!0,n=!1,r=void 0;try{for(var i,o=this.responders.keys()[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value;this.dropResponder(s,e)}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}}},{key:"dropResponder",value:function(e,t){var n={type:"drop-responder",id:e,reason:t},r=this.buildPacket(n,this.server);this.log.debug(this.logTag,"Sending drop-responder",w(e)),this.ws.send(r),this.responders.delete(e)}}],[{key:"validateTaskInfo",value:function(e,t){if(e.length<1)throw new c("Task names must not be empty");if(Object.keys(t).length<1)throw new c("Task data must not be empty");if(e.length!==Object.keys(t).length)throw new c("Task data must contain an entry for every task");var n=!0,r=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value;if(!t.hasOwnProperty(a))throw new c("Task data must contain an entry for every task")}}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}}},{key:"chooseCommonTask",value:function(e,t){var n=!0,r=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value;if(-1!==t.indexOf(a.getName()))return a}}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}return null}}]),h}(),M=function(e){function u(e,t,n,r,i,o,s,a,c){d(this,u);var h=f(this,(u.__proto__||Object.getPrototypeOf(u)).call(this,e,t,n,r,i,o,s,void 0===c?a:void 0));return h.logTag="[SaltyRTC.Responder]",h.initiator=null,h.role="responder",h.initiator=new x(a,h.permanentKey),void 0!==c?h.authToken=c:h.initiator.handshakeState="token-sent",h}return a(u,j),s(u,[{key:"getWebsocketPath",value:function(){return this.initiator.permanentSharedKey.remotePublicKeyHex}},{key:"encryptHandshakeDataForPeer",value:function(e,t,n,r){if(L(e))throw new g("Responder may not encrypt messages for other responders: "+e);if(e!==j.SALTYRTC_ADDR_INITIATOR)throw new g("Bad receiver byte: "+e);switch(t){case"token":return this.authToken.encrypt(n,r);case"key":return this.initiator.permanentSharedKey.encrypt(n,r);default:var i=this.getPeer().sessionSharedKey;if(null===i)throw new g("Trying to encrypt for peer using session key, but session key is null");return i.encrypt(n,r)}}},{key:"getPeer",value:function(){return null!==this.initiator?this.initiator:null}},{key:"getPeerWithId",value:function(e){if(e===j.SALTYRTC_ADDR_SERVER)return this.server;if(e===j.SALTYRTC_ADDR_INITIATOR)return this.initiator;throw new g("Invalid peer id: "+e)}},{key:"handlePeerHandshakeSignalingError",value:function(e,t){this.resetConnection(e.closeCode)}},{key:"onPeerHandshakeMessage",value:function(e,t){if(t.destination!==this.address)throw new g("Message destination does not match our address");var n=void 0;if(t.source===j.SALTYRTC_ADDR_SERVER){try{n=this.server.sessionSharedKey.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new y(l.CloseCode.ProtocolError,"Could not decrypt server message."):e}var r=this.decodeMessage(n,"server");switch(r.type){case"new-initiator":this.log.debug(this.logTag,"Received new-initiator"),this.handleNewInitiator();break;case"send-error":this.log.debug(this.logTag,"Received send-error message"),this.handleSendError(r);break;case"disconnected":this.log.debug(this.logTag,"Received disconnected message"),this.handleDisconnected(r);break;default:throw new g("Received unexpected server message: "+r.type)}}else{if(t.source!==j.SALTYRTC_ADDR_INITIATOR)throw new y(l.CloseCode.InternalError,"Message source is neither the server nor the initiator");n=this.decryptInitiatorMessage(e);var i=void 0;switch(this.initiator.handshakeState){case"new":throw new g("Unexpected peer handshake message");case"key-sent":i=this.decodeMessage(n,"key",!0),this.log.debug(this.logTag,"Received key"),this.handleKey(i),this.sendAuth(t);break;case"auth-sent":i=this.decodeMessage(n,"auth",!0),this.log.debug(this.logTag,"Received auth"),this.handleAuth(i,t),this.setState("task"),this.log.info(this.logTag,"Peer handshake done");break;default:throw new y(l.CloseCode.InternalError,"Unknown initiator handshake state")}}}},{key:"decryptInitiatorMessage",value:function(e){switch(this.initiator.handshakeState){case"new":case"token-sent":case"key-received":throw new g("Received message in "+this.initiator.handshakeState+" state.");case"key-sent":try{return this.initiator.permanentSharedKey.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new y(l.CloseCode.ProtocolError,"Could not decrypt key message."):e}case"auth-sent":case"auth-received":try{return this.initiator.sessionSharedKey.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new y(l.CloseCode.ProtocolError,"Could not decrypt initiator session message."):e}default:throw new g("Invalid handshake state: "+this.initiator.handshakeState)}}},{key:"sendClientHello",value:function(){var e={type:"client-hello",key:b(this.permanentKey.publicKeyBytes)},t=this.buildPacket(e,this.server,!1);this.log.debug(this.logTag,"Sending client-hello"),this.ws.send(t),this.server.handshakeState="hello-sent"}},{key:"handleServerAuth",value:function(e,t){if(255<t.destination||t.destination<2)throw this.log.error(this.logTag,"Invalid nonce destination:",t.destination),new c("Invalid nonce destination: "+t.destination);if(this.address=t.destination,this.log.debug(this.logTag,"Server assigned address",w(this.address)),this.logTag="[SaltyRTC.Responder."+w(this.address)+"]",this.validateRepeatedCookie(this.server,new Uint8Array(e.your_cookie)),null!=this.serverPublicKey)try{this.validateSignedKeys(new Uint8Array(e.signed_keys),t,this.serverPublicKey)}catch(e){if("ValidationError"===e.name)throw new g("Verification of signed_keys failed: "+e.message);throw e}else null!==e.signed_keys&&void 0!==e.signed_keys&&this.log.warn(this.logTag,"Server sent signed keys, but we're not verifying them.");this.initiator.connected=e.initiator_connected,this.log.debug(this.logTag,"Initiator",this.initiator.connected?"":"not","connected"),this.server.handshakeState="done"}},{key:"handleNewInitiator",value:function(){this.initiator=new x(this.initiator.permanentSharedKey.remotePublicKeyBytes,this.permanentKey),this.initiator.connected=!0,this.initPeerHandshake()}},{key:"initPeerHandshake",value:function(){this.initiator.connected&&(null===this.peerTrustedKey&&this.sendToken(),this.sendKey())}},{key:"sendToken",value:function(){var e={type:"token",key:b(this.permanentKey.publicKeyBytes)},t=this.buildPacket(e,this.initiator);this.log.debug(this.logTag,"Sending token"),this.ws.send(t),this.initiator.handshakeState="token-sent"}},{key:"sendKey",value:function(){this.initiator.setLocalSessionKey(new T(void 0,this.log));var e={type:"key",key:b(this.initiator.localSessionKey.publicKeyBytes)},t=this.buildPacket(e,this.initiator);this.log.debug(this.logTag,"Sending key"),this.ws.send(t),this.initiator.handshakeState="key-sent"}},{key:"handleKey",value:function(e){this.initiator.setSessionSharedKey(new Uint8Array(e.key)),this.initiator.handshakeState="key-received"}},{key:"sendAuth",value:function(e){if(e.cookie.equals(this.initiator.cookiePair.ours))throw new g("Their cookie and our cookie are the same.");var t={},n=!0,r=!1,i=void 0;try{for(var o,s=this.tasks[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value;t[a.getName()]=a.getData()}}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}var c=this.tasks.map(function(e){return e.getName()}),h={type:"auth",your_cookie:b(e.cookie.bytes),tasks:c,data:t},u=this.buildPacket(h,this.initiator);this.log.debug(this.logTag,"Sending auth"),this.ws.send(u),this.initiator.handshakeState="auth-sent"}},{key:"handleAuth",value:function(e,t){this.validateRepeatedCookie(this.initiator,new Uint8Array(e.your_cookie));try{u.validateTaskInfo(e.task,e.data)}catch(e){if("ValidationError"===e.name)throw new g("Peer sent invalid task info: "+e.message);throw e}var n=null,r=!0,i=!1,o=void 0;try{for(var s,a=this.tasks[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var c=s.value;if(c.getName()===e.task){n=c,this.log.info(this.logTag,"Task",e.task,"has been selected");break}}}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}if(null===n)throw new y(l.CloseCode.ProtocolError,"Initiator selected unknown task");this.initTask(n,e.data[n.getName()]),this.log.debug(this.logTag,"Initiator authenticated"),this.initiator.cookiePair.theirs=t.cookie,this.initiator.handshakeState="auth-received"}},{key:"_handleSendError",value:function(e){if(e!==j.SALTYRTC_ADDR_INITIATOR)throw new g("Outgoing c2c messages must have been sent to the initiator");this.client.emit({type:"signaling-connection-lost",data:e}),this.resetConnection(l.CloseCode.ProtocolError)}}],[{key:"validateTaskInfo",value:function(e,t){if(0===e.length)throw new c("Task name must not be empty");if(Object.keys(t).length<1)throw new c("Task data must not be empty");if(1<Object.keys(t).length)throw new c("Task data must contain exactly 1 key");if(!t.hasOwnProperty(e))throw new c("Task data must contain an entry for the chosen task")}}]),u}(),U=function(){function n(){d(this,n),this.hasConnectionInfo=!1,this.hasKeyStore=!1,this.hasInitiatorInfo=!1,this.hasTrustedPeerKey=!1,this.hasTasks=!1,this.serverInfoFactory=null,this.pingInterval=0,this.logLevel="none"}return s(n,[{key:"requireKeyStore",value:function(){if(!this.hasKeyStore)throw new Error("Keys not set yet. Please call .withKeyStore method first.")}},{key:"requireConnectionInfo",value:function(){if(!this.hasConnectionInfo)throw new Error("Connection info not set yet. Please call .connectTo method first.")}},{key:"requireTasks",value:function(){if(!this.hasTasks)throw new Error("Tasks not set yet. Please call .usingTasks method first.")}},{key:"requireInitiatorInfo",value:function(){if(!this.hasInitiatorInfo)throw new Error("Initiator info not set yet. Please call .initiatorInfo method first.")}},{key:"connectTo",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:8765;return n.validateHost(e),this.host=e,this.port=t,this.hasConnectionInfo=!0,this}},{key:"connectWith",value:function(e){return this.serverInfoFactory=e,this.hasConnectionInfo=!0,this}},{key:"withKeyStore",value:function(e){return this.keyStore=e,this.hasKeyStore=!0,this}},{key:"withTrustedPeerKey",value:function(e){return this.peerTrustedKey=r(e,"Peer key"),this.hasTrustedPeerKey=!0,this}},{key:"usingTasks",value:function(e){if(e.length<1)throw new Error("You must specify at least 1 task");return this.tasks=e,this.hasTasks=!0,this}},{key:"withPingInterval",value:function(e){if(e<0)throw new Error("Ping interval may not be negative");return this.pingInterval=e,this}},{key:"withServerKey",value:function(e){return this.serverPublicKey=r(e,"Server public key"),this}},{key:"withLoggingLevel",value:function(e){return this.logLevel=e,this}},{key:"initiatorInfo",value:function(e,t){return this.initiatorPublicKey=r(e,"Initiator public key"),this.authToken=r(t,"Auth token"),this.hasInitiatorInfo=!0,this}},{key:"processServerInfo",value:function(e,t){var n=e(k(t));this.host=n.host,this.port=n.port}},{key:"asInitiator",value:function(){if(this.requireConnectionInfo(),this.requireKeyStore(),this.requireTasks(),this.hasInitiatorInfo)throw new Error("Cannot initialize as initiator if .initiatorInfo(...) has been used");return null!==this.serverInfoFactory&&this.processServerInfo(this.serverInfoFactory,this.keyStore.publicKeyBytes),this.hasTrustedPeerKey?new B(new p(this.logLevel),this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.peerTrustedKey).asInitiator():new B(new p(this.logLevel),this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval).asInitiator()}},{key:"asResponder",value:function(){return this.requireConnectionInfo(),this.requireKeyStore(),this.requireTasks(),this.hasTrustedPeerKey?(null!==this.serverInfoFactory&&this.processServerInfo(this.serverInfoFactory,this.peerTrustedKey),new B(new p(this.logLevel),this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.peerTrustedKey).asResponder()):(this.requireInitiatorInfo(),null!==this.serverInfoFactory&&this.processServerInfo(this.serverInfoFactory,this.initiatorPublicKey),new B(new p(this.logLevel),this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval).asResponder(this.initiatorPublicKey,this.authToken))}}],[{key:"validateHost",value:function(e){if(e.endsWith("/"))throw new Error("SaltyRTC host may not end with a slash");if(-1!==e.indexOf("//"))throw new Error("SaltyRTC host should not contain protocol")}}]),n}(),B=function(){function c(e,t,n,r,i,o,s,a){if(d(this,c),this.peerTrustedKey=null,this._signaling=null,this.logTag="[SaltyRTC.Client]",void 0===t)throw new Error("SaltyRTC must be initialized with a permanent key");if(void 0===n)throw new Error("SaltyRTC must be initialized with a target host");if(void 0===o||0===o.length)throw new Error("SaltyRTC must be initialized with at least 1 task");this.log=e,this.host=n,this.port=r,this.permanentKey=t,this.tasks=o,this.pingInterval=s,void 0!==a&&(this.peerTrustedKey=a),void 0!==i&&(this.serverPublicKey=i),this.eventRegistry=new v}return s(c,[{key:"asInitiator",value:function(){return null!==this.peerTrustedKey?this._signaling=new F(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey,this.peerTrustedKey):this._signaling=new F(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey),this}},{key:"asResponder",value:function(e,t){if(null!==this.peerTrustedKey)this._signaling=new M(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey,this.peerTrustedKey);else{var n=new $(t,this.log);this._signaling=new M(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey,e,n)}return this}},{key:"getTask",value:function(){return this.signaling.task}},{key:"getCurrentPeerCsn",value:function(){return this.signaling.getCurrentPeerCsn()}},{key:"encryptForPeer",value:function(e,t){return this.signaling.encryptForPeer(e,t)}},{key:"decryptFromPeer",value:function(e){return this.signaling.decryptFromPeer(e)}},{key:"connect",value:function(){this.signaling.connect()}},{key:"disconnect",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.signaling.disconnect(e)}},{key:"on",value:function(e,t){this.eventRegistry.register(e,t)}},{key:"once",value:function(e,r){var i=this;this.eventRegistry.register(e,function t(n){try{r(n)}catch(e){throw i.off(n.type,t),e}i.off(n.type,t)})}},{key:"off",value:function(e,t){void 0===e?this.eventRegistry.unregisterAll():this.eventRegistry.unregister(e,t)}},{key:"emit",value:function(t){this.log.debug(this.logTag,"New event:",t.type);var e=this.eventRegistry.get(t.type),n=!0,r=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value;try{this.callHandler(a,t)}catch(e){this.log.error(this.logTag,"Unhandled exception in",t.type,"handler:",e)}}}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}}},{key:"sendApplicationMessage",value:function(e){this.signaling.sendApplication({type:"application",data:e})}},{key:"callHandler",value:function(e,t){!1===e(t)&&this.eventRegistry.unregister(t.type,e)}},{key:"signaling",get:function(){if(null===this._signaling)throw Error("SaltyRTC instance not initialized. Use .asInitiator() or .asResponder().");return this._signaling}},{key:"state",get:function(){return this.signaling.getState()}},{key:"keyStore",get:function(){return this.permanentKey}},{key:"permanentKeyBytes",get:function(){return this.signaling.permanentKeyBytes}},{key:"permanentKeyHex",get:function(){return k(this.signaling.permanentKeyBytes)}},{key:"authTokenBytes",get:function(){return this.signaling.authTokenBytes}},{key:"authTokenHex",get:function(){return this.signaling.authTokenBytes?k(this.signaling.authTokenBytes):null}},{key:"peerPermanentKeyBytes",get:function(){return this.signaling.peerPermanentKeyBytes}},{key:"peerPermanentKeyHex",get:function(){return k(this.signaling.peerPermanentKeyBytes)}}]),c}();return l.exceptions=n,l.SaltyRTCBuilder=U,l.KeyStore=T,l.Box=S,l.Cookie=_,l.CookiePair=E,l.CombinedSequence=I,l.CombinedSequencePair=R,l.EventRegistry=v,l.explainCloseCode=i,l.SignalingError=y,l.ConnectionError=t,l.Log=p,l}({},nacl,msgpack);

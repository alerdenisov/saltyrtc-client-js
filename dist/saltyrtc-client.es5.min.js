/**
 * saltyrtc-client-js v0.1.8
 * SaltyRTC JavaScript implementation
 * https://github.com/saltyrtc/saltyrtc-client-js
 *
 * Copyright (C) 2016 Threema GmbH
 *
 * This software may be modified and distributed under the terms
 * of the MIT license:
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";this.saltyrtc=this.saltyrtc||{},function(e){function t(e){var t=[],r=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;t.push(a.toString(16).replace(/^([\da-f])$/,"0$1"))}}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}return t.join("")}function r(e){return"0x"+("00"+e.toString(16)).substr(-2)}function n(){var e=window.crypto||window.msCrypto;return e.getRandomValues(new Uint32Array(1))[0]}function i(){for(var e=0,t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];var i=!0,o=!1,s=void 0;try{for(var a,u=r[Symbol.iterator]();!(i=(a=u.next()).done);i=!0){var f=a.value;e+=f.length}}catch(e){o=!0,s=e}finally{try{!i&&u.return&&u.return()}finally{if(o)throw s}}var h=new Uint8Array(e),c=0,l=!0,d=!1,y=void 0;try{for(var p,g=r[Symbol.iterator]();!(l=(p=g.next()).done);l=!0){var v=p.value;h.set(v,c),c+=v.length}}catch(e){d=!0,y=e}finally{try{!l&&g.return&&g.return()}finally{if(d)throw y}}return h}function o(e){switch(e){case m.ClosingNormal:return"Normal closing";case m.GoingAway:return"The endpoint is going away";case m.NoSharedSubprotocol:return"No shared subprotocol could be found";case m.PathFull:return"No free responder byte";case m.ProtocolError:return"Protocol error";case m.InternalError:return"Internal error";case m.Handover:return"Handover finished";case m.DroppedByInitiator:return"Dropped by initiator";case m.InitiatorCouldNotDecrypt:return"Initiator could not decrypt a message";case m.NoSharedTask:return"No shared task was found";default:return"Unknown"}}function s(e){this.message=e,"captureStackTrace"in Error?Error.captureStackTrace(this,s):this.stack=(new Error).stack}function a(e,t,r,n){try{return t.decrypt(e,r)}catch(e){throw"decryption-failed"===e?new T(m.ProtocolError,"Could not decrypt "+n+" message."):e}}function u(e){return e>=2&&e<=255}var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h=(function(){function e(e){this.value=e}function t(t){function r(e,t){return new Promise(function(r,i){var a={key:e,arg:t,resolve:r,reject:i,next:null};s?s=s.next=a:(o=s=a,n(e,t))})}function n(r,o){try{var s=t[r](o),a=s.value;a instanceof e?Promise.resolve(a.value).then(function(e){n("next",e)},function(e){n("throw",e)}):i(s.done?"return":"normal",s.value)}catch(e){i("throw",e)}}function i(e,t){switch(e){case"return":o.resolve({value:t,done:!0});break;case"throw":o.reject(t);break;default:o.resolve({value:t,done:!1})}o=o.next,o?n(o.key,o.arg):s=null}var o,s;this._invoke=r,"function"!=typeof t.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),c=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},d=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};!function(t){if("object"==("undefined"==typeof e?"undefined":f(e))&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r;r="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,r.msgpack=t()}}(function(){return function e(t,r,n){function i(s,a){if(!r[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var f=new Error("Cannot find module '"+s+"'");throw f.code="MODULE_NOT_FOUND",f}var h=r[s]={exports:{}};t[s][0].call(h.exports,function(e){var r=t[s][1][e];return i(r?r:e)},h,h.exports,e,t,r,n)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(e,t,r){r.encode=e("./encode").encode,r.decode=e("./decode").decode,r.Encoder=e("./encoder").Encoder,r.Decoder=e("./decoder").Decoder,r.createCodec=e("./ext").createCodec,r.codec=e("./codec").codec},{"./codec":4,"./decode":6,"./decoder":7,"./encode":9,"./encoder":10,"./ext":14}],2:[function(e,t,r){(function(t){function n(e,t){for(var r=this,n=t||0,i=e.length,o=0;i>o;o++){var s=e.charCodeAt(o);128>s?r[n++]=s:2048>s?(r[n++]=192|s>>6,r[n++]=128|63&s):(r[n++]=224|s>>12,r[n++]=128|s>>6&63,r[n++]=128|63&s)}return n-t}function i(e,t){var r=this,n=e-0||0;t||(t=r.length);var i=t-e;i>l&&(i=l);for(var o=[];t>n;){for(var s=new Array(i),a=0;i>a&&t>n;){var u=r[n++];u=128>u?u:224>u?(63&u)<<6|63&r[n++]:(63&u)<<12|(63&r[n++])<<6|63&r[n++],s[a++]=u}i>a&&(s=s.slice(0,a)),o.push(String.fromCharCode.apply("",s))}return o.length>1?o.join(""):o.length?o.shift():""}function o(e,t,r,n){var i;r||(r=0),n||0===n||(n=this.length),t||(t=0);var o=n-r;if(e===this&&t>r&&n>t)for(i=o-1;i>=0;i--)e[i+t]=this[i+r];else for(i=0;o>i;i++)e[i+t]=this[i+r];return o}function s(e,r){function n(e){r+=e.length}function i(e){t.isBuffer(e)?e.copy(s,a):o.call(e,s,a),a+=e.length}r||(r=0,Array.prototype.forEach.call(e,n));var s=new t(r),a=0;return Array.prototype.forEach.call(e,i),s}function a(e,t){new h(this,t,e)}function u(e,t){new c(this,t,e)}var f=e("int64-buffer"),h=f.Uint64BE,c=f.Int64BE,l=8192;r.writeString=n,r.readString=i,r.copy=o,r.concat=s,r.writeUint64BE=a,r.writeInt64BE=u}).call(this,e("buffer").Buffer)},{buffer:23,"int64-buffer":27}],3:[function(e,t,r){function n(e){return this instanceof n?(this.options=e,void this.init()):new n(e)}function i(e){for(var t in e)n.prototype[t]=o(n.prototype[t],e[t])}function o(e,t){function r(){return e.apply(this,arguments),t.apply(this,arguments)}return e&&t?r:e||t}function s(e){function t(e,t){return t(e)}return e=e.slice(),function(r){return e.reduce(t,r)}}function a(e){return f(e)?s(e):e}function u(e){return new n(e)}var f=e("isarray");r.createCodec=u,r.install=i,r.filter=a,n.prototype.init=function(){return this},r.preset=u({preset:!0})},{isarray:28}],4:[function(e,t,r){e("./read-core"),e("./write-core"),r.codec={preset:e("./codec-base").preset}},{"./codec-base":3,"./read-core":16,"./write-core":19}],5:[function(e,t,r){function n(e){return this instanceof n?void(e&&(this.options=e,e.codec&&(this.codec=e.codec))):new n(e)}r.DecodeBuffer=n;var i=e("./read-core").preset,o=e("./flex-buffer").FlexDecoder;o.mixin(n.prototype),n.prototype.codec=i,n.prototype.fetch=function(){return this.codec.decode(this)}},{"./flex-buffer":15,"./read-core":16}],6:[function(e,t,r){function n(e,t){var r=new i(t);return r.write(e),r.read()}r.decode=n;var i=e("./decode-buffer").DecodeBuffer},{"./decode-buffer":5}],7:[function(e,t,r){function n(e){return this instanceof n?void o.call(this,e):new n(e)}r.Decoder=n;var i=e("event-lite"),o=e("./decode-buffer").DecodeBuffer;n.prototype=new o,i.mixin(n.prototype),n.prototype.decode=function(e){arguments.length&&this.write(e),this.flush()},n.prototype.push=function(e){this.emit("data",e)},n.prototype.end=function(e){this.decode(e),this.emit("end")}},{"./decode-buffer":5,"event-lite":25}],8:[function(e,t,r){function n(e){return this instanceof n?void(e&&(this.options=e,e.codec&&(this.codec=e.codec))):new n(e)}r.EncodeBuffer=n;var i=e("./write-core").preset,o=e("./flex-buffer").FlexEncoder;o.mixin(n.prototype),n.prototype.codec=i,n.prototype.write=function(e){this.codec.encode(this,e)}},{"./flex-buffer":15,"./write-core":19}],9:[function(e,t,r){function n(e,t){var r=new i(t);return r.write(e),r.read()}r.encode=n;var i=e("./encode-buffer").EncodeBuffer},{"./encode-buffer":8}],10:[function(e,t,r){function n(e){return this instanceof n?void o.call(this,e):new n(e)}r.Encoder=n;var i=e("event-lite"),o=e("./encode-buffer").EncodeBuffer;n.prototype=new o,i.mixin(n.prototype),n.prototype.encode=function(e){this.write(e),this.emit("data",this.read())},n.prototype.end=function(e){arguments.length&&this.encode(e),this.flush(),this.emit("end")}},{"./encode-buffer":8,"event-lite":25}],11:[function(e,t,r){function n(e,t){return this instanceof n?(this.buffer=e,void(this.type=t)):new n(e,t)}r.ExtBuffer=n},{}],12:[function(e,t,r){(function(t){function n(e){e.addExtPacker(14,Error,[u,i]),e.addExtPacker(1,EvalError,[u,i]),e.addExtPacker(2,RangeError,[u,i]),e.addExtPacker(3,ReferenceError,[u,i]),e.addExtPacker(4,SyntaxError,[u,i]),e.addExtPacker(5,TypeError,[u,i]),e.addExtPacker(6,URIError,[u,i]),e.addExtPacker(10,RegExp,[a,i]),e.addExtPacker(11,Boolean,[s,i]),e.addExtPacker(12,String,[s,i]),e.addExtPacker(13,Date,[Number,i]),e.addExtPacker(15,Number,[s,i]),"undefined"!=typeof Uint8Array&&(e.addExtPacker(17,Int8Array,o),e.addExtPacker(18,Uint8Array,o),e.addExtPacker(19,Int16Array,f),e.addExtPacker(20,Uint16Array,f),e.addExtPacker(21,Int32Array,f),e.addExtPacker(22,Uint32Array,f),e.addExtPacker(23,Float32Array,f),"undefined"!=typeof Float64Array&&e.addExtPacker(24,Float64Array,f),"undefined"!=typeof Uint8ClampedArray&&e.addExtPacker(25,Uint8ClampedArray,o),e.addExtPacker(26,ArrayBuffer,h),e.addExtPacker(29,DataView,f)),e.addExtPacker(27,t,o)}function i(t){return c||(c=e("./encode").encode),c(t)}function o(e){return new t(e)}function s(e){return e.valueOf()}function a(e){e=RegExp.prototype.toString.call(e).split("/"),e.shift();var t=[e.pop()];return t.unshift(e.join("/")),t}function u(e){var t={};for(var r in l)t[r]=e[r];return t}function f(e){return new t(new Uint8Array(e.buffer))}function h(e){return new t(new Uint8Array(e))}r.setExtPackers=n;var c,l={name:1,message:1,stack:1,columnNumber:1,fileName:1,lineNumber:1}}).call(this,e("buffer").Buffer)},{"./encode":9,buffer:23}],13:[function(e,t,r){(function(t){function n(e){e.addExtUnpacker(14,[i,s(Error)]),e.addExtUnpacker(1,[i,s(EvalError)]),e.addExtUnpacker(2,[i,s(RangeError)]),e.addExtUnpacker(3,[i,s(ReferenceError)]),e.addExtUnpacker(4,[i,s(SyntaxError)]),e.addExtUnpacker(5,[i,s(TypeError)]),e.addExtUnpacker(6,[i,s(URIError)]),e.addExtUnpacker(10,[i,o]),e.addExtUnpacker(11,[i,a(Boolean)]),e.addExtUnpacker(12,[i,a(String)]),e.addExtUnpacker(13,[i,a(Date)]),e.addExtUnpacker(15,[i,a(Number)]),"undefined"!=typeof Uint8Array&&(e.addExtUnpacker(17,a(Int8Array)),e.addExtUnpacker(18,a(Uint8Array)),e.addExtUnpacker(19,[u,a(Int16Array)]),e.addExtUnpacker(20,[u,a(Uint16Array)]),e.addExtUnpacker(21,[u,a(Int32Array)]),e.addExtUnpacker(22,[u,a(Uint32Array)]),e.addExtUnpacker(23,[u,a(Float32Array)]),"undefined"!=typeof Float64Array&&e.addExtUnpacker(24,[u,a(Float64Array)]),"undefined"!=typeof Uint8ClampedArray&&e.addExtUnpacker(25,a(Uint8ClampedArray)),e.addExtUnpacker(26,u),e.addExtUnpacker(29,[u,a(DataView)])),e.addExtUnpacker(27,a(t))}function i(t){return f||(f=e("./decode").decode),f(t)}function o(e){return RegExp.apply(null,e)}function s(e){return function(t){var r=new e;for(var n in h)r[n]=t[n];return r}}function a(e){return function(t){return new e(t)}}function u(e){return new Uint8Array(e).buffer}r.setExtUnpackers=n;var f,h={name:1,message:1,stack:1,columnNumber:1,fileName:1,lineNumber:1}}).call(this,e("buffer").Buffer)},{"./decode":6,buffer:23}],14:[function(e,t,r){e("./read-core"),e("./write-core"),r.createCodec=e("./codec-base").createCodec},{"./codec-base":3,"./read-core":16,"./write-core":19}],15:[function(e,t,r){(function(t){function n(){return this instanceof n?void 0:new n}function i(){return this instanceof i?void 0:new i}function o(){function e(e){var t=this.offset?this.buffer.slice(this.offset):this.buffer;this.buffer=t?e?d.concat([t,e]):t:e,this.offset=0}function t(){for(;this.offset<this.buffer.length;){var e,t=this.offset;try{e=this.fetch()}catch(e){if(e!==g)throw e;this.offset=t;break}this.push(e)}}function r(e){var t=this.offset,r=t+e;if(r>this.buffer.length)throw g;return this.offset=r,t}return{write:e,fetch:u,flush:t,push:h,pull:c,read:f,reserve:r,offset:0}}function s(){function e(){var e=this.start;if(e<this.offset){var t=this.start=this.offset;return this.buffer.slice(e,t)}}function r(){for(;this.start<this.offset;){var e=this.fetch();e&&this.push(e)}}function n(){var e=this.buffers||(this.buffers=[]),t=e.length>1?d.concat(e):e[0];return e.length=0,t}function i(e){var r=0|e;if(this.buffer){var n=this.buffer.length,i=0|this.offset,o=i+r;if(n>o)return this.offset=o,i;this.flush(),e=Math.max(e,Math.min(2*n,this.maxBufferSize))}return e=Math.max(e,this.minBufferSize),this.buffer=new t(e),this.start=0,this.offset=r,0}function o(e){var r=this.offset+e.length;r<this.buffer.length?(t.isBuffer(e)&&t.isBuffer(this.buffer)?e.copy(this.buffer,this.offset):d.copy.call(e,this.buffer,this.offset),this.offset=r):(this.flush(),this.push(e))}return{write:a,fetch:e,flush:r,push:h,pull:n,read:f,reserve:i,send:o,maxBufferSize:p,minBufferSize:y,offset:0,start:0}}function a(){throw new Error("method not implemented: write()")}function u(){throw new Error("method not implemented: fetch()")}function f(){var e=this.buffers&&this.buffers.length;return e?(this.flush(),this.pull()):this.fetch()}function h(e){var t=this.buffers||(this.buffers=[]);t.push(e)}function c(){var e=this.buffers||(this.buffers=[]);return e.shift()}function l(e){function t(t){for(var r in e)t[r]=e[r];return t}return t}var d=e("./buffer-lite");r.FlexDecoder=n,r.FlexEncoder=i;var y=2048,p=65536,g=new Error("BUFFER_SHORTAGE");n.mixin=l(o()),n.mixin(n.prototype),i.mixin=l(s()),i.mixin(i.prototype)}).call(this,e("buffer").Buffer)},{"./buffer-lite":2,buffer:23}],16:[function(e,t,r){function n(e){function t(e){var t=f(e),n=r[t];if(!n)throw new Error("Invalid type: "+(t?"0x"+t.toString(16):t));return n(e)}var r=h.getReadToken(e);return t}function i(){var e=this.options;return this.decode=n(e),e&&e.preset&&u.setExtUnpackers(this),this}function o(e,t){var r=this.extUnpackers||(this.extUnpackers=[]);r[e]=c.filter(t)}function s(e){function t(t){return new a(t,e)}var r=this.extUnpackers||(this.extUnpackers=[]);return r[e]||t}var a=e("./ext-buffer").ExtBuffer,u=e("./ext-unpacker"),f=e("./read-format").readUint8,h=e("./read-token"),c=e("./codec-base");c.install({addExtUnpacker:o,getExtUnpacker:s,init:i}),r.preset=i.call(c.preset)},{"./codec-base":3,"./ext-buffer":11,"./ext-unpacker":13,"./read-format":17,"./read-token":18}],17:[function(e,t,r){(function(t){function n(e){var r=R&&e&&e.binarraybuffer,n={map:i,array:o,str:s,bin:r?u:a,ext:f,uint8:h,uint16:c,uint32:l(4,t.prototype.readUInt32BE),uint64:l(8,d),int8:l(1,t.prototype.readInt8),int16:l(2,t.prototype.readInt16BE),int32:l(4,t.prototype.readInt32BE),int64:l(8,y),float32:l(4,v),float64:l(8,w)};return e&&e.int64&&(n.uint64=l(8,p),n.int64=l(8,g)),n}function i(e,t){var r,n={},i=new Array(t),o=new Array(t),s=e.codec.decode;for(r=0;t>r;r++)i[r]=s(e),o[r]=s(e);for(r=0;t>r;r++)n[i[r]]=o[r];return n}function o(e,t){for(var r=new Array(t),n=e.codec.decode,i=0;t>i;i++)r[i]=n(e);return r}function s(e,r){var n=e.reserve(r),i=n+r,o=e.buffer;return S||!t.isBuffer(o)?A.readString.call(o,n,i):o.toString("utf-8",n,i)}function a(e,t){var r=e.reserve(t),n=r+t;return k.call(e.buffer,r,n)}function u(e,t){var r=e.reserve(t),n=r+t,i=new Uint8Array(t);return A.copy.call(e.buffer,i,0,r,n),i.buffer}function f(e,t){var r=e.reserve(t),n=e.buffer[r++],i=r+t,o=e.codec.getExtUnpacker(n);if(!o)throw new Error("Invalid ext type: "+(n?"0x"+n.toString(16):n));var s=k.call(e.buffer,r,i);return o(s)}function h(e){var t=e.reserve(1);return e.buffer[t]}function c(e){var t=e.reserve(2),r=e.buffer;return r[t++]<<8|r[t]}function l(e,t){return function(r){var n=r.reserve(e);return t.call(r.buffer,n,_)}}function d(e){return new E(this,e).toNumber()}function y(e){return new T(this,e).toNumber()}function p(e){return new E(this,e)}function g(e){return new T(this,e)}function v(e){return this.readFloatBE?this.readFloatBE(e):b.read(this,e,!1,23,4)}function w(e){return this.readDoubleBE?this.readDoubleBE(e):b.read(this,e,!1,52,8)}function k(e,r){var n=this.slice||Array.prototype.slice,i=n.call(this,e,r);return t.isBuffer(i)||(i=t(i)),i}var b=e("ieee754"),m=e("int64-buffer"),E=m.Uint64BE,T=m.Int64BE;r.getReadFormat=n,r.readUint8=h;var A=e("./buffer-lite"),S="TYPED_ARRAY_SUPPORT"in t,R="undefined"!=typeof Uint8Array,_=!0}).call(this,e("buffer").Buffer)},{"./buffer-lite":2,buffer:23,ieee754:26,"int64-buffer":27}],18:[function(e,t,r){function n(e){var t=f.getReadFormat(e);return e&&e.useraw?o(t):i(t)}function i(e){var t,r=new Array(256);for(t=0;127>=t;t++)r[t]=s(t);for(t=128;143>=t;t++)r[t]=u(t-128,e.map);for(t=144;159>=t;t++)r[t]=u(t-144,e.array);for(t=160;191>=t;t++)r[t]=u(t-160,e.str);for(r[192]=s(null),r[193]=null,r[194]=s(!1),r[195]=s(!0),r[196]=a(e.uint8,e.bin),r[197]=a(e.uint16,e.bin),r[198]=a(e.uint32,e.bin),r[199]=a(e.uint8,e.ext),r[200]=a(e.uint16,e.ext),r[201]=a(e.uint32,e.ext),r[202]=e.float32,r[203]=e.float64,r[204]=e.uint8,r[205]=e.uint16,r[206]=e.uint32,r[207]=e.uint64,r[208]=e.int8,r[209]=e.int16,r[210]=e.int32,r[211]=e.int64,r[212]=u(1,e.ext),r[213]=u(2,e.ext),r[214]=u(4,e.ext),r[215]=u(8,e.ext),r[216]=u(16,e.ext),r[217]=a(e.uint8,e.str),r[218]=a(e.uint16,e.str),r[219]=a(e.uint32,e.str),r[220]=a(e.uint16,e.array),r[221]=a(e.uint32,e.array),r[222]=a(e.uint16,e.map),r[223]=a(e.uint32,e.map),t=224;255>=t;t++)r[t]=s(t-256);return r}function o(e){var t,r=n(e).slice();for(r[217]=r[196],r[218]=r[197],r[219]=r[198],t=160;191>=t;t++)r[t]=u(t-160,e.bin);return r}function s(e){return function(){return e}}function a(e,t){return function(r){var n=e(r);return t(r,n)}}function u(e,t){return function(r){return t(r,e)}}var f=e("./read-format");r.getReadToken=n},{"./read-format":17}],19:[function(e,t,r){function n(e){function t(e,t){var n=r["undefined"==typeof t?"undefined":f(t)];if(!n)throw new Error('Unsupported type "'+("undefined"==typeof t?"undefined":f(t))+'": '+t);n(e,t)}var r=h.getWriteType(e);return t}function i(){var e=this.options;return this.encode=n(e),e&&e.preset&&u.setExtPackers(this),this}function o(e,t,r){function n(t){var n=r(t);return new a(n,e)}r=c.filter(r);var i=t.name;if(i&&"Object"!==i){var o=this.extPackers||(this.extPackers={});o[i]=n}else{var s=this.extEncoderList||(this.extEncoderList=[]);s.unshift([t,n])}}function s(e){var t=this.extPackers||(this.extPackers={}),r=e.constructor,n=r&&r.name&&t[r.name];if(n)return n;for(var i=this.extEncoderList||(this.extEncoderList=[]),o=i.length,s=0;o>s;s++){var a=i[s];if(r===a[0])return a[1]}}var a=e("./ext-buffer").ExtBuffer,u=e("./ext-packer"),h=e("./write-type"),c=e("./codec-base");c.install({addExtPacker:o,getExtPacker:s,init:i}),r.preset=i.call(c.preset)},{"./codec-base":3,"./ext-buffer":11,"./ext-packer":12,"./write-type":21}],20:[function(e,t,r){(function(t){function n(e){return d||e&&e.safe?o():i()}function i(){var e=c.slice();return e[196]=s(196),e[197]=a(197),e[198]=u(198),e[199]=s(199),e[200]=a(200),e[201]=u(201),e[202]=f(202,4,t.prototype.writeFloatBE,!0),e[203]=f(203,8,t.prototype.writeDoubleBE,!0),e[204]=s(204),e[205]=a(205),e[206]=u(206),e[207]=f(207,8,h.writeUint64BE),e[208]=s(208),e[209]=a(209),e[210]=u(210),e[211]=f(211,8,h.writeUint64BE),e[217]=s(217),e[218]=a(218),e[219]=u(219),e[220]=a(220),e[221]=u(221),e[222]=a(222),e[223]=u(223),e}function o(){var e=c.slice();return e[196]=f(196,1,t.prototype.writeUInt8),e[197]=f(197,2,t.prototype.writeUInt16BE),e[198]=f(198,4,t.prototype.writeUInt32BE),e[199]=f(199,1,t.prototype.writeUInt8),e[200]=f(200,2,t.prototype.writeUInt16BE),e[201]=f(201,4,t.prototype.writeUInt32BE),e[202]=f(202,4,t.prototype.writeFloatBE),e[203]=f(203,8,t.prototype.writeDoubleBE),e[204]=f(204,1,t.prototype.writeUInt8),e[205]=f(205,2,t.prototype.writeUInt16BE),e[206]=f(206,4,t.prototype.writeUInt32BE),e[207]=f(207,8,h.writeUint64BE),e[208]=f(208,1,t.prototype.writeInt8),e[209]=f(209,2,t.prototype.writeInt16BE),e[210]=f(210,4,t.prototype.writeInt32BE),e[211]=f(211,8,h.writeUint64BE),e[217]=f(217,1,t.prototype.writeUInt8),e[218]=f(218,2,t.prototype.writeUInt16BE),e[219]=f(219,4,t.prototype.writeUInt32BE),e[220]=f(220,2,t.prototype.writeUInt16BE),e[221]=f(221,4,t.prototype.writeUInt32BE),e[222]=f(222,2,t.prototype.writeUInt16BE),e[223]=f(223,4,t.prototype.writeUInt32BE),e}function s(e){return function(t,r){var n=t.reserve(2),i=t.buffer;i[n++]=e,i[n]=r}}function a(e){return function(t,r){var n=t.reserve(3),i=t.buffer;i[n++]=e,i[n++]=r>>>8,i[n]=r}}function u(e){return function(t,r){var n=t.reserve(5),i=t.buffer;i[n++]=e,i[n++]=r>>>24,i[n++]=r>>>16,i[n++]=r>>>8,i[n]=r}}function f(e,t,r,n){return function(i,o){var s=i.reserve(t+1);i.buffer[s++]=e,r.call(i.buffer,o,s,n)}}var h=e("./buffer-lite"),c=e("./write-uint8").uint8,l="TYPED_ARRAY_SUPPORT"in t,d=l&&!t.TYPED_ARRAY_SUPPORT;r.getWriteToken=n}).call(this,e("buffer").Buffer)},{"./buffer-lite":2,"./write-uint8":22,buffer:23}],21:[function(e,t,r){(function(t){function n(e){function r(e){return e instanceof ArrayBuffer}function n(e,t){var r=t?195:194;x[r](e,t)}function o(e,t){var r,n=0|t;return t!==n?(r=203,void x[r](e,t)):(r=n>=-32&&127>=n?255&n:n>=0?255>=n?204:65535>=n?205:206:n>=-128?208:n>=-32768?209:210,void x[r](e,n))}function p(e,t){var r=207;x[r](e,t.toArray())}function g(e,t){var r=211;x[r](e,t.toArray())}function v(e){return 32>e?1:255>=e?2:65535>=e?3:5}function w(e){return 32>e?1:65535>=e?3:5}function k(e){function r(r,n){var i=n.length,o=5+3*i;r.offset=r.reserve(o);var s=r.buffer,a=e(i),f=r.offset+a;i=u.writeString.call(s,n,f);var h=e(i);if(a!==h){var c=f+h-a,d=f+i;!l&&t.isBuffer(s)?s.copy(s,c,f,d):u.copy.call(s,s,c,f,d)}var y=1===h?160+i:3>=h?215+h:219;x[y](r,i),r.offset+=i}return r}function b(e,t){if(null===t)return E(e,t);if(I(t))return C(e,t);if(i(t))return T(e,t);if(s.isUint64BE(t))return p(e,t);if(a.isInt64BE(t))return g(e,t);var r=e.codec.getExtPacker(t);return r&&(t=r(t)),t instanceof c?R(e,t):void _(e,t)}function m(e,t){return I(t)?P(e,t):void b(e,t)}function E(e,t){var r=192;x[r](e,t)}function T(e,t){var r=t.length,n=16>r?144+r:65535>=r?220:221;x[n](e,r);for(var i=e.codec.encode,o=0;r>o;o++)i(e,t[o])}function A(e,t){var r=t.length,n=255>r?196:65535>=r?197:198;x[n](e,r),e.send(t)}function S(e,t){A(e,new Uint8Array(t))}function R(e,t){var r=t.buffer,n=r.length,i=y[n]||(255>n?199:65535>=n?200:201);x[i](e,n),h[t.type](e),e.send(r)}function _(e,t){var r=Object.keys(t),n=r.length,i=16>n?128+n:65535>=n?222:223;x[i](e,n);var o=e.codec.encode;r.forEach(function(r){o(e,r),o(e,t[r])})}function P(e,t){var r=t.length,n=32>r?160+r:65535>=r?218:219;x[n](e,r),e.send(t)}var x=f.getWriteToken(e),B=e&&e.useraw,U=d&&e&&e.binarraybuffer,I=U?r:t.isBuffer,C=U?S:A,K={boolean:n,function:E,number:o,object:B?m:b,string:k(B?w:v),symbol:E,undefined:E};return K}var i=e("isarray"),o=e("int64-buffer"),s=o.Uint64BE,a=o.Int64BE,u=e("./buffer-lite"),f=e("./write-token"),h=e("./write-uint8").uint8,c=e("./ext-buffer").ExtBuffer,l="TYPED_ARRAY_SUPPORT"in t,d="undefined"!=typeof Uint8Array,y=[];y[1]=212,y[2]=213,y[4]=214,y[8]=215,y[16]=216,r.getWriteType=n}).call(this,e("buffer").Buffer)},{"./buffer-lite":2,"./ext-buffer":11,"./write-token":20,"./write-uint8":22,buffer:23,"int64-buffer":27,isarray:28}],22:[function(e,t,r){function n(e){return function(t){var r=t.reserve(1);t.buffer[r]=e}}for(var i=r.uint8=new Array(256),o=0;255>=o;o++)i[o]=n(o)},{}],23:[function(e,t,r){(function(t){function n(){try{var e=new Uint8Array(1);return e.foo=function(){return 42},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}function i(){return s.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function o(e,t){if(i()<t)throw new RangeError("Invalid typed array length");return s.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t),e.__proto__=s.prototype):(null===e&&(e=new s(t)),e.length=t),e}function s(e,t,r){if(!(s.TYPED_ARRAY_SUPPORT||this instanceof s))return new s(e,t,r);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return h(this,e)}return a(this,e,t,r)}function a(e,t,r,n){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?d(e,t,r,n):"string"==typeof t?c(e,t,r):y(e,t)}function u(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number')}function f(e,t,r,n){return u(t),0>=t?o(e,t):void 0!==r?"string"==typeof n?o(e,t).fill(r,n):o(e,t).fill(r):o(e,t)}function h(e,t){if(u(t),e=o(e,0>t?0:0|p(t)),!s.TYPED_ARRAY_SUPPORT)for(var r=0;t>r;r++)e[r]=0;return e}function c(e,t,r){if("string"==typeof r&&""!==r||(r="utf8"),!s.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var n=0|v(t,r);return e=o(e,n),e.write(t,r),e}function l(e,t){var r=0|p(t.length);e=o(e,r);for(var n=0;r>n;n+=1)e[n]=255&t[n];return e}function d(e,t,r,n){if(t.byteLength,0>r||t.byteLength<r)throw new RangeError("'offset' is out of bounds");if(t.byteLength<r+(n||0))throw new RangeError("'length' is out of bounds");return t=void 0===n?new Uint8Array(t,r):new Uint8Array(t,r,n),s.TYPED_ARRAY_SUPPORT?(e=t,e.__proto__=s.prototype):e=l(e,t),e}function y(e,t){if(s.isBuffer(t)){var r=0|p(t.length);return e=o(e,r),0===e.length?e:(t.copy(e,0,0,r),e)}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||X(t.length)?o(e,0):l(e,t);if("Buffer"===t.type&&$(t.data))return l(e,t.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function p(e){if(e>=i())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i().toString(16)+" bytes");return 0|e}function g(e){return+e!=e&&(e=0),s.alloc(+e)}function v(e,t){if(s.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var n=!1;;)switch(t){case"ascii":case"binary":case"raw":case"raws":return r;case"utf8":case"utf-8":case void 0:return q(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return z(e).length;default:if(n)return q(e).length;t=(""+t).toLowerCase(),n=!0}}function w(e,t,r){var n=!1;if((void 0===t||0>t)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),0>=r)return"";if(r>>>=0,t>>>=0,t>=r)return"";for(e||(e="utf8");;)switch(e){case"hex":return I(this,t,r);case"utf8":case"utf-8":return P(this,t,r);case"ascii":return B(this,t,r);case"binary":return U(this,t,r);case"base64":return _(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function k(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function b(e,t,r,n){function i(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}var o=1,s=e.length,a=t.length;if(void 0!==n&&(n=String(n).toLowerCase(),"ucs2"===n||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;o=2,s/=2,a/=2,r/=2}for(var u=-1,f=0;s>r+f;f++)if(i(e,r+f)===i(t,-1===u?0:f-u)){if(-1===u&&(u=f),f-u+1===a)return(r+u)*o}else-1!==u&&(f-=f-u),u=-1;return-1}function m(e,t,r,n){r=Number(r)||0;var i=e.length-r;n?(n=Number(n),n>i&&(n=i)):n=i;var o=t.length;if(o%2!==0)throw new Error("Invalid hex string");n>o/2&&(n=o/2);for(var s=0;n>s;s++){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[r+s]=a}return s}function E(e,t,r,n){return G(q(t,e.length-r),e,r,n)}function T(e,t,r,n){return G(V(t),e,r,n)}function A(e,t,r,n){return T(e,t,r,n)}function S(e,t,r,n){return G(z(t),e,r,n)}function R(e,t,r,n){return G(W(t,e.length-r),e,r,n)}function _(e,t,r){return 0===t&&r===e.length?J.fromByteArray(e):J.fromByteArray(e.slice(t,r))}function P(e,t,r){r=Math.min(e.length,r);for(var n=[],i=t;r>i;){var o=e[i],s=null,a=o>239?4:o>223?3:o>191?2:1;if(r>=i+a){var u,f,h,c;switch(a){case 1:128>o&&(s=o);break;case 2:u=e[i+1],128===(192&u)&&(c=(31&o)<<6|63&u,c>127&&(s=c));break;case 3:u=e[i+1],f=e[i+2],128===(192&u)&&128===(192&f)&&(c=(15&o)<<12|(63&u)<<6|63&f,c>2047&&(55296>c||c>57343)&&(s=c));break;case 4:u=e[i+1],f=e[i+2],h=e[i+3],128===(192&u)&&128===(192&f)&&128===(192&h)&&(c=(15&o)<<18|(63&u)<<12|(63&f)<<6|63&h,c>65535&&1114112>c&&(s=c))}}null===s?(s=65533,a=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|1023&s),n.push(s),i+=a}return x(n)}function x(e){var t=e.length;if(Z>=t)return String.fromCharCode.apply(String,e);for(var r="",n=0;t>n;)r+=String.fromCharCode.apply(String,e.slice(n,n+=Z));return r}function B(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;r>i;i++)n+=String.fromCharCode(127&e[i]);return n}function U(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;r>i;i++)n+=String.fromCharCode(e[i]);return n}function I(e,t,r){var n=e.length;(!t||0>t)&&(t=0),(!r||0>r||r>n)&&(r=n);for(var i="",o=t;r>o;o++)i+=j(e[o]);return i}function C(e,t,r){for(var n=e.slice(t,r),i="",o=0;o<n.length;o+=2)i+=String.fromCharCode(n[o]+256*n[o+1]);return i}function K(e,t,r){if(e%1!==0||0>e)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function D(e,t,r,n,i,o){if(!s.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||o>t)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function O(e,t,r,n){0>t&&(t=65535+t+1);for(var i=0,o=Math.min(e.length-r,2);o>i;i++)e[r+i]=(t&255<<8*(n?i:1-i))>>>8*(n?i:1-i)}function N(e,t,r,n){0>t&&(t=4294967295+t+1);for(var i=0,o=Math.min(e.length-r,4);o>i;i++)e[r+i]=t>>>8*(n?i:3-i)&255}function L(e,t,r,n,i,o){if(r+n>e.length)throw new RangeError("Index out of range");if(0>r)throw new RangeError("Index out of range")}function M(e,t,r,n,i){return i||L(e,t,r,4,3.4028234663852886e38,-3.4028234663852886e38),Q.write(e,t,r,n,23,4),r+4}function Y(e,t,r,n,i){return i||L(e,t,r,8,1.7976931348623157e308,-1.7976931348623157e308),Q.write(e,t,r,n,52,8),r+8}function H(e){if(e=F(e).replace(ee,""),e.length<2)return"";for(;e.length%4!==0;)e+="=";return e}function F(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function j(e){return 16>e?"0"+e.toString(16):e.toString(16)}function q(e,t){t=t||1/0;for(var r,n=e.length,i=null,o=[],s=0;n>s;s++){if(r=e.charCodeAt(s),r>55295&&57344>r){if(!i){if(r>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===n){(t-=3)>-1&&o.push(239,191,189);continue}i=r;continue}if(56320>r){(t-=3)>-1&&o.push(239,191,189),i=r;continue}r=(i-55296<<10|r-56320)+65536}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,128>r){if((t-=1)<0)break;o.push(r)}else if(2048>r){if((t-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(65536>r){if((t-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(1114112>r))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function V(e){for(var t=[],r=0;r<e.length;r++)t.push(255&e.charCodeAt(r));return t}function W(e,t){for(var r,n,i,o=[],s=0;s<e.length&&!((t-=2)<0);s++)r=e.charCodeAt(s),n=r>>8,i=r%256,o.push(i),o.push(n);return o}function z(e){return J.toByteArray(H(e))}function G(e,t,r,n){for(var i=0;n>i&&!(i+r>=t.length||i>=e.length);i++)t[i+r]=e[i];return i}function X(e){return e!==e}var J=e("base64-js"),Q=e("ieee754"),$=e("isarray");r.Buffer=s,r.SlowBuffer=g,r.INSPECT_MAX_BYTES=50,s.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:n(),
r.kMaxLength=i(),s.poolSize=8192,s._augment=function(e){return e.__proto__=s.prototype,e},s.from=function(e,t,r){return a(null,e,t,r)},s.TYPED_ARRAY_SUPPORT&&(s.prototype.__proto__=Uint8Array.prototype,s.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&s[Symbol.species]===s&&Object.defineProperty(s,Symbol.species,{value:null,configurable:!0})),s.alloc=function(e,t,r){return f(null,e,t,r)},s.allocUnsafe=function(e){return h(null,e)},s.allocUnsafeSlow=function(e){return h(null,e)},s.isBuffer=function(e){return!(null==e||!e._isBuffer)},s.compare=function(e,t){if(!s.isBuffer(e)||!s.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,n=t.length,i=0,o=Math.min(r,n);o>i;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return n>r?-1:r>n?1:0},s.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},s.concat=function(e,t){if(!$(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return s.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;r++)t+=e[r].length;var n=s.allocUnsafe(t),i=0;for(r=0;r<e.length;r++){var o=e[r];if(!s.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(n,i),i+=o.length}return n},s.byteLength=v,s.prototype._isBuffer=!0,s.prototype.swap16=function(){var e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;e>t;t+=2)k(this,t,t+1);return this},s.prototype.swap32=function(){var e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;e>t;t+=4)k(this,t,t+3),k(this,t+1,t+2);return this},s.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?P(this,0,e):w.apply(this,arguments)},s.prototype.equals=function(e){if(!s.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===s.compare(this,e)},s.prototype.inspect=function(){var e="",t=r.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,t).match(/.{2}/g).join(" "),this.length>t&&(e+=" ... ")),"<Buffer "+e+">"},s.prototype.compare=function(e,t,r,n,i){if(!s.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),0>t||r>e.length||0>n||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(t>>>=0,r>>>=0,n>>>=0,i>>>=0,this===e)return 0;for(var o=i-n,a=r-t,u=Math.min(o,a),f=this.slice(n,i),h=e.slice(t,r),c=0;u>c;++c)if(f[c]!==h[c]){o=f[c],a=h[c];break}return a>o?-1:o>a?1:0},s.prototype.indexOf=function(e,t,r){if("string"==typeof t?(r=t,t=0):t>2147483647?t=2147483647:-2147483648>t&&(t=-2147483648),t>>=0,0===this.length)return-1;if(t>=this.length)return-1;if(0>t&&(t=Math.max(this.length+t,0)),"string"==typeof e&&(e=s.from(e,r)),s.isBuffer(e))return 0===e.length?-1:b(this,e,t,r);if("number"==typeof e)return s.TYPED_ARRAY_SUPPORT&&"function"===Uint8Array.prototype.indexOf?Uint8Array.prototype.indexOf.call(this,e,t):b(this,[e],t,r);throw new TypeError("val must be string, number or Buffer")},s.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},s.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t=0|t,isFinite(r)?(r=0|r,void 0===n&&(n="utf8")):(n=r,r=void 0)}var i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(0>r||0>t)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return m(this,e,t,r);case"utf8":case"utf-8":return E(this,e,t,r);case"ascii":return T(this,e,t,r);case"binary":return A(this,e,t,r);case"base64":return S(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return R(this,e,t,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},s.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Z=4096;s.prototype.slice=function(e,t){var r=this.length;e=~~e,t=void 0===t?r:~~t,0>e?(e+=r,0>e&&(e=0)):e>r&&(e=r),0>t?(t+=r,0>t&&(t=0)):t>r&&(t=r),e>t&&(t=e);var n;if(s.TYPED_ARRAY_SUPPORT)n=this.subarray(e,t),n.__proto__=s.prototype;else{var i=t-e;n=new s(i,void 0);for(var o=0;i>o;o++)n[o]=this[o+e]}return n},s.prototype.readUIntLE=function(e,t,r){e=0|e,t=0|t,r||K(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return n},s.prototype.readUIntBE=function(e,t,r){e=0|e,t=0|t,r||K(e,t,this.length);for(var n=this[e+--t],i=1;t>0&&(i*=256);)n+=this[e+--t]*i;return n},s.prototype.readUInt8=function(e,t){return t||K(e,1,this.length),this[e]},s.prototype.readUInt16LE=function(e,t){return t||K(e,2,this.length),this[e]|this[e+1]<<8},s.prototype.readUInt16BE=function(e,t){return t||K(e,2,this.length),this[e]<<8|this[e+1]},s.prototype.readUInt32LE=function(e,t){return t||K(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},s.prototype.readUInt32BE=function(e,t){return t||K(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},s.prototype.readIntLE=function(e,t,r){e=0|e,t=0|t,r||K(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return i*=128,n>=i&&(n-=Math.pow(2,8*t)),n},s.prototype.readIntBE=function(e,t,r){e=0|e,t=0|t,r||K(e,t,this.length);for(var n=t,i=1,o=this[e+--n];n>0&&(i*=256);)o+=this[e+--n]*i;return i*=128,o>=i&&(o-=Math.pow(2,8*t)),o},s.prototype.readInt8=function(e,t){return t||K(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},s.prototype.readInt16LE=function(e,t){t||K(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt16BE=function(e,t){t||K(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt32LE=function(e,t){return t||K(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},s.prototype.readInt32BE=function(e,t){return t||K(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},s.prototype.readFloatLE=function(e,t){return t||K(e,4,this.length),Q.read(this,e,!0,23,4)},s.prototype.readFloatBE=function(e,t){return t||K(e,4,this.length),Q.read(this,e,!1,23,4)},s.prototype.readDoubleLE=function(e,t){return t||K(e,8,this.length),Q.read(this,e,!0,52,8)},s.prototype.readDoubleBE=function(e,t){return t||K(e,8,this.length),Q.read(this,e,!1,52,8)},s.prototype.writeUIntLE=function(e,t,r,n){if(e=+e,t=0|t,r=0|r,!n){var i=Math.pow(2,8*r)-1;D(this,e,t,r,i,0)}var o=1,s=0;for(this[t]=255&e;++s<r&&(o*=256);)this[t+s]=e/o&255;return t+r},s.prototype.writeUIntBE=function(e,t,r,n){if(e=+e,t=0|t,r=0|r,!n){var i=Math.pow(2,8*r)-1;D(this,e,t,r,i,0)}var o=r-1,s=1;for(this[t+o]=255&e;--o>=0&&(s*=256);)this[t+o]=e/s&255;return t+r},s.prototype.writeUInt8=function(e,t,r){return e=+e,t=0|t,r||D(this,e,t,1,255,0),s.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},s.prototype.writeUInt16LE=function(e,t,r){return e=+e,t=0|t,r||D(this,e,t,2,65535,0),s.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):O(this,e,t,!0),t+2},s.prototype.writeUInt16BE=function(e,t,r){return e=+e,t=0|t,r||D(this,e,t,2,65535,0),s.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):O(this,e,t,!1),t+2},s.prototype.writeUInt32LE=function(e,t,r){return e=+e,t=0|t,r||D(this,e,t,4,4294967295,0),s.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):N(this,e,t,!0),t+4},s.prototype.writeUInt32BE=function(e,t,r){return e=+e,t=0|t,r||D(this,e,t,4,4294967295,0),s.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):N(this,e,t,!1),t+4},s.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t=0|t,!n){var i=Math.pow(2,8*r-1);D(this,e,t,r,i-1,-i)}var o=0,s=1,a=0;for(this[t]=255&e;++o<r&&(s*=256);)0>e&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},s.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t=0|t,!n){var i=Math.pow(2,8*r-1);D(this,e,t,r,i-1,-i)}var o=r-1,s=1,a=0;for(this[t+o]=255&e;--o>=0&&(s*=256);)0>e&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},s.prototype.writeInt8=function(e,t,r){return e=+e,t=0|t,r||D(this,e,t,1,127,-128),s.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),0>e&&(e=255+e+1),this[t]=255&e,t+1},s.prototype.writeInt16LE=function(e,t,r){return e=+e,t=0|t,r||D(this,e,t,2,32767,-32768),s.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):O(this,e,t,!0),t+2},s.prototype.writeInt16BE=function(e,t,r){return e=+e,t=0|t,r||D(this,e,t,2,32767,-32768),s.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):O(this,e,t,!1),t+2},s.prototype.writeInt32LE=function(e,t,r){return e=+e,t=0|t,r||D(this,e,t,4,2147483647,-2147483648),s.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):N(this,e,t,!0),t+4},s.prototype.writeInt32BE=function(e,t,r){return e=+e,t=0|t,r||D(this,e,t,4,2147483647,-2147483648),0>e&&(e=4294967295+e+1),s.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):N(this,e,t,!1),t+4},s.prototype.writeFloatLE=function(e,t,r){return M(this,e,t,!0,r)},s.prototype.writeFloatBE=function(e,t,r){return M(this,e,t,!1,r)},s.prototype.writeDoubleLE=function(e,t,r){return Y(this,e,t,!0,r)},s.prototype.writeDoubleBE=function(e,t,r){return Y(this,e,t,!1,r)},s.prototype.copy=function(e,t,r,n){if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&r>n&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(0>t)throw new RangeError("targetStart out of bounds");if(0>r||r>=this.length)throw new RangeError("sourceStart out of bounds");if(0>n)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var i,o=n-r;if(this===e&&t>r&&n>t)for(i=o-1;i>=0;i--)e[i+t]=this[i+r];else if(1e3>o||!s.TYPED_ARRAY_SUPPORT)for(i=0;o>i;i++)e[i+t]=this[i+r];else Uint8Array.prototype.set.call(e,this.subarray(r,r+o),t);return o},s.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),1===e.length){var i=e.charCodeAt(0);256>i&&(e=i)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!s.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof e&&(e=255&e);if(0>t||this.length<t||this.length<r)throw new RangeError("Out of range index");if(t>=r)return this;t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0);var o;if("number"==typeof e)for(o=t;r>o;o++)this[o]=e;else{var a=s.isBuffer(e)?e:q(new s(e,n).toString()),u=a.length;for(o=0;r-t>o;o++)this[o+t]=a[o%u]}return this};var ee=/[^+\/0-9A-Za-z-_]/g}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"base64-js":24,ieee754:26,isarray:28}],24:[function(e,t,r){function n(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0,r=e.length;r>t;++t)u[t]=e[t],f[e.charCodeAt(t)]=t;f["-".charCodeAt(0)]=62,f["_".charCodeAt(0)]=63}function i(e){var t,r,n,i,o,s,a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");o="="===e[a-2]?2:"="===e[a-1]?1:0,s=new h(3*a/4-o),n=o>0?a-4:a;var u=0;for(t=0,r=0;n>t;t+=4,r+=3)i=f[e.charCodeAt(t)]<<18|f[e.charCodeAt(t+1)]<<12|f[e.charCodeAt(t+2)]<<6|f[e.charCodeAt(t+3)],s[u++]=i>>16&255,s[u++]=i>>8&255,s[u++]=255&i;return 2===o?(i=f[e.charCodeAt(t)]<<2|f[e.charCodeAt(t+1)]>>4,s[u++]=255&i):1===o&&(i=f[e.charCodeAt(t)]<<10|f[e.charCodeAt(t+1)]<<4|f[e.charCodeAt(t+2)]>>2,s[u++]=i>>8&255,s[u++]=255&i),s}function o(e){return u[e>>18&63]+u[e>>12&63]+u[e>>6&63]+u[63&e]}function s(e,t,r){for(var n,i=[],s=t;r>s;s+=3)n=(e[s]<<16)+(e[s+1]<<8)+e[s+2],i.push(o(n));return i.join("")}function a(e){for(var t,r=e.length,n=r%3,i="",o=[],a=16383,f=0,h=r-n;h>f;f+=a)o.push(s(e,f,f+a>h?h:f+a));return 1===n?(t=e[r-1],i+=u[t>>2],i+=u[t<<4&63],i+="=="):2===n&&(t=(e[r-2]<<8)+e[r-1],i+=u[t>>10],i+=u[t>>4&63],i+=u[t<<2&63],i+="="),o.push(i),o.join("")}r.toByteArray=i,r.fromByteArray=a;var u=[],f=[],h="undefined"!=typeof Uint8Array?Uint8Array:Array;n()},{}],25:[function(e,t,r){function n(){return this instanceof n?void 0:new n}!function(e){function r(e){for(var t in f)e[t]=f[t];return e}function n(e,t){return a(this,e).push(t),this}function i(e,t){function r(){o.call(n,e,r),t.apply(this,arguments)}var n=this;return r.originalListener=t,a(n,e).push(r),n}function o(e,t){function r(e){return e!==t&&e.originalListener!==t}var n,i=this;if(arguments.length){if(t){if(n=a(i,e,!0)){if(n=n.filter(r),!n.length)return o.call(i,e);i[u][e]=n}}else if(n=i[u],n&&(delete n[e],!Object.keys(n).length))return o.call(i)}else delete i[u];return i}function s(e,t){function r(e){e.call(o)}function n(e){e.call(o,t)}function i(e){e.apply(o,f)}var o=this,s=a(o,e,!0);if(!s)return!1;var u=arguments.length;if(1===u)s.forEach(r);else if(2===u)s.forEach(n);else{var f=Array.prototype.slice.call(arguments,1);s.forEach(i)}return!!s.length}function a(e,t,r){if(!r||e[u]){var n=e[u]||(e[u]={});return n[t]||(n[t]=[])}}"undefined"!=typeof t&&(t.exports=e);var u="listeners",f={on:n,once:i,off:o,emit:s};r(e.prototype),e.mixin=r}(n)},{}],26:[function(e,t,r){r.read=function(e,t,r,n,i){var o,s,a=8*i-n-1,u=(1<<a)-1,f=u>>1,h=-7,c=r?i-1:0,l=r?-1:1,d=e[t+c];for(c+=l,o=d&(1<<-h)-1,d>>=-h,h+=a;h>0;o=256*o+e[t+c],c+=l,h-=8);for(s=o&(1<<-h)-1,o>>=-h,h+=n;h>0;s=256*s+e[t+c],c+=l,h-=8);if(0===o)o=1-f;else{if(o===u)return s?NaN:(d?-1:1)*(1/0);s+=Math.pow(2,n),o-=f}return(d?-1:1)*s*Math.pow(2,o-n)},r.write=function(e,t,r,n,i,o){var s,a,u,f=8*o-i-1,h=(1<<f)-1,c=h>>1,l=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:o-1,y=n?1:-1,p=0>t||0===t&&0>1/t?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=h):(s=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-s))<1&&(s--,u*=2),t+=s+c>=1?l/u:l*Math.pow(2,1-c),t*u>=2&&(s++,u/=2),s+c>=h?(a=0,s=h):s+c>=1?(a=(t*u-1)*Math.pow(2,i),s+=c):(a=t*Math.pow(2,c-1)*Math.pow(2,i),s=0));i>=8;e[r+d]=255&a,d+=y,a/=256,i-=8);for(s=s<<i|a,f+=i;f>0;e[r+d]=255&s,d+=y,s/=256,f-=8);e[r+d-y]|=128*p}},{}],27:[function(e,t,r){(function(e){var t,n;!function(r){function i(e,t,r,n,i){if(T&&A&&(t instanceof A&&(t=new T(t)),n instanceof A&&(n=new T(n))),!(t||r||n||g))return void(e.buffer=h(S,0));if(!o(t,r)){var u=g||Array;i=r,n=t,r=0,t=new u(8)}e.buffer=t,e.offset=r|=0,"undefined"!=typeof n&&("string"==typeof n?a(t,r,n,i||10):o(n,i)?s(t,r,n,i):"number"==typeof i?(l(t,r,n),l(t,r+4,i)):n>0?d(t,r,n):0>n?y(t,r,n):s(t,r,S,0))}function o(e,t){var r=e&&e.length;return t|=0,r&&r>=t+8&&"string"!=typeof e[t]}function s(e,t,r,n){t|=0,n|=0;for(var i=0;8>i;i++)e[t++]=255&r[n++]}function a(e,t,r,n){var i=0,o=r.length,s=0,a=0;"-"===r[0]&&i++;for(var u=i;o>i;){var f=parseInt(r[i++],n);if(!(f>=0))break;a=a*n+f,s=s*n+Math.floor(a/_),a%=_}u&&(s=~s,a?a=_-a:s++),l(e,t,s),l(e,t+4,a)}function u(e,t,r,n){var i="",o=c(e,t),s=c(e,t+4),a=n&&2147483648&o;for(a&&(o=~o,s=_-s),r=r||10;;){var u=o%r*_+s;if(o=Math.floor(o/r),s=Math.floor(u/r),i=(u%r).toString(r)+i,!o&&!s)break}return a&&(i="-"+i),i}function h(e,t){return Array.prototype.slice.call(e,t,t+8)}function c(e,t){return e[t++]*P+(e[t++]<<16)+(e[t++]<<8)+e[t]}function l(e,t,r){e[t+3]=255&r,r>>=8,e[t+2]=255&r,r>>=8,e[t+1]=255&r,r>>=8,e[t]=255&r}function d(e,t,r){for(var n=t+7;n>=t;n--)e[n]=255&r,r/=256}function y(e,t,r){r++;for(var n=t+7;n>=t;n--)e[n]=255&-r^255,r/=256}function p(e){return!!e&&"[object Array]"==Object.prototype.toString.call(e)}var g,v=r.Uint64BE=t=function(e,r,n,o){return this instanceof t?i(this,e,r,n,o):new t(e,r,n,o)},w=r.Int64BE=n=function(e,t,r,o){return this instanceof n?i(this,e,t,r,o):new n(e,t,r,o)},k=v.prototype,b=w.prototype,m="undefined",E=m!==("undefined"==typeof e?"undefined":f(e))&&e,T=m!==("undefined"==typeof Uint8Array?"undefined":f(Uint8Array))&&Uint8Array,A=m!==("undefined"==typeof ArrayBuffer?"undefined":f(ArrayBuffer))&&ArrayBuffer,S=[0,0,0,0,0,0,0,0],R=Array.isArray||p,_=4294967296,P=16777216;k.buffer=b.buffer=void 0,k.offset=b.offset=0,k._isUint64BE=b._isInt64BE=!0,v.isUint64BE=function(e){return!(!e||!e._isUint64BE)},w.isInt64BE=function(e){return!(!e||!e._isInt64BE)},k.toNumber=function(){var e=this.buffer,t=this.offset,r=c(e,t),n=c(e,t+4);return r?r*_+n:n},b.toNumber=function(){var e=this.buffer,t=this.offset,r=0|c(e,t),n=c(e,t+4);return r?r*_+n:n},k.toArray=b.toArray=function(e){var t=this.buffer,r=this.offset;return g=null,e!==!1&&0===r&&8===t.length&&R(t)?t:h(t,r)},E&&(k.toBuffer=b.toBuffer=function(t){var r=this.buffer,n=this.offset;if(g=E,t!==!1&&0===n&&8===r.length&&e.isBuffer(r))return r;var i=new E(8);return s(i,0,r,n),i}),T&&(k.toArrayBuffer=b.toArrayBuffer=function(e){var t=this.buffer,r=this.offset,n=t.buffer;if(g=T,e!==!1&&0===r&&n instanceof A&&8===n.byteLength)return n;var i=new T(8);return s(i,0,t,r),i.buffer}),b.toString=function(e){return u(this.buffer,this.offset,e,!0)},k.toString=function(e){return u(this.buffer,this.offset,e,!1)},k.toJSON=k.toNumber,b.toJSON=b.toNumber}("object"==("undefined"==typeof r?"undefined":f(r))&&"string"!=typeof r.nodeName?r:this||{})}).call(this,e("buffer").Buffer)},{buffer:23}],28:[function(e,t,r){var n={}.toString;t.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},{}]},{},[1])(1)});var y=function(){function e(t,r,n){h(this,e),this._nonce=t,this._nonceLength=n,this._data=r}return c(e,[{key:"toUint8Array",value:function(){var e=new Uint8Array(this.length);return e.set(this._nonce),e.set(this._data,this._nonceLength),e}},{key:"length",get:function(){return this._nonce.length+this._data.length}},{key:"data",get:function(){return this._data}},{key:"nonce",get:function(){return this._nonce}}],[{key:"fromUint8Array",value:function(t,r){if(void 0===r)throw new Error("nonceLength parameter not specified");if(t.byteLength<=r)throw"bad-message-length";var n=t.slice(0,r),i=t.slice(r);return new e(n,i,r)}}]),e}(),p=function(){function e(r,n){h(this,e),void 0===r||void 0===n?(this._keyPair=nacl.box.keyPair(),console.debug("KeyStore: New public key:",t(this._keyPair.publicKey))):(this._keyPair={publicKey:r,secretKey:n},console.debug("KeyStore: Restored public key:",t(this._keyPair.publicKey)))}return c(e,[{key:"encrypt",value:function(e,t,r){var n=nacl.box(e,t,r,this._keyPair.secretKey);return new y(t,n,nacl.box.nonceLength)}},{key:"decrypt",value:function(e,t){var r=nacl.box.open(e.data,e.nonce,t,this._keyPair.secretKey);if(r===!1)throw"decryption-failed";return r}},{key:"publicKeyHex",get:function(){return t(this._keyPair.publicKey)}},{key:"publicKeyBytes",get:function(){return this._keyPair.publicKey}},{key:"secretKeyHex",get:function(){return t(this._keyPair.secretKey)}},{key:"secretKeyBytes",get:function(){return this._keyPair.secretKey}},{key:"keypair",get:function(){return this._keyPair}}]),e}(),g=function(){function e(t){if(h(this,e),this._authToken=null,"undefined"==typeof t)this._authToken=nacl.randomBytes(nacl.secretbox.keyLength),console.debug("AuthToken: Generated auth token");else{if(t.byteLength!=nacl.secretbox.keyLength)throw console.error("Auth token must be",nacl.secretbox.keyLength,"bytes long."),"bad-token-length";this._authToken=t,console.debug("AuthToken: Initialized auth token")}}return c(e,[{key:"encrypt",value:function(e,t){var r=nacl.secretbox(e,t,this._authToken);return new y(t,r,nacl.secretbox.nonceLength)}},{key:"decrypt",value:function(e){var t=nacl.secretbox.open(e.data,e.nonce,this._authToken);if(t===!1)throw"decryption-failed";return t}},{key:"keyBytes",get:function(){return this._authToken}},{key:"keyHex",get:function(){return t(this._authToken)}}]),e}(),v=function(){function e(t){if(h(this,e),"undefined"!=typeof t){if(16!==t.length)throw"bad-cookie-length";this.bytes=t}else this.bytes=nacl.randomBytes(e.COOKIE_LENGTH)}return c(e,[{key:"asArrayBuffer",value:function(){return this.bytes.buffer.slice(this.bytes.byteOffset,this.bytes.byteLength)}},{key:"equals",value:function(e){if(e.bytes===this.bytes)return!0;if(null==e.bytes||null==this.bytes)return!1;if(e.bytes.byteLength!=this.bytes.byteLength)return!1;for(var t=0;t<this.bytes.byteLength;t++)if(e.bytes[t]!=this.bytes[t])return!1;return!0}}],[{key:"fromArrayBuffer",value:function(t){return new e(new Uint8Array(t))}}]),e}();v.COOKIE_LENGTH=16;var w=function e(t,r){if(h(this,e),this.ours=null,this.theirs=null,"undefined"!=typeof t&&"undefined"!=typeof r)this.ours=t,this.theirs=r;else{if("undefined"!=typeof t||"undefined"!=typeof r)throw new Error("Either both or no cookies must be specified");this.ours=new v}},k=function(){function e(t,r,n,i,o){h(this,e),this._cookie=t,this._overflow=r,this._sequenceNumber=n,this._source=i,this._destination=o}return c(e,[{key:"toArrayBuffer",value:function(){var t=new ArrayBuffer(e.TOTAL_LENGTH),r=new Uint8Array(t);r.set(this._cookie.bytes);var n=new DataView(t);return n.setUint8(16,this._source),n.setUint8(17,this._destination),n.setUint16(18,this._overflow),n.setUint32(20,this._sequenceNumber),t}},{key:"cookie",get:function(){return this._cookie}},{key:"overflow",get:function(){return this._overflow}},{key:"sequenceNumber",get:function(){return this._sequenceNumber}},{key:"combinedSequenceNumber",get:function(){return(this._overflow<<32)+this._sequenceNumber}},{key:"source",get:function(){return this._source}},{key:"destination",get:function(){return this._destination}}],[{key:"fromArrayBuffer",value:function(t){if(t.byteLength!=this.TOTAL_LENGTH)throw"bad-packet-length";var r=new DataView(t),n=new v(new Uint8Array(t,0,16)),i=r.getUint8(16),o=r.getUint8(17),s=r.getUint16(18),a=r.getUint32(20);return new e(n,s,a,i,o)}}]),e}();k.TOTAL_LENGTH=24;var b=function(){function e(){h(this,e),this.sequenceNumber=n(),this.overflow=0}return c(e,[{key:"next",value:function(){if(this.sequenceNumber+1>=e.SEQUENCE_NUMBER_MAX){if(this.sequenceNumber=0,this.overflow+=1,this.overflow>=e.OVERFLOW_MAX)throw console.error("Overflow number just overflowed!"),new Error("overflow-overflow")}else this.sequenceNumber+=1;return{sequenceNumber:this.sequenceNumber,overflow:this.overflow}}}]),e}();b.SEQUENCE_NUMBER_MAX=4294967296,b.OVERFLOW_MAX=1048576;var m,E=function e(t,r){if(h(this,e),this.ours=null,this.theirs=null,"undefined"!=typeof t&&"undefined"!=typeof r)this.ours=t,this.theirs=r;else{if("undefined"!=typeof t||"undefined"!=typeof r)throw new Error("Either both or no combined sequences must be specified");this.ours=new b}};!function(e){e[e.ClosingNormal=1e3]="ClosingNormal",e[e.GoingAway=1001]="GoingAway",e[e.NoSharedSubprotocol=1002]="NoSharedSubprotocol",e[e.PathFull=3e3]="PathFull",e[e.ProtocolError=3001]="ProtocolError",e[e.InternalError=3002]="InternalError",e[e.Handover=3003]="Handover",e[e.DroppedByInitiator=3004]="DroppedByInitiator",e[e.InitiatorCouldNotDecrypt=3005]="InitiatorCouldNotDecrypt",e[e.NoSharedTask=3006]="NoSharedTask"}(m||(m={})),s.prototype=Object.create(Error.prototype),s.prototype.name="InternalError",s.prototype.constructor=s;var T=function(e){function t(e,r){h(this,t);var n=d(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r));return n.message=r,n.closeCode=e,n.name="SignalingError",n}return l(t,e),t}(Error),A=function(e){function t(e){return h(this,t),d(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,m.ProtocolError,e))}return l(t,e),t}(T),S=function(e){function t(e){h(this,t);var r=d(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.message=e,r.name="ConnectionError",r}return l(t,e),t}(Error),R=function(e){function t(e){h(this,t);var r=d(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.message=e,r.name="ValidationError",r}return l(t,e),t}(Error),_=function(){function e(t,r,n,i,s,a){var u=this;h(this,e),this.protocol="wss",this.ws=null,this.msgpackOptions={codec:msgpack.createCodec({binarraybuffer:!0})},this.state="new",this.serverHandshakeState="new",this.handoverState={local:!1,peer:!1},this.task=null,this.serverKey=null,this.sessionKey=null,this.authToken=null,this.peerTrustedKey=null,this.role=null,this.logTag="Signaling:",this.address=e.SALTYRTC_ADDR_UNKNOWN,this.cookiePair=null,this.serverCsn=new b,this.onOpen=function(e){console.info(u.logTag,"Opened connection"),u.setState("server-handshake")},this.onError=function(e){console.error(u.logTag,"General WebSocket error",e),u.client.emit({type:"connection-error",data:e})},this.onClose=function(e){if(e.code===m.Handover)console.info(u.logTag,"Closed WebSocket connection due to handover");else{console.info(u.logTag,"Closed WebSocket connection"),u.setState("closed");var t=function(e){return console.error(u.logTag,"Server closed connection:",e)};switch(e.code){case m.GoingAway:t("Server is being shut down");break;case m.NoSharedSubprotocol:t("No shared sub-protocol could be found");break;case m.PathFull:t("Path full (no free responder byte)");break;case m.ProtocolError:t("Protocol error");break;case m.InternalError:t("Internal server error");break;case m.DroppedByInitiator:t("Dropped by initiator")}u.client.emit({type:"connection-closed",data:e})}},this.onMessage=function(e){console.debug(u.logTag,"New ws message ("+e.data.byteLength+" bytes)");try{var t=y.fromUint8Array(new Uint8Array(e.data),k.TOTAL_LENGTH),r=k.fromArrayBuffer(t.nonce.buffer);switch(u.getState()){case"server-handshake":u.onServerHandshakeMessage(t,r);break;case"peer-handshake":u.onPeerHandshakeMessage(t,r);break;case"task":u.onSignalingMessage(t,r);break;default:console.warn(u.logTag,"Received message in",u.getState(),"signaling state. Ignoring.")}}catch(e){throw e instanceof T?(console.error(u.logTag,"Signaling error: "+o(e.closeCode)),"task"===u.state&&u.sendClose(e.closeCode),u.resetConnection(e.closeCode)):e instanceof S&&(console.warn(u.logTag,"Connection error. Resetting connection."),u.resetConnection(m.InternalError)),e}},this.client=t,this.permanentKey=s,this.host=r,this.port=n,this.tasks=i,void 0!==a&&(this.peerTrustedKey=a)}return c(e,[{key:"setState",value:function(e){this.state=e,this.client.emit({type:"state-change",data:e}),this.client.emit({type:"state-change:"+e})}},{key:"getState",value:function(){return this.state}},{key:"msgpackEncode",value:function(e){return msgpack.encode(e,this.msgpackOptions)}},{key:"msgpackDecode",value:function(e){return msgpack.decode(e,this.msgpackOptions)}},{key:"connect",value:function(){this.resetConnection(),this.initWebsocket()}},{key:"disconnect",value:function(){null!==this.ws&&(console.debug(this.logTag,"Disconnecting WebSocket"),this.ws.close()),this.ws=null,this.setState("closed")}},{key:"initWebsocket",value:function(){var t=this.protocol+"://"+this.host+":"+this.port+"/",r=this.getWebsocketPath();this.ws=new WebSocket(t+r,e.SALTYRTC_SUBPROTOCOL),this.ws.binaryType="arraybuffer",this.ws.addEventListener("open",this.onOpen),this.ws.addEventListener("error",this.onError),this.ws.addEventListener("close",this.onClose),this.ws.addEventListener("message",this.onMessage),this.setState("ws-connecting"),console.debug(this.logTag,"Opening WebSocket connection to",t+r)}},{key:"onServerHandshakeMessage",value:function(e,t){var r=void 0;r="new"===this.serverHandshakeState?e.data:this.permanentKey.decrypt(e,this.serverKey);var n=this.decodeMessage(r,"server handshake");switch(this.serverHandshakeState){case"new":if("server-hello"!==n.type)throw new A("Expected server-hello message, but got "+n.type);console.debug(this.logTag,"Received server-hello"),this.handleServerHello(n,t),this.sendClientHello(),this.sendClientAuth();break;case"hello-sent":throw new A("Received "+n.type+" message before sending client-auth");case"auth-sent":if("server-auth"!==n.type)throw new A("Expected server-auth message, but got "+n.type);console.debug(this.logTag,"Received server-auth"),this.handleServerAuth(n,t);break;case"done":throw new T(m.InternalError,"Received server handshake message even though server handshake state is set to 'done'");default:throw new T(m.InternalError,"Unknown server handshake state: "+this.serverHandshakeState)}"done"===this.serverHandshakeState&&(this.setState("peer-handshake"),console.debug(this.logTag,"Server handshake done"),this.initPeerHandshake())}},{key:"onSignalingMessage",value:function(t,n){if(console.debug("Message received"),n.source===e.SALTYRTC_ADDR_SERVER)this.onSignalingServerMessage(t);else{var i=void 0;try{i=this.decryptFromPeer(t)}catch(e){if("decryption-failed"===e)return void console.warn(this.logTag,"Could not decrypt peer message from",r(n.source));throw e}this.onSignalingPeerMessage(i)}}},{key:"onSignalingServerMessage",value:function(e){var t=this.decryptServerMessage(e);"send-error"===t.type?this.handleSendError(t):console.warn(this.logTag,"Invalid server message type:",t.type)}},{key:"onSignalingPeerMessage",value:function(e){var t=this.decodeMessage(e);"close"===t.type?console.debug("Received close"):"data"===t.type?(console.debug(this.logTag,"Received data"),this.handleData(t)):"restart"===t.type?(console.debug(this.logTag,"Received restart"),this.handleRestart(t)):null!==this.task&&this.task.getSupportedMessageTypes().indexOf(t.type)!==-1?(console.debug(this.logTag,"Received",t.type,"["+this.task.getName()+"]"),this.task.onTaskMessage(t)):console.warn(this.logTag,"Received message with invalid type from peer:",t.type)}},{key:"handleServerHello",value:function(e,t){this.serverKey=new Uint8Array(e.key);var r=void 0;do r=new v;while(r.equals(t.cookie));this.cookiePair=new w(r,t.cookie)}},{key:"sendClientAuth",value:function(){var t={type:"client-auth",your_cookie:this.cookiePair.theirs.asArrayBuffer(),subprotocols:[e.SALTYRTC_SUBPROTOCOL]},r=this.buildPacket(t,e.SALTYRTC_ADDR_SERVER);console.debug(this.logTag,"Sending client-auth"),this.ws.send(r),this.serverHandshakeState="auth-sent"}},{key:"handleData",value:function(e){this.client.emit({type:"data",data:e.data}),"string"==typeof e.data_type&&this.client.emit({type:"data:"+e.data_type,data:e.data})}},{key:"handleRestart",value:function(e){throw new A("Restart messages not yet implemented")}},{key:"handleSendError",value:function(e){throw new A("Send error messages not yet implemented")}},{key:"validateNonce",value:function(e,t,r){if(void 0!==t&&e.destination!==t)throw console.error(this.logTag,"Nonce destination is",e.destination,"but we're",this.address),"bad-nonce-destination";if(void 0!==r&&e.source!==r)throw console.error(this.logTag,"Nonce source is",e.source,"but should be",r),"bad-nonce-source"}},{key:"validateRepeatedCookie",value:function(e){var t=v.fromArrayBuffer(e.your_cookie);if(!t.equals(this.cookiePair.ours))throw console.debug(this.logTag,"Their cookie:",t.bytes),console.debug(this.logTag,"Our cookie:",this.cookiePair.ours.bytes),new A("Peer repeated cookie does not match our cookie")}},{key:"decodeMessage",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.msgpackDecode(e);if(void 0===n.type)throw new A("Malformed "+t+" message: Failed to decode msgpack data.");if(r&&void 0!==t&&n.type!==t)throw new A("Invalid "+t+" message, bad type: "+n);return n}},{key:"buildPacket",value:function(t,r){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=this.getNextCsn(r),s=new k(this.cookiePair.ours,o.overflow,o.sequenceNumber,this.address,r),a=new Uint8Array(s.toArrayBuffer()),f=this.msgpackEncode(t);if(n===!1)return i(a,f);var h=void 0;if(r===e.SALTYRTC_ADDR_SERVER)h=this.encryptHandshakeDataForServer(f,a);else{if(r!==e.SALTYRTC_ADDR_INITIATOR&&!u(r))throw new A("Bad receiver byte: "+r);h=this.encryptHandshakeDataForPeer(r,t.type,f,a)}return h.toUint8Array()}},{key:"encryptHandshakeDataForServer",value:function(e,t){return this.permanentKey.encrypt(e,t,this.serverKey)}},{key:"decryptData",value:function(e){var t=this.sessionKey.decrypt(e,this.getPeerSessionKey()),r=t.byteOffset,n=r+t.byteLength;return t.buffer.slice(r,n);
}},{key:"resetConnection",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:m.ClosingNormal;this.setState("new"),this.serverCsn=new b,null!==this.ws&&(console.debug(this.logTag,"Disconnecting WebSocket (close code "+e+")"),this.ws.close(e)),this.ws=null}},{key:"initTask",value:function(e,t){try{e.init(this,t)}catch(e){if(e instanceof R)throw new A("Peer sent invalid task data");throw e}this.task=e}},{key:"decryptPeerMessage",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];try{var n=this.sessionKey.decrypt(e,this.getPeerSessionKey());return this.decodeMessage(n,"peer")}catch(n){if(t===!0&&"decryption-failed"===n){var i=k.fromArrayBuffer(e.nonce.buffer);throw new A("Could not decrypt peer message from "+r(i.source))}throw n}}},{key:"decryptServerMessage",value:function(e){try{var t=this.permanentKey.decrypt(e,this.serverKey);return this.decodeMessage(t,"server")}catch(e){throw"decryption-failed"===e?new A("Could not decrypt server message"):e}}},{key:"send",value:function(e){if(["server-handshake","peer-handshake","task"].indexOf(this.state)===-1)throw console.error("Trying to send message, but connection state is",this.state),new S("Bad signaling state, cannot send message");this.handoverState.local===!1&&this.ws.send(e)}},{key:"sendTaskMessage",value:function(e){var t=this.getPeerAddress();if(null===t)throw new T(m.InternalError,"No peer address could be found");var r=this.buildPacket(e,t);this.send(r)}},{key:"encryptForPeer",value:function(e,t){return this.sessionKey.encrypt(e,t,this.getPeerSessionKey())}},{key:"decryptFromPeer",value:function(e){return this.sessionKey.decrypt(e,this.getPeerSessionKey())}},{key:"sendClose",value:function(e){}},{key:"permanentKeyBytes",get:function(){return this.permanentKey.publicKeyBytes}},{key:"authTokenBytes",get:function(){return null!==this.authToken?this.authToken.keyBytes:null}},{key:"peerPermanentKeyBytes",get:function(){return this.getPeerPermanentKey()}}]),e}();_.SALTYRTC_SUBPROTOCOL="v0.saltyrtc.org",_.SALTYRTC_ADDR_UNKNOWN=0,_.SALTYRTC_ADDR_SERVER=0,_.SALTYRTC_ADDR_INITIATOR=1;var P=function(){function e(t){h(this,e),this._csn=new b,this.permanentKey=t}return c(e,[{key:"id",get:function(){return this._id}},{key:"hexId",get:function(){return r(this._id)}},{key:"csn",get:function(){return this._csn}}]),e}(),x=function(e){function t(e){h(this,t);var r=d(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.connected=!1,r.handshakeState="new",r._id=1,r}return l(t,e),t}(P),B=function(e){function t(e){h(this,t);var r=d(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.keyStore=new p,r.handshakeState="new",r._id=e,r}return l(t,e),t}(P),U=function(e){function t(e,r,n,i,o,s){h(this,t);var a=d(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n,i,o,s));return a.logTag="Initiator:",a.responders=null,a.responder=null,a.role="initiator",void 0===s&&(a.authToken=new g),a}return l(t,e),c(t,[{key:"getWebsocketPath",value:function(){return this.permanentKey.publicKeyHex}},{key:"getNextCsn",value:function(e){if(e===_.SALTYRTC_ADDR_SERVER)return this.serverCsn.next();if(e===_.SALTYRTC_ADDR_INITIATOR)throw new A("Initiator cannot send messages to initiator");if(u(e)){if("task"===this.getState())return this.responder.csn.next();if(this.responders.has(e))return this.responders.get(e).csn.next();throw new A("Unknown responder: "+e)}throw new A("Bad receiver byte: "+e)}},{key:"encryptHandshakeDataForPeer",value:function(e,t,r,n){if(e===_.SALTYRTC_ADDR_INITIATOR)throw new A("Initiator cannot encrypt messages for initiator");if(!u(e))throw new A("Bad receiver byte: "+e);var i=void 0;if("task"===this.getState())i=this.responder;else{if(!this.responders.has(e))throw new A("Unknown responder: "+e);i=this.responders.get(e)}switch(t){case"key":return this.permanentKey.encrypt(r,n,i.permanentKey);default:return i.keyStore.encrypt(r,n,i.sessionKey)}}},{key:"getPeerAddress",value:function(){return null!==this.responder?this.responder.id:null}},{key:"getPeerSessionKey",value:function(){return null!==this.responder?this.responder.sessionKey:null}},{key:"getPeerPermanentKey",value:function(){return null!==this.responder?this.responder.permanentKey:null}},{key:"processNewResponder",value:function(e){if(this.responders.has(e))console.warn(this.logTag,"Got new-responder message for an already known responder.");else{if(!u(e))throw new A("Invalid responder id: "+e);var t=new B(e);null!==this.peerTrustedKey&&(t.handshakeState="token-received",t.permanentKey=this.peerTrustedKey),this.responders.set(e,t),this.client.emit({type:"new-responder",data:e})}}},{key:"onPeerHandshakeMessage",value:function(e,t){if(t.destination!=this.address)throw new A("Message destination does not match our address");var r=void 0;if(t.source===_.SALTYRTC_ADDR_SERVER){r=a(e,this.permanentKey,this.serverKey,"server");var n=this.decodeMessage(r,"server");switch(n.type){case"new-responder":console.debug(this.logTag,"Received new-responder"),this.handleNewResponder(n);break;default:throw new A("Received unexpected server message: "+n.type)}}else{if(!u(t.source))throw new T(m.InternalError,"Message source is neither the server nor a responder");var i=this.responders.get(t.source);if(null===i)throw new A("Unknown message sender: "+t.source);var o=void 0;switch(i.handshakeState){case"new":if(null!==this.peerTrustedKey)throw new T(m.InternalError,'Handshake state is "new" even though a trusted key is available');try{r=this.authToken.decrypt(e)}catch(e){return console.warn(this.logTag,"Could not decrypt token message: ",e),void this.dropResponder(i.id)}o=this.decodeMessage(r,"token",!0),console.debug(this.logTag,"Received token"),this.handleToken(o,i);break;case"token-received":var s=this.peerTrustedKey||i.permanentKey;try{r=this.permanentKey.decrypt(e,s)}catch(e){if(null!==this.peerTrustedKey)return console.warn(this.logTag,"Could not decrypt key message"),void this.dropResponder(i.id);throw e}o=this.decodeMessage(r,"key",!0),console.debug(this.logTag,"Received key"),this.handleKey(o,i),this.sendKey(i);break;case"key-sent":r=a(e,i.keyStore,i.sessionKey,"auth"),o=this.decodeMessage(r,"auth",!0),console.debug(this.logTag,"Received auth"),this.handleAuth(o,i,t),this.sendAuth(i,t),this.responder=this.responders.get(i.id),this.sessionKey=i.keyStore,this.responders.delete(i.id),this.dropResponders(),this.setState("task"),console.info(this.logTag,"Peer handshake done"),this.task.onPeerHandshakeDone();break;default:throw new T(m.InternalError,"Unknown responder handshake state")}}}},{key:"sendClientHello",value:function(){}},{key:"handleServerAuth",value:function(e,t){this.address=_.SALTYRTC_ADDR_INITIATOR,this.validateNonce(t,this.address,_.SALTYRTC_ADDR_SERVER),this.validateRepeatedCookie(e),this.responders=new Map;var r=!0,n=!1,i=void 0;try{for(var o,s=e.responders[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;this.processNewResponder(a)}}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}console.debug(this.logTag,this.responders.size,"responders connected"),this.serverHandshakeState="done"}},{key:"initPeerHandshake",value:function(){}},{key:"handleNewResponder",value:function(e){this.processNewResponder(e.id)}},{key:"handleToken",value:function(e,t){t.permanentKey=new Uint8Array(e.key),t.handshakeState="token-received"}},{key:"handleKey",value:function(e,t){t.sessionKey=new Uint8Array(e.key),t.handshakeState="key-received"}},{key:"sendKey",value:function(e){var t={type:"key",key:e.keyStore.publicKeyBytes.buffer},r=this.buildPacket(t,e.id);console.debug(this.logTag,"Sending key"),this.ws.send(r),e.handshakeState="key-sent"}},{key:"sendAuth",value:function(e,t){if(t.cookie.equals(this.cookiePair.ours))throw new A("Their cookie and our cookie are the same.");var r={};r[this.task.getName()]=this.task.getData();var n={type:"auth",your_cookie:t.cookie.asArrayBuffer(),task:this.task.getName(),data:r},i=this.buildPacket(n,e.id);console.debug(this.logTag,"Sending auth"),this.ws.send(i),e.handshakeState="auth-sent"}},{key:"handleAuth",value:function(e,r,n){this.validateRepeatedCookie(e);try{t.validateTaskInfo(e.tasks,e.data)}catch(e){if(e instanceof R)throw new A("Peer sent invalid task info: "+e.message);throw e}var i=t.chooseCommonTask(this.tasks,e.tasks);if(null===i)throw new T(m.NoSharedTask,"No shared task could be found");if(console.log(this.logTag,"Task",i.getName(),"has been selected"),this.initTask(i,e.data[i.getName()]),console.debug(this.logTag,"Responder",r.hexId,"authenticated"),n.cookie.equals(this.cookiePair.ours))throw new A("Local and remote cookies are equal");r.cookie=n.cookie,r.handshakeState="auth-received"}},{key:"dropResponders",value:function(){console.debug(this.logTag,"Dropping",this.responders.size,"other responders.");var e=!0,t=!1,r=void 0;try{for(var n,i=this.responders.keys()[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var o=n.value;this.dropResponder(o)}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}}},{key:"dropResponder",value:function(e){var t={type:"drop-responder",id:e},n=this.buildPacket(t,_.SALTYRTC_ADDR_SERVER);console.debug(this.logTag,"Sending drop-responder",r(e)),this.ws.send(n),this.responders.delete(e)}}],[{key:"validateTaskInfo",value:function(e,t){if(e.length<1)throw new R("Task names must not be empty");if(Object.keys(t).length<1)throw new R("Task data must not be empty");if(e.length!=Object.keys(t).length)throw new R("Task data must contain an entry for every task");var r=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;if(!t.hasOwnProperty(a))throw new R("Task data must contain an entry for every task")}}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}}},{key:"chooseCommonTask",value:function(e,t){var r=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;if(t.indexOf(a.getName())!==-1)return a}}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}return null}}]),t}(_),I=function(e){function n(e,t,r,i,o,s,a){h(this,n);var u=d(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,t,r,i,o,void 0===a?s:void 0));return u.logTag="Responder:",u.initiator=null,u.role="responder",u.initiator=new x(s),void 0!==a?u.authToken=a:u.initiator.handshakeState="token-sent",u}return l(n,e),c(n,[{key:"getWebsocketPath",value:function(){return t(this.initiator.permanentKey)}},{key:"getNextCsn",value:function(e){if(e===_.SALTYRTC_ADDR_SERVER)return this.serverCsn.next();if(e===_.SALTYRTC_ADDR_INITIATOR)return this.initiator.csn.next();throw new A(u(e)?"Responder may not send messages to other responders: "+e:"Bad receiver byte: "+e)}},{key:"encryptHandshakeDataForPeer",value:function(e,t,r,n){if(u(e))throw new A("Responder may not encrypt messages for other responders: "+e);if(e!==_.SALTYRTC_ADDR_INITIATOR)throw new A("Bad receiver byte: "+e);switch(t){case"token":return this.authToken.encrypt(r,n);case"key":return this.permanentKey.encrypt(r,n,this.initiator.permanentKey);default:var i=this.getPeerSessionKey();if(null===i)throw new A("Trying to encrypt for peer using session key, but session key is null");return this.sessionKey.encrypt(r,n,i)}}},{key:"getPeerAddress",value:function(){return null!==this.initiator?this.initiator.id:null}},{key:"getPeerSessionKey",value:function(){return null!==this.initiator?this.initiator.sessionKey:null}},{key:"getPeerPermanentKey",value:function(){return null!==this.initiator?this.initiator.permanentKey:null}},{key:"onPeerHandshakeMessage",value:function(e,t){if(t.destination!=this.address)throw new A("Message destination does not match our address");var r=void 0;if(t.source===_.SALTYRTC_ADDR_SERVER){r=a(e,this.permanentKey,this.serverKey,"server");var n=this.decodeMessage(r,"server");switch(n.type){case"new-initiator":console.debug(this.logTag,"Received new-initiator"),this.handleNewInitiator(n);break;default:throw new A("Received unexpected server message: "+n.type)}}else{if(t.source!==_.SALTYRTC_ADDR_INITIATOR)throw new T(m.InternalError,"Message source is neither the server nor the initiator");r=this.decryptInitiatorMessage(e);var i=void 0;switch(this.initiator.handshakeState){case"new":throw new A("Unexpected peer handshake message");case"key-sent":i=this.decodeMessage(r,"key",!0),console.debug(this.logTag,"Received key"),this.handleKey(i),this.sendAuth(t);break;case"auth-sent":i=this.decodeMessage(r,"auth",!0),console.debug(this.logTag,"Received auth"),this.handleAuth(i,t),this.setState("task"),console.info(this.logTag,"Peer handshake done");break;default:throw new T(m.InternalError,"Unknown initiator handshake state")}}}},{key:"decryptInitiatorMessage",value:function(e){switch(this.initiator.handshakeState){case"new":case"token-sent":case"key-received":throw new A("Received message in "+this.initiator.handshakeState+" state.");case"key-sent":return a(e,this.permanentKey,this.initiator.permanentKey,"key");case"auth-sent":case"auth-received":return a(e,this.sessionKey,this.initiator.sessionKey,"initiator session");default:throw new A("Invalid handshake state: "+this.initiator.handshakeState)}}},{key:"sendClientHello",value:function(){var e={type:"client-hello",key:this.permanentKey.publicKeyBytes.buffer},t=this.buildPacket(e,_.SALTYRTC_ADDR_SERVER,!1);console.debug(this.logTag,"Sending client-hello"),this.ws.send(t),this.serverHandshakeState="hello-sent"}},{key:"handleServerAuth",value:function(e,t){if(this.validateNonce(t,void 0,_.SALTYRTC_ADDR_SERVER),t.destination>255||t.destination<2)throw console.error(this.logTag,"Invalid nonce destination:",t.destination),"bad-nonce-destination";this.address=t.destination,console.debug(this.logTag,"Server assigned address",r(this.address)),this.logTag="Responder["+r(this.address)+"]:",this.validateRepeatedCookie(e),this.initiator.connected=e.initiator_connected,console.debug(this.logTag,"Initiator",this.initiator.connected?"":"not","connected"),this.serverHandshakeState="done"}},{key:"handleNewInitiator",value:function(e){this.initiator.connected=!0,this.initPeerHandshake()}},{key:"initPeerHandshake",value:function(){this.initiator.connected&&(null===this.peerTrustedKey&&this.sendToken(),this.sendKey())}},{key:"sendToken",value:function(){var e={type:"token",key:this.permanentKey.publicKeyBytes.buffer},t=this.buildPacket(e,_.SALTYRTC_ADDR_INITIATOR);console.debug(this.logTag,"Sending token"),this.ws.send(t),this.initiator.handshakeState="token-sent"}},{key:"sendKey",value:function(){this.sessionKey=new p;var e={type:"key",key:this.sessionKey.publicKeyBytes.buffer},t=this.buildPacket(e,_.SALTYRTC_ADDR_INITIATOR);console.debug(this.logTag,"Sending key"),this.ws.send(t),this.initiator.handshakeState="key-sent"}},{key:"handleKey",value:function(e){this.initiator.sessionKey=new Uint8Array(e.key),this.initiator.handshakeState="key-received"}},{key:"sendAuth",value:function(e){if(e.cookie.equals(this.cookiePair.ours))throw new A("Their cookie and our cookie are the same.");var t={},r=!0,n=!1,i=void 0;try{for(var o,s=this.tasks[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;t[a.getName()]=a.getData()}}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}var u=this.tasks.map(function(e){return e.getName()}),f={type:"auth",your_cookie:e.cookie.asArrayBuffer(),tasks:u,data:t},h=this.buildPacket(f,_.SALTYRTC_ADDR_INITIATOR);console.debug(this.logTag,"Sending auth"),this.ws.send(h),this.initiator.handshakeState="auth-sent"}},{key:"handleAuth",value:function(e,t){this.validateRepeatedCookie(e);try{n.validateTaskInfo(e.task,e.data)}catch(e){if(e instanceof R)throw new A("Peer sent invalid task info: "+e.message);throw e}var r=null,i=!0,o=!1,s=void 0;try{for(var a,u=this.tasks[Symbol.iterator]();!(i=(a=u.next()).done);i=!0){var f=a.value;if(f.getName()===e.task){r=f,console.info(this.logTag,"Task",e.task,"has been selected");break}}}catch(e){o=!0,s=e}finally{try{!i&&u.return&&u.return()}finally{if(o)throw s}}if(null===r)throw new T(m.ProtocolError,"Initiator selected unknown task");this.initTask(r,e.data[r.getName()]),console.debug(this.logTag,"Initiator authenticated"),this.initiator.cookie=t.cookie,this.initiator.handshakeState="auth-received"}}],[{key:"validateTaskInfo",value:function(e,t){if(0==e.length)throw new R("Task name must not be empty");if(Object.keys(t).length<1)throw new R("Task data must not be empty");if(Object.keys(t).length>1)throw new R("Task data must contain exactly 1 key");if(!t.hasOwnProperty(e))throw new R("Task data must contain an entry for the chosen task")}}]),n}(_),C=function(){function e(){h(this,e),this.map=new Map}return c(e,[{key:"register",value:function(e,t){if("string"==typeof e)this.set(e,t);else{var r=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;this.set(a,t)}}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}}}},{key:"unregister",value:function(e,t){if("string"==typeof e){if(!this.map.has(e))return;if("undefined"==typeof t)this.map.delete(e);else{var r=this.map.get(e),n=r.indexOf(t);n!==-1&&r.splice(n,1)}}else{var i=!0,o=!1,s=void 0;try{for(var a,u=e[Symbol.iterator]();!(i=(a=u.next()).done);i=!0){var f=a.value;this.unregister(f,t)}}catch(e){o=!0,s=e}finally{try{!i&&u.return&&u.return()}finally{if(o)throw s}}}}},{key:"set",value:function(e,t){if(this.map.has(e)){var r=this.map.get(e);r.indexOf(t)===-1&&r.push(t)}else this.map.set(e,[t])}},{key:"get",value:function(e){var t=[];if("string"==typeof e)this.map.has(e)&&t.push.apply(t,this.map.get(e));else{var r=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value,u=!0,f=!1,h=void 0;try{for(var c,l=this.get(a)[Symbol.iterator]();!(u=(c=l.next()).done);u=!0){var d=c.value;t.indexOf(d)===-1&&t.push(d)}}catch(e){f=!0,h=e}finally{try{!u&&l.return&&l.return()}finally{if(f)throw h}}}}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}}return t}}]),e}(),K=function(){function e(){h(this,e),this.hasConnectionInfo=!1,this.hasKeyStore=!1,this.hasInitiatorInfo=!1,this.hasTrustedPeerKey=!1,this.hasTasks=!1}return c(e,[{key:"validateHost",value:function(e){if(e.endsWith("/"))throw new Error("SaltyRTC host may not end with a slash");if(e.indexOf("//")!==-1)throw new Error("SaltyRTC host should not contain protocol")}},{key:"requireKeyStore",value:function(){if(!this.hasKeyStore)throw new Error("Keys not set yet. Please call .withKeyStore method first.")}},{key:"requireConnectionInfo",value:function(){if(!this.hasConnectionInfo)throw new Error("Connection info not set yet. Please call .connectTo method first.")}},{key:"requireTasks",value:function(){if(!this.hasTasks)throw new Error("Tasks not set yet. Please call .usingTasks method first.")}},{key:"requireInitiatorInfo",value:function(){if(!this.hasInitiatorInfo)throw new Error("Initiator info not set yet. Please call .initiatorInfo method first.")}},{key:"connectTo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8765;return this.validateHost(e),this.host=e,this.port=t,this.hasConnectionInfo=!0,this}},{key:"withKeyStore",value:function(e){return this.keyStore=e,this.hasKeyStore=!0,this}},{key:"withTrustedPeerKey",value:function(e){return this.peerTrustedKey=e,this.hasTrustedPeerKey=!0,this}},{key:"usingTasks",value:function(e){if(e.length<1)throw new Error("You must specify at least 1 task");return this.tasks=e,this.hasTasks=!0,this}},{key:"initiatorInfo",value:function(e,t){return this.initiatorPublicKey=e,this.authToken=t,this.hasInitiatorInfo=!0,this}},{key:"asInitiator",value:function(){return this.requireConnectionInfo(),this.requireKeyStore(),this.requireTasks(),this.hasTrustedPeerKey?new D(this.keyStore,this.host,this.port,this.tasks,this.peerTrustedKey).asInitiator():new D(this.keyStore,this.host,this.port,this.tasks).asInitiator()}},{key:"asResponder",value:function(){return this.requireConnectionInfo(),this.requireKeyStore(),this.requireTasks(),this.hasTrustedPeerKey?new D(this.keyStore,this.host,this.port,this.tasks,this.peerTrustedKey).asResponder():(this.requireInitiatorInfo(),new D(this.keyStore,this.host,this.port,this.tasks).asResponder(this.initiatorPublicKey,this.authToken))}}]),e}(),D=function(){function e(t,r,n,i,o){if(h(this,e),this.peerTrustedKey=null,this._signaling=null,void 0===t)throw new Error("SaltyRTC must be initialized with a permanent key");if(void 0===r)throw new Error("SaltyRTC must be initialized with a target host");if(void 0===i||0==i.length)throw new Error("SaltyRTC must be initialized with at least 1 task");this.host=r,this.port=n,this.permanentKey=t,this.tasks=i,void 0!==o&&(this.peerTrustedKey=o),this.eventRegistry=new C}return c(e,[{key:"asInitiator",value:function(){return null!==this.peerTrustedKey?this._signaling=new U(this,this.host,this.port,this.tasks,this.permanentKey,this.peerTrustedKey):this._signaling=new U(this,this.host,this.port,this.tasks,this.permanentKey),this}},{key:"asResponder",value:function(e,t){if(null!==this.peerTrustedKey)this._signaling=new I(this,this.host,this.port,this.tasks,this.permanentKey,this.peerTrustedKey);else{var r=new g(t);this._signaling=new I(this,this.host,this.port,this.tasks,this.permanentKey,e,r)}return this}},{key:"getTask",value:function(){return this.signaling.task}},{key:"connect",value:function(){this.signaling.connect()}},{key:"disconnect",value:function(){this.signaling.disconnect()}},{key:"on",value:function(e,t){this.eventRegistry.register(e,t)}},{key:"once",value:function(e,t){var r=this,n=function e(n){try{t(n)}catch(t){throw r.off(n.type,e),t}r.off(n.type,e)};this.eventRegistry.register(e,n)}},{key:"off",value:function(e,t){this.eventRegistry.unregister(e,t)}},{key:"emit",value:function(e){console.debug("SaltyRTC: New event:",e.type);var t=this.eventRegistry.get(e.type),r=!0,n=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;try{this.callHandler(a,e)}catch(t){console.error("SaltyRTC: Unhandled exception in",e.type,"handler:",t)}}}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}}},{key:"callHandler",value:function(e,t){var r=e(t);r===!1&&this.eventRegistry.unregister(t.type,e)}},{key:"signaling",get:function(){if(null===this._signaling)throw Error("SaltyRTC instance not initialized. Use .asInitiator() or .asResponder().");return this._signaling}},{key:"state",get:function(){return this.signaling.getState()}},{key:"keyStore",get:function(){return this.permanentKey}},{key:"permanentKeyBytes",get:function(){return this.signaling.permanentKeyBytes}},{key:"permanentKeyHex",get:function(){return t(this.signaling.permanentKeyBytes)}},{key:"authTokenBytes",get:function(){return this.signaling.authTokenBytes}},{key:"authTokenHex",get:function(){return t(this.signaling.authTokenBytes)}},{key:"peerPermanentKeyBytes",get:function(){return this.signaling.peerPermanentKeyBytes}},{key:"peerPermanentKeyHex",get:function(){return t(this.signaling.peerPermanentKeyBytes)}}]),e}();e.SaltyRTCBuilder=K,e.KeyStore=p,e.Box=y,e.Cookie=v,e.CookiePair=w,e.CombinedSequence=b,e.CombinedSequencePair=E,e.EventRegistry=C}(this.saltyrtc.client=this.saltyrtc.client||{});

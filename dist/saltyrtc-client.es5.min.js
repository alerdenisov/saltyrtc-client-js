/**
 * saltyrtc-client-js v0.14.4
 * SaltyRTC JavaScript implementation
 * https://github.com/saltyrtc/saltyrtc-client-js
 *
 * Copyright (C) 2016-2018 Threema GmbH
 *
 * This software may be modified and distributed under the terms
 * of the MIT license:
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";var saltyrtcClient=function(u,s,c){var e;function i(e){switch(e){case u.CloseCode.ClosingNormal:return"Normal closing";case u.CloseCode.GoingAway:return"The endpoint is going away";case u.CloseCode.NoSharedSubprotocol:return"No shared subprotocol could be found";case u.CloseCode.PathFull:return"No free responder byte";case u.CloseCode.ProtocolError:return"Protocol error";case u.CloseCode.InternalError:return"Internal error";case u.CloseCode.Handover:return"Handover finished";case u.CloseCode.DroppedByInitiator:return"Dropped by initiator";case u.CloseCode.InitiatorCouldNotDecrypt:return"Initiator could not decrypt a message";case u.CloseCode.NoSharedTask:return"No shared task was found";case u.CloseCode.InvalidKey:return"Invalid key";case u.CloseCode.Timeout:return"Timeout";default:return"Unknown"}}(e=u.CloseCode||(u.CloseCode={}))[e.ClosingNormal=1e3]="ClosingNormal",e[e.GoingAway=1001]="GoingAway",e[e.NoSharedSubprotocol=1002]="NoSharedSubprotocol",e[e.PathFull=3e3]="PathFull",e[e.ProtocolError=3001]="ProtocolError",e[e.InternalError=3002]="InternalError",e[e.Handover=3003]="Handover",e[e.DroppedByInitiator=3004]="DroppedByInitiator",e[e.InitiatorCouldNotDecrypt=3005]="InitiatorCouldNotDecrypt",e[e.NoSharedTask=3006]="NoSharedTask",e[e.InvalidKey=3007]="InvalidKey",e[e.Timeout=3008]="Timeout";var d=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),a=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},y=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},g=function(e){function r(e,t){d(this,r);var n=y(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return n.message=t,n.closeCode=e,n.name="SignalingError",n}return a(r,e),r}(Error),v=function(e){function t(e){return d(this,t),y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.CloseCode.ProtocolError,e))}return a(t,g),t}(),t=function(e){function n(e){d(this,n);var t=y(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.message=e,t.name="ConnectionError",t}return a(n,e),n}(Error),h=function(e){function r(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];d(this,r);var n=y(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return n.message=e,n.name="ValidationError",n.critical=t,n}return a(r,e),r}(Error),l=function(e){function r(e,t){d(this,r);var n=y(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return n.name="CryptoError",n.message=t,n.code=e,n}return a(r,e),r}(Error),n=Object.freeze({SignalingError:g,ProtocolError:v,ConnectionError:t,ValidationError:h,CryptoError:l}),f=function(){function e(){d(this,e),this.map=new Map}return o(e,[{key:"register",value:function(e,t){if("string"==typeof e)this.set(e,t);else{var n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var a=s.value;this.set(a,t)}}catch(e){r=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw i}}}}},{key:"unregister",value:function(e,t){if("string"==typeof e){if(!this.map.has(e))return;if(void 0===t)this.map.delete(e);else{var n=this.map.get(e),r=n.indexOf(t);-1!==r&&n.splice(r,1)}}else{var i=!0,s=!1,o=void 0;try{for(var a,h=e[Symbol.iterator]();!(i=(a=h.next()).done);i=!0){var l=a.value;this.unregister(l,t)}}catch(e){s=!0,o=e}finally{try{!i&&h.return&&h.return()}finally{if(s)throw o}}}}},{key:"unregisterAll",value:function(){this.map.clear()}},{key:"set",value:function(e,t){if(this.map.has(e)){var n=this.map.get(e);-1===n.indexOf(t)&&n.push(t)}else this.map.set(e,[t])}},{key:"get",value:function(e){var t=[];if("string"==typeof e)this.map.has(e)&&t.push.apply(t,this.map.get(e));else{var n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var a=s.value,h=!0,l=!1,c=void 0;try{for(var u,d=this.get(a)[Symbol.iterator]();!(h=(u=d.next()).done);h=!0){var y=u.value;-1===t.indexOf(y)&&t.push(y)}}catch(e){l=!0,c=e}finally{try{!h&&d.return&&d.return()}finally{if(l)throw c}}}}catch(e){r=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw i}}}return t}}]),e}(),k=function(){function t(e){d(this,t),this.level=e}return o(t,[{key:"noop",value:function(){}},{key:"level",set:function(e){switch(this._level=e,this.debug=this.noop,this.trace=this.noop,this.info=this.noop,this.warn=this.noop,this.error=this.noop,this.assert=this.noop,e){case"debug":this.debug=console.debug,this.trace=console.trace;case"info":this.info=console.info;case"warn":this.warn=console.warn;case"error":this.error=console.error,this.assert=console.assert}},get:function(){return this._level}}]),t}();function p(e){var t=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var a=s.value;t.push(a.toString(16).replace(/^([\da-f])$/,"0$1"))}}catch(e){r=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw i}}return t.join("")}function w(e){return"0x"+("00"+e.toString(16)).substr(-2)}function b(){for(var e=0,t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var i=!0,s=!1,o=void 0;try{for(var a,h=n[Symbol.iterator]();!(i=(a=h.next()).done);i=!0){e+=a.value.length}}catch(e){s=!0,o=e}finally{try{!i&&h.return&&h.return()}finally{if(s)throw o}}var l=new Uint8Array(e),c=0,u=!0,d=!1,y=void 0;try{for(var g,v=n[Symbol.iterator]();!(u=(g=v.next()).done);u=!0){var f=g.value;l.set(f,c),c+=f.length}}catch(e){d=!0,y=e}finally{try{!u&&v.return&&v.return()}finally{if(d)throw y}}return l}function r(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"Key",r=void 0;if("string"==typeof(t=e)||t instanceof String)r=function(e){var t,n=void 0,r=void 0,i=0,s=void 0;for(e.length%2==1&&(e="0"+e),n=new Uint8Array(e.length/2),r=s=0,t=e.length;s<=t;r=s+=2)n[i++]=parseInt(e.substr(r,2),16);return n}(e);else{if(!(e instanceof Uint8Array))throw new h(n+" must be an Uint8Array or a hex string");r=e}if(32!==r.byteLength)throw new h(n+" must be 32 bytes long");return r}function m(e){return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}var S=function(){function r(e,t,n){d(this,r),this._nonce=e,this._nonceLength=n,this._data=t}return o(r,[{key:"toUint8Array",value:function(){var e=new Uint8Array(this.length);return e.set(this._nonce),e.set(this._data,this._nonceLength),e}},{key:"length",get:function(){return this._nonce.length+this._data.length}},{key:"data",get:function(){return this._data}},{key:"nonce",get:function(){return this._nonce}}],[{key:"fromUint8Array",value:function(e,t){if(void 0===t)throw new Error("nonceLength parameter not specified");if(e.byteLength<=t)throw new l("bad-message-length","Message is shorter than nonce");return new r(e.slice(0,t),e.slice(t),t)}}]),r}(),T=function(){function n(e,t){if(d(this,n),this.logTag="[SaltyRTC.KeyStore]",void 0===t&&(t=new k("none")),2<arguments.length)throw new Error("Too many arguments in KeyStore constructor");void 0===e?(this._keyPair=s.box.keyPair(),t.debug(this.logTag,"New public key:",p(this._keyPair.publicKey))):(this._keyPair=s.box.keyPair.fromSecretKey(r(e,"Private key")),t.debug(this.logTag,"Restored public key:",p(this._keyPair.publicKey)))}return o(n,[{key:"getSharedKeyStore",value:function(e){return new C(this.secretKeyBytes,e)}},{key:"encryptRaw",value:function(e,t,n){return s.box(e,t,n,this._keyPair.secretKey)}},{key:"encrypt",value:function(e,t,n){var r=this.encryptRaw(e,t,n);return new S(t,r,s.box.nonceLength)}},{key:"decryptRaw",value:function(e,t,n){var r=s.box.open(e,t,n,this._keyPair.secretKey);if(!r)throw new l("decryption-failed","Data could not be decrypted");return r}},{key:"decrypt",value:function(e,t){return this.decryptRaw(e.data,e.nonce,t)}},{key:"publicKeyHex",get:function(){return p(this._keyPair.publicKey)}},{key:"publicKeyBytes",get:function(){return this._keyPair.publicKey}},{key:"secretKeyHex",get:function(){return p(this._keyPair.secretKey)}},{key:"secretKeyBytes",get:function(){return this._keyPair.secretKey}},{key:"keypair",get:function(){return this._keyPair}}]),n}(),C=function(){function n(e,t){d(this,n),this._localSecretKey=r(e,"Local private key"),this._remotePublicKey=r(t,"Remote public key"),this._sharedKey=s.box.before(this._remotePublicKey,this._localSecretKey)}return o(n,[{key:"encryptRaw",value:function(e,t){return s.box.after(e,t,this._sharedKey)}},{key:"encrypt",value:function(e,t){var n=this.encryptRaw(e,t);return new S(t,n,s.box.nonceLength)}},{key:"decryptRaw",value:function(e,t){var n=s.box.open.after(e,t,this._sharedKey);if(!n)throw new l("decryption-failed","Data could not be decrypted");return n}},{key:"decrypt",value:function(e){return this.decryptRaw(e.data,e.nonce)}},{key:"localSecretKeyHex",get:function(){return p(this._localSecretKey)}},{key:"localSecretKeyBytes",get:function(){return this._localSecretKey}},{key:"remotePublicKeyHex",get:function(){return p(this._remotePublicKey)}},{key:"remotePublicKeyBytes",get:function(){return this._remotePublicKey}}]),n}(),_=function(){function r(e,t){if(d(this,r),this._authToken=null,this.logTag="[SaltyRTC.AuthToken]",void 0===t&&(t=new k("none")),void 0===e)this._authToken=s.randomBytes(s.secretbox.keyLength),t.debug(this.logTag,"Generated auth token");else{if(e.byteLength!==s.secretbox.keyLength){var n="Auth token must be "+s.secretbox.keyLength+" bytes long.";throw t.error(this.logTag,n),new l("bad-token-length",n)}this._authToken=e,t.debug(this.logTag,"Initialized auth token")}}return o(r,[{key:"encrypt",value:function(e,t){var n=s.secretbox(e,t,this._authToken);return new S(t,n,s.secretbox.nonceLength)}},{key:"decrypt",value:function(e){var t=s.secretbox.open(e.data,e.nonce,this._authToken);if(!t)throw new l("decryption-failed","Data could not be decrypted");return t}},{key:"keyBytes",get:function(){return this._authToken}},{key:"keyHex",get:function(){return p(this._authToken)}}]),r}(),P=function(){function n(e){if(d(this,n),void 0!==e){if(16!==e.length)throw new h("Bad cookie length");this.bytes=e}else this.bytes=s.randomBytes(n.COOKIE_LENGTH)}return o(n,[{key:"equals",value:function(e){if(e.bytes===this.bytes)return!0;if(e.bytes.byteLength!==n.COOKIE_LENGTH)return!1;for(var t=0;t<this.bytes.byteLength;t++)if(e.bytes[t]!==this.bytes[t])return!1;return!0}}]),n}();P.COOKIE_LENGTH=16;var K=function(){function n(e,t){if(d(this,n),this._ours=null,this._theirs=null,void 0!==e&&void 0!==t){if(t.equals(e))throw new v("Their cookie matches our cookie");this._ours=e,this._theirs=t}else{if(void 0!==e||void 0!==t)throw new Error("Either both or no cookies must be specified");this._ours=new P}}return o(n,[{key:"ours",get:function(){return this._ours}},{key:"theirs",get:function(){return this._theirs},set:function(e){if(e.equals(this._ours))throw new v("Their cookie matches our cookie");this._theirs=e}}],[{key:"fromTheirs",value:function(e){for(var t=void 0;(t=new P).equals(e););return new n(t,e)}}]),n}(),R=function(){function s(e,t,n,r,i){d(this,s),this._cookie=e,this._overflow=t,this._sequenceNumber=n,this._source=r,this._destination=i}return o(s,[{key:"toUint8Array",value:function(){var e=new ArrayBuffer(s.TOTAL_LENGTH),t=new Uint8Array(e);t.set(this._cookie.bytes);var n=new DataView(e,P.COOKIE_LENGTH,8);return n.setUint8(0,this._source),n.setUint8(1,this._destination),n.setUint16(2,this._overflow),n.setUint32(4,this._sequenceNumber),t}},{key:"cookie",get:function(){return this._cookie}},{key:"overflow",get:function(){return this._overflow}},{key:"sequenceNumber",get:function(){return this._sequenceNumber}},{key:"combinedSequenceNumber",get:function(){return this._overflow*Math.pow(2,32)+this._sequenceNumber}},{key:"source",get:function(){return this._source}},{key:"destination",get:function(){return this._destination}}],[{key:"fromUint8Array",value:function(e){if(e.byteLength!==this.TOTAL_LENGTH)throw new h("bad-packet-length");var t=new DataView(e.buffer,e.byteOffset+P.COOKIE_LENGTH,8),n=new P(e.slice(0,P.COOKIE_LENGTH)),r=t.getUint8(0),i=t.getUint8(1);return new s(n,t.getUint16(2),t.getUint32(4),r,i)}}]),s}();R.TOTAL_LENGTH=24;var E=function(){function e(){d(this,e),this.sequenceNumber=(window.crypto||window.msCrypto).getRandomValues(new Uint32Array(1))[0],this.overflow=0}return o(e,[{key:"next",value:function(){if(this.sequenceNumber>=e.SEQUENCE_NUMBER_MAX){if(this.sequenceNumber=0,this.overflow+=1,this.overflow>=e.OVERFLOW_MAX)throw new Error("overflow-overflow")}else this.sequenceNumber+=1;return{sequenceNumber:this.sequenceNumber,overflow:this.overflow}}},{key:"asNumber",value:function(){return this.overflow*Math.pow(2,32)+this.sequenceNumber}}]),e}();E.SEQUENCE_NUMBER_MAX=4294967295,E.OVERFLOW_MAX=1048575;var I=function e(t,n){if(d(this,e),this.ours=null,this.theirs=null,void 0!==t&&void 0!==n)this.ours=t,this.theirs=n;else{if(void 0!==t||void 0!==n)throw new Error("Either both or no combined sequences must be specified");this.ours=new E}},A=function(){function n(e,t){d(this,n),this._csnPair=new I,this._permanentSharedKey=null,this._sessionSharedKey=null,this._id=e,this._cookiePair=void 0===t?new K:t}return o(n,[{key:"setPermanentSharedKey",value:function(e,t){this._permanentSharedKey=t.getSharedKeyStore(e)}},{key:"setSessionSharedKey",value:function(e,t){this._sessionSharedKey=t.getSharedKeyStore(e)}},{key:"id",get:function(){return this._id}},{key:"hexId",get:function(){return w(this._id)}},{key:"csnPair",get:function(){return this._csnPair}},{key:"cookiePair",get:function(){return this._cookiePair}},{key:"permanentSharedKey",get:function(){return this._permanentSharedKey}},{key:"sessionSharedKey",get:function(){return this._sessionSharedKey}}]),n}(),N=function(e){function n(){d(this,n);var e=y(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments));return e._localSessionKey=null,e}return a(n,A),o(n,[{key:"setLocalSessionKey",value:function(e){this._localSessionKey=e}},{key:"setSessionSharedKey",value:function(e,t){t?this._localSessionKey=t:t=this._localSessionKey,function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,n,r)}if("value"in i)return i.value;var o=i.get;return void 0!==o?o.call(r):void 0}(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setSessionSharedKey",this).call(this,e,t)}},{key:"localSessionKey",get:function(){return this._localSessionKey}}]),n}(),O=function(e){function r(e,t){d(this,r);var n=y(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,r.ID));return n.connected=!1,n.handshakeState="new",n.setPermanentSharedKey(e,t),n}return a(r,N),o(r,[{key:"name",get:function(){return"Initiator"}}]),r}();O.ID=1;var D=function(e){function r(e,t){d(this,r);var n=y(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return n.handshakeState="new",n._counter=t,n}return a(r,N),o(r,[{key:"name",get:function(){return"Responder "+this.id}},{key:"counter",get:function(){return this._counter}}]),r}(),L=function(e){function t(){d(this,t);var e=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.ID));return e.handshakeState="new",e}return a(t,A),o(t,[{key:"name",get:function(){return"Server"}}]),t}();L.ID=0;var x=function(){function e(){d(this,e),this.reset()}return o(e,[{key:"reset",value:function(){this._local=!1,this._peer=!1}},{key:"local",get:function(){return this._local},set:function(e){var t=this.both;this._local=e,!t&&this.both&&void 0!==this.onBoth&&this.onBoth()}},{key:"peer",get:function(){return this._peer},set:function(e){var t=this.both;this._peer=e,!t&&this.both&&void 0!==this.onBoth&&this.onBoth()}},{key:"both",get:function(){return!0===this._local&&!0===this._peer}},{key:"any",get:function(){return!0===this._local||!0===this._peer}}]),e}();function U(e){return 2<=e&&e<=255}var M=function(){function l(e,t,n,r,i,s,o,a){var h=this;d(this,l),this.protocol="wss",this.ws=null,this.msgpackEncodeOptions={codec:c.createCodec({binarraybuffer:!0})},this.msgpackDecodeOptions={codec:c.createCodec({binarraybuffer:!0})},this.state="new",this.handoverState=new x,this.task=null,this.server=new L,this.peerTrustedKey=null,this.authToken=null,this.serverPublicKey=null,this.role=null,this.logTag="[SaltyRTC.Signaling]",this.address=l.SALTYRTC_ADDR_UNKNOWN,this.log=e.log,this.client=e,this.permanentKey=o,this.host=t,this.port=n,this.tasks=i,this.pingInterval=s,void 0!==a&&(this.peerTrustedKey=a),void 0!==r&&(this.serverPublicKey=r),this.handoverState.onBoth=function(){h.client.emit({type:"handover"}),h.closeWebsocket(u.CloseCode.Handover)}}return o(l,[{key:"setState",value:function(e){this.state=e,this.client.emit({type:"state-change",data:e}),this.client.emit({type:"state-change:"+e})}},{key:"getState",value:function(){return this.state}},{key:"msgpackEncode",value:function(e){return c.encode(e,this.msgpackEncodeOptions)}},{key:"msgpackDecode",value:function(e){return c.decode(e,this.msgpackDecodeOptions)}},{key:"connect",value:function(){this.resetConnection(),this.initWebsocket()}},{key:"disconnect",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=u.CloseCode.ClosingNormal;this.setState("closing"),"task"===this.state&&this.sendClose(t),this.closeWebsocket(t,void 0,e),null!==this.task&&(this.log.debug(this.logTag,"Closing task connections"),this.task.close(t)),this.setState("closed")}},{key:"closeWebsocket",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];null!==this.ws&&((void 0===e||e<=3e3)&&(e=u.CloseCode.ClosingNormal),this.log.debug(this.logTag,"Disconnecting WebSocket, close code: "+e),this.ws.close(e,t),n&&(this.ws.removeEventListener("open",this.onOpen.bind(this)),this.ws.removeEventListener("error",this.onError.bind(this)),this.ws.removeEventListener("close",this.onClose.bind(this)),this.ws.removeEventListener("message",this.onMessage.bind(this))),this.ws=null,n&&this.setState("closed"))}},{key:"initWebsocket",value:function(){var e=this.protocol+"://"+this.host+":"+this.port+"/",t=this.getWebsocketPath();this.ws=new WebSocket(e+t,l.SALTYRTC_SUBPROTOCOL),this.ws.binaryType="arraybuffer",this.ws.addEventListener("open",this.onOpen.bind(this)),this.ws.addEventListener("error",this.onError.bind(this)),this.ws.addEventListener("close",this.onClose.bind(this)),this.ws.addEventListener("message",this.onMessage.bind(this)),this.setState("ws-connecting"),this.log.debug(this.logTag,"Opening WebSocket connection to",e+t)}},{key:"onOpen",value:function(){this.log.info(this.logTag,"Opened connection"),this.setState("server-handshake")}},{key:"onError",value:function(e){this.log.error(this.logTag,"General WebSocket error",e),this.client.emit({type:"connection-error"})}},{key:"onClose",value:function(e){e.code===u.CloseCode.Handover?this.log.info(this.logTag,"Closed WebSocket connection due to handover"):(this.log.info(this.logTag,"Closed WebSocket connection with close code "+e.code+" ("+i(e.code)+")"),this.setState("closed"),this.client.emit({type:"connection-closed",data:e.code}))}},{key:"onMessage",value:function(e){if(this.log.debug(this.logTag,"New ws message ("+e.data.byteLength+" bytes)"),this.handoverState.peer)return this.log.error(this.logTag,"Protocol error: Received WebSocket message from peer even though it has already handed over to task."),void this.resetConnection(u.CloseCode.ProtocolError);var t=void 0;try{var n=S.fromUint8Array(new Uint8Array(e.data),R.TOTAL_LENGTH);if(t=R.fromUint8Array(n.nonce),null===this.getPeerWithId(t.source))return void this.log.debug(this.logTag,"Ignoring message from unknown id: "+t.source);try{this.validateNonce(t)}catch(e){if("ValidationError"===e.name){if(!0===e.critical)throw new v("Invalid nonce: "+e);return void this.log.warn(this.logTag,"Dropping message with invalid nonce: "+e)}throw e}switch(this.getState()){case"server-handshake":this.onServerHandshakeMessage(n,t);break;case"peer-handshake":this.onPeerHandshakeMessage(n,t);break;case"task":this.onSignalingMessage(n,t);break;default:this.log.warn(this.logTag,"Received message in",this.getState(),"signaling state. Ignoring.")}}catch(e){if("SignalingError"===e.name||"ProtocolError"===e.name){var r="Signaling error: "+i(e.closeCode);switch(e.message&&(r+=" ("+e.message+")"),this.log.error(this.logTag,r),this.state){case"new":case"ws-connecting":case"server-handshake":this.resetConnection(e.closeCode);break;case"peer-handshake":this.handlePeerHandshakeSignalingError(e,void 0===t?null:t.source);break;case"task":this.sendClose(e.closeCode),this.resetConnection(u.CloseCode.ClosingNormal)}}else{if("ConnectionError"!==e.name)throw e.hasOwnProperty("stack")&&(this.log.error(this.logTag,"An unknown error occurred:"),this.log.error(e.stack)),e;this.log.warn(this.logTag,"Connection error. Resetting connection."),this.resetConnection(u.CloseCode.InternalError)}}}},{key:"onServerHandshakeMessage",value:function(e,t){var n=void 0;n="new"===this.server.handshakeState?e.data:this.server.sessionSharedKey.decrypt(e);var r=this.decodeMessage(n,"server handshake");switch(this.server.handshakeState){case"new":if("server-hello"!==r.type)throw new v("Expected server-hello message, but got "+r.type);this.log.debug(this.logTag,"Received server-hello"),this.handleServerHello(r,t),this.sendClientHello(),this.sendClientAuth();break;case"hello-sent":throw new v("Received "+r.type+" message before sending client-auth");case"auth-sent":if("server-auth"!==r.type)throw new v("Expected server-auth message, but got "+r.type);this.log.debug(this.logTag,"Received server-auth"),this.handleServerAuth(r,t);break;case"done":throw new g(u.CloseCode.InternalError,"Received server handshake message even though server handshake state is set to 'done'");default:throw new g(u.CloseCode.InternalError,"Unknown server handshake state: "+this.server.handshakeState)}"done"===this.server.handshakeState&&(this.setState("peer-handshake"),this.log.debug(this.logTag,"Server handshake done"),this.initPeerHandshake())}},{key:"onSignalingMessage",value:function(e,t){if(this.log.debug(this.logTag,"Message received"),t.source===l.SALTYRTC_ADDR_SERVER)this.onSignalingServerMessage(e);else{var n=this.getPeer().sessionSharedKey.decrypt(e);this.onSignalingPeerMessage(n)}}},{key:"onSignalingServerMessage",value:function(e){var t=this.decryptServerMessage(e);switch(t.type){case"send-error":this.log.debug(this.logTag,"Received send-error message"),this.handleSendError(t);break;case"disconnected":this.log.debug(this.logTag,"Received disconnected message"),this.handleDisconnected(t);break;default:this.onUnhandledSignalingServerMessage(t)}}},{key:"onSignalingPeerMessage",value:function(e){var t=this.decodeMessage(e);if("close"===t.type)this.log.debug(this.logTag,"Received close"),this.handleClose(t);else if("application"===t.type)this.log.debug(this.logTag,"Received application message"),this.handleApplication(t);else if(null!==this.task){-1!==this.task.getSupportedMessageTypes().indexOf(t.type)?(this.log.debug(this.logTag,"Received",t.type,"["+this.task.getName()+"]"),this.task.onTaskMessage(t)):(this.log.error(this.logTag,"Received",t.type,"message which is not supported by the",this.task.getName(),"task"),this.resetConnection(u.CloseCode.ProtocolError))}else this.log.warn(this.logTag,"Received message with invalid type from peer:",t.type)}},{key:"handleServerHello",value:function(e,t){this.server.setSessionSharedKey(new Uint8Array(e.key),this.permanentKey),this.server.cookiePair.theirs=t.cookie}},{key:"sendClientAuth",value:function(){var e={type:"client-auth",your_cookie:m(this.server.cookiePair.theirs.bytes),subprotocols:[l.SALTYRTC_SUBPROTOCOL],ping_interval:this.pingInterval};null!==this.serverPublicKey&&(e.your_key=m(this.serverPublicKey));var t=this.buildPacket(e,this.server);this.log.debug(this.logTag,"Sending client-auth"),this.ws.send(t),this.server.handshakeState="auth-sent"}},{key:"handleSendError",value:function(e){var t=new DataView(e.id),n=p(new Uint8Array(e.id)),r=t.getUint8(0),i=t.getUint8(1);if(r!==this.address)throw new v("Received send-error message for a message not sent by us!");this.log.warn(this.logTag,"SendError: Could not send unknown message:",n),this._handleSendError(i)}},{key:"handleApplication",value:function(e){this.client.emit({type:"application",data:e.data})}},{key:"sendClose",value:function(e){var t={type:"close",reason:e};if(this.log.debug(this.logTag,"Sending close"),!0===this.handoverState.local)this.task.sendSignalingMessage(this.msgpackEncode(t));else{var n=this.buildPacket(t,this.getPeer());this.ws.send(n)}}},{key:"handleClose",value:function(e){this.log.warn(this.logTag,"Received close message. Reason:",e.reason,"("+i(e.reason)+")"),this.task.close(e.reason),this.resetConnection(u.CloseCode.GoingAway)}},{key:"handleDisconnected",value:function(e){this.client.emit({type:"peer-disconnected",data:e.id})}},{key:"validateNonce",value:function(e){this.validateNonceSource(e),this.validateNonceDestination(e),this.validateNonceCsn(e),this.validateNonceCookie(e)}},{key:"validateNonceSource",value:function(e){switch(this.state){case"server-handshake":if(e.source!==l.SALTYRTC_ADDR_SERVER)throw new h("Received message during server handshake with invalid sender address ("+e.source+" != "+l.SALTYRTC_ADDR_SERVER+")",!1);break;case"peer-handshake":case"task":if(e.source!==l.SALTYRTC_ADDR_SERVER){if("initiator"===this.role&&!U(e.source))throw new h("Initiator peer message does not come from a valid responder address: "+e.source,!1);if("responder"===this.role&&e.source!==l.SALTYRTC_ADDR_INITIATOR)throw new h("Responder peer message does not come from intitiator ("+l.SALTYRTC_ADDR_INITIATOR+"), but from "+e.source,!1)}break;default:throw new v("Cannot validate message nonce in signaling state "+this.state)}}},{key:"validateNonceDestination",value:function(e){var t=null;if("server-handshake"===this.state)switch(this.server.handshakeState){case"new":case"hello-sent":t=l.SALTYRTC_ADDR_UNKNOWN;break;case"auth-sent":if("initiator"===this.role)t=l.SALTYRTC_ADDR_INITIATOR;else if(!U(e.destination))throw new h("Received message during server handshake with invalid receiver address ("+e.destination+" is not a valid responder id)");break;case"done":t=this.address}else{if("peer-handshake"!==this.state&&"task"!==this.state)throw new h("Cannot validate message nonce in signaling state "+this.state);t=this.address}if(null!==t&&e.destination!==t)throw new h("Received message with invalid destination ("+e.destination+" != "+t+")")}},{key:"validateNonceCsn",value:function(e){var t=this.getPeerWithId(e.source);if(null===t)throw new v("Could not find peer "+e.source);if(null===t.csnPair.theirs){if(0!==e.overflow)throw new h("First message from "+t.name+" must have set the overflow number to 0");t.csnPair.theirs=e.combinedSequenceNumber}else{var n=t.csnPair.theirs,r=e.combinedSequenceNumber;if(r<n)throw new h(t.name+" CSN is lower than last time");if(r===n)throw new h(t.name+" CSN hasn't been incremented");t.csnPair.theirs=r}}},{key:"validateNonceCookie",value:function(e){var t=this.getPeerWithId(e.source);if(null!==t&&null!==t.cookiePair.theirs&&!e.cookie.equals(t.cookiePair.theirs))throw new h(t.name+" cookie changed")}},{key:"validateRepeatedCookie",value:function(e,t){var n=new P(t);if(!n.equals(e.cookiePair.ours))throw this.log.debug(this.logTag,"Their cookie:",n.bytes),this.log.debug(this.logTag,"Our cookie:",e.cookiePair.ours.bytes),new v("Peer repeated cookie does not match our cookie")}},{key:"validateSignedKeys",value:function(e,t,n){if(null==e)throw new h("Server did not send signed_keys in server-auth message");var r=new S(t.toUint8Array(),new Uint8Array(e),s.box.nonceLength);this.log.debug(this.logTag,"Expected server public permanent key is",p(n));var i=void 0;try{i=this.permanentKey.decrypt(r,n)}catch(e){if("CryptoError"===e.name&&"decryption-failed"===e.code)throw new h("Could not decrypt signed_keys in server_auth message");throw e}if(!function(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}(i,b(this.server.sessionSharedKey.remotePublicKeyBytes,this.permanentKey.publicKeyBytes)))throw new h("Decrypted signed_keys in server-auth message is invalid")}},{key:"decodeMessage",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],r=this.msgpackDecode(e);if(void 0===r.type)throw new v("Malformed "+t+" message: Failed to decode msgpack data.");if(n&&void 0!==t&&r.type!==t)throw new v("Invalid "+t+" message, bad type: "+r);return r}},{key:"buildPacket",value:function(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],r=void 0;try{r=t.csnPair.ours.next()}catch(e){throw new v("CSN overflow: "+e.message)}var i=new R(t.cookiePair.ours,r.overflow,r.sequenceNumber,this.address,t.id).toUint8Array(),s=this.msgpackEncode(e);if(!1===n)return b(i,s);var o=void 0;if(t.id===l.SALTYRTC_ADDR_SERVER)o=this.encryptHandshakeDataForServer(s,i);else{if(t.id!==l.SALTYRTC_ADDR_INITIATOR&&!U(t.id))throw new v("Bad receiver byte: "+t);o=this.encryptHandshakeDataForPeer(t.id,e.type,s,i)}return o.toUint8Array()}},{key:"encryptHandshakeDataForServer",value:function(e,t){return this.server.sessionSharedKey.encrypt(e,t)}},{key:"getCurrentPeerCsn",value:function(){return"task"!==this.getState()?null:{incoming:this.getPeer().csnPair.theirs,outgoing:this.getPeer().csnPair.ours.asNumber()}}},{key:"decryptData",value:function(e){return this.getPeer().sessionSharedKey.decrypt(e)}},{key:"resetConnection",value:function(e){this.closeWebsocket(e,void 0,!0),this.server=new L,this.handoverState.reset(),this.setState("new"),void 0!==e&&this.log.debug(this.logTag,"Connection reset")}},{key:"initTask",value:function(e,t){try{e.init(this,t)}catch(e){if("ValidationError"===e.name)throw new v("Peer sent invalid task data");throw e}this.task=e}},{key:"decryptPeerMessage",value:function(t){var n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];try{var e=this.getPeer().sessionSharedKey.decrypt(t);return this.decodeMessage(e,"peer")}catch(e){if(!0===n&&"CryptoError"===e.name&&"decryption-failed"===e.code){var r=R.fromUint8Array(t.nonce);throw new v("Could not decrypt peer message from "+w(r.source))}throw e}}},{key:"decryptServerMessage",value:function(e){try{var t=this.server.sessionSharedKey.decrypt(e);return this.decodeMessage(t,"server")}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new v("Could not decrypt server message"):e}}},{key:"sendApplication",value:function(e){this.sendPostClientHandshakeMessage(e,"application")}},{key:"sendTaskMessage",value:function(e){this.sendPostClientHandshakeMessage(e,"task")}},{key:"sendPostClientHandshakeMessage",value:function(e,t){if("task"!==this.state)throw new g(u.CloseCode.ProtocolError,"Cannot send "+t+' message in "'+this.state+'" state');var n=this.getPeer();if(null===n)throw new g(u.CloseCode.InternalError,"No peer address could be found");if(!0===this.handoverState.local)this.log.debug(this.logTag,"Sending",t,"message through dc"),this.task.sendSignalingMessage(this.msgpackEncode(e));else{this.log.debug(this.logTag,"Sending",t,"message through ws");var r=this.buildPacket(e,n);this.ws.send(r)}}},{key:"encryptForPeer",value:function(e,t){var n=this.getPeer();if(!n)throw new Error("Remote peer has not yet been established");var r=n.sessionSharedKey;if(!r)throw new Error("Session key not yet established");return r.encrypt(e,t)}},{key:"decryptFromPeer",value:function(e){var t=this.getPeer();if(!t)throw new Error("Remote peer has not yet been established");var n=t.sessionSharedKey;if(!n)throw new Error("Session key not yet established");try{return n.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?("task"===this.state&&this.sendClose(u.CloseCode.InternalError),this.resetConnection(u.CloseCode.InternalError),new g(u.CloseCode.InternalError,"Decryption of peer message failed. This should not happen.")):e}}},{key:"permanentKeyBytes",get:function(){return this.permanentKey.publicKeyBytes}},{key:"authTokenBytes",get:function(){return null!==this.authToken?this.authToken.keyBytes:null}},{key:"peerPermanentKeyBytes",get:function(){return this.getPeer().permanentSharedKey.remotePublicKeyBytes}}]),l}();M.SALTYRTC_SUBPROTOCOL="v1.saltyrtc.org",M.SALTYRTC_ADDR_UNKNOWN=0,M.SALTYRTC_ADDR_SERVER=0,M.SALTYRTC_ADDR_INITIATOR=1;var H=function(e){function l(e,t,n,r,i,s,o,a){d(this,l);var h=y(this,(l.__proto__||Object.getPrototypeOf(l)).call(this,e,t,n,r,i,s,o,a));return h.logTag="[SaltyRTC.Initiator]",h.responderCounter=0,h.responders=null,h.responder=null,h.role="initiator",void 0===a&&(h.authToken=new _(void 0,h.log)),h}return a(l,M),o(l,[{key:"getWebsocketPath",value:function(){return this.permanentKey.publicKeyHex}},{key:"encryptHandshakeDataForPeer",value:function(e,t,n,r){if(e===M.SALTYRTC_ADDR_INITIATOR)throw new v("Initiator cannot encrypt messages for initiator");if(!U(e))throw new v("Bad receiver byte: "+e);var i=void 0;if("task"===this.getState())i=this.responder;else{if(!this.responders.has(e))throw new v("Unknown responder: "+e);i=this.responders.get(e)}switch(t){case"key":return i.permanentSharedKey.encrypt(n,r);default:return i.sessionSharedKey.encrypt(n,r)}}},{key:"getPeer",value:function(){return null!==this.responder?this.responder:null}},{key:"getPeerWithId",value:function(e){if(e===M.SALTYRTC_ADDR_SERVER)return this.server;if(U(e))return"task"===this.state&&null!==this.responder&&this.responder.id===e?this.responder:this.responders.has(e)?this.responders.get(e):null;throw new v("Invalid peer id: "+e)}},{key:"handlePeerHandshakeSignalingError",value:function(e,t){null!==t&&this.dropResponder(t,e.closeCode)}},{key:"processNewResponder",value:function(e){this.responders.has(e)&&(this.log.warn(this.logTag,"Previous responder discarded (server should have sent 'disconnected' message): "+e),this.responders.delete(e));var t=new D(e,this.responderCounter++);null!==this.peerTrustedKey&&(t.handshakeState="token-received",t.setPermanentSharedKey(this.peerTrustedKey,this.permanentKey)),this.responders.set(e,t),252<this.responders.size&&this.dropOldestInactiveResponder(),this.client.emit({type:"new-responder",data:e})}},{key:"dropOldestInactiveResponder",value:function(){this.log.warn(this.logTag,"Dropping oldest inactive responder");var e=null,t=!0,n=!1,r=void 0;try{for(var i,s=this.responders.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var o=i.value;"new"===o.handshakeState&&(null===e?e=o:o.counter<e.counter&&(e=o))}}catch(e){n=!0,r=e}finally{try{!t&&s.return&&s.return()}finally{if(n)throw r}}null!==e&&this.dropResponder(e.id,u.CloseCode.DroppedByInitiator)}},{key:"onPeerHandshakeMessage",value:function(e,t){if(t.destination!==this.address)throw new v("Message destination does not match our address");var n=void 0;if(t.source===M.SALTYRTC_ADDR_SERVER){try{n=this.server.sessionSharedKey.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new g(u.CloseCode.ProtocolError,"Could not decrypt server message."):e}var r=this.decodeMessage(n,"server");switch(r.type){case"new-responder":this.log.debug(this.logTag,"Received new-responder message",w(r.id)),this.handleNewResponder(r);break;case"send-error":this.log.debug(this.logTag,"Received send-error message"),this.handleSendError(r);break;case"disconnected":this.log.debug(this.logTag,"Received disconnected message"),this.handleDisconnected(r);break;default:throw new v("Received unexpected server message: "+r.type)}}else{if(!U(t.source))throw new g(u.CloseCode.InternalError,"Message source is neither the server nor a responder");var i=this.responders.get(t.source);if(null===i)throw new v("Unknown message source: "+t.source);var s=void 0;switch(i.handshakeState){case"new":if(null!==this.peerTrustedKey)throw new g(u.CloseCode.InternalError,'Handshake state is "new" even though a trusted key is available');try{n=this.authToken.decrypt(e)}catch(e){return this.log.warn(this.logTag,"Could not decrypt token message: ",e),void this.dropResponder(i.id,u.CloseCode.InitiatorCouldNotDecrypt)}s=this.decodeMessage(n,"token",!0),this.log.debug(this.logTag,"Received token"),this.handleToken(s,i);break;case"token-received":if(null!==this.peerTrustedKey)try{n=this.permanentKey.decrypt(e,this.peerTrustedKey)}catch(e){return this.log.warn(this.logTag,"Could not decrypt key message"),void this.dropResponder(i.id,u.CloseCode.InitiatorCouldNotDecrypt)}else n=i.permanentSharedKey.decrypt(e);s=this.decodeMessage(n,"key",!0),this.log.debug(this.logTag,"Received key"),this.handleKey(s,i),this.sendKey(i);break;case"key-sent":try{n=i.sessionSharedKey.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new g(u.CloseCode.ProtocolError,"Could not decrypt auth message."):e}s=this.decodeMessage(n,"auth",!0),this.log.debug(this.logTag,"Received auth"),this.handleAuth(s,i,t),this.sendAuth(i,t),this.responder=this.responders.get(i.id),this.responders.delete(i.id),this.dropResponders(u.CloseCode.DroppedByInitiator),this.setState("task"),this.log.info(this.logTag,"Peer handshake done"),this.task.onPeerHandshakeDone();break;default:throw new g(u.CloseCode.InternalError,"Unknown responder handshake state")}}}},{key:"onUnhandledSignalingServerMessage",value:function(e){"new-responder"===e.type?(this.log.debug(this.logTag,"Received new-responder message"),this.handleNewResponder(e)):this.log.warn(this.logTag,"Unexpected server message type:",e.type)}},{key:"sendClientHello",value:function(){}},{key:"handleServerAuth",value:function(e,t){if(this.address=M.SALTYRTC_ADDR_INITIATOR,this.validateRepeatedCookie(this.server,new Uint8Array(e.your_cookie)),null!=this.serverPublicKey)try{this.validateSignedKeys(new Uint8Array(e.signed_keys),t,this.serverPublicKey)}catch(e){if("ValidationError"===e.name)throw new v("Verification of signed_keys failed: "+e.message);throw e}else null!==e.signed_keys&&void 0!==e.signed_keys&&this.log.warn(this.logTag,"Server sent signed keys, but we're not verifying them.");this.responders=new Map;var n=!0,r=!1,i=void 0;try{for(var s,o=e.responders[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var a=s.value;if(!U(a))throw new v("Responder id "+a+" must be in the range 0x02-0xff");this.processNewResponder(a)}}catch(e){r=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw i}}this.log.debug(this.logTag,this.responders.size,"responders connected"),this.server.handshakeState="done"}},{key:"initPeerHandshake",value:function(){}},{key:"handleNewResponder",value:function(e){if(!U(e.id))throw new v("Responder id "+e.id+" must be in the range 0x02-0xff");"peer-handshake"===this.state?this.processNewResponder(e.id):(this.log.debug(this.logTag,"Dropping responder "+e.id+" in '"+this.state+"' state"),this.dropResponder(e.id,u.CloseCode.DroppedByInitiator))}},{key:"handleToken",value:function(e,t){t.setPermanentSharedKey(new Uint8Array(e.key),this.permanentKey),t.handshakeState="token-received"}},{key:"handleKey",value:function(e,t){t.setLocalSessionKey(new T(void 0,this.log)),t.setSessionSharedKey(new Uint8Array(e.key)),t.handshakeState="key-received"}},{key:"sendKey",value:function(e){var t={type:"key",key:m(e.localSessionKey.publicKeyBytes)},n=this.buildPacket(t,e);this.log.debug(this.logTag,"Sending key"),this.ws.send(n),e.handshakeState="key-sent"}},{key:"sendAuth",value:function(e,t){if(t.cookie.equals(e.cookiePair.ours))throw new v("Their cookie and our cookie are the same.");var n={};n[this.task.getName()]=this.task.getData();var r={type:"auth",your_cookie:m(t.cookie.bytes),task:this.task.getName(),data:n},i=this.buildPacket(r,e);this.log.debug(this.logTag,"Sending auth"),this.ws.send(i),e.handshakeState="auth-sent"}},{key:"handleAuth",value:function(e,t,n){this.validateRepeatedCookie(t,new Uint8Array(e.your_cookie));try{l.validateTaskInfo(e.tasks,e.data)}catch(e){if("ValidationError"===e.name)throw new v("Peer sent invalid task info: "+e.message);throw e}var r=l.chooseCommonTask(this.tasks,e.tasks);if(null===r){var i=this.tasks.map(function(e){return e.getName()}),s=e.tasks;throw this.log.debug(this.logTag,"We requested:",i,"Peer offered:",s),this.client.emit({type:"no-shared-task",data:{requested:i,offered:s}}),new g(u.CloseCode.NoSharedTask,"No shared task could be found")}this.log.debug(this.logTag,"Task",r.getName(),"has been selected"),this.initTask(r,e.data[r.getName()]),this.log.debug(this.logTag,"Responder",t.hexId,"authenticated"),t.cookiePair.theirs=n.cookie,t.handshakeState="auth-received"}},{key:"_handleSendError",value:function(e){if(!U(e))throw new v("Outgoing c2c messages must have been sent to a responder");var t=!1;if(null===this.responder){var n=this.responders.get(e);null==n?this.log.warn(this.logTag,"Got send-error message for unknown responder",e):(t=!0,this.responders.delete(e))}else this.responder.id===e?(t=!0,this.resetConnection(u.CloseCode.ProtocolError)):this.log.warn(this.logTag,"Got send-error message for unknown responder",e);!0===t&&this.client.emit({type:"signaling-connection-lost",data:e})}},{key:"dropResponders",value:function(e){this.log.debug(this.logTag,"Dropping",this.responders.size,"other responders.");var t=!0,n=!1,r=void 0;try{for(var i,s=this.responders.keys()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var o=i.value;this.dropResponder(o,e)}}catch(e){n=!0,r=e}finally{try{!t&&s.return&&s.return()}finally{if(n)throw r}}}},{key:"dropResponder",value:function(e,t){var n={type:"drop-responder",id:e,reason:t},r=this.buildPacket(n,this.server);this.log.debug(this.logTag,"Sending drop-responder",w(e)),this.ws.send(r),this.responders.delete(e)}}],[{key:"validateTaskInfo",value:function(e,t){if(e.length<1)throw new h("Task names must not be empty");if(Object.keys(t).length<1)throw new h("Task data must not be empty");if(e.length!==Object.keys(t).length)throw new h("Task data must contain an entry for every task");var n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var a=s.value;if(!t.hasOwnProperty(a))throw new h("Task data must contain an entry for every task")}}catch(e){r=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw i}}}},{key:"chooseCommonTask",value:function(e,t){var n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var a=s.value;if(-1!==t.indexOf(a.getName()))return a}}catch(e){r=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw i}}return null}}]),l}(),B=function(e){function c(e,t,n,r,i,s,o,a,h){d(this,c);var l=y(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,e,t,n,r,i,s,o,void 0===h?a:void 0));return l.logTag="[SaltyRTC.Responder]",l.initiator=null,l.role="responder",l.initiator=new O(a,l.permanentKey),void 0!==h?l.authToken=h:l.initiator.handshakeState="token-sent",l}return a(c,M),o(c,[{key:"getWebsocketPath",value:function(){return this.initiator.permanentSharedKey.remotePublicKeyHex}},{key:"encryptHandshakeDataForPeer",value:function(e,t,n,r){if(U(e))throw new v("Responder may not encrypt messages for other responders: "+e);if(e!==M.SALTYRTC_ADDR_INITIATOR)throw new v("Bad receiver byte: "+e);switch(t){case"token":return this.authToken.encrypt(n,r);case"key":return this.initiator.permanentSharedKey.encrypt(n,r);default:var i=this.getPeer().sessionSharedKey;if(null===i)throw new v("Trying to encrypt for peer using session key, but session key is null");return i.encrypt(n,r)}}},{key:"getPeer",value:function(){return null!==this.initiator?this.initiator:null}},{key:"getPeerWithId",value:function(e){if(e===M.SALTYRTC_ADDR_SERVER)return this.server;if(e===M.SALTYRTC_ADDR_INITIATOR)return this.initiator;throw new v("Invalid peer id: "+e)}},{key:"handlePeerHandshakeSignalingError",value:function(e,t){this.resetConnection(e.closeCode)}},{key:"onPeerHandshakeMessage",value:function(e,t){if(t.destination!==this.address)throw new v("Message destination does not match our address");var n=void 0;if(t.source===M.SALTYRTC_ADDR_SERVER){try{n=this.server.sessionSharedKey.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new g(u.CloseCode.ProtocolError,"Could not decrypt server message."):e}var r=this.decodeMessage(n,"server");switch(r.type){case"new-initiator":this.log.debug(this.logTag,"Received new-initiator message"),this.handleNewInitiator();break;case"send-error":this.log.debug(this.logTag,"Received send-error message"),this.handleSendError(r);break;case"disconnected":this.log.debug(this.logTag,"Received disconnected message"),this.handleDisconnected(r);break;default:throw new v("Received unexpected server message: "+r.type)}}else{if(t.source!==M.SALTYRTC_ADDR_INITIATOR)throw new g(u.CloseCode.InternalError,"Message source is neither the server nor the initiator");n=this.decryptInitiatorMessage(e);var i=void 0;switch(this.initiator.handshakeState){case"new":throw new v("Unexpected peer handshake message");case"key-sent":i=this.decodeMessage(n,"key",!0),this.log.debug(this.logTag,"Received key"),this.handleKey(i),this.sendAuth(t);break;case"auth-sent":i=this.decodeMessage(n,"auth",!0),this.log.debug(this.logTag,"Received auth"),this.handleAuth(i,t),this.setState("task"),this.log.info(this.logTag,"Peer handshake done");break;default:throw new g(u.CloseCode.InternalError,"Unknown initiator handshake state")}}}},{key:"decryptInitiatorMessage",value:function(e){switch(this.initiator.handshakeState){case"new":case"token-sent":case"key-received":throw new v("Received message in "+this.initiator.handshakeState+" state.");case"key-sent":try{return this.initiator.permanentSharedKey.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new g(u.CloseCode.ProtocolError,"Could not decrypt key message."):e}case"auth-sent":case"auth-received":try{return this.initiator.sessionSharedKey.decrypt(e)}catch(e){throw"CryptoError"===e.name&&"decryption-failed"===e.code?new g(u.CloseCode.ProtocolError,"Could not decrypt initiator session message."):e}default:throw new v("Invalid handshake state: "+this.initiator.handshakeState)}}},{key:"onUnhandledSignalingServerMessage",value:function(e){"new-initiator"===e.type?(this.log.debug(this.logTag,"Received new-initiator message after peer handshake completed, closing"),this.resetConnection(u.CloseCode.ClosingNormal)):this.log.warn(this.logTag,"Unexpected server message type:",e.type)}},{key:"sendClientHello",value:function(){var e={type:"client-hello",key:m(this.permanentKey.publicKeyBytes)},t=this.buildPacket(e,this.server,!1);this.log.debug(this.logTag,"Sending client-hello"),this.ws.send(t),this.server.handshakeState="hello-sent"}},{key:"handleServerAuth",value:function(e,t){if(255<t.destination||t.destination<2)throw this.log.error(this.logTag,"Invalid nonce destination:",t.destination),new h("Invalid nonce destination: "+t.destination);if(this.address=t.destination,this.log.debug(this.logTag,"Server assigned address",w(this.address)),this.logTag="[SaltyRTC.Responder."+w(this.address)+"]",this.validateRepeatedCookie(this.server,new Uint8Array(e.your_cookie)),null!=this.serverPublicKey)try{this.validateSignedKeys(new Uint8Array(e.signed_keys),t,this.serverPublicKey)}catch(e){if("ValidationError"===e.name)throw new v("Verification of signed_keys failed: "+e.message);throw e}else null!==e.signed_keys&&void 0!==e.signed_keys&&this.log.warn(this.logTag,"Server sent signed keys, but we're not verifying them.");this.initiator.connected=e.initiator_connected,this.log.debug(this.logTag,"Initiator",this.initiator.connected?"":"not","connected"),this.server.handshakeState="done"}},{key:"handleNewInitiator",value:function(){this.initiator=new O(this.initiator.permanentSharedKey.remotePublicKeyBytes,this.permanentKey),this.initiator.connected=!0,this.initPeerHandshake()}},{key:"initPeerHandshake",value:function(){this.initiator.connected&&(null===this.peerTrustedKey&&this.sendToken(),this.sendKey())}},{key:"sendToken",value:function(){var e={type:"token",key:m(this.permanentKey.publicKeyBytes)},t=this.buildPacket(e,this.initiator);this.log.debug(this.logTag,"Sending token"),this.ws.send(t),this.initiator.handshakeState="token-sent"}},{key:"sendKey",value:function(){this.initiator.setLocalSessionKey(new T(void 0,this.log));var e={type:"key",key:m(this.initiator.localSessionKey.publicKeyBytes)},t=this.buildPacket(e,this.initiator);this.log.debug(this.logTag,"Sending key"),this.ws.send(t),this.initiator.handshakeState="key-sent"}},{key:"handleKey",value:function(e){this.initiator.setSessionSharedKey(new Uint8Array(e.key)),this.initiator.handshakeState="key-received"}},{key:"sendAuth",value:function(e){if(e.cookie.equals(this.initiator.cookiePair.ours))throw new v("Their cookie and our cookie are the same.");var t={},n=!0,r=!1,i=void 0;try{for(var s,o=this.tasks[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var a=s.value;t[a.getName()]=a.getData()}}catch(e){r=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw i}}var h=this.tasks.map(function(e){return e.getName()}),l={type:"auth",your_cookie:m(e.cookie.bytes),tasks:h,data:t},c=this.buildPacket(l,this.initiator);this.log.debug(this.logTag,"Sending auth"),this.ws.send(c),this.initiator.handshakeState="auth-sent"}},{key:"handleAuth",value:function(e,t){this.validateRepeatedCookie(this.initiator,new Uint8Array(e.your_cookie));try{c.validateTaskInfo(e.task,e.data)}catch(e){if("ValidationError"===e.name)throw new v("Peer sent invalid task info: "+e.message);throw e}var n=null,r=!0,i=!1,s=void 0;try{for(var o,a=this.tasks[Symbol.iterator]();!(r=(o=a.next()).done);r=!0){var h=o.value;if(h.getName()===e.task){n=h,this.log.info(this.logTag,"Task",e.task,"has been selected");break}}}catch(e){i=!0,s=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw s}}if(null===n)throw new g(u.CloseCode.ProtocolError,"Initiator selected unknown task");this.initTask(n,e.data[n.getName()]),this.log.debug(this.logTag,"Initiator authenticated"),this.initiator.cookiePair.theirs=t.cookie,this.initiator.handshakeState="auth-received"}},{key:"_handleSendError",value:function(e){if(e!==M.SALTYRTC_ADDR_INITIATOR)throw new v("Outgoing c2c messages must have been sent to the initiator");this.client.emit({type:"signaling-connection-lost",data:e}),this.resetConnection(u.CloseCode.ProtocolError)}}],[{key:"validateTaskInfo",value:function(e,t){if(0===e.length)throw new h("Task name must not be empty");if(Object.keys(t).length<1)throw new h("Task data must not be empty");if(1<Object.keys(t).length)throw new h("Task data must contain exactly 1 key");if(!t.hasOwnProperty(e))throw new h("Task data must contain an entry for the chosen task")}}]),c}(),q=function(){function n(){d(this,n),this.hasConnectionInfo=!1,this.hasKeyStore=!1,this.hasInitiatorInfo=!1,this.hasTrustedPeerKey=!1,this.hasTasks=!1,this.serverInfoFactory=null,this.pingInterval=0,this.logLevel="none"}return o(n,[{key:"requireKeyStore",value:function(){if(!this.hasKeyStore)throw new Error("Keys not set yet. Please call .withKeyStore method first.")}},{key:"requireConnectionInfo",value:function(){if(!this.hasConnectionInfo)throw new Error("Connection info not set yet. Please call .connectTo method first.")}},{key:"requireTasks",value:function(){if(!this.hasTasks)throw new Error("Tasks not set yet. Please call .usingTasks method first.")}},{key:"requireInitiatorInfo",value:function(){if(!this.hasInitiatorInfo)throw new Error("Initiator info not set yet. Please call .initiatorInfo method first.")}},{key:"connectTo",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:8765;return n.validateHost(e),this.host=e,this.port=t,this.hasConnectionInfo=!0,this}},{key:"connectWith",value:function(e){return this.serverInfoFactory=e,this.hasConnectionInfo=!0,this}},{key:"withKeyStore",value:function(e){return this.keyStore=e,this.hasKeyStore=!0,this}},{key:"withTrustedPeerKey",value:function(e){return this.peerTrustedKey=r(e,"Peer key"),this.hasTrustedPeerKey=!0,this}},{key:"usingTasks",value:function(e){if(e.length<1)throw new Error("You must specify at least 1 task");return this.tasks=e,this.hasTasks=!0,this}},{key:"withPingInterval",value:function(e){if(e<0)throw new Error("Ping interval may not be negative");return this.pingInterval=e,this}},{key:"withServerKey",value:function(e){return this.serverPublicKey=r(e,"Server public key"),this}},{key:"withLoggingLevel",value:function(e){return this.logLevel=e,this}},{key:"initiatorInfo",value:function(e,t){return this.initiatorPublicKey=r(e,"Initiator public key"),this.authToken=r(t,"Auth token"),this.hasInitiatorInfo=!0,this}},{key:"processServerInfo",value:function(e,t){var n=e(p(t));this.host=n.host,this.port=n.port}},{key:"asInitiator",value:function(){if(this.requireConnectionInfo(),this.requireKeyStore(),this.requireTasks(),this.hasInitiatorInfo)throw new Error("Cannot initialize as initiator if .initiatorInfo(...) has been used");return null!==this.serverInfoFactory&&this.processServerInfo(this.serverInfoFactory,this.keyStore.publicKeyBytes),this.hasTrustedPeerKey?new W(new k(this.logLevel),this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.peerTrustedKey).asInitiator():new W(new k(this.logLevel),this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval).asInitiator()}},{key:"asResponder",value:function(){return this.requireConnectionInfo(),this.requireKeyStore(),this.requireTasks(),this.hasTrustedPeerKey?(null!==this.serverInfoFactory&&this.processServerInfo(this.serverInfoFactory,this.peerTrustedKey),new W(new k(this.logLevel),this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.peerTrustedKey).asResponder()):(this.requireInitiatorInfo(),null!==this.serverInfoFactory&&this.processServerInfo(this.serverInfoFactory,this.initiatorPublicKey),new W(new k(this.logLevel),this.keyStore,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval).asResponder(this.initiatorPublicKey,this.authToken))}}],[{key:"validateHost",value:function(e){if(e.endsWith("/"))throw new Error("SaltyRTC host may not end with a slash");if(-1!==e.indexOf("//"))throw new Error("SaltyRTC host should not contain protocol")}}]),n}(),W=function(){function h(e,t,n,r,i,s,o,a){if(d(this,h),this.peerTrustedKey=null,this._signaling=null,this.logTag="[SaltyRTC.Client]",void 0===t)throw new Error("SaltyRTC must be initialized with a permanent key");if(void 0===n)throw new Error("SaltyRTC must be initialized with a target host");if(void 0===s||0===s.length)throw new Error("SaltyRTC must be initialized with at least 1 task");this.log=e,this.host=n,this.port=r,this.permanentKey=t,this.tasks=s,this.pingInterval=o,void 0!==a&&(this.peerTrustedKey=a),void 0!==i&&(this.serverPublicKey=i),this.eventRegistry=new f}return o(h,[{key:"asInitiator",value:function(){return null!==this.peerTrustedKey?this._signaling=new H(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey,this.peerTrustedKey):this._signaling=new H(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey),this}},{key:"asResponder",value:function(e,t){if(null!==this.peerTrustedKey)this._signaling=new B(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey,this.peerTrustedKey);else{var n=new _(t,this.log);this._signaling=new B(this,this.host,this.port,this.serverPublicKey,this.tasks,this.pingInterval,this.permanentKey,e,n)}return this}},{key:"getTask",value:function(){return this.signaling.task}},{key:"getCurrentPeerCsn",value:function(){return this.signaling.getCurrentPeerCsn()}},{key:"encryptForPeer",value:function(e,t){return this.signaling.encryptForPeer(e,t)}},{key:"decryptFromPeer",value:function(e){return this.signaling.decryptFromPeer(e)}},{key:"connect",value:function(){this.signaling.connect()}},{key:"disconnect",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.signaling.disconnect(e)}},{key:"on",value:function(e,t){this.eventRegistry.register(e,t)}},{key:"once",value:function(e,r){var i=this;this.eventRegistry.register(e,function t(n){try{r(n)}catch(e){throw i.off(n.type,t),e}i.off(n.type,t)})}},{key:"off",value:function(e,t){void 0===e?this.eventRegistry.unregisterAll():this.eventRegistry.unregister(e,t)}},{key:"emit",value:function(t){this.log.debug(this.logTag,"New event:",t.type);var e=this.eventRegistry.get(t.type),n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var a=s.value;try{this.callHandler(a,t)}catch(e){this.log.error(this.logTag,"Unhandled exception in",t.type,"handler:",e)}}}catch(e){r=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw i}}}},{key:"sendApplicationMessage",value:function(e){this.signaling.sendApplication({type:"application",data:e})}},{key:"callHandler",value:function(e,t){!1===e(t)&&this.eventRegistry.unregister(t.type,e)}},{key:"signaling",get:function(){if(null===this._signaling)throw Error("SaltyRTC instance not initialized. Use .asInitiator() or .asResponder().");return this._signaling}},{key:"state",get:function(){return this.signaling.getState()}},{key:"keyStore",get:function(){return this.permanentKey}},{key:"permanentKeyBytes",get:function(){return this.signaling.permanentKeyBytes}},{key:"permanentKeyHex",get:function(){return p(this.signaling.permanentKeyBytes)}},{key:"authTokenBytes",get:function(){return this.signaling.authTokenBytes}},{key:"authTokenHex",get:function(){return this.signaling.authTokenBytes?p(this.signaling.authTokenBytes):null}},{key:"peerPermanentKeyBytes",get:function(){return this.signaling.peerPermanentKeyBytes}},{key:"peerPermanentKeyHex",get:function(){return p(this.signaling.peerPermanentKeyBytes)}}]),h}();return u.exceptions=n,u.SaltyRTCBuilder=q,u.KeyStore=T,u.Box=S,u.Cookie=P,u.CookiePair=K,u.CombinedSequence=E,u.CombinedSequencePair=I,u.EventRegistry=f,u.explainCloseCode=i,u.SignalingError=g,u.ConnectionError=t,u.Log=k,u}({},nacl,msgpack);

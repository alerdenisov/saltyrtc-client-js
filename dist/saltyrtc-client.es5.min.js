/**
 * saltyrtc-client-js v0.2.0
 * SaltyRTC JavaScript implementation
 * https://github.com/saltyrtc/saltyrtc-client-js
 *
 * Copyright (C) 2016 Threema GmbH
 *
 * This software may be modified and distributed under the terms
 * of the MIT license:
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";this.saltyrtc=this.saltyrtc||{},function(e,t){function n(e){var t=[],n=!0,r=!1,s=void 0;try{for(var i,o=e[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var a=i.value;t.push(a.toString(16).replace(/^([\da-f])$/,"0$1"))}}catch(e){r=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw s}}return t.join("")}function r(e){return"0x"+("00"+e.toString(16)).substr(-2)}function s(){var e=window.crypto||window.msCrypto;return e.getRandomValues(new Uint32Array(1))[0]}function i(){for(var e=0,t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var s=!0,i=!1,o=void 0;try{for(var a,h=n[Symbol.iterator]();!(s=(a=h.next()).done);s=!0){var u=a.value;e+=u.length}}catch(e){i=!0,o=e}finally{try{!s&&h.return&&h.return()}finally{if(i)throw o}}var c=new Uint8Array(e),l=0,d=!0,y=!1,f=void 0;try{for(var k,g=n[Symbol.iterator]();!(d=(k=g.next()).done);d=!0){var v=k.value;c.set(v,l),l+=v.length}}catch(e){y=!0,f=e}finally{try{!d&&g.return&&g.return()}finally{if(y)throw f}}return c}function o(e){switch(e){case T.ClosingNormal:return"Normal closing";case T.GoingAway:return"The endpoint is going away";case T.NoSharedSubprotocol:return"No shared subprotocol could be found";case T.PathFull:return"No free responder byte";case T.ProtocolError:return"Protocol error";case T.InternalError:return"Internal error";case T.Handover:return"Handover finished";case T.DroppedByInitiator:return"Dropped by initiator";case T.InitiatorCouldNotDecrypt:return"Initiator could not decrypt a message";case T.NoSharedTask:return"No shared task was found";default:return"Unknown"}}function a(e){this.message=e,"captureStackTrace"in Error?Error.captureStackTrace(this,a):this.stack=(new Error).stack}function h(e,t,n,r){try{return t.decrypt(e,n)}catch(e){throw"decryption-failed"===e?new S(T.ProtocolError,"Could not decrypt "+r+" message."):e}}function u(e){return e>=2&&e<=255}var c=(function(){function e(e){this.value=e}function t(t){function n(e,t){return new Promise(function(n,s){var a={key:e,arg:t,resolve:n,reject:s,next:null};o?o=o.next=a:(i=o=a,r(e,t))})}function r(n,i){try{var o=t[n](i),a=o.value;a instanceof e?Promise.resolve(a.value).then(function(e){r("next",e)},function(e){r("throw",e)}):s(o.done?"return":"normal",o.value)}catch(e){s("throw",e)}}function s(e,t){switch(e){case"return":i.resolve({value:t,done:!0});break;case"throw":i.reject(t);break;default:i.resolve({value:t,done:!1})}i=i.next,i?r(i.key,i.arg):o=null}var i,o;this._invoke=n,"function"!=typeof t.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),l=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),d=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},y=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},f=function(){function e(t,n,r){c(this,e),this._nonce=t,this._nonceLength=r,this._data=n}return l(e,[{key:"toUint8Array",value:function(){var e=new Uint8Array(this.length);return e.set(this._nonce),e.set(this._data,this._nonceLength),e}},{key:"length",get:function(){return this._nonce.length+this._data.length}},{key:"data",get:function(){return this._data}},{key:"nonce",get:function(){return this._nonce}}],[{key:"fromUint8Array",value:function(t,n){if(void 0===n)throw new Error("nonceLength parameter not specified");if(t.byteLength<=n)throw"bad-message-length";var r=t.slice(0,n),s=t.slice(n);return new e(r,s,n)}}]),e}(),k=function(){function e(t,r){c(this,e),void 0===t||void 0===r?(this._keyPair=nacl.box.keyPair(),console.debug("KeyStore: New public key:",n(this._keyPair.publicKey))):(this._keyPair={publicKey:t,secretKey:r},console.debug("KeyStore: Restored public key:",n(this._keyPair.publicKey)))}return l(e,[{key:"encrypt",value:function(e,t,n){var r=nacl.box(e,t,n,this._keyPair.secretKey);return new f(t,r,nacl.box.nonceLength)}},{key:"decrypt",value:function(e,t){var n=nacl.box.open(e.data,e.nonce,t,this._keyPair.secretKey);if(n===!1)throw"decryption-failed";return n}},{key:"publicKeyHex",get:function(){return n(this._keyPair.publicKey)}},{key:"publicKeyBytes",get:function(){return this._keyPair.publicKey}},{key:"secretKeyHex",get:function(){return n(this._keyPair.secretKey)}},{key:"secretKeyBytes",get:function(){return this._keyPair.secretKey}},{key:"keypair",get:function(){return this._keyPair}}]),e}(),g=function(){function e(t){if(c(this,e),this._authToken=null,"undefined"==typeof t)this._authToken=nacl.randomBytes(nacl.secretbox.keyLength),console.debug("AuthToken: Generated auth token");else{if(t.byteLength!=nacl.secretbox.keyLength)throw console.error("Auth token must be",nacl.secretbox.keyLength,"bytes long."),"bad-token-length";this._authToken=t,console.debug("AuthToken: Initialized auth token")}}return l(e,[{key:"encrypt",value:function(e,t){var n=nacl.secretbox(e,t,this._authToken);return new f(t,n,nacl.secretbox.nonceLength)}},{key:"decrypt",value:function(e){var t=nacl.secretbox.open(e.data,e.nonce,this._authToken);if(t===!1)throw"decryption-failed";return t}},{key:"keyBytes",get:function(){return this._authToken}},{key:"keyHex",get:function(){return n(this._authToken)}}]),e}(),v=function(){function e(t){if(c(this,e),"undefined"!=typeof t){if(16!==t.length)throw"bad-cookie-length";this.bytes=t}else this.bytes=nacl.randomBytes(e.COOKIE_LENGTH)}return l(e,[{key:"asArrayBuffer",value:function(){return this.bytes.buffer.slice(this.bytes.byteOffset,this.bytes.byteLength)}},{key:"equals",value:function(e){if(e.bytes===this.bytes)return!0;if(null==e.bytes||null==this.bytes)return!1;if(e.bytes.byteLength!=this.bytes.byteLength)return!1;for(var t=0;t<this.bytes.byteLength;t++)if(e.bytes[t]!=this.bytes[t])return!1;return!0}}],[{key:"fromArrayBuffer",value:function(t){return new e(new Uint8Array(t))}}]),e}();v.COOKIE_LENGTH=16;var p=function e(t,n){if(c(this,e),this.ours=null,this.theirs=null,"undefined"!=typeof t&&"undefined"!=typeof n)this.ours=t,this.theirs=n;else{if("undefined"!=typeof t||"undefined"!=typeof n)throw new Error("Either both or no cookies must be specified");this.ours=new v}},w=function(){function e(t,n,r,s,i){c(this,e),this._cookie=t,this._overflow=n,this._sequenceNumber=r,this._source=s,this._destination=i}return l(e,[{key:"toArrayBuffer",value:function(){var t=new ArrayBuffer(e.TOTAL_LENGTH),n=new Uint8Array(t);n.set(this._cookie.bytes);var r=new DataView(t);return r.setUint8(16,this._source),r.setUint8(17,this._destination),r.setUint16(18,this._overflow),r.setUint32(20,this._sequenceNumber),t}},{key:"cookie",get:function(){return this._cookie}},{key:"overflow",get:function(){return this._overflow}},{key:"sequenceNumber",get:function(){return this._sequenceNumber}},{key:"combinedSequenceNumber",get:function(){return(this._overflow<<32)+this._sequenceNumber}},{key:"source",get:function(){return this._source}},{key:"destination",get:function(){return this._destination}}],[{key:"fromArrayBuffer",value:function(t){if(t.byteLength!=this.TOTAL_LENGTH)throw"bad-packet-length";var n=new DataView(t),r=new v(new Uint8Array(t,0,16)),s=n.getUint8(16),i=n.getUint8(17),o=n.getUint16(18),a=n.getUint32(20);return new e(r,o,a,s,i)}}]),e}();w.TOTAL_LENGTH=24;var b=function(){function e(){c(this,e),this.sequenceNumber=s(),this.overflow=0}return l(e,[{key:"next",value:function(){if(this.sequenceNumber+1>=e.SEQUENCE_NUMBER_MAX){if(this.sequenceNumber=0,this.overflow+=1,this.overflow>=e.OVERFLOW_MAX)throw console.error("Overflow number just overflowed!"),new Error("overflow-overflow")}else this.sequenceNumber+=1;return{sequenceNumber:this.sequenceNumber,overflow:this.overflow}}}]),e}();b.SEQUENCE_NUMBER_MAX=4294967296,b.OVERFLOW_MAX=1048576;var T,m=function e(t,n){if(c(this,e),this.ours=null,this.theirs=null,"undefined"!=typeof t&&"undefined"!=typeof n)this.ours=t,this.theirs=n;else{if("undefined"!=typeof t||"undefined"!=typeof n)throw new Error("Either both or no combined sequences must be specified");this.ours=new b}};!function(e){e[e.ClosingNormal=1e3]="ClosingNormal",e[e.GoingAway=1001]="GoingAway",e[e.NoSharedSubprotocol=1002]="NoSharedSubprotocol",e[e.PathFull=3e3]="PathFull",e[e.ProtocolError=3001]="ProtocolError",e[e.InternalError=3002]="InternalError",e[e.Handover=3003]="Handover",e[e.DroppedByInitiator=3004]="DroppedByInitiator",e[e.InitiatorCouldNotDecrypt=3005]="InitiatorCouldNotDecrypt",e[e.NoSharedTask=3006]="NoSharedTask"}(T||(T={})),a.prototype=Object.create(Error.prototype),a.prototype.name="InternalError",a.prototype.constructor=a;var S=function(e){function t(e,n){c(this,t);var r=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n));return r.message=n,r.closeCode=e,r.name="SignalingError",r}return d(t,e),t}(Error),_=function(e){function t(e){return c(this,t),y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,T.ProtocolError,e))}return d(t,e),t}(S),R=function(e){function t(e){c(this,t);var n=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.message=e,n.name="ConnectionError",n}return d(t,e),t}(Error),K=function(e){function t(e){c(this,t);var n=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.message=e,n.name="ValidationError",n}return d(t,e),t}(Error),A=function(){function e(n,r,s,i,a,h){var u=this;c(this,e),this.protocol="wss",this.ws=null,this.msgpackOptions={codec:t.createCodec({binarraybuffer:!0})},this.state="new",this.serverHandshakeState="new",this.handoverState={local:!1,peer:!1},this.task=null,this.serverKey=null,this.sessionKey=null,this.authToken=null,this.peerTrustedKey=null,this.role=null,this.logTag="Signaling:",this.address=e.SALTYRTC_ADDR_UNKNOWN,this.cookiePair=null,this.serverCsn=new b,this.onOpen=function(e){console.info(u.logTag,"Opened connection"),u.setState("server-handshake")},this.onError=function(e){console.error(u.logTag,"General WebSocket error",e),u.client.emit({type:"connection-error",data:e})},this.onClose=function(e){if(e.code===T.Handover)console.info(u.logTag,"Closed WebSocket connection due to handover");else{console.info(u.logTag,"Closed WebSocket connection"),u.setState("closed");var t=function(e){return console.error(u.logTag,"Server closed connection:",e)};switch(e.code){case T.GoingAway:t("Server is being shut down");break;case T.NoSharedSubprotocol:t("No shared sub-protocol could be found");break;case T.PathFull:t("Path full (no free responder byte)");break;case T.ProtocolError:t("Protocol error");break;case T.InternalError:t("Internal server error");break;case T.DroppedByInitiator:t("Dropped by initiator")}u.client.emit({type:"connection-closed",data:e})}},this.onMessage=function(e){console.debug(u.logTag,"New ws message ("+e.data.byteLength+" bytes)");try{var t=f.fromUint8Array(new Uint8Array(e.data),w.TOTAL_LENGTH),n=w.fromArrayBuffer(t.nonce.buffer);switch(u.getState()){case"server-handshake":u.onServerHandshakeMessage(t,n);break;case"peer-handshake":u.onPeerHandshakeMessage(t,n);break;case"task":u.onSignalingMessage(t,n);break;default:console.warn(u.logTag,"Received message in",u.getState(),"signaling state. Ignoring.")}}catch(e){throw e instanceof S?(console.error(u.logTag,"Signaling error: "+o(e.closeCode)),"task"===u.state&&u.sendClose(e.closeCode),u.resetConnection(e.closeCode)):e instanceof R&&(console.warn(u.logTag,"Connection error. Resetting connection."),u.resetConnection(T.InternalError)),e}},this.client=n,this.permanentKey=a,this.host=r,this.port=s,this.tasks=i,void 0!==h&&(this.peerTrustedKey=h)}return l(e,[{key:"setState",value:function(e){this.state=e,this.client.emit({type:"state-change",data:e}),this.client.emit({type:"state-change:"+e})}},{key:"getState",value:function(){return this.state}},{key:"msgpackEncode",value:function(e){return t.encode(e,this.msgpackOptions)}},{key:"msgpackDecode",value:function(e){return t.decode(e,this.msgpackOptions)}},{key:"connect",value:function(){this.resetConnection(),this.initWebsocket()}},{key:"disconnect",value:function(){null!==this.ws&&(console.debug(this.logTag,"Disconnecting WebSocket"),this.ws.close()),this.ws=null,this.setState("closed")}},{key:"initWebsocket",value:function(){var t=this.protocol+"://"+this.host+":"+this.port+"/",n=this.getWebsocketPath();this.ws=new WebSocket(t+n,e.SALTYRTC_SUBPROTOCOL),this.ws.binaryType="arraybuffer",this.ws.addEventListener("open",this.onOpen),this.ws.addEventListener("error",this.onError),this.ws.addEventListener("close",this.onClose),this.ws.addEventListener("message",this.onMessage),this.setState("ws-connecting"),console.debug(this.logTag,"Opening WebSocket connection to",t+n)}},{key:"onServerHandshakeMessage",value:function(e,t){var n=void 0;n="new"===this.serverHandshakeState?e.data:this.permanentKey.decrypt(e,this.serverKey);var r=this.decodeMessage(n,"server handshake");switch(this.serverHandshakeState){case"new":if("server-hello"!==r.type)throw new _("Expected server-hello message, but got "+r.type);console.debug(this.logTag,"Received server-hello"),this.handleServerHello(r,t),this.sendClientHello(),this.sendClientAuth();break;case"hello-sent":throw new _("Received "+r.type+" message before sending client-auth");case"auth-sent":if("server-auth"!==r.type)throw new _("Expected server-auth message, but got "+r.type);console.debug(this.logTag,"Received server-auth"),this.handleServerAuth(r,t);break;case"done":throw new S(T.InternalError,"Received server handshake message even though server handshake state is set to 'done'");default:throw new S(T.InternalError,"Unknown server handshake state: "+this.serverHandshakeState)}"done"===this.serverHandshakeState&&(this.setState("peer-handshake"),console.debug(this.logTag,"Server handshake done"),this.initPeerHandshake())}},{key:"onSignalingMessage",value:function(t,n){if(console.debug("Message received"),n.source===e.SALTYRTC_ADDR_SERVER)this.onSignalingServerMessage(t);else{var s=void 0;try{s=this.decryptFromPeer(t)}catch(e){if("decryption-failed"===e)return void console.warn(this.logTag,"Could not decrypt peer message from",r(n.source));throw e}this.onSignalingPeerMessage(s)}}},{key:"onSignalingServerMessage",value:function(e){var t=this.decryptServerMessage(e);"send-error"===t.type?this.handleSendError(t):console.warn(this.logTag,"Invalid server message type:",t.type)}},{key:"onSignalingPeerMessage",value:function(e){var t=this.decodeMessage(e);"close"===t.type?console.debug("Received close"):"data"===t.type?(console.debug(this.logTag,"Received data"),this.handleData(t)):"restart"===t.type?(console.debug(this.logTag,"Received restart"),this.handleRestart(t)):null!==this.task&&this.task.getSupportedMessageTypes().indexOf(t.type)!==-1?(console.debug(this.logTag,"Received",t.type,"["+this.task.getName()+"]"),this.task.onTaskMessage(t)):console.warn(this.logTag,"Received message with invalid type from peer:",t.type)}},{key:"handleServerHello",value:function(e,t){this.serverKey=new Uint8Array(e.key);var n=void 0;do n=new v;while(n.equals(t.cookie));this.cookiePair=new p(n,t.cookie)}},{key:"sendClientAuth",value:function(){var t={type:"client-auth",your_cookie:this.cookiePair.theirs.asArrayBuffer(),subprotocols:[e.SALTYRTC_SUBPROTOCOL]},n=this.buildPacket(t,e.SALTYRTC_ADDR_SERVER);console.debug(this.logTag,"Sending client-auth"),this.ws.send(n),this.serverHandshakeState="auth-sent"}},{key:"handleData",value:function(e){this.client.emit({type:"data",data:e.data}),"string"==typeof e.data_type&&this.client.emit({type:"data:"+e.data_type,data:e.data})}},{key:"handleRestart",value:function(e){throw new _("Restart messages not yet implemented")}},{key:"handleSendError",value:function(e){throw new _("Send error messages not yet implemented")}},{key:"validateNonce",value:function(e,t,n){if(void 0!==t&&e.destination!==t)throw console.error(this.logTag,"Nonce destination is",e.destination,"but we're",this.address),"bad-nonce-destination";if(void 0!==n&&e.source!==n)throw console.error(this.logTag,"Nonce source is",e.source,"but should be",n),"bad-nonce-source"}},{key:"validateRepeatedCookie",value:function(e){var t=v.fromArrayBuffer(e.your_cookie);if(!t.equals(this.cookiePair.ours))throw console.debug(this.logTag,"Their cookie:",t.bytes),console.debug(this.logTag,"Our cookie:",this.cookiePair.ours.bytes),new _("Peer repeated cookie does not match our cookie")}},{key:"decodeMessage",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.msgpackDecode(e);if(void 0===r.type)throw new _("Malformed "+t+" message: Failed to decode msgpack data.");if(n&&void 0!==t&&r.type!==t)throw new _("Invalid "+t+" message, bad type: "+r);return r}},{key:"buildPacket",value:function(t,n){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],s=this.getNextCsn(n),o=new w(this.cookiePair.ours,s.overflow,s.sequenceNumber,this.address,n),a=new Uint8Array(o.toArrayBuffer()),h=this.msgpackEncode(t);if(r===!1)return i(a,h);var c=void 0;if(n===e.SALTYRTC_ADDR_SERVER)c=this.encryptHandshakeDataForServer(h,a);else{if(n!==e.SALTYRTC_ADDR_INITIATOR&&!u(n))throw new _("Bad receiver byte: "+n);c=this.encryptHandshakeDataForPeer(n,t.type,h,a)}return c.toUint8Array()}},{key:"encryptHandshakeDataForServer",value:function(e,t){return this.permanentKey.encrypt(e,t,this.serverKey)}},{key:"decryptData",value:function(e){var t=this.sessionKey.decrypt(e,this.getPeerSessionKey()),n=t.byteOffset,r=n+t.byteLength;return t.buffer.slice(n,r)}},{key:"resetConnection",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:T.ClosingNormal;this.setState("new"),this.serverCsn=new b,null!==this.ws&&(console.debug(this.logTag,"Disconnecting WebSocket (close code "+e+")"),this.ws.close(e)),this.ws=null}},{key:"initTask",value:function(e,t){try{e.init(this,t)}catch(e){if(e instanceof K)throw new _("Peer sent invalid task data");throw e}this.task=e}},{key:"decryptPeerMessage",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];try{var n=this.sessionKey.decrypt(e,this.getPeerSessionKey());return this.decodeMessage(n,"peer")}catch(n){if(t===!0&&"decryption-failed"===n){var s=w.fromArrayBuffer(e.nonce.buffer);throw new _("Could not decrypt peer message from "+r(s.source))}throw n}}},{key:"decryptServerMessage",value:function(e){try{var t=this.permanentKey.decrypt(e,this.serverKey);return this.decodeMessage(t,"server")}catch(e){throw"decryption-failed"===e?new _("Could not decrypt server message"):e}}},{key:"send",value:function(e){if(["server-handshake","peer-handshake","task"].indexOf(this.state)===-1)throw console.error("Trying to send message, but connection state is",this.state),new R("Bad signaling state, cannot send message");this.handoverState.local===!1&&this.ws.send(e)}},{key:"sendTaskMessage",value:function(e){var t=this.getPeerAddress();if(null===t)throw new S(T.InternalError,"No peer address could be found");var n=this.buildPacket(e,t);this.send(n)}},{key:"encryptForPeer",value:function(e,t){return this.sessionKey.encrypt(e,t,this.getPeerSessionKey())}},{key:"decryptFromPeer",value:function(e){return this.sessionKey.decrypt(e,this.getPeerSessionKey())}},{key:"sendClose",value:function(e){}},{key:"permanentKeyBytes",get:function(){return this.permanentKey.publicKeyBytes}},{key:"authTokenBytes",get:function(){return null!==this.authToken?this.authToken.keyBytes:null}},{key:"peerPermanentKeyBytes",get:function(){return this.getPeerPermanentKey()}}]),e}();A.SALTYRTC_SUBPROTOCOL="v0.saltyrtc.org",A.SALTYRTC_ADDR_UNKNOWN=0,A.SALTYRTC_ADDR_SERVER=0,A.SALTYRTC_ADDR_INITIATOR=1;var P=function(){function e(t){c(this,e),this._csn=new b,this.permanentKey=t}return l(e,[{key:"id",get:function(){return this._id}},{key:"hexId",get:function(){return r(this._id)}},{key:"csn",get:function(){return this._csn}}]),e}(),I=function(e){function t(e){c(this,t);var n=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.connected=!1,n.handshakeState="new",n._id=1,n}return d(t,e),t}(P),C=function(e){function t(e){c(this,t);var n=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.keyStore=new k,n.handshakeState="new",n._id=e,n}return d(t,e),t}(P),E=function(e){function t(e,n,r,s,i,o){c(this,t);var a=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,r,s,i,o));return a.logTag="Initiator:",a.responders=null,a.responder=null,a.role="initiator",void 0===o&&(a.authToken=new g),a}return d(t,e),l(t,[{key:"getWebsocketPath",value:function(){return this.permanentKey.publicKeyHex}},{key:"getNextCsn",value:function(e){if(e===A.SALTYRTC_ADDR_SERVER)return this.serverCsn.next();if(e===A.SALTYRTC_ADDR_INITIATOR)throw new _("Initiator cannot send messages to initiator");if(u(e)){if("task"===this.getState())return this.responder.csn.next();if(this.responders.has(e))return this.responders.get(e).csn.next();throw new _("Unknown responder: "+e)}throw new _("Bad receiver byte: "+e)}},{key:"encryptHandshakeDataForPeer",value:function(e,t,n,r){if(e===A.SALTYRTC_ADDR_INITIATOR)throw new _("Initiator cannot encrypt messages for initiator");if(!u(e))throw new _("Bad receiver byte: "+e);var s=void 0;if("task"===this.getState())s=this.responder;else{if(!this.responders.has(e))throw new _("Unknown responder: "+e);s=this.responders.get(e)}switch(t){case"key":return this.permanentKey.encrypt(n,r,s.permanentKey);default:return s.keyStore.encrypt(n,r,s.sessionKey)}}},{key:"getPeerAddress",value:function(){return null!==this.responder?this.responder.id:null}},{key:"getPeerSessionKey",value:function(){return null!==this.responder?this.responder.sessionKey:null}},{key:"getPeerPermanentKey",value:function(){return null!==this.responder?this.responder.permanentKey:null}},{key:"processNewResponder",value:function(e){if(this.responders.has(e))console.warn(this.logTag,"Got new-responder message for an already known responder.");else{if(!u(e))throw new _("Invalid responder id: "+e);var t=new C(e);null!==this.peerTrustedKey&&(t.handshakeState="token-received",t.permanentKey=this.peerTrustedKey),this.responders.set(e,t),this.client.emit({type:"new-responder",data:e})}}},{key:"onPeerHandshakeMessage",value:function(e,t){if(t.destination!=this.address)throw new _("Message destination does not match our address");var n=void 0;if(t.source===A.SALTYRTC_ADDR_SERVER){n=h(e,this.permanentKey,this.serverKey,"server");var r=this.decodeMessage(n,"server");switch(r.type){case"new-responder":console.debug(this.logTag,"Received new-responder"),this.handleNewResponder(r);break;default:throw new _("Received unexpected server message: "+r.type)}}else{if(!u(t.source))throw new S(T.InternalError,"Message source is neither the server nor a responder");var s=this.responders.get(t.source);if(null===s)throw new _("Unknown message sender: "+t.source);var i=void 0;switch(s.handshakeState){case"new":if(null!==this.peerTrustedKey)throw new S(T.InternalError,'Handshake state is "new" even though a trusted key is available');try{n=this.authToken.decrypt(e)}catch(e){return console.warn(this.logTag,"Could not decrypt token message: ",e),void this.dropResponder(s.id)}i=this.decodeMessage(n,"token",!0),console.debug(this.logTag,"Received token"),this.handleToken(i,s);break;case"token-received":var o=this.peerTrustedKey||s.permanentKey;try{n=this.permanentKey.decrypt(e,o)}catch(e){if(null!==this.peerTrustedKey)return console.warn(this.logTag,"Could not decrypt key message"),void this.dropResponder(s.id);throw e}i=this.decodeMessage(n,"key",!0),console.debug(this.logTag,"Received key"),this.handleKey(i,s),this.sendKey(s);break;case"key-sent":n=h(e,s.keyStore,s.sessionKey,"auth"),i=this.decodeMessage(n,"auth",!0),console.debug(this.logTag,"Received auth"),this.handleAuth(i,s,t),this.sendAuth(s,t),this.responder=this.responders.get(s.id),this.sessionKey=s.keyStore,this.responders.delete(s.id),this.dropResponders(),this.setState("task"),console.info(this.logTag,"Peer handshake done"),this.task.onPeerHandshakeDone();break;default:throw new S(T.InternalError,"Unknown responder handshake state")}}}},{key:"sendClientHello",value:function(){}},{key:"handleServerAuth",value:function(e,t){this.address=A.SALTYRTC_ADDR_INITIATOR,this.validateNonce(t,this.address,A.SALTYRTC_ADDR_SERVER),this.validateRepeatedCookie(e),this.responders=new Map;var n=!0,r=!1,s=void 0;try{for(var i,o=e.responders[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var a=i.value;this.processNewResponder(a)}}catch(e){r=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw s}}console.debug(this.logTag,this.responders.size,"responders connected"),this.serverHandshakeState="done"}},{key:"initPeerHandshake",value:function(){}},{key:"handleNewResponder",value:function(e){this.processNewResponder(e.id)}},{key:"handleToken",value:function(e,t){t.permanentKey=new Uint8Array(e.key),t.handshakeState="token-received"}},{key:"handleKey",value:function(e,t){t.sessionKey=new Uint8Array(e.key),t.handshakeState="key-received"}},{key:"sendKey",value:function(e){var t={type:"key",key:e.keyStore.publicKeyBytes.buffer},n=this.buildPacket(t,e.id);console.debug(this.logTag,"Sending key"),this.ws.send(n),e.handshakeState="key-sent"}},{key:"sendAuth",value:function(e,t){if(t.cookie.equals(this.cookiePair.ours))throw new _("Their cookie and our cookie are the same.");var n={};n[this.task.getName()]=this.task.getData();var r={type:"auth",your_cookie:t.cookie.asArrayBuffer(),task:this.task.getName(),data:n},s=this.buildPacket(r,e.id);console.debug(this.logTag,"Sending auth"),this.ws.send(s),e.handshakeState="auth-sent"}},{key:"handleAuth",value:function(e,n,r){this.validateRepeatedCookie(e);try{t.validateTaskInfo(e.tasks,e.data)}catch(e){if(e instanceof K)throw new _("Peer sent invalid task info: "+e.message);throw e}var s=t.chooseCommonTask(this.tasks,e.tasks);if(null===s)throw new S(T.NoSharedTask,"No shared task could be found");if(console.log(this.logTag,"Task",s.getName(),"has been selected"),this.initTask(s,e.data[s.getName()]),console.debug(this.logTag,"Responder",n.hexId,"authenticated"),r.cookie.equals(this.cookiePair.ours))throw new _("Local and remote cookies are equal");n.cookie=r.cookie,n.handshakeState="auth-received"}},{key:"dropResponders",value:function(){console.debug(this.logTag,"Dropping",this.responders.size,"other responders.");var e=!0,t=!1,n=void 0;try{for(var r,s=this.responders.keys()[Symbol.iterator]();!(e=(r=s.next()).done);e=!0){var i=r.value;this.dropResponder(i)}}catch(e){t=!0,n=e}finally{try{!e&&s.return&&s.return()}finally{if(t)throw n}}}},{key:"dropResponder",value:function(e){var t={type:"drop-responder",id:e},n=this.buildPacket(t,A.SALTYRTC_ADDR_SERVER);console.debug(this.logTag,"Sending drop-responder",r(e)),this.ws.send(n),this.responders.delete(e)}}],[{key:"validateTaskInfo",value:function(e,t){if(e.length<1)throw new K("Task names must not be empty");if(Object.keys(t).length<1)throw new K("Task data must not be empty");if(e.length!=Object.keys(t).length)throw new K("Task data must contain an entry for every task");var n=!0,r=!1,s=void 0;try{for(var i,o=e[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var a=i.value;if(!t.hasOwnProperty(a))throw new K("Task data must contain an entry for every task")}}catch(e){r=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw s}}}},{key:"chooseCommonTask",value:function(e,t){var n=!0,r=!1,s=void 0;try{for(var i,o=e[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var a=i.value;if(t.indexOf(a.getName())!==-1)return a}}catch(e){r=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw s}}return null}}]),t}(A),N=function(e){function t(e,n,r,s,i,o,a){c(this,t);var h=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,r,s,i,void 0===a?o:void 0));return h.logTag="Responder:",h.initiator=null,h.role="responder",h.initiator=new I(o),void 0!==a?h.authToken=a:h.initiator.handshakeState="token-sent",h}return d(t,e),l(t,[{key:"getWebsocketPath",value:function(){return n(this.initiator.permanentKey)}},{key:"getNextCsn",value:function(e){if(e===A.SALTYRTC_ADDR_SERVER)return this.serverCsn.next();if(e===A.SALTYRTC_ADDR_INITIATOR)return this.initiator.csn.next();throw new _(u(e)?"Responder may not send messages to other responders: "+e:"Bad receiver byte: "+e)}},{key:"encryptHandshakeDataForPeer",value:function(e,t,n,r){if(u(e))throw new _("Responder may not encrypt messages for other responders: "+e);if(e!==A.SALTYRTC_ADDR_INITIATOR)throw new _("Bad receiver byte: "+e);switch(t){case"token":return this.authToken.encrypt(n,r);case"key":return this.permanentKey.encrypt(n,r,this.initiator.permanentKey);default:var s=this.getPeerSessionKey();if(null===s)throw new _("Trying to encrypt for peer using session key, but session key is null");return this.sessionKey.encrypt(n,r,s)}}},{key:"getPeerAddress",value:function(){return null!==this.initiator?this.initiator.id:null}},{key:"getPeerSessionKey",value:function(){return null!==this.initiator?this.initiator.sessionKey:null}},{key:"getPeerPermanentKey",value:function(){return null!==this.initiator?this.initiator.permanentKey:null}},{key:"onPeerHandshakeMessage",value:function(e,t){if(t.destination!=this.address)throw new _("Message destination does not match our address");var n=void 0;if(t.source===A.SALTYRTC_ADDR_SERVER){n=h(e,this.permanentKey,this.serverKey,"server");var r=this.decodeMessage(n,"server");switch(r.type){case"new-initiator":console.debug(this.logTag,"Received new-initiator"),this.handleNewInitiator(r);break;default:throw new _("Received unexpected server message: "+r.type)}}else{if(t.source!==A.SALTYRTC_ADDR_INITIATOR)throw new S(T.InternalError,"Message source is neither the server nor the initiator");n=this.decryptInitiatorMessage(e);var s=void 0;switch(this.initiator.handshakeState){case"new":throw new _("Unexpected peer handshake message");case"key-sent":s=this.decodeMessage(n,"key",!0),console.debug(this.logTag,"Received key"),this.handleKey(s),this.sendAuth(t);break;case"auth-sent":s=this.decodeMessage(n,"auth",!0),console.debug(this.logTag,"Received auth"),this.handleAuth(s,t),this.setState("task"),console.info(this.logTag,"Peer handshake done");break;default:throw new S(T.InternalError,"Unknown initiator handshake state")}}}},{key:"decryptInitiatorMessage",value:function(e){switch(this.initiator.handshakeState){case"new":case"token-sent":case"key-received":throw new _("Received message in "+this.initiator.handshakeState+" state.");case"key-sent":return h(e,this.permanentKey,this.initiator.permanentKey,"key");case"auth-sent":case"auth-received":return h(e,this.sessionKey,this.initiator.sessionKey,"initiator session");default:throw new _("Invalid handshake state: "+this.initiator.handshakeState)}}},{key:"sendClientHello",value:function(){var e={type:"client-hello",key:this.permanentKey.publicKeyBytes.buffer},t=this.buildPacket(e,A.SALTYRTC_ADDR_SERVER,!1);console.debug(this.logTag,"Sending client-hello"),this.ws.send(t),this.serverHandshakeState="hello-sent"}},{key:"handleServerAuth",value:function(e,t){if(this.validateNonce(t,void 0,A.SALTYRTC_ADDR_SERVER),t.destination>255||t.destination<2)throw console.error(this.logTag,"Invalid nonce destination:",t.destination),"bad-nonce-destination";this.address=t.destination,console.debug(this.logTag,"Server assigned address",r(this.address)),
this.logTag="Responder["+r(this.address)+"]:",this.validateRepeatedCookie(e),this.initiator.connected=e.initiator_connected,console.debug(this.logTag,"Initiator",this.initiator.connected?"":"not","connected"),this.serverHandshakeState="done"}},{key:"handleNewInitiator",value:function(e){this.initiator.connected=!0,this.initPeerHandshake()}},{key:"initPeerHandshake",value:function(){this.initiator.connected&&(null===this.peerTrustedKey&&this.sendToken(),this.sendKey())}},{key:"sendToken",value:function(){var e={type:"token",key:this.permanentKey.publicKeyBytes.buffer},t=this.buildPacket(e,A.SALTYRTC_ADDR_INITIATOR);console.debug(this.logTag,"Sending token"),this.ws.send(t),this.initiator.handshakeState="token-sent"}},{key:"sendKey",value:function(){this.sessionKey=new k;var e={type:"key",key:this.sessionKey.publicKeyBytes.buffer},t=this.buildPacket(e,A.SALTYRTC_ADDR_INITIATOR);console.debug(this.logTag,"Sending key"),this.ws.send(t),this.initiator.handshakeState="key-sent"}},{key:"handleKey",value:function(e){this.initiator.sessionKey=new Uint8Array(e.key),this.initiator.handshakeState="key-received"}},{key:"sendAuth",value:function(e){if(e.cookie.equals(this.cookiePair.ours))throw new _("Their cookie and our cookie are the same.");var t={},n=!0,r=!1,s=void 0;try{for(var i,o=this.tasks[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var a=i.value;t[a.getName()]=a.getData()}}catch(e){r=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw s}}var h=this.tasks.map(function(e){return e.getName()}),u={type:"auth",your_cookie:e.cookie.asArrayBuffer(),tasks:h,data:t},c=this.buildPacket(u,A.SALTYRTC_ADDR_INITIATOR);console.debug(this.logTag,"Sending auth"),this.ws.send(c),this.initiator.handshakeState="auth-sent"}},{key:"handleAuth",value:function(e,n){this.validateRepeatedCookie(e);try{t.validateTaskInfo(e.task,e.data)}catch(e){if(e instanceof K)throw new _("Peer sent invalid task info: "+e.message);throw e}var r=null,s=!0,i=!1,o=void 0;try{for(var a,h=this.tasks[Symbol.iterator]();!(s=(a=h.next()).done);s=!0){var u=a.value;if(u.getName()===e.task){r=u,console.info(this.logTag,"Task",e.task,"has been selected");break}}}catch(e){i=!0,o=e}finally{try{!s&&h.return&&h.return()}finally{if(i)throw o}}if(null===r)throw new S(T.ProtocolError,"Initiator selected unknown task");this.initTask(r,e.data[r.getName()]),console.debug(this.logTag,"Initiator authenticated"),this.initiator.cookie=n.cookie,this.initiator.handshakeState="auth-received"}}],[{key:"validateTaskInfo",value:function(e,t){if(0==e.length)throw new K("Task name must not be empty");if(Object.keys(t).length<1)throw new K("Task data must not be empty");if(Object.keys(t).length>1)throw new K("Task data must contain exactly 1 key");if(!t.hasOwnProperty(e))throw new K("Task data must contain an entry for the chosen task")}}]),t}(A),O=function(){function e(){c(this,e),this.map=new Map}return l(e,[{key:"register",value:function(e,t){if("string"==typeof e)this.set(e,t);else{var n=!0,r=!1,s=void 0;try{for(var i,o=e[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var a=i.value;this.set(a,t)}}catch(e){r=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw s}}}}},{key:"unregister",value:function(e,t){if("string"==typeof e){if(!this.map.has(e))return;if("undefined"==typeof t)this.map.delete(e);else{var n=this.map.get(e),r=n.indexOf(t);r!==-1&&n.splice(r,1)}}else{var s=!0,i=!1,o=void 0;try{for(var a,h=e[Symbol.iterator]();!(s=(a=h.next()).done);s=!0){var u=a.value;this.unregister(u,t)}}catch(e){i=!0,o=e}finally{try{!s&&h.return&&h.return()}finally{if(i)throw o}}}}},{key:"set",value:function(e,t){if(this.map.has(e)){var n=this.map.get(e);n.indexOf(t)===-1&&n.push(t)}else this.map.set(e,[t])}},{key:"get",value:function(e){var t=[];if("string"==typeof e)this.map.has(e)&&t.push.apply(t,this.map.get(e));else{var n=!0,r=!1,s=void 0;try{for(var i,o=e[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var a=i.value,h=!0,u=!1,c=void 0;try{for(var l,d=this.get(a)[Symbol.iterator]();!(h=(l=d.next()).done);h=!0){var y=l.value;t.indexOf(y)===-1&&t.push(y)}}catch(e){u=!0,c=e}finally{try{!h&&d.return&&d.return()}finally{if(u)throw c}}}}catch(e){r=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw s}}}return t}}]),e}(),D=function(){function e(){c(this,e),this.hasConnectionInfo=!1,this.hasKeyStore=!1,this.hasInitiatorInfo=!1,this.hasTrustedPeerKey=!1,this.hasTasks=!1}return l(e,[{key:"validateHost",value:function(e){if(e.endsWith("/"))throw new Error("SaltyRTC host may not end with a slash");if(e.indexOf("//")!==-1)throw new Error("SaltyRTC host should not contain protocol")}},{key:"requireKeyStore",value:function(){if(!this.hasKeyStore)throw new Error("Keys not set yet. Please call .withKeyStore method first.")}},{key:"requireConnectionInfo",value:function(){if(!this.hasConnectionInfo)throw new Error("Connection info not set yet. Please call .connectTo method first.")}},{key:"requireTasks",value:function(){if(!this.hasTasks)throw new Error("Tasks not set yet. Please call .usingTasks method first.")}},{key:"requireInitiatorInfo",value:function(){if(!this.hasInitiatorInfo)throw new Error("Initiator info not set yet. Please call .initiatorInfo method first.")}},{key:"connectTo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8765;return this.validateHost(e),this.host=e,this.port=t,this.hasConnectionInfo=!0,this}},{key:"withKeyStore",value:function(e){return this.keyStore=e,this.hasKeyStore=!0,this}},{key:"withTrustedPeerKey",value:function(e){return this.peerTrustedKey=e,this.hasTrustedPeerKey=!0,this}},{key:"usingTasks",value:function(e){if(e.length<1)throw new Error("You must specify at least 1 task");return this.tasks=e,this.hasTasks=!0,this}},{key:"initiatorInfo",value:function(e,t){return this.initiatorPublicKey=e,this.authToken=t,this.hasInitiatorInfo=!0,this}},{key:"asInitiator",value:function(){return this.requireConnectionInfo(),this.requireKeyStore(),this.requireTasks(),this.hasTrustedPeerKey?new x(this.keyStore,this.host,this.port,this.tasks,this.peerTrustedKey).asInitiator():new x(this.keyStore,this.host,this.port,this.tasks).asInitiator()}},{key:"asResponder",value:function(){return this.requireConnectionInfo(),this.requireKeyStore(),this.requireTasks(),this.hasTrustedPeerKey?new x(this.keyStore,this.host,this.port,this.tasks,this.peerTrustedKey).asResponder():(this.requireInitiatorInfo(),new x(this.keyStore,this.host,this.port,this.tasks).asResponder(this.initiatorPublicKey,this.authToken))}}]),e}(),x=function(){function e(t,n,r,s,i){if(c(this,e),this.peerTrustedKey=null,this._signaling=null,void 0===t)throw new Error("SaltyRTC must be initialized with a permanent key");if(void 0===n)throw new Error("SaltyRTC must be initialized with a target host");if(void 0===s||0==s.length)throw new Error("SaltyRTC must be initialized with at least 1 task");this.host=n,this.port=r,this.permanentKey=t,this.tasks=s,void 0!==i&&(this.peerTrustedKey=i),this.eventRegistry=new O}return l(e,[{key:"asInitiator",value:function(){return null!==this.peerTrustedKey?this._signaling=new E(this,this.host,this.port,this.tasks,this.permanentKey,this.peerTrustedKey):this._signaling=new E(this,this.host,this.port,this.tasks,this.permanentKey),this}},{key:"asResponder",value:function(e,t){if(null!==this.peerTrustedKey)this._signaling=new N(this,this.host,this.port,this.tasks,this.permanentKey,this.peerTrustedKey);else{var n=new g(t);this._signaling=new N(this,this.host,this.port,this.tasks,this.permanentKey,e,n)}return this}},{key:"getTask",value:function(){return this.signaling.task}},{key:"connect",value:function(){this.signaling.connect()}},{key:"disconnect",value:function(){this.signaling.disconnect()}},{key:"on",value:function(e,t){this.eventRegistry.register(e,t)}},{key:"once",value:function(e,t){var n=this,r=function e(r){try{t(r)}catch(t){throw n.off(r.type,e),t}n.off(r.type,e)};this.eventRegistry.register(e,r)}},{key:"off",value:function(e,t){this.eventRegistry.unregister(e,t)}},{key:"emit",value:function(e){console.debug("SaltyRTC: New event:",e.type);var t=this.eventRegistry.get(e.type),n=!0,r=!1,s=void 0;try{for(var i,o=t[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var a=i.value;try{this.callHandler(a,e)}catch(t){console.error("SaltyRTC: Unhandled exception in",e.type,"handler:",t)}}}catch(e){r=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw s}}}},{key:"callHandler",value:function(e,t){var n=e(t);n===!1&&this.eventRegistry.unregister(t.type,e)}},{key:"signaling",get:function(){if(null===this._signaling)throw Error("SaltyRTC instance not initialized. Use .asInitiator() or .asResponder().");return this._signaling}},{key:"state",get:function(){return this.signaling.getState()}},{key:"keyStore",get:function(){return this.permanentKey}},{key:"permanentKeyBytes",get:function(){return this.signaling.permanentKeyBytes}},{key:"permanentKeyHex",get:function(){return n(this.signaling.permanentKeyBytes)}},{key:"authTokenBytes",get:function(){return this.signaling.authTokenBytes}},{key:"authTokenHex",get:function(){return n(this.signaling.authTokenBytes)}},{key:"peerPermanentKeyBytes",get:function(){return this.signaling.peerPermanentKeyBytes}},{key:"peerPermanentKeyHex",get:function(){return n(this.signaling.peerPermanentKeyBytes)}}]),e}();e.SaltyRTCBuilder=D,e.KeyStore=k,e.Box=f,e.Cookie=v,e.CookiePair=p,e.CombinedSequence=b,e.CombinedSequencePair=m,e.EventRegistry=O}(this.saltyrtc.client=this.saltyrtc.client||{},msgpack);
